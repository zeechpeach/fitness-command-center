<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zach's Fitness Command Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            background: linear-gradient(45deg, #06b6d4, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #64748b;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .workout-day-selector {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .day-btn {
            padding: 0.75rem 1.25rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
            border: none;
        }

        .day-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .intelligence-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .intelligence-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .intelligence-header h3 {
            color: #06b6d4;
            font-weight: 600;
        }

        .ai-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .suggestion-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.2);
            border-radius: 12px;
            padding: 1rem;
        }

        .suggestion-type {
            color: #f59e0b;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .suggestion-text {
            color: #e2e8f0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .exercise-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .exercise-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .exercise-target {
            display: inline-block;
            background: rgba(6, 182, 212, 0.2);
            color: #06b6d4;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .exercise-intelligence {
            text-align: right;
            flex-shrink: 0;
        }

        .suggested-weight {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .pr-indicator {
            color: #f59e0b;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .previous-session {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .previous-header {
            color: #60a5fa;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .previous-sets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
        }

        .previous-set {
            color: #93c5fd;
            font-size: 0.8rem;
            text-align: center;
            padding: 0.25rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
        }

        .set-input-grid {
            display: grid;
            gap: 0.75rem;
        }

        .set-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(15, 23, 42, 0.6);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .set-number {
            width: 2rem;
            color: #64748b;
            font-weight: 600;
            text-align: center;
        }

        .weight-input, .reps-input {
            width: 4rem;
            padding: 0.5rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            color: white;
            text-align: center;
            font-weight: 500;
        }

        .weight-input:focus, .reps-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .notes-input {
            flex: 1;
            padding: 0.5rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }

        .notes-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .notes-input::placeholder {
            color: #64748b;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-copy {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-copy:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-add {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .btn-add:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .btn-complete {
            padding: 1rem 3rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            display: block;
            margin: 2rem auto 0;
        }

        .btn-complete:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .analytics-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .insights-list {
            list-style: none;
        }

        .insight-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            border-left: 4px solid #06b6d4;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .exercise-header {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .set-row {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
        .stretch-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    background: rgba(30, 41, 59, 0.8);
    border: 2px solid rgba(71, 85, 105, 0.5);
    border-radius: 4px;
    cursor: pointer;
    appearance: none;
    position: relative;
    transition: all 0.3s ease;
}

.stretch-checkbox:checked {
    background: linear-gradient(135deg, #10b981, #059669);
    border-color: #10b981;
}

.stretch-checkbox:checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
}

.stretch-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: rgba(15, 23, 42, 0.6);
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid rgba(71, 85, 105, 0.3);
    justify-content: space-between;
}

.stretch-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.stretch-label {
    color: #e2e8f0;
    font-size: 0.9rem;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Zach's Fitness Command Center</h1>
            <p>Intelligent Workout Tracking & Performance Analytics</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" id="workout-tab-btn">🏋️ Workout</div>
            <div class="nav-tab" id="analytics-tab-btn">📊 Analytics</div>
            <div class="nav-tab" id="progress-tab-btn">📈 Progress</div>
            <div class="nav-tab" id="intelligence-tab-btn">🧠 Insights</div>
        </div>

        <!-- WORKOUT TAB -->
        <div id="workout-content" class="tab-content active">
            <div class="workout-day-selector">
    <button class="day-btn active" id="upper-btn">Upper</button>
    <button class="day-btn" id="lower-btn">Lower</button>
    <button class="day-btn" id="push-btn">Push</button>
    <button class="day-btn" id="pull-btn">Pull</button>
    <button class="day-btn" id="legs-btn">Legs</button>
</div>

<div class="workout-controls" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap;">
    <button class="btn" id="log-past-workout-btn" style="background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3);">📅 Log Past Workout</button>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <label style="color: #94a3b8; font-size: 0.9rem;">Date:</label>
        <input type="date" id="workout-date-input" style="padding: 0.5rem; background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 6px; color: white;">
    </div>
</div>

            <div class="intelligence-panel">
                <div class="intelligence-header">
                    <div class="ai-icon">AI</div>
                    <h3>Workout Intelligence</h3>
                </div>
                <div class="suggestions-grid" id="suggestions-container">
                    <div class="suggestion-card">
                        <div class="suggestion-type">Loading...</div>
                        <div class="suggestion-text">Loading AI suggestions...</div>
                    </div>
                </div>
            </div>

            <div id="exercises-container">
                <!-- Exercises will be populated here -->
            </div>

            <button class="btn-complete" id="complete-workout-btn">Complete Session</button>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics-content" class="tab-content">
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3 class="analytics-title">💪 Total Volume</h3>
                    <div class="stat-value" id="total-volume">0</div>
                    <div class="stat-label">lbs lifted this month</div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">🎯 Personal Records</h3>
                    <div class="stat-value" id="pr-count">0</div>
                    <div class="stat-label">PRs set this month</div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">🔥 Workout Streak</h3>
                    <div class="stat-value" id="workout-streak">0</div>
                    <div class="stat-label">consecutive workouts</div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">⚡ Overload Score</h3>
                    <div class="stat-value" id="overload-score">0</div>
                    <div class="stat-label">progressive overload rating</div>
                </div>
            </div>
        </div>

        <!-- PROGRESS TAB -->
        <div id="progress-content" class="tab-content">
            <div class="analytics-card">
                <h3 class="analytics-title">📈 Progress Tracking</h3>
                <div id="progress-list">
                    <p style="color: #64748b;">Complete some workouts to see your strength progression!</p>
                </div>
            </div>
        </div>

        <!-- INTELLIGENCE TAB -->
        <div id="intelligence-content" class="tab-content">
            <div class="analytics-card">
                <h3 class="analytics-title">🧠 AI Insights</h3>
                <ul class="insights-list" id="insights-list">
                    <li class="insight-item">Complete some workouts to get personalized insights!</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBouZ7KMUMSf8RdBKudMW2qEXI_FHgchIU",
            authDomain: "fitness-command-center.firebaseapp.com",
            projectId: "fitness-command-center",
            storageBucket: "fitness-command-center.firebasestorage.app",
            messagingSenderId: "416632779679",
            appId: "1:416632779679:web:768ab3ec04da3aecac03aa",
            measurementId: "G-F06G7Y9V25"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global state
        let currentDay = 'Upper';
        let currentWorkout = {};
        let allWorkouts = [];

        const workoutPlans = {
            Upper: [
                { name: 'Incline Dumbbell Press', sets: 3, reps: 8 },
                { name: 'Seated Cable Fly', sets: 2, reps: 10 },
                { name: 'Weighted Pull-Ups', sets: 3, reps: 6 },
                { name: 'High Cable Lateral Raise', sets: 2, reps: 10 },
                { name: 'Deficit Pendlay Row', sets: 2, reps: 8 },
                { name: 'Cable Tricep Extension', sets: 2, reps: 10 },
                { name: 'Bayesian Cable Bicep Curl', sets: 2, reps: 10 }
            ],
            Lower: [
                { name: 'Lying Leg Curls', sets: 2, reps: '8+partial to failure' },
                { name: 'Barbell Squat', sets: 3, reps: 8 },
                { name: 'Romanian Deadlift', sets: 3, reps: 8 },
                { name: 'Leg Extension', sets: 2, reps: 10 },
                { name: 'Hip Abduction', sets: 2, reps: 10 },
                { name: 'Standing Calf Raise', sets: 3, reps: 10 }
            ],
            Push: [
                { name: 'Barbell Bench Press', sets: 1, reps: '3-5 with warmup ladder (15, 5, 3, 2, 1)' },
                { name: 'Dumbbell Larsen Press', sets: 2, reps: '10 (75% of bench press weight)' },
                { name: 'Standing Arnold Press', sets: 3, reps: '8-10' },
                { name: 'Cable Press-Around (Superset)', sets: 2, reps: '12-15' },
                { name: 'Pec Stretch (Superset)', sets: 2, reps: '30 seconds' },
                { name: 'Cross-Body Cable Y-Raise', sets: 3, reps: '12-15' },
                { name: 'Squeeze-Only Pressdown (Superset)', sets: 3, reps: 8 },
                { name: 'Stretch-Only Overhead Extension (Superset)', sets: 3, reps: 8 },
                { name: 'Cross-Body Triceps Extension', sets: 2, reps: '10-12' }
            ],
            Pull: [
                { name: 'Lat Pulldown', sets: '4 feeder sets + 1-2 sets to failure + 1 dropset', reps: 'Varies' },
                { name: 'Machine Row/T-Bar Row/DB Helms Row', sets: 3, reps: '10-12' },
                { name: 'Bottom Half DB Lat Pullovers (Superset)', sets: 2, reps: '10-12' },
                { name: 'Static Lat Stretching (Superset)', sets: 2, reps: '30 seconds' },
                { name: 'Omni Directional Face Pulls', sets: 3, reps: '12-15' },
                { name: 'EZ Bar Bicep Curl', sets: 3, reps: '6-8' },
                { name: 'Bottom-Half DB Preacher Curl', sets: 2, reps: '10-12' } 
            ],
            Legs: [
                { name: 'Squats - Warmup 20%', sets: 1, reps: 10 },
                { name: 'Squats - Warmup 35%', sets: 1, reps: 5 },
                { name: 'Squats - Warmup 55%', sets: 1, reps: 3 },
                { name: 'Squats - Warmup 70%', sets: 1, reps: 2 },
                { name: 'Squats - Warmup 80%', sets: 1, reps: 1 },
                { name: 'Squats - 85-90%', sets: 1, reps: '2-4' },
                { name: 'Paused Squats (75% of working weight)', sets: 2, reps: 5 },
                { name: 'Romanian Deadlift', sets: 3, reps: '8-10' },
                { name: 'Walking Lunges', sets: 2, reps: '10 per leg' },
                { name: 'Seated Leg Curl', sets: 3, reps: '10-12' },
                { name: 'Leg Press Toe Press', sets: 4, reps: '10-12' },
                { name: 'Decline Plate Crunch', sets: 3, reps: '10-12' },
            ]
        };

        // Firebase functions
        async function saveWorkoutToFirebase(workoutData) {
            try {
                const docRef = await addDoc(collection(db, "workouts"), {
                    ...workoutData,
                    timestamp: new Date()
                });
                console.log("Workout saved with ID:", docRef.id);
                return docRef.id;
            } catch (e) {
                console.error("Error adding workout:", e);
                throw e;
            }
        }

        async function loadWorkoutsFromFirebase() {
            try {
                const q = query(collection(db, "workouts"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                const workouts = [];
                querySnapshot.forEach((doc) => {
                    workouts.push({ id: doc.id, ...doc.data() });
                });
                allWorkouts = workouts;
                console.log("Loaded workouts:", workouts.length);
                return workouts;
            } catch (e) {
                console.error("Error loading workouts:", e);
                return [];
            }
        }

        // Analytics functions
        function calculateTotalVolume() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            return allWorkouts
                .filter(workout => {
                    const workoutDate = new Date(workout.date);
                    return workoutDate.getMonth() === thisMonth && workoutDate.getFullYear() === thisYear;
                })
                .reduce((total, workout) => {
                    return total + Object.values(workout.exercises || {}).reduce((exerciseTotal, exercise) => {
                        return exerciseTotal + exercise.sets.reduce((setTotal, set) => {
                            return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                        }, 0);
                    }, 0);
                }, 0);
        }

        function calculateWorkoutStreak() {
            if (allWorkouts.length === 0) return 0;
            
            const sortedWorkouts = allWorkouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            let streak = 1;
            let currentDate = new Date(sortedWorkouts[0].date);
            
            for (let i = 1; i < sortedWorkouts.length; i++) {
                const workoutDate = new Date(sortedWorkouts[i].date);
                const daysDiff = Math.floor((currentDate - workoutDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff <= 2) { // Allow 1 rest day
                    streak++;
                    currentDate = workoutDate;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function calculateProgressiveOverloadScore() {
            if (allWorkouts.length < 2) return 0;
            
            const recentWorkouts = allWorkouts.slice(0, 6); // Last 6 workouts
            let totalScore = 0;
            let comparisons = 0;
            
            for (let i = 0; i < recentWorkouts.length - 1; i++) {
                const currentWorkout = recentWorkouts[i];
                const previousWorkout = recentWorkouts[i + 1];
                
                if (currentWorkout.day !== previousWorkout.day) continue;
                
                Object.keys(currentWorkout.exercises || {}).forEach(exerciseIndex => {
                    const currentEx = currentWorkout.exercises[exerciseIndex];
                    const prevEx = previousWorkout.exercises?.[exerciseIndex];
                    
                    if (!prevEx) return;
                    
                    const currentVolume = currentEx.sets.reduce((sum, set) =>
                        sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0
                    );
                    const prevVolume = prevEx.sets.reduce((sum, set) =>
                        sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0
                    );
                    
                    if (currentVolume > prevVolume) {
                        totalScore += 10;
                    }
                    
                    const currentMaxWeight = Math.max(...currentEx.sets.map(set => parseFloat(set.weight) || 0));
                    const prevMaxWeight = Math.max(...prevEx.sets.map(set => parseFloat(set.weight) || 0));
                    
                    if (currentMaxWeight > prevMaxWeight) {
                        totalScore += 20;
                    }
                    
                    comparisons++;
                });
            }
            
            return comparisons > 0 ? Math.round(totalScore / comparisons) : 0;
        }

        function calculatePRCount() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const monthlyWorkouts = allWorkouts.filter(workout => {
                const workoutDate = new Date(workout.date);
                return workoutDate.getMonth() === thisMonth && workoutDate.getFullYear() === thisYear;
            });
            
            // Simplified PR calculation - estimate based on workout frequency
            return Math.floor(monthlyWorkouts.length * 0.4);
        }

        function generateAISuggestions() {
            if (allWorkouts.length === 0) {
                return [{
                    type: 'motivation',
                    text: 'Start logging workouts to get personalized AI suggestions!'
                }];
            }
            
            const suggestions = [];
            
            // Get last workout for current day
            const lastWorkout = allWorkouts.find(w => w.day === currentDay);
            
            if (lastWorkout) {
                const daysSince = Math.floor((Date.now() - new Date(lastWorkout.date).getTime()) / (1000 * 60 * 60 * 24));
                
                if (daysSince > 7) {
                    suggestions.push({
                        type: 'recovery',
                        text: `It's been ${daysSince} days since your last ${currentDay} workout. You should feel strong today!`
                    });
                } else if (daysSince === 0) {
                    suggestions.push({
                        type: 'warning',
                        text: `You already trained ${currentDay} today. Consider rest or a different muscle group.`
                    });
                }
                
                // Weight progression suggestions
                Object.values(lastWorkout.exercises || {}).forEach((exercise, idx) => {
                    if (idx < 3) { // Only suggest for first 3 exercises
                        const avgWeight = exercise.sets.reduce((sum, set) => sum + (parseFloat(set.weight) || 0), 0) / exercise.sets.length;
                        const avgReps = exercise.sets.reduce((sum, set) => sum + (parseInt(set.reps) || 0), 0) / exercise.sets.length;
                        
                        if (avgWeight > 0 && avgReps >= 8) {
                            suggestions.push({
                                type: 'progression',
                                text: `${exercise.exercise}: Try ${Math.round(avgWeight + 5)}lbs based on your last session (${Math.round(avgWeight)}lbs × ${Math.round(avgReps)})`
                            });
                        }
                    }
                });
            }
            
            // Consistency suggestions
            const recentWorkouts = allWorkouts.slice(0, 7);
            if (recentWorkouts.length >= 3) {
                const consistency = (recentWorkouts.length / 7) * 100;
                if (consistency >= 60) {
                    suggestions.push({
                        type: 'motivation',
                        text: `Great consistency! ${Math.round(consistency)}% workout rate this week. Keep it up!`
                    });
                }
            }
            
            // Volume trend
            if (allWorkouts.length >= 4) {
                const recentVolume = allWorkouts.slice(0, 2).reduce((sum, w) => sum + calculateWorkoutVolume(w), 0);
                const olderVolume = allWorkouts.slice(2, 4).reduce((sum, w) => sum + calculateWorkoutVolume(w), 0);
                
                if (recentVolume > olderVolume * 1.1) {
                    suggestions.push({
                        type: 'analytics',
                        text: `Volume trending up ${Math.round(((recentVolume - olderVolume) / olderVolume) * 100)}%! Excellent progressive overload.`
                    });
                }
            }
            
            return suggestions.slice(0, 4); // Max 4 suggestions
        }

        function calculateWorkoutVolume(workout) {
            return Object.values(workout.exercises || {}).reduce((total, exercise) => {
                return total + exercise.sets.reduce((setTotal, set) => {
                    return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                }, 0);
            }, 0);
        }

        function generateAIInsights() {
            if (allWorkouts.length < 3) {
                return [
                    "Complete more workouts to unlock AI insights!",
                    "Aim for consistency - 3-4 workouts per week is ideal.",
                    "Focus on progressive overload - gradually increase weight or reps."
                ];
            }
            
            const insights = [];
            
            // Workout frequency analysis
            const workoutDays = allWorkouts.slice(0, 10).map(w => new Date(w.date).getDay());
            const dayFrequency = {};
            workoutDays.forEach(day => {
                dayFrequency[day] = (dayFrequency[day] || 0) + 1;
            });
            
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const preferredDay = Object.keys(dayFrequency).reduce((a, b) => dayFrequency[a] > dayFrequency[b] ? a : b);
            insights.push(`You work out most often on ${dayNames[preferredDay]}s - this seems to be your power day!`);
            
            // Volume analysis
            const totalVolume = allWorkouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0);
            const avgVolumePerWorkout = Math.round(totalVolume / allWorkouts.length);
            insights.push(`Your average workout volume is ${avgVolumePerWorkout.toLocaleString()}lbs - that's solid training stimulus.`);
            
            // Muscle group balance
            const muscleGroupVolumes = { Push: 0, Pull: 0, Legs: 0, Upper: 0, Lower: 0 };
            allWorkouts.forEach(workout => {
                const volume = calculateWorkoutVolume(workout);
                muscleGroupVolumes[workout.day] = (muscleGroupVolumes[workout.day] || 0) + volume;
            });
            
            const maxVolume = Math.max(...Object.values(muscleGroupVolumes));
            const strongestGroup = Object.keys(muscleGroupVolumes).find(key => muscleGroupVolumes[key] === maxVolume);
            insights.push(`Your strongest muscle group appears to be ${strongestGroup} based on training volume.`);
            
            // Progressive overload
            const overloadScore = calculateProgressiveOverloadScore();
            if (overloadScore > 15) {
                insights.push(`Excellent progressive overload! Your training progression score is ${overloadScore}/30.`);
            } else if (overloadScore > 0) {
                insights.push(`Good progress with a score of ${overloadScore}/30. Consider increasing weight or reps gradually.`);
            }
            
            return insights;
        }

        function getLastWorkoutForDay(day) {
            return allWorkouts.find(workout => workout.day === day);
        }

        function getPersonalRecords() {
            const prs = {};
            
            allWorkouts.forEach(workout => {
                Object.values(workout.exercises || {}).forEach(exercise => {
                    exercise.sets.forEach(set => {
                        const weight = parseFloat(set.weight);
                        const reps = parseInt(set.reps);
                        
                        if (weight && reps) {
                            const exerciseName = exercise.exercise;
                            if (!prs[exerciseName] || weight > prs[exerciseName].weight) {
                                prs[exerciseName] = { weight, reps, date: workout.date };
                            }
                        }
                    });
                });
            });
            
            return prs;
        }

        // UI Functions
        function updateSuggestions() {
            const suggestions = generateAISuggestions();
            const container = document.getElementById('suggestions-container');
            
            container.innerHTML = suggestions.map(suggestion => `
                <div class="suggestion-card">
                    <div class="suggestion-type">${suggestion.type}</div>
                    <div class="suggestion-text">${suggestion.text}</div>
                </div>
            `).join('');
        }

        function updateAnalytics() {
            document.getElementById('total-volume').textContent = calculateTotalVolume().toLocaleString();
            document.getElementById('pr-count').textContent = calculatePRCount();
            document.getElementById('workout-streak').textContent = calculateWorkoutStreak();
            document.getElementById('overload-score').textContent = calculateProgressiveOverloadScore();
        }

        function updateInsights() {
            const insights = generateAIInsights();
            const container = document.getElementById('insights-list');
            
            container.innerHTML = insights.map(insight => `
                <li class="insight-item">${insight}</li>
            `).join('');
        }

        function updateProgress() {
            const prs = getPersonalRecords();
            const container = document.getElementById('progress-list');
            
            if (Object.keys(prs).length === 0) {
                container.innerHTML = '<p style="color: #64748b;">Complete some workouts to see your personal records!</p>';
                return;
            }
            
            const sortedPRs = Object.entries(prs).sort(([,a], [,b]) => b.weight - a.weight);
            
            container.innerHTML = `
                <h4 style="color: #06b6d4; margin-bottom: 1rem;">🏆 Personal Records</h4>
                ${sortedPRs.slice(0, 10).map(([exercise, pr]) => `
                    <div class="insight-item">
                        <strong>${exercise}</strong><br>
                        ${pr.weight}lbs × ${pr.reps} reps - ${new Date(pr.date).toLocaleDateString()}
                    </div>
                `).join('')}
            `;
        }

        // Main app initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Loading Firebase data...');
            await loadWorkoutsFromFirebase();
            
            setupEventListeners();
            initializeWorkout();
            updateSuggestions();
            updateAnalytics();
            updateInsights();
            updateProgress();
            
            console.log('Fitness Command Center initialized with Firebase!');
        });

        function setupEventListeners() {
            // Tab switching
            document.getElementById('workout-tab-btn').addEventListener('click', () => {
                showTab('workout');
                updateSuggestions();
            });
            document.getElementById('analytics-tab-btn').addEventListener('click', () => {
                showTab('analytics');
                updateAnalytics();
            });
            document.getElementById('progress-tab-btn').addEventListener('click', () => {
                showTab('progress');
                updateProgress();
            });
            document.getElementById('intelligence-tab-btn').addEventListener('click', () => {
                showTab('intelligence');
                updateInsights();
            });

            // Day selection
            document.getElementById('upper-btn').addEventListener('click', () => selectDay('Upper'));
            document.getElementById('lower-btn').addEventListener('click', () => selectDay('Lower'));
            document.getElementById('push-btn').addEventListener('click', () => selectDay('Push'));
            document.getElementById('pull-btn').addEventListener('click', () => selectDay('Pull'));
            document.getElementById('legs-btn').addEventListener('click', () => selectDay('Legs'));

            // Complete workout
            document.getElementById('complete-workout-btn').addEventListener('click', completeWorkout);
           // Initialize date input to today
const today = new Date().toISOString().split('T')[0];
document.getElementById('workout-date-input').value = today;

// Date input handling
document.getElementById('workout-date-input').addEventListener('change', setWorkoutDate);
document.getElementById('log-past-workout-btn').addEventListener('click', () => {
    const dateInput = document.getElementById('workout-date-input');
    if (dateInput.style.display === 'none' || !dateInput.style.display) {
        dateInput.style.display = 'block';
        dateInput.focus();
    }
});

setWorkoutDate(); // Initialize the button text

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-content').classList.add('active');
            document.getElementById(tabName + '-tab-btn').classList.add('active');
        }

        function selectDay(day) {
            currentDay = day;
            
            // Update day buttons
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(day.toLowerCase() + '-btn').classList.add('active');

            initializeWorkout();
            updateSuggestions();
        }

        function initializeWorkout() {
            currentWorkout = {};
            const exercises = workoutPlans[currentDay];

            exercises.forEach((exercise, index) => {
                const isStretch = exercise.name.toLowerCase().includes('stretch');
currentWorkout[index] = {
    exercise: exercise.name,
    sets: isStretch ? 
        [{ completed: false }] : 
        Array(typeof exercise.sets === 'number' ? exercise.sets : 1).fill().map(() => ({
            weight: '',
            reps: '',
            notes: ''
        }))
};

            renderWorkout();
        }

        function renderWorkout() {
            const container = document.getElementById('exercises-container');
            const exercises = workoutPlans[currentDay];
            const lastWorkout = getLastWorkoutForDay(currentDay);
            
            let html = '';
            
            exercises.forEach((exercise, exerciseIndex) => {
                const workoutExercise = currentWorkout[exerciseIndex];
                const previousExercise = lastWorkout?.exercises?.[exerciseIndex];
                
                // Calculate suggested weight
                let suggestedWeight = '';
                if (previousExercise && previousExercise.sets.length > 0) {
                    const avgWeight = previousExercise.sets.reduce((sum, set) => sum + (parseFloat(set.weight) || 0), 0) / previousExercise.sets.length;
                    const avgReps = previousExercise.sets.reduce((sum, set) => sum + (parseInt(set.reps) || 0), 0) / previousExercise.sets.length;
                    
                    if (avgWeight > 0 && avgReps >= 8) {
                        suggestedWeight = Math.round(avgWeight + 5);
                    } else if (avgWeight > 0) {
                        suggestedWeight = Math.round(avgWeight);
                    }
                }

                // Get PR for this exercise
                const prs = getPersonalRecords();
                const exercisePR = prs[exercise.name];
                
                html += `
                    <div class="exercise-card">
                        <div class="exercise-header">
                            <div>
                                <div class="exercise-name">${exercise.name}</div>
                                <div class="exercise-target">${exercise.sets} × ${exercise.reps}</div>
                            </div>
                            <div class="exercise-intelligence">
                                ${suggestedWeight ? `<div class="suggested-weight">Try ${suggestedWeight}lbs</div>` : ''}
                                ${exercisePR ? `<div class="pr-indicator">PR: ${exercisePR.weight}lbs × ${exercisePR.reps}</div>` : ''}
                            </div>
                        </div>

                        ${previousExercise ? `
                            <div class="previous-session">
                                <div class="previous-header">Last session (${lastWorkout.date}):</div>
                                <div class="previous-sets">
                                    ${previousExercise.sets.filter(set => set.weight || set.reps).map((set, idx) => `
                                        <div class="previous-set">Set ${idx + 1}: ${set.weight}×${set.reps}</div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        // Check if this is a stretch exercise
const isStretch = exercise.name.toLowerCase().includes('stretch');

if (isStretch) {
    html += `
        <div class="stretch-row">
            <div class="stretch-info">
                <div class="set-number">✓</div>
                <div class="stretch-label">${exercise.name}</div>
            </div>
            <input type="checkbox" class="stretch-checkbox" 
                   ${workoutExercise.sets[0]?.completed ? 'checked' : ''}
                   onchange="updateStretch(${exerciseIndex}, this.checked)">
        </div>
    `;
} else {
    html += `<div class="set-input-grid">`;
    
    workoutExercise.sets.forEach((set, setIndex) => {
        html += `
            <div class="set-row">
                <div class="set-number">${setIndex + 1}</div>
                <input type="number" class="weight-input" placeholder="lbs" 
                       value="${set.weight}" 
                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'weight', this.value)">
                <span style="color: #64748b;">×</span>
                <input type="number" class="reps-input" placeholder="reps" 
                       value="${set.reps}" 
                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'reps', this.value)">
                <input type="text" class="notes-input" placeholder="notes" 
                       value="${set.notes}" 
                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'notes', this.value)">
                ${previousExercise?.sets[setIndex]?.weight ? `
                    <button class="btn btn-copy" onclick="copyPrevious(${exerciseIndex}, ${setIndex})">Copy</button>
                ` : ''}
            </div>`;
    });
    
    html += `
            </div>
            <button class="btn btn-add" onclick="addSet(${exerciseIndex})" style="margin-top: 0.75rem;">+ Add Set</button>
        `;
});
                
                html += `
                        </div>
                        <button class="btn btn-add" onclick="addSet(${exerciseIndex})" style="margin-top: 0.75rem;">+ Add Set</button>
                    </div>`;
            });
            
            container.innerHTML = html;
        }

        // Make functions globally available
        window.updateSet = function(exerciseIndex, setIndex, field, value) {
            currentWorkout[exerciseIndex].sets[setIndex][field] = value;
        };

        window.addSet = function(exerciseIndex) {
            currentWorkout[exerciseIndex].sets.push({ weight: '', reps: '', notes: '' });
            renderWorkout();
        };

        window.copyPrevious = function(exerciseIndex, setIndex) {
            const lastWorkout = getLastWorkoutForDay(currentDay);
            const previousSet = lastWorkout?.exercises?.[exerciseIndex]?.sets[setIndex];
            
            if (previousSet) {
                currentWorkout[exerciseIndex].sets[setIndex].weight = previousSet.weight;
                currentWorkout[exerciseIndex].sets[setIndex].reps = previousSet.reps;
                renderWorkout();
            }
        }
            window.updateStretch = function(exerciseIndex, completed) {
    currentWorkout[exerciseIndex].sets[0] = { completed: completed };
};

window.setWorkoutDate = function() {
    const dateInput = document.getElementById('workout-date-input');
    const logBtn = document.getElementById('log-past-workout-btn');
    const today = new Date().toISOString().split('T')[0];
    
    if (dateInput.value && dateInput.value !== today) {
        logBtn.textContent = '📅 For ' + new Date(dateInput.value + 'T00:00:00').toLocaleDateString();
        logBtn.style.background = 'rgba(16, 185, 129, 0.2)';
        logBtn.style.color = '#10b981';
    } else {
        logBtn.textContent = '📅 Log Past Workout';
        logBtn.style.background = 'rgba(168, 85, 247, 0.2)';
        logBtn.style.color = '#a855f7';
    }
};

        async function completeWorkout() {
            // Date input handling document.getElementById('workout-date-input').addEventListener('change', setWorkoutDate); document.getElementById('log-past-workout-btn').addEventListener('click', () => {     const dateInput = document.getElementById('workout-date-input');     dateInput.value = new Date().toISOString().split('T')[0]; // Set to today by default     setWorkoutDate(); });
const today = new Date().toISOString().split('T')[0];
const selectedDate = dateInput.value && dateInput.value !== today ? dateInput.value : today;
            
            const workoutData = {
    date: selectedDate,
    day: currentDay,
    exercises: currentWorkout
};
            
            try {
                // Save to Firebase
                await saveWorkoutToFirebase(workoutData);
                
                // Also save locally as backup
                const localHistory = JSON.parse(localStorage.getItem('fitnessData') || '{}');
                const workoutKey = currentDay + '-' + today + '-' + Date.now();
                localHistory[workoutKey] = workoutData;
                localStorage.setItem('fitnessData', JSON.stringify(localHistory));
                
                // Reload data from Firebase
                await loadWorkoutsFromFirebase();
                
                // Export to clipboard
                exportToClipboard();
                
                alert('💪 Workout saved to Firebase and copied to clipboard!');
                
                // Reset and refresh
                initializeWorkout();
                updateSuggestions();
                updateAnalytics();
                
            } catch (error) {
                console.error('Error saving workout:', error);
                alert('Error saving workout. Check your internet connection.');
            }
        }

        function exportToClipboard() {
            const today = new Date().toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short', 
                day: 'numeric'
            });
            
            let exportText = '🏋️‍♂️ ' + currentDay + ' | ' + today + '\n';
            exportText += '=========================\n\n';
            
            Object.values(currentWorkout).forEach(exercise => {
                exportText += exercise.exercise + '\n';
                
                exercise.sets.forEach((set, index) => {
                    if (set.weight || set.reps) {
                        exportText += '  ' + set.weight + 'lbs × ' + set.reps;
                        if (set.notes) exportText += ' (' + set.notes + ')';
                        exportText += '\n';
                    }
                });
                exportText += '\n';
            });
            
            // Copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(exportText);
            } else {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = exportText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }
    </script>
</body>
</html>
