<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unison</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            /* Color Palette - Warm Neutral Theme */
            --color-bg: #FAF9F7;
            --color-surface: #FFFFFF;
            --color-text-primary: #1A1A1A;
            --color-text-secondary: #6B6B6B;
            --color-accent-primary: #4A5D4A;
            --color-accent-secondary: #A8B5A0;
            --color-border: #E8E6E3;
            --color-success: #5D8A66;
            --color-warning: #D4A84B;
            --color-error: #C4736D;
            
            /* Semantic Colors */
            --color-on-track: #5D8A66;
            --color-off-track: #C4736D;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 100px;
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.08);
            --focus-shadow: 0 0 0 2px rgba(74, 93, 74, 0.2);
            
            /* Transitions */
            --transition-base: all 0.15s ease-out;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'DM Sans', 'Segoe UI', sans-serif;
            background: var(--color-bg);
            color: var(--color-text-primary);
            min-height: 100vh;
            padding: 1.5rem;
            line-height: 1.5;
            font-weight: 400;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .header p {
            color: var(--color-text-secondary);
            font-size: 0.9375rem;
            font-weight: 300;
            font-style: italic;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding: 0.5rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-md);
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .nav-tabs::-webkit-scrollbar-track {
            background: var(--color-border);
            border-radius: 2px;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background: var(--color-accent-secondary);
            border-radius: 2px;
        }

        .nav-tab {
            padding: 0.625rem 1.125rem;
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: var(--transition-base);
            white-space: nowrap;
            font-weight: 400;
            font-size: 0.9375rem;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-tab.active {
            background: var(--color-text-primary);
            color: var(--color-surface);
            border-color: transparent;
            box-shadow: var(--shadow-sm);
        }

        .nav-tab:hover:not(.active) {
            background: var(--color-bg);
            color: var(--color-text-primary);
            border-color: var(--color-border);
            transform: scale(1.02);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .workout-day-selector {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .day-btn {
            padding: 0.875rem 1.5rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: var(--transition-base);
            white-space: nowrap;
            font-weight: 400;
            min-height: 44px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .day-btn.active {
            background: var(--color-accent-primary);
            color: var(--color-surface);
            border-color: transparent;
            box-shadow: var(--shadow-md);
        }

        .day-btn:hover:not(.active) {
            background: var(--color-bg);
            border-color: var(--color-accent-secondary);
            transform: scale(1.02);
        }

        .intelligence-panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-md);
        }

        .intelligence-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .intelligence-header h3 {
            color: var(--color-text-primary);
            font-weight: 500;
            font-size: 1.125rem;
        }

        .ai-icon {
            width: 28px;
            height: 28px;
            background: var(--color-accent-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-surface);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .suggestion-card {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 1rem;
            transition: var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .suggestion-card:hover {
            background: var(--color-surface);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .suggestion-type {
            color: var(--color-accent-primary);
            font-size: 0.8125rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .suggestion-text {
            color: var(--color-text-primary);
            font-size: 0.9375rem;
            line-height: 1.5;
        }

        .exercise-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition-base);
        }

        .exercise-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.25rem;
            gap: 1rem;
        }

        .exercise-name {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
        }

        .exercise-target {
            display: inline-block;
            background: rgba(168, 181, 160, 0.15);
            color: var(--color-accent-primary);
            padding: 0.375rem 0.875rem;
            border-radius: var(--radius-full);
            font-size: 0.8125rem;
            font-weight: 400;
            border: 1px solid var(--color-accent-secondary);
        }

        .exercise-intelligence {
            text-align: right;
            flex-shrink: 0;
        }

        .suggested-weight {
            background: var(--color-accent-primary);
            color: var(--color-surface);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            font-weight: 500;
            font-size: 0.9375rem;
            margin-bottom: 0.5rem;
            display: inline-block;
            box-shadow: var(--shadow-sm);
        }

        .pr-indicator {
            color: var(--color-success);
            font-size: 0.8125rem;
            font-weight: 400;
        }

        .progression-indicator {
            color: var(--color-success);
            font-size: 0.8125rem;
            font-weight: 400;
            margin-bottom: 0.25rem;
        }

        .previous-session {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 0.75rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .previous-header {
            color: var(--color-accent-primary);
            font-size: 0.8125rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .previous-sets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
        }

        .previous-set {
            color: var(--color-accent-primary);
            font-size: 0.8125rem;
            text-align: center;
            padding: 0.25rem;
            background: rgba(168, 181, 160, 0.15);
            border-radius: var(--radius-sm);
        }

        .previous-sets-compact {
            color: var(--color-accent-primary);
            font-size: 0.875rem;
            line-height: 1.5;
            background: rgba(168, 181, 160, 0.08);
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-accent-secondary);
            max-height: 4rem;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .previous-sets-compact::-webkit-scrollbar {
            width: 6px;
        }
        
        .previous-sets-compact::-webkit-scrollbar-track {
            background: rgba(168, 181, 160, 0.05);
            border-radius: 3px;
        }
        
        .previous-sets-compact::-webkit-scrollbar-thumb {
            background: var(--color-accent-secondary);
            border-radius: 3px;
        }
        
        .previous-sets-compact::-webkit-scrollbar-thumb:hover {
            background: var(--color-accent-primary);
        }

        .intensity-inputs {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .intensity-row {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            margin-bottom: 1rem;
        }

        .intensity-row:last-child {
            margin-bottom: 0;
        }

        .intensity-label {
            color: var(--color-text-primary);
            font-weight: 400;
            min-width: 100px;
            font-size: 0.9375rem;
        }

        .intensity-scale {
            display: flex;
            gap: 0.625rem;
        }

        .intensity-btn {
            width: 2.5rem;
            height: 2.5rem;
            border: 1px solid var(--color-border);
            background: var(--color-bg);
            color: var(--color-text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition-base);
        }

        .intensity-btn:hover:not(.active) {
            background: var(--color-surface);
            border-color: var(--color-accent-secondary);
            transform: scale(1.02);
        }

        .intensity-btn.active {
            background: var(--color-accent-primary);
            color: var(--color-surface);
            border-color: transparent;
            box-shadow: var(--shadow-sm);
        }

        .set-input-grid {
            display: grid;
            gap: 0.75rem;
        }

        .set-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--color-bg);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
        }

        .set-number {
            width: 2rem;
            color: var(--color-text-secondary);
            font-weight: 500;
            text-align: center;
        }

        .weight-input, .reps-input {
            width: 4rem;
            padding: 0.5rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            text-align: center;
            font-weight: 400;
        }

        .weight-input:focus, .reps-input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            box-shadow: var(--focus-shadow);
        }

        .notes-input {
            flex: 1;
            padding: 0.5rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: 0.9375rem;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            box-shadow: var(--focus-shadow);
        }

        .notes-input::placeholder {
            color: var(--color-text-secondary);
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-weight: 400;
            transition: var(--transition-base);
            font-size: 0.9375rem;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: scale(1.02);
        }

        .btn-copy {
            background: var(--color-accent-primary);
            color: var(--color-surface);
            box-shadow: var(--shadow-sm);
        }

        .btn-copy:hover {
            box-shadow: var(--shadow-md);
        }

        .btn-add {
            background: var(--color-surface);
            color: var(--color-accent-primary);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
        }

        .btn-add:hover {
            background: var(--color-bg);
            border-color: var(--color-accent-secondary);
        }

        .btn-complete {
            padding: 1rem 3rem;
            background: var(--color-accent-primary);
            color: var(--color-surface);
            border: none;
            border-radius: var(--radius-full);
            font-size: 1.125rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-base);
            box-shadow: var(--shadow-md);
            display: block;
            margin: 2rem auto 0;
            min-height: 56px;
        }

        .btn-complete:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition-base);
        }

        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .analytics-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 500;
            color: var(--color-text-primary);
            line-height: 1.2;
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: 0.8125rem;
            margin-top: 0.5rem;
            font-weight: 300;
        }



        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .insights-list {
            list-style: none;
        }

        .insight-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--color-bg);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-success);
            color: var(--color-text-primary);
            font-size: 0.9375rem;
            box-shadow: var(--shadow-sm);
        }

        .plateau-alert {
            border-left-color: var(--color-warning);
            background: rgba(212, 168, 75, 0.1);
        }

        .progression-highlight {
            border-left-color: var(--color-success);
            background: rgba(93, 138, 102, 0.1);
        }

        .stretch-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            appearance: none;
            position: relative;
            transition: var(--transition-base);
        }

        .stretch-checkbox:checked {
            background: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
        }

        .stretch-checkbox:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--color-surface);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .stretch-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--color-bg);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
        }

        .stretch-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .stretch-label {
            color: var(--color-text-primary);
            font-size: 0.9375rem;
        }

        .exercise-progress-indicator {
            font-size: 0.8125rem;
            color: var(--color-success);
            margin-bottom: 0.25rem;
        }

        /* Calendar Styles */
        .calendar-container {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-md);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .calendar-nav-btn {
            padding: 0.75rem 1.25rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-accent-primary);
            cursor: pointer;
            transition: var(--transition-base);
            font-weight: 400;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .calendar-nav-btn:hover {
            background: var(--color-bg);
            transform: scale(1.02);
        }

        .calendar-month-year {
            font-size: 1.25rem;
            font-weight: 400;
            color: var(--color-text-primary);
            flex: 1;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.625rem;
        }

        .calendar-day-header {
            text-align: center;
            padding: 0.75rem 0.5rem;
            color: var(--color-text-secondary);
            font-weight: 500;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 0.625rem;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 70px;
            box-shadow: var(--shadow-sm);
        }

        .calendar-day:hover {
            background: var(--color-surface);
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .calendar-day.other-month {
            opacity: 0.25;
            pointer-events: none;
        }

        .calendar-day.today {
            border-color: var(--color-success);
            box-shadow: 0 0 0 2px rgba(93, 138, 102, 0.3), 0 4px 12px rgba(93, 138, 102, 0.2);
        }

        .calendar-day.has-workout {
            background: rgba(93, 138, 102, 0.15);
            border-color: rgba(93, 138, 102, 0.4);
        }

        .calendar-day.scheduled {
            background: rgba(93, 138, 102, 0.08);
            border-color: rgba(93, 138, 102, 0.25);
        }

        .calendar-day.missed {
            background: rgba(244, 67, 54, 0.1);
            border-color: rgba(244, 67, 54, 0.35);
        }

        .calendar-day-number {
            font-size: 1rem;
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 0.375rem;
        }

        .calendar-day-label {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            text-align: center;
            font-weight: 400;
        }

        .calendar-day-label.Upper { color: var(--color-success); }
        .calendar-day-label.Lower { color: #8B7355; }
        .calendar-day-label.Push { color: #A67C52; }
        .calendar-day-label.Pull { color: #5D7F7F; }
        .calendar-day-label.Legs { color: #7D6B5D; }
        .calendar-day-label.Rest { color: var(--color-text-secondary); }
        .calendar-day-label.Travel { color: var(--color-accent-primary); }
        .calendar-day-label.Sick { color: var(--color-error); }

        .adherence-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .adherence-score {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .adherence-score-value {
            font-size: 2.5rem;
            font-weight: 500;
            color: var(--color-success);
        }

        .adherence-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .adherence-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .adherence-stat:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .adherence-stat-value {
            font-size: 1.5rem;
            font-weight: 500;
            color: #1a1a1a;
            line-height: 1.2;
        }

        .adherence-stat-label {
            font-size: 0.8125rem;
            color: var(--color-text-secondary);
            margin-top: 0.5rem;
            font-weight: 300;
        }

        .selected-day-workout {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        /* Nutrition Styles */
        .meal-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transition: all 0.15s ease-out;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
            cursor: pointer;
            user-select: none;
        }

        .meal-type {
            font-size: 1.125rem;
            font-weight: 500;
            color: #1a1a1a;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .meal-time {
            color: var(--color-text-secondary);
            font-size: 0.8125rem;
            margin-top: 0.25rem;
        }

        /* Collapsible Meal Styles */
        .meal-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            margin-top: 0.75rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .meal-summary-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .meal-summary-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .meal-summary-value {
            font-size: 1rem;
            font-weight: 500;
            color: #1a1a1a;
        }

        .meal-summary-label {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin-top: 0.125rem;
        }

        .meal-collapse-icon {
            font-size: 1.25rem;
            transition: transform 0.15s ease-out;
            color: var(--color-text-secondary);
        }

        .meal-card.collapsed .meal-collapse-icon {
            transform: rotate(-90deg);
        }

        .meal-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .meal-card.collapsed .meal-content {
            max-height: 0;
            opacity: 0;
        }

        .meal-card:not(.collapsed) .meal-content {
            max-height: 5000px;
            opacity: 1;
        }

        .quick-add-food-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: var(--color-success);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 100px;
            font-weight: 400;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.15s ease-out;
            min-height: 44px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .quick-add-food-btn:hover {
            background: rgba(255, 255, 255, 0.85);
            transform: scale(1.02);
        }


        .food-input-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .food-input {
            flex: 2;
            min-width: 200px;
            padding: 0.875rem;
            min-height: 48px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            color: #1a1a1a;
            font-size: 0.9375rem;
            transition: all 0.15s ease-out;
        }

        .food-input:focus {
            outline: none;
            border-color: var(--color-success);
            box-shadow: 0 0 0 3px rgba(93, 138, 102, 0.15);
            background: rgba(255, 255, 255, 0.9);
        }

        .macro-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .macro-input-label {
            color: var(--color-text-secondary);
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .macro-input {
            width: 80px;
            padding: 0.875rem 0.5rem;
            min-height: 48px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            color: #1a1a1a;
            text-align: center;
            font-size: 0.9375rem;
            transition: all 0.15s ease-out;
        }

        .macro-input:focus {
            outline: none;
            border-color: var(--color-success);
            box-shadow: 0 0 0 3px rgba(93, 138, 102, 0.15);
            background: rgba(255, 255, 255, 0.9);
        }

        .macro-inputs-grid {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .food-action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .macro-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .macro-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .macro-item:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .macro-value {
            font-size: 1.5rem;
            font-weight: 500;
            color: #1a1a1a;
            line-height: 1.2;
        }

        .macro-label {
            font-size: 0.8125rem;
            color: var(--color-text-secondary);
            margin-top: 0.5rem;
            font-weight: 300;
        }

        /* Body Metrics Styles */
        .weight-input-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .weight-input-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .weight-input-field {
            flex: 1;
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            color: #1a1a1a;
            font-size: 0.9375rem;
            text-align: center;
            transition: all 0.15s ease-out;
        }

        .weight-input-field:focus {
            outline: none;
            border-color: var(--color-success);
            box-shadow: 0 0 0 2px rgba(93, 138, 102, 0.2);
            background: rgba(255, 255, 255, 0.9);
        }

        .photo-upload-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .photo-upload-area {
            border: 2px dashed rgba(93, 138, 102, 0.4);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease-out;
        }

        .photo-upload-area:hover {
            border-color: var(--color-success);
            background: rgba(93, 138, 102, 0.08);
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-date {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.25rem;
            font-size: 0.7rem;
            color: white;
            text-align: center;
        }

        .btn-delete-photo {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.5rem;
            min-width: 36px;
            min-height: 36px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            border-radius: 100px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.15s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .btn-delete-photo:hover {
            background: rgba(244, 67, 54, 1);
            transform: scale(1.05);
            transform: scale(1.1);
        }

        /* Body Goal Styles */
        .body-goal-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .goal-input-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .goal-input-group {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .goal-input-label {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .goal-select, .goal-input {
            padding: 0.75rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: 1rem;
        }

        .goal-select:focus, .goal-input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            box-shadow: var(--focus-shadow);
        }

        .goal-display {
            background: rgba(168, 181, 160, 0.1);
            border: 1px solid var(--color-accent-secondary);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-top: 1rem;
        }

        .goal-display-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .goal-display-row:last-child {
            margin-bottom: 0;
        }

        .goal-display-label {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .goal-display-value {
            color: var(--color-accent-primary);
            font-size: 1rem;
            font-weight: 500;
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            margin-top: 1rem;
            font-weight: 500;
        }

        .progress-indicator.on-track {
            background: rgba(93, 138, 102, 0.1);
            border: 1px solid var(--color-on-track);
            color: var(--color-on-track);
        }

        .progress-indicator.off-track {
            background: rgba(196, 115, 109, 0.1);
            border: 1px solid var(--color-off-track);
            color: var(--color-off-track);
        }

        .calorie-target-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .calorie-breakdown {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .calorie-item {
            flex: 1;
            min-width: 150px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            text-align: center;
        }

        .calorie-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-accent-primary);
            margin-bottom: 0.25rem;
        }

        .calorie-label {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
        }

        /* Nutrition Layout - Sidebar for Desktop */
        .nutrition-layout-container {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .nutrition-main-content {
            flex: 1;
            min-width: 0;
        }

        .nutrition-sidebar {
            width: 350px;
            flex-shrink: 0;
            position: sticky;
            top: 1.5rem;
            max-height: calc(100vh - 3rem);
            overflow-y: auto;
        }

        /* Mobile Saved Foods Button */
        .mobile-saved-foods-btn {
            display: none;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--color-accent-primary);
            color: var(--color-surface);
            border: none;
            border-radius: var(--radius-full);
            font-size: 1rem;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            z-index: 100;
            transition: var(--transition-base);
        }

        .mobile-saved-foods-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Saved Foods Modal/Sheet for Mobile */
        .saved-foods-modal {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-surface);
            border-top-left-radius: var(--radius-xl);
            border-top-right-radius: var(--radius-xl);
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.1);
        }

        .saved-foods-modal.active {
            transform: translateY(0);
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }

        .modal-backdrop.active {
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close-btn {
            padding: 0.5rem;
            background: rgba(196, 115, 109, 0.15);
            color: var(--color-error);
            border: none;
            border-radius: var(--radius-full);
            font-size: 1.5rem;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
        }

        /* Saved Foods Styles */
        .saved-foods-panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 0;
            box-shadow: var(--shadow-md);
        }

        .saved-food-search {
            width: 100%;
            padding: 0.75rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            margin-bottom: 1rem;
            font-size: 0.9375rem;
        }

        .saved-food-search:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            box-shadow: var(--focus-shadow);
        }

        .saved-food-list {
            display: grid;
            gap: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .saved-food-item {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .saved-food-item:hover {
            background: var(--color-surface);
            border-color: var(--color-accent-secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .saved-food-info {
            flex: 1;
        }

        .saved-food-name {
            color: var(--color-text-primary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .saved-food-macros {
            color: var(--color-text-secondary);
            font-size: 0.75rem;
            display: grid;
            grid-template-columns: repeat(4, auto);
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .saved-food-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-quick-add {
            padding: 0.5rem 1rem;
            background: var(--color-success);
            color: var(--color-surface);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition-base);
            white-space: nowrap;
            min-width: 90px;
        }

        .btn-quick-add:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-delete-food {
            padding: 0.75rem;
            min-width: 44px;
            min-height: 44px;
            background: rgba(196, 115, 109, 0.15);
            color: var(--color-error);
            border: 1px solid rgba(196, 115, 109, 0.3);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-delete-food:hover {
            background: rgba(196, 115, 109, 0.25);
        }

        .btn-save-food {
            padding: 0.75rem 1rem;
            min-height: 44px;
            background: rgba(74, 93, 74, 0.15);
            color: var(--color-accent-primary);
            border: 1px solid var(--color-accent-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-save-food:hover {
            background: rgba(74, 93, 74, 0.25);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-secondary);
        }

        /* Meal Type Selection Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .meal-type-buttons {
            display: grid;
            gap: 1rem;
        }

        .meal-type-btn {
            padding: 1rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 400;
            transition: var(--transition-base);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .meal-type-btn:hover {
            background: var(--color-accent-primary);
            color: var(--color-surface);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .modal-close {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(196, 115, 109, 0.15);
            border: 1px solid rgba(196, 115, 109, 0.3);
            border-radius: var(--radius-full);
            color: var(--color-error);
            cursor: pointer;
            width: 100%;
            font-size: 0.9375rem;
            transition: var(--transition-base);
        }

        .modal-close:hover {
            background: rgba(196, 115, 109, 0.25);
            transform: scale(1.02);
        }

        /* Exercise Substitution Styles */
        .substitution-tag {
            display: inline-block;
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .approach-selector {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .approach-btn {
            padding: 0.25rem 0.75rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition-base);
        }

        .approach-btn.active {
            background: rgba(168, 181, 160, 0.15);
            color: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
        }

        .approach-btn:hover {
            background: var(--color-surface);
        }

        /* Alternative Exercise History Styles */
        .alt-exercise-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .alt-exercise-modal.active {
            display: flex;
        }

        .alt-exercise-modal-content {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .alt-exercise-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .alt-exercise-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .alt-exercise-close-btn {
            background: rgba(196, 115, 109, 0.15);
            border: 1px solid rgba(196, 115, 109, 0.3);
            color: var(--color-error);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition-base);
        }

        .alt-exercise-close-btn:hover {
            background: rgba(196, 115, 109, 0.25);
        }

        .alt-exercise-input-section {
            margin-bottom: 1.5rem;
        }

        .alt-exercise-input-label {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }

        .alt-exercise-name-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: 1rem;
        }

        .alt-exercise-name-input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            box-shadow: var(--focus-shadow);
        }

        .alt-exercise-history-section {
            margin-top: 1.5rem;
        }

        .alt-exercise-history-title {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .alt-exercise-history-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .alt-exercise-history-item {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 0.75rem;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alt-exercise-history-item:hover {
            background: var(--color-surface);
            border-color: var(--color-accent-secondary);
            transform: translateX(4px);
        }

        .alt-exercise-history-item-name {
            font-weight: 500;
            color: var(--color-text-primary);
            font-size: 1rem;
        }

        .alt-exercise-history-item-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .alt-exercise-history-item-date {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        .alt-exercise-history-item-count {
            font-size: 0.7rem;
            color: var(--color-accent-primary);
            background: rgba(168, 181, 160, 0.15);
            padding: 0.125rem 0.5rem;
            border-radius: var(--radius-sm);
        }

        .alt-exercise-empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-secondary);
            font-style: italic;
        }

        .alt-exercise-confirm-btn {
            width: 100%;
            padding: 0.875rem;
            background: var(--color-accent-primary);
            color: var(--color-surface);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition-base);
            margin-top: 1rem;
        }

        .alt-exercise-confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .alt-exercise-confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .substitution-tag {
            display: inline-block;
            background: rgba(168, 181, 160, 0.15);
            color: var(--color-accent-primary);
            padding: 0.25rem 0.625rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--color-accent-secondary);
            margin-left: 0.5rem;
        }

        /* Travel Mode Styles */
        .travel-mode-banner {
            background: rgba(171, 71, 188, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(171, 71, 188, 0.3);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .travel-mode-banner.active {
            display: block;
        }

        .travel-mode-controls {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .schedule-exceptions-section input[type="date"]:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 0 3px rgba(74, 93, 74, 0.1);
        }

        .calendar-day.travel {
            background: repeating-linear-gradient(
                45deg,
                rgba(168, 85, 247, 0.1),
                rgba(168, 85, 247, 0.1) 10px,
                rgba(74, 93, 74, 0.1) 10px,
                rgba(74, 93, 74, 0.1) 20px
            );
            border: 1px solid rgba(168, 85, 247, 0.5);
        }

        .calendar-day.travel .calendar-day-label {
            color: var(--color-accent-primary);
            font-weight: 600;
        }

        .calendar-day.sick {
            background: repeating-linear-gradient(
                45deg,
                rgba(244, 114, 182, 0.1),
                rgba(244, 114, 182, 0.1) 10px,
                rgba(236, 72, 153, 0.1) 10px,
                rgba(236, 72, 153, 0.1) 20px
            );
            border: 1px solid rgba(244, 114, 182, 0.5);
        }

        .calendar-day.sick .calendar-day-label {
            color: var(--color-error);
            font-weight: 600;
        }

        /* Desktop sidebar styles (768px and above) */
        @media (min-width: 769px) {
            .nutrition-layout-container {
                display: flex;
            }

            .nutrition-sidebar {
                display: block;
            }

            .mobile-saved-foods-btn {
                display: none !important;
            }

            .saved-foods-modal {
                display: none !important;
            }

            .saved-food-list {
                max-height: calc(100vh - 300px);
            }
        }

        @media (max-width: 768px) {
            /* Nutrition Layout - Mobile */
            .nutrition-layout-container {
                display: block;
            }

            .nutrition-sidebar {
                display: none;
            }

            .mobile-saved-foods-btn {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .saved-foods-modal {
                display: block;
            }

            .modal-backdrop {
                display: block;
            }

            /* Reduce body padding for more screen space */
            body {
                padding: 0.5rem;
            }

            /* Optimize header for mobile */
            .header {
                margin-bottom: 1rem;
                padding: 1rem 0;
            }

            .header h1 {
                font-size: 1.75rem;
                margin-bottom: 0.25rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            /* Optimize tabs for mobile scrolling */
            .nav-tabs {
                gap: 0.5rem;
                margin-bottom: 1.5rem;
                padding: 0.375rem;
            }

            .nav-tab {
                padding: 0.75rem 1.125rem;
                font-size: 0.875rem;
                min-height: 44px;
            }
            
            .exercise-header {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .set-row {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .intensity-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            /* Fix calendar grid overflow on mobile */
            .calendar-container {
                overflow-x: auto;
                overflow-y: hidden;
                padding: 1.5rem;
            }

            .calendar-grid {
                min-width: 100%;
                gap: 0.5rem;
            }

            .calendar-day {
                min-width: 50px;
                min-height: 50px;
                padding: 0.375rem;
                font-size: 0.875rem;
            }

            .calendar-day-number {
                font-size: 1rem;
            }

            .calendar-day-label {
                font-size: 0.65rem;
            }

            .adherence-stats {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .macro-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            /* Fix weight tracking section overflow on mobile */
            .weight-input-row {
                flex-direction: column;
                gap: 0.75rem;
            }

            .weight-input-field {
                width: 100%;
            }

            /* Ensure photo gallery is responsive */
            .photo-gallery {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            /* Mobile-optimized meal cards */
            .meal-card {
                padding: 1.25rem;
                margin-bottom: 1rem;
                border-radius: 16px;
            }

            .meal-header {
                flex-direction: row;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .meal-summary {
                padding: 0.75rem;
            }

            .meal-summary-stats {
                gap: 1rem;
                justify-content: space-around;
            }

            .meal-summary-stat {
                min-width: 60px;
            }

            .meal-header > div:first-child {
                width: auto;
                flex: 1;
            }

            .meal-header button {
                width: auto;
                min-height: 44px;
                padding: 0.75rem;
                font-size: 0.875rem;
            }

            .meal-type {
                width: 100%;
                font-size: 1rem;
                padding: 0.75rem;
                min-height: 48px;
            }

            .meal-time {
                font-size: 0.8rem;
            }

            /* Optimize food input rows for mobile */
            .food-input-row {
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 0.75rem;
            }

            .food-input {
                width: 100%;
                min-width: 100%;
                padding: 0.75rem;
                font-size: 1rem;
            }

            /* Create a grid layout for macro inputs on mobile */
            .macro-inputs-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                width: 100%;
            }

            .macro-input-wrapper {
                width: 100%;
            }

            .macro-input {
                width: 100%;
                padding: 0.75rem;
                font-size: 1rem;
                min-height: 48px;
            }

            /* Make action buttons full width on mobile */
            .food-action-buttons {
                display: flex;
                gap: 0.5rem;
                width: 100%;
                margin-top: 0.5rem;
            }

            .btn-save-food,
            .btn-delete-food {
                flex: 1;
                min-height: 48px;
                padding: 0.75rem;
                font-size: 0.95rem;
            }

            /* Optimize macro summary for mobile */
            .macro-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-top: 1rem;
                padding-top: 1rem;
            }

            .macro-item {
                padding: 0.75rem;
                background: var(--color-surface);
                border: 1px solid var(--color-border);
                border-radius: 8px;
            }

            .macro-value {
                font-size: 1.3rem;
            }

            .macro-label {
                font-size: 0.75rem;
            }

            /* Add Meal button optimization */
            .btn-add {
                width: 100%;
                min-height: 48px;
                padding: 0.75rem;
                font-size: 0.95rem;
                margin-top: 0.5rem;
            }

            /* Optimize saved foods panel */
            .saved-foods-panel {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .saved-food-item {
                padding: 0.75rem;
            }

            .btn-quick-add {
                min-height: 44px;
                padding: 0.65rem 0.85rem;
                font-size: 0.85rem;
            }

            /* Analytics card optimization */
            .analytics-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .analytics-title {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            /* Reduce intelligence panel spacing */
            .intelligence-panel {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .suggestions-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .suggestion-card {
                padding: 0.75rem;
            }

            /* Body goal mobile optimization */
            .goal-input-row {
                flex-direction: column;
                gap: 0.75rem;
            }

            .goal-input-group {
                min-width: 100%;
            }

            .calorie-breakdown {
                flex-direction: column;
                gap: 0.75rem;
            }

            .calorie-item {
                min-width: 100%;
            }
        }

        /* Additional breakpoint for very small phones (iPhone SE, etc.) */
        @media (max-width: 375px) {
            body {
                padding: 0.25rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.85rem;
            }

            .meal-card {
                padding: 0.75rem;
            }

            .macro-summary {
                grid-template-columns: 1fr;
            }

            .macro-input {
                width: 100%;
            }

            .food-input-row {
                gap: 0.4rem;
            }
        }

        /* Breakpoint for larger phones */
        @media (min-width: 414px) and (max-width: 768px) {
            .macro-inputs-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Unison</h1>
            <p>Body in unison.</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" id="workout-tab-btn">Workout</div>
            <div class="nav-tab" id="calendar-tab-btn">Calendar</div>
            <div class="nav-tab" id="nutrition-tab-btn">Nutrition</div>
            <div class="nav-tab" id="body-metrics-tab-btn">Body</div>
            <div class="nav-tab" id="analytics-tab-btn">Analytics</div>
            <div class="nav-tab" id="progress-tab-btn">Progress</div>
            <div class="nav-tab" id="intelligence-tab-btn">Insights</div>
        </div>

        <!-- Travel Mode Banner -->
        <div id="travel-mode-banner" class="travel-mode-banner">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <div>
                    <div style="color: var(--color-warning); font-weight: 600; font-size: 1.1rem; margin-bottom: 0.25rem;">Travel Mode Active</div>
                    <div style="color: var(--color-text-secondary); font-size: 0.9rem;">
                        <span id="travel-mode-dates"></span>
                    </div>
                </div>
                <button class="btn" onclick="endTravelMode()" style="background: rgba(212, 168, 75, 0.15); color: var(--color-warning); border: 1px solid var(--color-warning);">End Travel Mode</button>
            </div>
        </div>

        <!-- WORKOUT TAB -->
        <div id="workout-content" class="tab-content active">
            <div class="workout-day-selector">
                <button class="day-btn active" id="upper-btn">Upper</button>
                <button class="day-btn" id="lower-btn">Lower</button>
                <button class="day-btn" id="rest-btn">Rest</button>
                <button class="day-btn" id="push-btn">Push</button>
                <button class="day-btn" id="pull-btn">Pull</button>
                <button class="day-btn" id="legs-btn">Legs</button>
            </div>

            <div class="workout-controls" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap;">
                <button class="btn" id="log-past-workout-btn" style="background: rgba(168, 181, 160, 0.15); color: var(--color-accent-primary); border: 1px solid var(--color-accent-secondary);">Log Past Workout</button>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <label style="color: var(--color-text-secondary); font-size: 0.9375rem;">Date:</label>
                    <input type="date" id="workout-date-input" style="padding: 0.5rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text-primary);">
                </div>
            </div>

            <div class="intensity-inputs">
                <h4 style="color: var(--color-accent-primary); margin-bottom: 1rem;">How are you feeling?</h4>
                <div class="intensity-row">
                    <span class="intensity-label">Energy:</span>
                    <div class="intensity-scale" id="energy-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: var(--color-text-secondary); font-size: 0.8rem;">Dragging â†’ Energetic</span>
                </div>
                <div class="intensity-row">
                    <span class="intensity-label">Motivation:</span>
                    <div class="intensity-scale" id="motivation-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: var(--color-text-secondary); font-size: 0.8rem;">Forced â†’ Eager</span>
                </div>
            </div>

            <div class="intelligence-panel">
                <div class="intelligence-header">
                    <div class="ai-icon">AI</div>
                    <h3>Workout Intelligence</h3>
                </div>
                <div class="suggestions-grid" id="suggestions-container">
                    <div class="suggestion-card">
                        <div class="suggestion-type">Loading...</div>
                        <div class="suggestion-text">Loading AI suggestions...</div>
                    </div>
                </div>
            </div>

            <div id="exercises-container">
                <!-- Exercises will be populated here -->
            </div>

            <div class="intensity-inputs">
                <h4 style="color: var(--color-success); margin-bottom: 1rem;">How did the workout go?</h4>
                <div class="intensity-row">
                    <span class="intensity-label">Fatigue:</span>
                    <div class="intensity-scale" id="fatigue-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: var(--color-text-secondary); font-size: 0.8rem;">Exhausted â†’ Energized</span>
                </div>
                <div class="intensity-row">
                    <span class="intensity-label">Satisfaction:</span>
                    <div class="intensity-scale" id="satisfaction-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: var(--color-text-secondary); font-size: 0.8rem;">Poor â†’ Crushed it</span>
                </div>
            </div>

            <button class="btn-complete" id="complete-workout-btn">Complete Session</button>
        </div>

        <!-- CALENDAR TAB -->
        <div id="calendar-content" class="tab-content">
            <div class="adherence-card">
                <h3 class="analytics-title">Workout Adherence</h3>
                <div class="adherence-score">
                    <div class="adherence-score-value" id="adherence-score">0%</div>
                    <div class="stat-label">Discipline Score</div>
                </div>
                <div class="adherence-stats">
                    <div class="adherence-stat">
                        <div class="adherence-stat-value" id="workouts-completed">0</div>
                        <div class="adherence-stat-label">Completed</div>
                    </div>
                    <div class="adherence-stat">
                        <div class="adherence-stat-value" id="workouts-scheduled">0</div>
                        <div class="adherence-stat-label">Scheduled</div>
                    </div>
                    <div class="adherence-stat">
                        <div class="adherence-stat-value" id="workouts-missed">0</div>
                        <div class="adherence-stat-label">Missed</div>
                    </div>
                </div>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" id="prev-month-btn">â† Previous</button>
                    <div class="calendar-month-year" id="calendar-month-year">Loading...</div>
                    <button class="calendar-nav-btn" id="next-month-btn">Next â†’</button>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar will be rendered here -->
                </div>
            </div>

            <div class="selected-day-workout" id="selected-day-workout" style="display: none;">
                <h3 class="analytics-title" id="selected-day-title">Workout Details</h3>
                <div id="selected-day-content">
                    <!-- Selected day workout will be rendered here -->
                </div>
            </div>

            <!-- Schedule Exceptions - Collapsible Section -->
            <div class="schedule-exceptions-section">
                <div class="schedule-exceptions-header" onclick="toggleScheduleExceptions()" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-top: 1rem;">
                    <h4 style="color: var(--color-text-secondary); font-size: 0.9375rem; margin: 0;">Schedule Exceptions</h4>
                    <span id="schedule-exceptions-toggle" style="color: var(--color-text-secondary); font-size: 1.2rem;">â–¼</span>
                </div>
                <div id="schedule-exceptions-content" style="display: none; margin-top: 0.5rem;">
                    <!-- Travel Mode Controls -->
                    <div class="travel-mode-controls">
                        <h4 style="color: var(--color-text-secondary); margin-bottom: 0.75rem;">Travel Mode</h4>
                        <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; margin-bottom: 0.75rem;">
                            <div style="flex: 1; min-width: 150px;">
                                <label style="color: var(--color-text-secondary); font-size: 0.8125rem; display: block; margin-bottom: 0.25rem;">Start Date</label>
                                <input type="date" id="travel-start-date" style="width: 100%; padding: 0.5rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text-primary);">
                            </div>
                            <div style="flex: 1; min-width: 150px;">
                                <label style="color: var(--color-text-secondary); font-size: 0.8125rem; display: block; margin-bottom: 0.25rem;">End Date</label>
                                <input type="date" id="travel-end-date" style="width: 100%; padding: 0.5rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text-primary);">
                            </div>
                            <button class="btn" onclick="enableTravelMode()" style="background: var(--color-bg); color: var(--color-text-secondary); border: 1px solid var(--color-border);">Set Travel Dates</button>
                        </div>
                        <div style="color: var(--color-text-secondary); font-size: 0.8125rem; line-height: 1.5;">
                            Travel mode pauses your workout schedule and excludes days from discipline scores. Your streak won't break during travel.
                        </div>
                    </div>

                    <!-- Sick Day Controls -->
                    <div class="travel-mode-controls">
                        <h4 style="color: var(--color-text-secondary); margin-bottom: 0.75rem;">Sick Day</h4>
                        <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; margin-bottom: 0.75rem;">
                            <div style="flex: 1; min-width: 150px;">
                                <label style="color: var(--color-text-secondary); font-size: 0.8125rem; display: block; margin-bottom: 0.25rem;">Select Date</label>
                                <input type="date" id="sick-day-date" style="width: 100%; padding: 0.5rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text-primary);">
                            </div>
                            <button class="btn" onclick="markSickDay()" style="background: var(--color-bg); color: var(--color-text-secondary); border: 1px solid var(--color-border);">Mark as Sick Day</button>
                        </div>
                        <div style="color: var(--color-text-secondary); font-size: 0.8125rem; line-height: 1.5;">
                            Mark a day as sick to cancel the scheduled workout. All remaining workouts will be pushed back by one day, maintaining the intended order.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NUTRITION TAB -->
        <div id="nutrition-content" class="tab-content">
            <!-- Desktop/Tablet: Sidebar Layout | Mobile: Main content with floating button -->
            <div class="nutrition-layout-container">
                <!-- Sidebar for Desktop/Tablet (>768px) -->
                <aside class="nutrition-sidebar">
                    <div class="saved-foods-panel">
                        <h3 class="analytics-title">Saved Foods</h3>
                        <input type="text" id="saved-food-search" class="saved-food-search" placeholder="Search saved foods...">
                        <div class="saved-food-list" id="saved-food-list">
                            <div class="empty-state">No saved foods yet. Save a food from a meal below!</div>
                        </div>
                    </div>
                </aside>

                <!-- Main Content Area -->
                <div class="nutrition-main-content">
                    <div class="analytics-card">
                        <h3 class="analytics-title">Daily Nutrition</h3>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <label style="color: var(--color-text-secondary); font-size: 0.9375rem;">Date:</label>
                            <input type="date" id="nutrition-date-input" style="padding: 0.5rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text-primary);">
                        </div>
                        <div class="macro-summary">
                            <div class="macro-item">
                                <div class="macro-value" id="total-calories">0</div>
                                <div class="macro-label">Calories</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="total-protein">0g</div>
                                <div class="macro-label">Protein</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="total-carbs">0g</div>
                                <div class="macro-label">Carbs</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="total-fats">0g</div>
                                <div class="macro-label">Fats</div>
                            </div>
                        </div>
                    </div>

                    <div class="calorie-target-card" id="calorie-target-card" style="display: none;">
                        <h3 class="analytics-title">Calorie Target</h3>
                        <div class="calorie-breakdown">
                            <div class="calorie-item">
                                <div class="calorie-value" id="maintenance-calories">--</div>
                                <div class="calorie-label">Maintenance</div>
                            </div>
                            <div class="calorie-item">
                                <div class="calorie-value" id="target-calories">--</div>
                                <div class="calorie-label" id="target-calories-label">Your Goal</div>
                            </div>
                            <div class="calorie-item">
                                <div class="calorie-value" id="calories-remaining">--</div>
                                <div class="calorie-label">Remaining</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 1rem; color: var(--color-text-secondary); font-size: 0.85rem;">
                            <span id="calorie-update-notice">Calories update automatically when you log weight</span>
                        </div>
                    </div>

                    <div id="meals-container">
                        <!-- Meals will be rendered here -->
                    </div>

                    <button class="btn btn-add" onclick="addMeal()" style="width: 100%; padding: 1rem; font-size: 1rem;">+ Add Meal</button>
                </div>
            </div>

            <!-- Mobile Saved Foods Button (< 768px) -->
            <button class="mobile-saved-foods-btn" onclick="openSavedFoodsModal()">
                Saved Foods
            </button>

            <!-- Modal Backdrop for Mobile -->
            <div class="modal-backdrop" id="saved-foods-backdrop" onclick="closeSavedFoodsModal()"></div>

            <!-- Mobile Saved Foods Modal/Bottom Sheet -->
            <div class="saved-foods-modal" id="saved-foods-modal">
                <div class="modal-header">
                    <h3 class="analytics-title" style="margin-bottom: 0;">Saved Foods</h3>
                    <button class="modal-close-btn" onclick="closeSavedFoodsModal()">Ã—</button>
                </div>
                <input type="text" id="saved-food-search-mobile" class="saved-food-search" placeholder="Search saved foods..." oninput="renderSavedFoods(this.value)">
                <div class="saved-food-list" id="saved-food-list-mobile">
                    <div class="empty-state">No saved foods yet. Save a food from a meal below!</div>
                </div>
            </div>
        </div>

        <!-- BODY METRICS TAB -->
        <div id="body-metrics-content" class="tab-content">
            <div class="weight-input-card">
                <h3 class="analytics-title">Weight Tracking</h3>
                <div class="weight-input-row">
                    <input type="date" id="weight-date-input" class="weight-input-field" style="flex: 0.5;">
                    <input type="number" id="weight-value-input" class="weight-input-field" placeholder="Weight (lbs)" step="0.1">
                    <button class="btn btn-complete" onclick="logWeight()" style="margin: 0; padding: 0.75rem 1.5rem;">Log Weight</button>
                </div>
            </div>

            <div class="body-goal-card">
                <h3 class="analytics-title">Body Goal</h3>
                <div class="goal-input-row">
                    <div class="goal-input-group">
                        <label class="goal-input-label">Goal Type</label>
                        <select id="body-goal-select" class="goal-select" onchange="saveBodyGoal()">
                            <option value="">Select Goal</option>
                            <option value="cutting">Cutting (Lose Weight)</option>
                            <option value="bulking">Bulking (Gain Weight)</option>
                            <option value="maintaining">Maintaining (Stay Current)</option>
                        </select>
                    </div>
                    <div class="goal-input-group">
                        <label class="goal-input-label">Target Weight (lbs)</label>
                        <input type="number" id="target-weight-input" class="goal-input" placeholder="Enter target weight" step="0.1" onchange="saveBodyGoal()">
                    </div>
                    <div class="goal-input-group">
                        <label class="goal-input-label">Goal Start Date</label>
                        <input type="date" id="goal-start-date-input" class="goal-input" onchange="saveBodyGoal()">
                    </div>
                </div>
                <div id="goal-display-container" style="display: none;">
                    <div class="goal-display">
                        <div class="goal-display-row">
                            <span class="goal-display-label">Current Weight:</span>
                            <span class="goal-display-value" id="display-current-weight">-- lbs</span>
                        </div>
                        <div class="goal-display-row">
                            <span class="goal-display-label">7-Day Moving Average:</span>
                            <span class="goal-display-value" id="display-moving-avg">-- lbs</span>
                        </div>
                        <div class="goal-display-row">
                            <span class="goal-display-label">Weight to Goal:</span>
                            <span class="goal-display-value" id="display-weight-diff">-- lbs</span>
                        </div>
                        <div class="goal-display-row">
                            <span class="goal-display-label">Estimated Completion:</span>
                            <span class="goal-display-value" id="display-goal-date">--</span>
                        </div>
                    </div>
                    <div id="progress-indicator" class="progress-indicator on-track">
                        <span>â³</span>
                        <span id="progress-status-text">Set your goal to track progress</span>
                    </div>
                </div>
            </div>

            <div class="analytics-card">
                <h3 class="analytics-title">Weight Progress</h3>
                <div class="chart-container">
                    <canvas id="weight-chart"></canvas>
                </div>
            </div>

            <div class="photo-upload-card">
                <h3 class="analytics-title">ðŸ“¸ Progress Photos</h3>
                <div class="photo-upload-area" onclick="document.getElementById('photo-input').click()">
                    <input type="file" id="photo-input" accept="image/*" style="display: none;" onchange="uploadProgressPhoto(event)">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸ“·</div>
                    <div style="color: var(--color-text-secondary);">Click to upload a progress photo</div>
                </div>
                <div class="photo-gallery" id="photo-gallery">
                    <!-- Photos will be rendered here -->
                </div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics-content" class="tab-content">
            <!-- Row 1: Main Stats and Volume Cards -->
            <div class="analytics-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="analytics-card">
                    <h3 class="analytics-title">Personal Records</h3>
                    <div class="stat-value" id="pr-count">0</div>
                    <div class="stat-label">PRs set this week</div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">Workout Streak</h3>
                    <div class="stat-value" id="workout-streak">0</div>
                    <div class="stat-label">consecutive workouts</div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">Upper Volume</h3>
                    <div class="stat-value" id="upper-record">0</div>
                    <div class="stat-label">Record: <span id="upper-record-lbs">0</span> lbs</div>
                    <div class="stat-label">Avg: <span id="upper-avg">0</span> lbs | <span id="upper-trend">â†’</span></div>
                    <div class="stat-label" style="font-size: 0.8rem; margin-top: 0.5rem;"><span id="upper-mom"></span></div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">Lower Volume</h3>
                    <div class="stat-value" id="lower-record">0</div>
                    <div class="stat-label">Record: <span id="lower-record-lbs">0</span> lbs</div>
                    <div class="stat-label">Avg: <span id="lower-avg">0</span> lbs | <span id="lower-trend">â†’</span></div>
                    <div class="stat-label" style="font-size: 0.8rem; margin-top: 0.5rem;"><span id="lower-mom"></span></div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">ðŸš€ Push Volume</h3>
                    <div class="stat-value" id="push-record">0</div>
                    <div class="stat-label">Record: <span id="push-record-lbs">0</span> lbs</div>
                    <div class="stat-label">Avg: <span id="push-avg">0</span> lbs | <span id="push-trend">â†’</span></div>
                    <div class="stat-label" style="font-size: 0.8rem; margin-top: 0.5rem;"><span id="push-mom"></span></div>
                </div>
            </div>

            <!-- Row 2: More Volume Cards -->
            <div class="analytics-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                <div class="analytics-card">
                    <h3 class="analytics-title">Pull Volume</h3>
                    <div class="stat-value" id="pull-record">0</div>
                    <div class="stat-label">Record: <span id="pull-record-lbs">0</span> lbs</div>
                    <div class="stat-label">Avg: <span id="pull-avg">0</span> lbs | <span id="pull-trend">â†’</span></div>
                    <div class="stat-label" style="font-size: 0.8rem; margin-top: 0.5rem;"><span id="pull-mom"></span></div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">ðŸ¦µ Legs Volume</h3>
                    <div class="stat-value" id="legs-record">0</div>
                    <div class="stat-label">Record: <span id="legs-record-lbs">0</span> lbs</div>
                    <div class="stat-label">Avg: <span id="legs-avg">0</span> lbs | <span id="legs-trend">â†’</span></div>
                    <div class="stat-label" style="font-size: 0.8rem; margin-top: 0.5rem;"><span id="legs-mom"></span></div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">Focus Areas</h3>
                    <div id="focus-areas-content" style="color: var(--color-text-secondary); font-size: 0.9rem;">
                        <p>Complete more workouts to see focus areas!</p>
                    </div>
                </div>
            </div>

            <!-- Row 3: Charts -->
            <div class="chart-grid">
                <div class="analytics-card">
                    <h3 class="analytics-title">PR Timeline</h3>
                    <div style="margin-bottom: 1rem;">
                        <label for="exercise-selector" style="color: var(--color-text-secondary); font-size: 0.9375rem; margin-right: 0.5rem;">Exercise:</label>
                        <select id="exercise-selector" style="padding: 0.5rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text-primary); font-size: 0.9375rem;">
                            <option value="">Select an exercise</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="pr-timeline-chart"></canvas>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">Session Comparison</h3>
                    <div style="margin-bottom: 1rem;">
                        <label for="comparison-selector" style="color: var(--color-text-secondary); font-size: 0.9375rem; margin-right: 0.5rem;">Workout Type:</label>
                        <select id="comparison-selector" style="padding: 0.5rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text-primary); font-size: 0.9375rem;">
                            <option value="Upper">Upper</option>
                            <option value="Lower">Lower</option>
                            <option value="Push">Push</option>
                            <option value="Pull">Pull</option>
                            <option value="Legs">Legs</option>
                        </select>
                    </div>
                    <div id="session-comparison-content" style="color: var(--color-text-secondary); font-size: 0.9375rem;">
                        <p>Select a workout type to compare sessions</p>
                    </div>
                </div>
            </div>

            <!-- Row 4: Analytics -->
            <div class="chart-grid">
                <div class="analytics-card">
                    <h3 class="analytics-title">Progression Snapshot</h3>
                    <div id="progression-snapshot" style="color: var(--color-text-secondary); font-size: 0.9375rem;">
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: #1a1a1a;">Quick Wins:</strong>
                            <div id="quick-wins">Complete at least 2 workouts to see recent PRs</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--color-success);">Trending Up:</strong>
                            <div style="font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 0.25rem;">Improving over last 4 sessions</div>
                            <div id="trending-up">N/A</div>
                        </div>
                        <div>
                            <strong style="color: var(--color-warning);">Needs Attention:</strong>
                            <div style="font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 0.25rem;">No progress for 3+ sessions</div>
                            <div id="needs-attention">N/A</div>
                        </div>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">Intensity Heatmap</h3>
                    <div id="intensity-heatmap" style="color: var(--color-text-secondary); font-size: 0.9rem;">
                        <div id="heatmap-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROGRESS TAB -->
        <div id="progress-content" class="tab-content">
            <div class="analytics-card">
                <h3 class="analytics-title">Exercise Progression</h3>
                <div id="exercise-progress-list">
                    <p style="color: var(--color-text-secondary);">Complete some workouts to see your detailed progression!</p>
                </div>
            </div>

            <div class="analytics-card">
                <h3 class="analytics-title">Personal Records</h3>
                <div id="progress-list">
                    <p style="color: var(--color-text-secondary);">Complete some workouts to see your strength progression!</p>
                </div>
            </div>
        </div>

        <!-- INTELLIGENCE TAB -->
        <div id="intelligence-content" class="tab-content">
            <div class="analytics-card">
                <h3 class="analytics-title">AI Insights</h3>
                <ul class="insights-list" id="insights-list">
                    <li class="insight-item">Complete some workouts to get personalized insights!</li>
                </ul>
            </div>

            <div class="analytics-card">
                <h3 class="analytics-title">Nutrition Analytics (Past 7 Days)</h3>
                <div id="nutrition-insights" style="color: var(--color-text-secondary); font-size: 0.9rem;">
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: var(--color-accent-primary);">Workout Days vs Rest Days</strong>
                        <div id="nutrition-comparison" style="margin-top: 0.5rem;">
                            Log nutrition for at least 3 days to see insights
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: var(--color-success);">Pre-Workout Nutrition</strong>
                        <div id="preworkout-insights" style="margin-top: 0.5rem;">
                            Track meal times to see pre-workout nutrition patterns
                        </div>
                    </div>
                    <div>
                        <strong style="color: var(--color-warning);">Post-Workout Recovery</strong>
                        <div id="postworkout-insights" style="margin-top: 0.5rem;">
                            Track meal times to see post-workout nutrition patterns
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meal Type Selection Modal -->
    <div class="modal-overlay" id="meal-type-modal">
        <div class="modal-content">
            <h3 class="modal-title">Select Meal Type</h3>
            <div class="meal-type-buttons">
                <button class="meal-type-btn" onclick="selectMealType('Breakfast')">Breakfast</button>
                <button class="meal-type-btn" onclick="selectMealType('Lunch')">Lunch</button>
                <button class="meal-type-btn" onclick="selectMealType('Dinner')">Dinner</button>
                <button class="meal-type-btn" onclick="selectMealType('Snack')">Snack</button>
            </div>
            <button class="modal-close" onclick="closeMealTypeModal()">Cancel</button>
        </div>
    </div>

    <!-- Alternative Exercise Modal -->
    <div class="alt-exercise-modal" id="alt-exercise-modal">
        <div class="alt-exercise-modal-content">
            <div class="alt-exercise-modal-header">
                <div class="alt-exercise-modal-title">Alternative Exercise</div>
                <button class="alt-exercise-close-btn" onclick="closeAltExerciseModal()">Ã— Close</button>
            </div>
            
            <div class="alt-exercise-input-section">
                <label class="alt-exercise-input-label">Exercise Name</label>
                <input type="text" id="alt-exercise-name-input" class="alt-exercise-name-input" placeholder="Enter alternative exercise name...">
            </div>

            <div class="alt-exercise-history-section" id="alt-exercise-history-section" style="display: none;">
                <div class="alt-exercise-history-title">Previously Used Alternatives</div>
                <div class="alt-exercise-history-list" id="alt-exercise-history-list"></div>
            </div>

            <button class="alt-exercise-confirm-btn" id="alt-exercise-confirm-btn" onclick="confirmAltExercise()">
                Confirm Alternative Exercise
            </button>
        </div>
    </div>

    <!-- Post-Travel Resume Options Modal -->
    <div class="modal-overlay" id="post-travel-modal">
        <div class="modal-content">
            <h3 class="modal-title">Welcome Back!</h3>
            <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem; text-align: center;">How would you like to resume your workout program?</p>
            <div class="meal-type-buttons">
                <button class="meal-type-btn" onclick="resumeWorkoutProgram('resume')" style="background: rgba(93, 138, 102, 0.2); border-color: rgba(93, 138, 102, 0.3); color: var(--color-success);">
                    <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">â–¶ï¸</div>
                    <div style="font-weight: 600;">Resume</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Continue from where you left off</div>
                </button>
                <button class="meal-type-btn" onclick="resumeWorkoutProgram('restart')" style="background: rgba(74, 93, 74, 0.2); border-color: rgba(74, 93, 74, 0.3); color: var(--color-accent-primary);">
                    <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">ðŸ”„</div>
                    <div style="font-weight: 600;">Restart</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Start the program from day 1</div>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, limit, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBouZ7KMUMSf8RdBKudMW2qEXI_FHgchIU",
            authDomain: "fitness-command-center.firebaseapp.com",
            projectId: "fitness-command-center",
            storageBucket: "fitness-command-center.firebasestorage.app",
            messagingSenderId: "416632779679",
            appId: "1:416632779679:web:768ab3ec04da3aecac03aa",
            measurementId: "G-F06G7Y9V25"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global state
        let currentDay = 'Upper';
        let currentWorkout = {};
        let allWorkouts = [];
        let workoutIntensity = {
            preWorkout: { energy: null, motivation: null },
            postWorkout: { fatigue: null, satisfaction: null }
        };
        let charts = {};
        let currentCalendarDate = new Date();
        let selectedCalendarDay = null;
        let nutritionData = [];
        window.nutritionData = nutritionData;
        let currentNutritionDate = new Date().toISOString().split('T')[0];
        let currentEditingMealId = null; // Track which meal is currently being edited
        let weightData = [];
        window.weightData = weightData;
        let photoData = [];
        window.photoData = photoData;
        let savedFoods = [];
        let travelModeData = [];
        window.travelModeData = travelModeData;
        let sickDayData = [];
        window.sickDayData = sickDayData;
        window.savedFoods = savedFoods;
        let bodyGoalData = null;
        window.bodyGoalData = bodyGoalData;
        let alternativeExerciseHistory = {}; // Store alternative exercise history by original exercise name
        let currentAltExerciseIndex = null; // Track which exercise is being edited

        const workoutPlans = {
            Upper: [
                { name: 'Incline Dumbbell Press', sets: 3, reps: 8 },
                { name: 'Seated Cable Fly', sets: 2, reps: 10 },
                { name: 'Weighted Pull-Ups', sets: 3, reps: 6 },
                { name: 'High Cable Lateral Raise', sets: 2, reps: 10 },
                { name: 'Deficit Pendlay Row', sets: 2, reps: 8 },
                { name: 'Cable Tricep Extension', sets: 2, reps: 10 },
                { name: 'Bayesian Cable Bicep Curl', sets: 2, reps: 10 }
            ],
            Lower: [
                { name: 'Lying Leg Curls', sets: 2, reps: '8+partial to failure' },
                { name: 'Barbell Squat', sets: 3, reps: 8 },
                { name: 'Romanian Deadlift', sets: 3, reps: 8 },
                { name: 'Leg Extension', sets: 2, reps: 10 },
                { name: 'Hip Abduction', sets: 2, reps: 10 },
                { name: 'Standing Calf Raise', sets: 3, reps: 10 }
            ],
            Rest: [
                { name: 'Rest Day Recovery', sets: 1, reps: 'Complete' }
            ],
            Push: [
                { name: 'Barbell Bench Press', sets: 1, reps: '3-5 with warmup ladder (15, 5, 3, 2, 1)' },
                { name: 'Dumbbell Larsen Press', sets: 2, reps: '10 (75% of bench press weight)' },
                { name: 'Standing Arnold Press', sets: 3, reps: '8-10' },
                { name: 'Cable Press-Around (Superset)', sets: 2, reps: '12-15' },
                { name: 'Pec Stretch (Superset)', sets: 2, reps: '30 seconds' },
                { name: 'Cross-Body Cable Y-Raise', sets: 3, reps: '12-15' },
                { name: 'Squeeze-Only Pressdown (Superset)', sets: 3, reps: 8 },
                { name: 'Overhead Extension - Extended Position (Superset)', sets: 3, reps: 8 },
                { name: 'Cross-Body Triceps Extension', sets: 2, reps: '10-12' }
            ],
            Pull: [
                { name: 'Lat Pulldown', sets: '4 feeder sets + 1-2 sets to failure + 1 dropset', reps: 'Varies' },
                { name: 'Machine Row/T-Bar Row/DB Helms Row', sets: 3, reps: '10-12' },
                { name: 'Bottom Half DB Lat Pullovers (Superset)', sets: 2, reps: '10-12' },
                { name: 'Static Lat Stretching (Superset)', sets: 2, reps: '30 seconds' },
                { name: 'Omni Directional Face Pulls', sets: 3, reps: '12-15' },
                { name: 'EZ Bar Bicep Curl', sets: 3, reps: '6-8' },
                { name: 'Bottom-Half DB Preacher Curl', sets: 2, reps: '10-12' } 
            ],
            Legs: [
                { name: 'Squats - Warmup 20%', sets: 1, reps: 10 },
                { name: 'Squats - Warmup 35%', sets: 1, reps: 5 },
                { name: 'Squats - Warmup 55%', sets: 1, reps: 3 },
                { name: 'Squats - Warmup 70%', sets: 1, reps: 2 },
                { name: 'Squats - Warmup 80%', sets: 1, reps: 1 },
                { name: 'Squats - 85-90%', sets: 1, reps: '2-4' },
                { name: 'Paused Squats (75% of working weight)', sets: 2, reps: 5 },
                { name: 'Romanian Deadlift', sets: 3, reps: '8-10' },
                { name: 'Walking Lunges', sets: 2, reps: '10 per leg' },
                { name: 'Seated Leg Curl', sets: 3, reps: '10-12' },
                { name: 'Leg Press Toe Press', sets: 4, reps: '10-12' },
                { name: 'Decline Plate Crunch', sets: 3, reps: '10-12' },
            ]
        };

        // Firebase functions
        async function saveWorkoutToFirebase(workoutData) {
            try {
                const docRef = await addDoc(collection(db, "workouts"), {
                    ...workoutData,
                    timestamp: new Date()
                });
                console.log("Workout saved with ID:", docRef.id);
                return docRef.id;
            } catch (e) {
                console.error("Error adding workout:", e);
                throw e;
            }
        }

        async function loadWorkoutsFromFirebase() {
            try {
                const q = query(collection(db, "workouts"), orderBy("timestamp", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                const workouts = [];
                querySnapshot.forEach((doc) => {
                    workouts.push({ id: doc.id, ...doc.data() });
                });
                allWorkouts = workouts;
                console.log("Loaded workouts:", workouts.length);
                return workouts;
            } catch (e) {
                console.error("Error loading workouts:", e);
                return [];
            }
        }

        async function loadNutritionData() {
            try {
                const q = query(collection(db, "nutrition"), orderBy("date", "desc"), limit(30));
                const querySnapshot = await getDocs(q);
                const nutrition = [];
                const seenIds = new Set();
                
                querySnapshot.forEach((doc) => {
                    // Prevent duplicate IDs
                    if (!seenIds.has(doc.id)) {
                        seenIds.add(doc.id);
                        nutrition.push({ id: doc.id, ...doc.data() });
                    }
                });
                
                nutritionData = nutrition;
                window.nutritionData = nutrition;
                console.log("Loaded nutrition data:", nutrition.length, "entries");
                return nutrition;
            } catch (e) {
                console.error("Error loading nutrition:", e);
                return [];
            }
        }

        async function loadWeightData() {
            try {
                const q = query(collection(db, "weight"), orderBy("date", "desc"), limit(90));
                const querySnapshot = await getDocs(q);
                const weights = [];
                querySnapshot.forEach((doc) => {
                    weights.push({ id: doc.id, ...doc.data() });
                });
                weightData = weights;
                window.weightData = weights;
                console.log("Loaded weight data:", weights.length);
                return weights;
            } catch (e) {
                console.error("Error loading weight:", e);
                return [];
            }
        }

        async function loadPhotoData() {
            try {
                const q = query(collection(db, "photos"), orderBy("date", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                const photos = [];
                querySnapshot.forEach((doc) => {
                    photos.push({ id: doc.id, ...doc.data() });
                });
                photoData = photos;
                window.photoData = photos;
                console.log("Loaded photo data:", photos.length);
                return photos;
            } catch (e) {
                console.error("Error loading photos:", e);
                return [];
            }
        }

        // Body Goal Functions
        async function loadBodyGoalData() {
            try {
                const q = query(collection(db, "bodyGoals"), limit(1));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    bodyGoalData = { id: doc.id, ...doc.data() };
                    window.bodyGoalData = bodyGoalData;
                    console.log("Loaded body goal data:", bodyGoalData);
                    populateBodyGoalForm();
                    updateBodyGoalDisplay();
                    updateNutritionCalories();
                    return bodyGoalData;
                }
                return null;
            } catch (e) {
                console.error("Error loading body goal:", e);
                return null;
            }
        }

        function populateBodyGoalForm() {
            if (!bodyGoalData) return;
            
            const goalSelect = document.getElementById('body-goal-select');
            const targetWeightInput = document.getElementById('target-weight-input');
            const goalStartDateInput = document.getElementById('goal-start-date-input');
            
            if (goalSelect && bodyGoalData.bodyGoal) {
                goalSelect.value = bodyGoalData.bodyGoal;
            }
            if (targetWeightInput && bodyGoalData.targetWeight) {
                targetWeightInput.value = bodyGoalData.targetWeight;
            }
            if (goalStartDateInput && bodyGoalData.goalStartDate) {
                goalStartDateInput.value = bodyGoalData.goalStartDate;
            }
        }

        window.saveBodyGoal = async function() {
            const bodyGoal = document.getElementById('body-goal-select').value;
            const targetWeight = parseFloat(document.getElementById('target-weight-input').value);
            const goalStartDate = document.getElementById('goal-start-date-input').value;
            
            if (!bodyGoal || !targetWeight || !goalStartDate) {
                console.log('Missing required fields for body goal');
                return;
            }
            
            // Validation
            if (isNaN(targetWeight)) {
                alert('Please enter a valid number for target weight');
                return;
            }
            
            if (targetWeight <= 0) {
                alert('Target weight must be greater than zero');
                return;
            }
            
            const goalData = {
                bodyGoal,
                targetWeight,
                goalStartDate,
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (bodyGoalData && bodyGoalData.id) {
                    // Update existing
                    await updateDoc(doc(db, "bodyGoals", bodyGoalData.id), goalData);
                    bodyGoalData = { id: bodyGoalData.id, ...goalData };
                } else {
                    // Create new
                    const docRef = await addDoc(collection(db, "bodyGoals"), goalData);
                    bodyGoalData = { id: docRef.id, ...goalData };
                }
                window.bodyGoalData = bodyGoalData;
                console.log('Body goal saved:', bodyGoalData);
                updateBodyGoalDisplay();
                updateNutritionCalories();
            } catch (e) {
                console.error("Error saving body goal:", e);
                alert('Error saving body goal');
            }
        };

        function calculateMaintenanceCalories(weight) {
            return Math.round(weight * 14.5);
        }

        function calculateTargetCalories(weight, bodyGoal) {
            const maintenance = calculateMaintenanceCalories(weight);
            
            switch (bodyGoal) {
                case 'cutting':
                    return maintenance - 500;
                case 'bulking':
                    return maintenance + 250;
                case 'maintaining':
                    return maintenance;
                default:
                    return maintenance;
            }
        }

        function calculate7DayMovingAverage(weightHistory) {
            if (!weightHistory || weightHistory.length === 0) return null;
            
            // Sort by date descending
            const sorted = [...weightHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Take last 7 entries (or fewer if less than 7 available)
            const last7 = sorted.slice(0, Math.min(7, sorted.length));
            
            // Calculate average
            const sum = last7.reduce((acc, w) => acc + w.weight, 0);
            return sum / last7.length;
        }

        function calculateGoalEndDate(currentWeight, targetWeight, goalStartDate, bodyGoal) {
            if (!currentWeight || !targetWeight || !goalStartDate || !bodyGoal) return null;
            
            if (bodyGoal === 'maintaining') return null;
            
            const weightDiff = Math.abs(targetWeight - currentWeight);
            let weeksToGoal;
            
            if (bodyGoal === 'cutting') {
                weeksToGoal = weightDiff / 1.0; // 1 lb per week
            } else if (bodyGoal === 'bulking') {
                weeksToGoal = weightDiff / 0.5; // 0.5 lb per week
            } else {
                return null;
            }
            
            const startDate = new Date(goalStartDate);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + (weeksToGoal * 7));
            
            return endDate.toISOString().split('T')[0];
        }

        function checkIfOnTrack(movingAverage, targetWeight, currentWeight, bodyGoal) {
            if (!movingAverage || !targetWeight || !bodyGoal) {
                return { isOnTrack: false, message: 'Set your goal to track progress' };
            }
            
            if (bodyGoal === 'maintaining') {
                const deviation = Math.abs(movingAverage - targetWeight);
                if (deviation <= 3) {
                    return { isOnTrack: true, message: `On Track (within Â±3 lbs of target)` };
                } else {
                    return { isOnTrack: false, message: `Off Track (${deviation.toFixed(1)} lbs from target)` };
                }
            } else if (bodyGoal === 'cutting') {
                if (movingAverage <= currentWeight) {
                    return { isOnTrack: true, message: 'On Track (trending downward)' };
                } else {
                    return { isOnTrack: false, message: 'Off Track (not trending downward)' };
                }
            } else if (bodyGoal === 'bulking') {
                if (movingAverage >= currentWeight) {
                    return { isOnTrack: true, message: 'On Track (trending upward)' };
                } else {
                    return { isOnTrack: false, message: 'Off Track (not trending upward)' };
                }
            }
            
            return { isOnTrack: false, message: 'Unable to determine progress' };
        }

        function updateBodyGoalDisplay() {
            if (!bodyGoalData || !bodyGoalData.bodyGoal) {
                document.getElementById('goal-display-container').style.display = 'none';
                return;
            }
            
            document.getElementById('goal-display-container').style.display = 'block';
            
            // Get current weight (most recent)
            const currentWeight = weightData && weightData.length > 0 ? weightData[0].weight : null;
            
            // Calculate 7-day moving average
            const movingAvg = calculate7DayMovingAverage(weightData);
            
            // Calculate weight difference
            const weightDiff = currentWeight && bodyGoalData.targetWeight 
                ? Math.abs(bodyGoalData.targetWeight - currentWeight) 
                : null;
            
            // Calculate goal end date
            const goalEndDate = currentWeight 
                ? calculateGoalEndDate(currentWeight, bodyGoalData.targetWeight, bodyGoalData.goalStartDate, bodyGoalData.bodyGoal)
                : null;
            
            // Update display
            document.getElementById('display-current-weight').textContent = 
                currentWeight ? `${currentWeight.toFixed(1)} lbs` : '-- lbs';
            
            document.getElementById('display-moving-avg').textContent = 
                movingAvg ? `${movingAvg.toFixed(1)} lbs` : '-- lbs (log weight first)';
            
            document.getElementById('display-weight-diff').textContent = 
                weightDiff ? `${weightDiff.toFixed(1)} lbs` : '-- lbs';
            
            if (bodyGoalData.bodyGoal === 'maintaining') {
                document.getElementById('display-goal-date').textContent = 'Goal: Maintain current weight';
            } else {
                document.getElementById('display-goal-date').textContent = 
                    goalEndDate ? new Date(goalEndDate).toLocaleDateString() : '--';
            }
            
            // Update progress indicator
            const progressStatus = checkIfOnTrack(movingAvg, bodyGoalData.targetWeight, currentWeight, bodyGoalData.bodyGoal);
            const progressIndicator = document.getElementById('progress-indicator');
            const progressText = document.getElementById('progress-status-text');
            
            if (progressStatus.isOnTrack) {
                progressIndicator.className = 'progress-indicator on-track';
            } else {
                progressIndicator.className = 'progress-indicator off-track';
            }
            
            progressText.textContent = progressStatus.message;
        }

        function updateNutritionCalories() {
            if (!bodyGoalData || !bodyGoalData.bodyGoal) {
                document.getElementById('calorie-target-card').style.display = 'none';
                return;
            }
            
            // Get current weight (most recent)
            const currentWeight = weightData && weightData.length > 0 ? weightData[0].weight : null;
            
            if (!currentWeight) {
                document.getElementById('calorie-target-card').style.display = 'none';
                return;
            }
            
            document.getElementById('calorie-target-card').style.display = 'block';
            
            const maintenanceCalories = calculateMaintenanceCalories(currentWeight);
            const targetCalories = calculateTargetCalories(currentWeight, bodyGoalData.bodyGoal);
            
            document.getElementById('maintenance-calories').textContent = maintenanceCalories;
            document.getElementById('target-calories').textContent = targetCalories;
            
            // Update label based on goal
            const labelMap = {
                'cutting': 'Cutting Goal',
                'bulking': 'Bulking Goal',
                'maintaining': 'Maintaining Goal'
            };
            document.getElementById('target-calories-label').textContent = 
                labelMap[bodyGoalData.bodyGoal] || 'Your Goal';
            
            // Calculate remaining calories
            const totalCalories = calculateTotalCalories();
            const remaining = targetCalories - totalCalories;
            document.getElementById('calories-remaining').textContent = remaining;
            
            // Update remaining color
            const remainingElement = document.getElementById('calories-remaining');
            if (remaining < 0) {
                remainingElement.style.color = 'var(--color-error)'; // red
            } else if (remaining < 200) {
                remainingElement.style.color = 'var(--color-warning)'; // orange
            } else {
                remainingElement.style.color = 'var(--color-accent-primary)'; // cyan
            }
        }

        function calculateTotalCalories() {
            // Get current date nutrition
            const currentDateMeals = nutritionData.filter(m => m.date === currentNutritionDate);
            let total = 0;
            currentDateMeals.forEach(meal => {
                if (meal.foods) {
                    meal.foods.forEach(food => {
                        const quantity = food.quantity || 1;
                        total += (parseFloat(food.calories) || 0) * quantity;
                    });
                }
            });
            return total;
        }

        // Workout Schedule Cycle: upper/lower/rest/push/pull/legs/rest
        // Workout cycle: 7-day repeating cycle
        const workoutSchedule = ['Upper', 'Lower', 'Rest', 'Push', 'Pull', 'Legs', 'Rest'];
        
        // Reference date for schedule calculation when no completed workouts exist
        // 2025-01-01 maps to workoutSchedule[0] = 'Upper'
        const SCHEDULE_REFERENCE_DATE = '2025-01-01';
        
        // Configuration for schedule calculation
        const MIN_SCHEDULE_DAYS = 14; // Minimum days to schedule ahead for missed workout queue
        const FUTURE_SCHEDULE_BUFFER = 7; // Additional days beyond missed workouts to schedule
        
        // Timezone configuration - default to LA timezone, but respect device timezone when traveling
        const DEFAULT_TIMEZONE = 'America/Los_Angeles';
        let userTimezone = DEFAULT_TIMEZONE;
        try {
            const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            // Use detected timezone if different from LA (indicates user is traveling)
            if (detectedTimezone && detectedTimezone !== DEFAULT_TIMEZONE) {
                userTimezone = detectedTimezone;
                console.log('User appears to be traveling, using detected timezone:', userTimezone);
            } else {
                userTimezone = DEFAULT_TIMEZONE;
            }
        } catch (e) {
            console.warn('Could not detect timezone, using default PST:', e);
        }
        console.log('Using timezone:', userTimezone);
        
        // Timezone-aware date helper functions
        function getTodayDateString() {
            // Get current date in the user's timezone (LA or device timezone)
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: userTimezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            return formatter.format(now); // Returns YYYY-MM-DD format
        }
        
        function getCurrentTimeString() {
            // Get current time in user's timezone
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: userTimezone,
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            return formatter.format(now);
        }
        
        function getCurrentHour() {
            // Get current hour in user's timezone (0-23)
            const now = new Date();
            const timeString = now.toLocaleString('en-US', { 
                timeZone: userTimezone, 
                hour: 'numeric', 
                hour12: false 
            });
            return parseInt(timeString);
        }
        
        function getDefaultMealType() {
            // Determine meal type based on current time in user's timezone
            // Before 11am = Breakfast
            // 11am-2pm = Lunch
            // 2pm-5pm = Snack
            // After 5pm = Dinner
            const hour = getCurrentHour();
            if (hour < 11) return 'Breakfast';
            if (hour < 14) return 'Lunch';
            if (hour < 17) return 'Snack';
            return 'Dinner';
        }
        
        function convertUnits(amount, fromUnit, toUnit) {
            // Simple unit conversion for portion tracking
            // Returns converted amount or null if conversion not possible
            fromUnit = fromUnit.toLowerCase();
            toUnit = toUnit.toLowerCase();
            
            if (fromUnit === toUnit) return amount;
            
            // g <-> oz conversion (1 oz = 28.35g)
            if (fromUnit === 'g' && toUnit === 'oz') return amount / 28.35;
            if (fromUnit === 'oz' && toUnit === 'g') return amount * 28.35;
            
            // ml treated as equivalent to g for simplicity (most liquids â‰ˆ 1g/ml)
            if (fromUnit === 'ml' && toUnit === 'g') return amount;
            if (fromUnit === 'g' && toUnit === 'ml') return amount;
            if (fromUnit === 'ml' && toUnit === 'oz') return amount / 28.35;
            if (fromUnit === 'oz' && toUnit === 'ml') return amount * 28.35;
            
            // each and serving are equivalent
            if ((fromUnit === 'each' || fromUnit === 'serving') && 
                (toUnit === 'each' || toUnit === 'serving')) return amount;
            
            // Cannot convert between weight/volume and count
            return null;
        }

        // Helper function to get what workout would have been scheduled on a special day (travel/sick)
        // This is used to show users what they're missing
        function getWouldBeScheduledWorkout(date) {
            const queryDate = new Date(date + 'T00:00:00.000Z');
            const actualWorkout = getWorkoutForDate(date);
            
            // If there's an actual workout on this date, return its type
            if (actualWorkout) {
                return actualWorkout.day;
            }
            
            // Calculate what workout would be here if we ignored travel/sick days
            const todayStr = getTodayDateString();
            const todayDate = new Date(todayStr + 'T00:00:00.000Z');
            
            // Find the most recent completed NON-REST workout (excluding rest days only)
            const completedWorkouts = allWorkouts
                .filter(w => w.day !== 'Rest')
                .sort((a, b) => new Date(b.date + 'T00:00:00.000Z') - new Date(a.date + 'T00:00:00.000Z'));
            
            if (completedWorkouts.length > 0) {
                const mostRecent = completedWorkouts[0];
                const mostRecentDate = new Date(mostRecent.date + 'T00:00:00.000Z');
                const mostRecentType = mostRecent.day;
                
                // Find the index of the most recent workout type in the schedule
                const lastIndex = workoutSchedule.indexOf(mostRecentType);
                
                // Count all days (including travel/sick) from most recent to query date
                let daysSince = 0;
                let d = new Date(mostRecentDate);
                while (d < queryDate) {
                    daysSince++;
                    d = new Date(d.getTime() + 24 * 60 * 60 * 1000);
                }
                
                // Project forward in the 7-day cycle
                const scheduleIndex = (lastIndex + daysSince) % workoutSchedule.length;
                return workoutSchedule[scheduleIndex];
            } else {
                // No workouts yet, use default schedule from reference date
                const referenceDate = new Date(SCHEDULE_REFERENCE_DATE + 'T00:00:00.000Z');
                let allDays = 0;
                let d = new Date(referenceDate);
                while (d < queryDate) {
                    allDays++;
                    d = new Date(d.getTime() + 24 * 60 * 60 * 1000);
                }
                const scheduleIndex = ((allDays % workoutSchedule.length) + workoutSchedule.length) % workoutSchedule.length;
                return workoutSchedule[scheduleIndex];
            }
        }
        
        // Helper function: Calculate calendar days between two dates (whole days)
        // Returns positive number if date2 is after date1, negative if before
        function daysBetween(date1Str, date2Str) {
            const d1 = new Date(date1Str + 'T00:00:00.000Z');
            const d2 = new Date(date2Str + 'T00:00:00.000Z');
            const diffMs = d2.getTime() - d1.getTime();
            const diffDays = Math.floor(diffMs / (24 * 60 * 60 * 1000));
            return diffDays;
        }
        
        // Helper function: Find the most recent completed non-Rest workout before (or on) a target date
        // Returns { date: string, day: string } or null if none found
        function getMostRecentCompletedNonRestWorkoutBefore(targetDateStr) {
            const targetDate = new Date(targetDateStr + 'T00:00:00.000Z');
            
            // Filter to non-Rest workouts that are on or before the target date
            const eligibleWorkouts = allWorkouts
                .filter(w => {
                    if (w.day === 'Rest') return false;
                    const workoutDate = new Date(w.date + 'T00:00:00.000Z');
                    return workoutDate <= targetDate;
                })
                .sort((a, b) => {
                    const dateA = new Date(a.date + 'T00:00:00.000Z');
                    const dateB = new Date(b.date + 'T00:00:00.000Z');
                    return dateB.getTime() - dateA.getTime(); // Most recent first
                });
            
            if (eligibleWorkouts.length > 0) {
                return {
                    date: eligibleWorkouts[0].date,
                    day: eligibleWorkouts[0].day
                };
            }
            return null;
        }
        
        function getScheduledWorkout(date) {
            const actualWorkout = getWorkoutForDate(date);
            
            // If there's an actual workout on this date, return its type (HIGHEST PRIORITY)
            // A logged workout overrides sick/travel markers because actual workout data
            // is authoritative - users want logged workouts to count toward their progress
            // even if the date was originally marked as sick or travel
            if (actualWorkout) {
                return actualWorkout.day;
            }
            
            // Check if date is a sick day
            if (isDateSickDay(date)) {
                return 'Sick';
            }
            
            // Check if date is in travel mode - show scheduled workout but don't penalize if missed
            if (isDateInTravelMode(date)) {
                return 'Travel';
            }
            
            // Calendar-day-based advancement approach:
            // Find the most recent completed non-Rest workout, then advance through the 7-day cycle
            // by counting calendar days (not skipping Rest/Sick/Travel)
            
            const lastCompleted = getMostRecentCompletedNonRestWorkoutBefore(date);
            
            if (lastCompleted) {
                // We have a most recent completed non-Rest workout
                // Calculate calendar days between lastCompleted.date and the target date
                const daysDiff = daysBetween(lastCompleted.date, date);
                
                // Find the index of the last completed workout in the schedule
                const lastCompletedIndex = workoutSchedule.indexOf(lastCompleted.day);
                
                // Advance by daysDiff positions in the 7-day cycle
                const scheduleIndex = (lastCompletedIndex + daysDiff) % workoutSchedule.length;
                return workoutSchedule[scheduleIndex];
            } else {
                // No completed non-Rest workouts found
                // Fall back to deterministic reference date (defined at top of file)
                const daysDiff = daysBetween(SCHEDULE_REFERENCE_DATE, date);
                
                // Handle negative modulo safely
                const scheduleIndex = ((daysDiff % workoutSchedule.length) + workoutSchedule.length) % workoutSchedule.length;
                return workoutSchedule[scheduleIndex];
            }
        }

        function getWorkoutForDate(dateString) {
            const workout = allWorkouts.find(w => w.date === dateString);
            if (workout) {
                console.log(`Found workout for ${dateString}: type="${workout.day}", hasExercises=${!!workout.exercises}`);
            }
            return workout;
        }

        function calculateAdherence() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            let scheduled = 0;
            let completed = 0;
            let missed = 0;
            
            for (let d = new Date(thirtyDaysAgo); d <= today; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const scheduledWorkout = getScheduledWorkout(dateStr);
                const actualWorkout = getWorkoutForDate(dateStr);
                
                // Exclude rest days from adherence calculations
                // Sick/travel days without logged workouts are excluded (getScheduledWorkout returns 'Sick'/'Travel')
                // Sick/travel days WITH logged workouts are included (getScheduledWorkout returns the workout type)
                if (scheduledWorkout !== 'Rest' && scheduledWorkout !== 'Travel' && scheduledWorkout !== 'Sick') {
                    scheduled++;
                    if (actualWorkout) {
                        completed++;
                    } else if (d < today) { // Don't count future dates as missed
                        missed++;
                    }
                }
            }
            
            const adherenceScore = scheduled > 0 ? Math.round((completed / scheduled) * 100) : 0;
            
            return {
                score: adherenceScore,
                completed,
                scheduled,
                missed
            };
        }
        // Enhanced Analytics Functions
        function calculateTotalVolume() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            return allWorkouts
                .filter(workout => {
                    const workoutDate = new Date(workout.date);
                    return workoutDate.getMonth() === thisMonth && workoutDate.getFullYear() === thisYear;
                })
                .reduce((total, workout) => {
                    return total + Object.values(workout.exercises || {}).reduce((exerciseTotal, exercise) => {
                        return exerciseTotal + exercise.sets.reduce((setTotal, set) => {
                            return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                        }, 0);
                    }, 0);
                }, 0);
        }

        function calculateWorkoutStreak() {
            if (allWorkouts.length === 0) return 0;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Sort workouts by date (most recent first)
            const sortedWorkouts = allWorkouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Check if the most recent workout is within the last scheduled workout day
            const mostRecentWorkout = sortedWorkouts[0];
            const mostRecentDate = new Date(mostRecentWorkout.date);
            mostRecentDate.setHours(0, 0, 0, 0);
            
            // Calculate days since last workout
            const daysSinceLastWorkout = Math.floor((today - mostRecentDate) / (1000 * 60 * 60 * 24));
            
            // Check if there's a missed workout (excluding rest days and travel days)
            let hasMissedWorkout = false;
            for (let i = 0; i < daysSinceLastWorkout; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i - 1);
                const dateStr = checkDate.toISOString().split('T')[0];
                const scheduled = getScheduledWorkout(dateStr);
                const actual = getWorkoutForDate(dateStr);
                
                // Only count as missed if it was a scheduled workout (not rest or travel)
                if (scheduled !== 'Rest' && scheduled !== 'Travel' && !actual) {
                    hasMissedWorkout = true;
                    break;
                }
            }
            
            // If there's a missed workout day, streak is broken
            if (hasMissedWorkout) {
                return 0;
            }
            
            // Count consecutive workouts (not days, but completed scheduled workout days)
            let streak = 0;
            let checkDate = new Date(today);
            checkDate.setHours(0, 0, 0, 0);
            
            // Go backwards day by day and check for completed scheduled workouts
            for (let daysBack = 0; daysBack < 365; daysBack++) {
                const dateStr = checkDate.toISOString().split('T')[0];
                const scheduled = getScheduledWorkout(dateStr);
                const actual = getWorkoutForDate(dateStr);
                
                // Only count scheduled workout days (not rest or travel)
                if (scheduled !== 'Rest' && scheduled !== 'Travel') {
                    // This was a scheduled workout day
                    if (actual) {
                        streak++;
                    } else if (checkDate < today) {
                        // Missed a past scheduled workout - streak ends
                        break;
                    }
                }
                
                checkDate.setDate(checkDate.getDate() - 1);
            }
            
            return streak;
        }

        function calculatePRCount() {
            const today = new Date();
            const sevenDaysAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
            
            const recentPRs = getRecentPRs(7);
            return recentPRs.length;
        }

        function detectPlateaus() {
            const plateaus = [];
            const workoutsByDay = {};
            
            // Group recent workouts by day
            allWorkouts.slice(0, 12).forEach(workout => {
                if (!workoutsByDay[workout.day]) workoutsByDay[workout.day] = [];
                workoutsByDay[workout.day].push(workout);
            });
            
            // Check each exercise for plateaus
            Object.keys(workoutsByDay).forEach(dayType => {
                const dayWorkouts = workoutsByDay[dayType].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (dayWorkouts.length < 3) return;
                
                const exerciseMap = {};
                
                // Track exercise progression
                dayWorkouts.forEach(workout => {
                    Object.values(workout.exercises || {}).forEach(exercise => {
                        if (exercise.exercise.toLowerCase().includes('stretch') || workout.day === 'Rest') return;
                        
                        if (!exerciseMap[exercise.exercise]) {
                            exerciseMap[exercise.exercise] = [];
                        }
                        
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        const maxReps = Math.max(...exercise.sets.map(set => parseInt(set.reps) || 0));
                        const totalVolume = exercise.sets.reduce((sum, set) => 
                            sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0);
                        
                        exerciseMap[exercise.exercise].push({
                            date: workout.date,
                            maxWeight,
                            maxReps,
                            totalVolume
                        });
                    });
                });
                
                // Detect plateaus
                Object.keys(exerciseMap).forEach(exerciseName => {
                    const progression = exerciseMap[exerciseName].slice(0, 3);
                    
                    if (progression.length < 3) return;
                    
                    // Check if weight hasn't increased in 3 sessions
                    const weights = progression.map(p => p.maxWeight);
                    const hasWeightProgression = weights.some((w, i) => i > 0 && w > weights[i-1]);
                    
                    // Check if volume is declining
                    const volumes = progression.map(p => p.totalVolume);
                    const hasVolumeDecline = volumes.length >= 2 && volumes[0] < volumes[1];
                    
                    if (!hasWeightProgression || hasVolumeDecline) {
                        plateaus.push({
                            exercise: exerciseName,
                            sessions: progression.length,
                            lastWeight: weights[0],
                            suggestion: generatePlateauSuggestion(exerciseName, progression)
                        });
                    }
                });
            });
            
            return plateaus;
        }

        function generatePlateauSuggestion(exerciseName, progression) {
            const isCompound = ['squat', 'bench', 'deadlift', 'press'].some(compound => 
                exerciseName.toLowerCase().includes(compound));
            
            if (isCompound) {
                return `Try micro-loading (+2.5lbs) or add pause reps at 90% weight`;
            } else {
                return `Consider adding 1 set or trying drop sets for volume progression`;
            }
        }
        function generateAdvancedSuggestions() {
            if (allWorkouts.length === 0) {
                return [{
                    type: 'motivation',
                    text: 'Start logging workouts to get personalized AI suggestions!'
                }];
            }
            
            const suggestions = [];
            
            // Get plateaus
            const plateaus = detectPlateaus();
            
            // Plateau alerts
            plateaus.slice(0, 2).forEach(plateau => {
                suggestions.push({
                    type: 'plateau',
                    text: `${plateau.exercise} has plateaued for ${plateau.sessions} sessions. ${plateau.suggestion}`
                });
            });
            
            // Get last workout for current day
            const lastWorkout = allWorkouts.find(w => w.day === currentDay);
            
            if (lastWorkout) {
                const daysSince = Math.floor((Date.now() - new Date(lastWorkout.date).getTime()) / (1000 * 60 * 60 * 24));
                
                if (daysSince > 7) {
                    suggestions.push({
                        type: 'recovery',
                        text: `It's been ${daysSince} days since your last ${currentDay} workout. You should feel strong today!`
                    });
                } else if (daysSince === 0) {
                    suggestions.push({
                        type: 'warning',
                        text: `You already trained ${currentDay} today. Consider rest or a different muscle group.`
                    });
                }
                
                // Smart progression suggestions
                Object.values(lastWorkout.exercises || {}).forEach((exercise, idx) => {
                    if (idx < 2 && !exercise.exercise.toLowerCase().includes('stretch') && lastWorkout.day !== 'Rest') {
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        const completedReps = exercise.sets.map(set => parseInt(set.reps) || 0);
                        const avgReps = completedReps.reduce((a, b) => a + b, 0) / completedReps.length;
                        
                        if (maxWeight > 0) {
                            // If consistently hitting high reps, suggest weight increase
                            if (avgReps >= 10 && completedReps.every(r => r >= 8)) {
                                suggestions.push({
                                    type: 'progression',
                                    text: `${exercise.exercise}: Strong performance (${maxWeight}lbs Ã— ${Math.round(avgReps)}). Try ${maxWeight + 5}lbs next time!`
                                });
                            }
                            // If struggling with reps, suggest technique focus
                            else if (avgReps < 6 && maxWeight > 0) {
                                suggestions.push({
                                    type: 'technique',
                                    text: `${exercise.exercise}: Focus on form at ${maxWeight - 5}lbs or add more warm-up sets`
                                });
                            }
                        }
                    }
                });
            }
            
            // Consistency suggestions
            const recentWorkouts = allWorkouts.slice(0, 7);
            if (recentWorkouts.length >= 3) {
                const consistency = (recentWorkouts.length / 7) * 100;
                if (consistency >= 60) {
                    suggestions.push({
                        type: 'motivation',
                        text: `Excellent consistency! ${Math.round(consistency)}% workout rate this week.`
                    });
                }
            } else if (recentWorkouts.length === 1) {
                suggestions.push({
                    type: 'consistency',
                    text: 'Great job getting back to training! Aim for 3-4 sessions this week.'
                });
            }
            
            return suggestions.slice(0, 4);
        }

        function calculateMuscleGroupVolumes() {
            const volumes = { Push: 0, Pull: 0, Legs: 0, Upper: 0, Lower: 0 };
            
            allWorkouts.slice(0, 8).forEach(workout => {
                if (workout.day === 'Rest') return;
                
                const workoutVolume = Object.values(workout.exercises || {}).reduce((total, exercise) => {
                    return total + exercise.sets.reduce((setTotal, set) => {
                        return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                    }, 0);
                }, 0);
                
                volumes[workout.day] = (volumes[workout.day] || 0) + workoutVolume;
            });
            
            return volumes;
        }

        function calculateWorkoutVolume(workout) {
            if (workout.day === 'Rest') return 0;
            
            return Object.values(workout.exercises || {}).reduce((total, exercise) => {
                return total + exercise.sets.reduce((setTotal, set) => {
                    return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                }, 0);
            }, 0);
        }

        // Get all workouts of a specific type (e.g., all "Upper" workouts)
        function getWorkoutsByType(workoutType) {
            return allWorkouts.filter(workout => workout.day === workoutType);
        }

        // Calculate record volume for a workout type
        function getRecordVolumeForType(workoutType) {
            const workouts = getWorkoutsByType(workoutType);
            if (workouts.length === 0) return 0;
            
            return Math.max(...workouts.map(workout => calculateWorkoutVolume(workout)));
        }

        // Calculate average volume for a workout type in current month
        function getCurrentMonthAverageVolume(workoutType) {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const monthWorkouts = allWorkouts.filter(workout => {
                const workoutDate = new Date(workout.date);
                return workout.day === workoutType && 
                       workoutDate.getMonth() === thisMonth && 
                       workoutDate.getFullYear() === thisYear;
            });
            
            if (monthWorkouts.length === 0) return 0;
            
            const totalVolume = monthWorkouts.reduce((sum, workout) => sum + calculateWorkoutVolume(workout), 0);
            return Math.round(totalVolume / monthWorkouts.length);
        }

        // Calculate average volume for a workout type in last month
        function getLastMonthAverageVolume(workoutType) {
            const lastMonth = new Date().getMonth() - 1;
            const year = lastMonth < 0 ? new Date().getFullYear() - 1 : new Date().getFullYear();
            const month = lastMonth < 0 ? 11 : lastMonth;
            
            const monthWorkouts = allWorkouts.filter(workout => {
                const workoutDate = new Date(workout.date);
                return workout.day === workoutType && 
                       workoutDate.getMonth() === month && 
                       workoutDate.getFullYear() === year;
            });
            
            if (monthWorkouts.length === 0) return 0;
            
            const totalVolume = monthWorkouts.reduce((sum, workout) => sum + calculateWorkoutVolume(workout), 0);
            return Math.round(totalVolume / monthWorkouts.length);
        }

        // Get trend direction for last 3 sessions
        function getTrendDirection(workoutType) {
            const workouts = getWorkoutsByType(workoutType).slice(0, 3);
            if (workouts.length < 2) return 'â†’';
            
            const volumes = workouts.map(w => calculateWorkoutVolume(w)).reverse();
            
            // Check if trending up
            let isIncreasing = true;
            let isDecreasing = true;
            
            for (let i = 1; i < volumes.length; i++) {
                if (volumes[i] <= volumes[i - 1]) isIncreasing = false;
                if (volumes[i] >= volumes[i - 1]) isDecreasing = false;
            }
            
            if (isIncreasing) return 'â†—ï¸';
            if (isDecreasing) return 'â†˜ï¸';
            return 'â†’';
        }

        // Find exercises with recent PRs
        function getRecentPRs(daysBack) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysBack);
            
            const exercisePRs = {};
            const recentPRs = [];
            
            // Build PR history chronologically
            allWorkouts.slice().reverse().forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (!exercise.exercise.toLowerCase().includes('stretch')) {
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        
                        if (maxWeight > 0) {
                            const exerciseName = exercise.exercise;
                            const currentPR = exercisePRs[exerciseName] || 0;
                            
                            if (maxWeight > currentPR) {
                                const workoutDate = new Date(workout.date);
                                if (workoutDate >= cutoffDate) {
                                    recentPRs.push({ exercise: exerciseName, weight: maxWeight, date: workout.date });
                                }
                                exercisePRs[exerciseName] = maxWeight;
                            }
                        }
                    }
                });
            });
            
            return recentPRs;
        }

        // Find exercises without progression
        function getPlateauedExercises(sessionsBack) {
            const exerciseHistory = {};
            
            // Track last N sessions for each exercise
            allWorkouts.slice(0, sessionsBack * 2).forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (!exercise.exercise.toLowerCase().includes('stretch')) {
                        const exerciseName = exercise.exercise;
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        
                        if (maxWeight > 0) {
                            if (!exerciseHistory[exerciseName]) {
                                exerciseHistory[exerciseName] = [];
                            }
                            exerciseHistory[exerciseName].push(maxWeight);
                        }
                    }
                });
            });
            
            // Find exercises that haven't progressed
            const plateaued = [];
            Object.keys(exerciseHistory).forEach(exercise => {
                const weights = exerciseHistory[exercise].slice(0, sessionsBack);
                if (weights.length >= sessionsBack) {
                    const hasProgress = weights.some((weight, idx) => idx > 0 && weight > weights[idx - 1]);
                    if (!hasProgress) {
                        plateaued.push({ exercise, weight: weights[0] });
                    }
                }
            });
            
            return plateaued.slice(0, 3);
        }

        // Get all unique exercises from workout history
        function getAllExercises() {
            const exercises = new Set();
            allWorkouts.forEach(workout => {
                if (workout.day !== 'Rest') {
                    Object.values(workout.exercises || {}).forEach(exercise => {
                        if (!exercise.exercise.toLowerCase().includes('stretch')) {
                            exercises.add(exercise.exercise);
                        }
                    });
                }
            });
            return Array.from(exercises).sort();
        }

        // Get exercise progression data for PR Timeline (specific exercise)
        function getExerciseProgressionForTimeline(exerciseName) {
            const progression = [];
            
            allWorkouts.slice().reverse().forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (exercise.exercise === exerciseName) {
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        if (maxWeight > 0) {
                            progression.push({
                                x: workout.date,
                                y: maxWeight,
                                isPR: false
                            });
                        }
                    }
                });
            });
            
            // Mark PRs
            let currentPR = 0;
            progression.forEach(point => {
                if (point.y > currentPR) {
                    point.isPR = true;
                    currentPR = point.y;
                }
            });
            
            return progression;
        }

        // Get exercises showing consistent improvement
        function getTrendingUpExercises() {
            const exerciseHistory = {};
            
            // Track recent sessions for each exercise
            allWorkouts.slice(0, 10).forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (!exercise.exercise.toLowerCase().includes('stretch')) {
                        const exerciseName = exercise.exercise;
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        
                        if (maxWeight > 0) {
                            if (!exerciseHistory[exerciseName]) {
                                exerciseHistory[exerciseName] = [];
                            }
                            exerciseHistory[exerciseName].push(maxWeight);
                        }
                    }
                });
            });
            
            // Find exercises trending up
            const trending = [];
            Object.keys(exerciseHistory).forEach(exercise => {
                const weights = exerciseHistory[exercise].slice(0, 4);
                if (weights.length >= 3) {
                    // Check if generally increasing
                    const increases = weights.filter((weight, idx) => idx > 0 && weight > weights[idx - 1]).length;
                    if (increases >= 2) {
                        trending.push(exercise);
                    }
                }
            });
            
            return trending.slice(0, 5);
        }

        // Get days since last workout of a specific type
        function getDaysSinceLastWorkout(workoutType) {
            const workouts = getWorkoutsByType(workoutType);
            if (workouts.length === 0) return null;
            
            const lastWorkout = new Date(workouts[0].date);
            const today = new Date();
            return Math.floor((today - lastWorkout) / (1000 * 60 * 60 * 24));
        }

        function generateAIInsights() {
            if (allWorkouts.length < 3) {
                return [
                    "Complete more workouts to unlock AI insights!",
                    "Aim for consistency - 3-4 workouts per week is ideal.",
                    "Focus on progressive overload - gradually increase weight or reps."
                ];
            }
            
            const insights = [];
            
            // Workout frequency analysis
            const workoutDays = allWorkouts.slice(0, 10).map(w => new Date(w.date).getDay());
            const dayFrequency = {};
            workoutDays.forEach(day => {
                dayFrequency[day] = (dayFrequency[day] || 0) + 1;
            });
            
            if (Object.keys(dayFrequency).length > 0) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const preferredDay = Object.keys(dayFrequency).reduce((a, b) => dayFrequency[a] > dayFrequency[b] ? a : b);
                insights.push(`You train most often on ${dayNames[preferredDay]}s - this seems to be your power day!`);
            }
            
            // Volume analysis
            const totalVolume = allWorkouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0);
            const avgVolumePerWorkout = Math.round(totalVolume / allWorkouts.length);
            insights.push(`Your average workout volume is ${avgVolumePerWorkout.toLocaleString()}lbs - solid training stimulus.`);
            
            // Data requirements: minimum 5 workouts, 5 nutrition days, 5 weight entries
            const hasEnoughData = allWorkouts.length >= 5 && 
                                   window.nutritionData && window.nutritionData.length >= 5 && 
                                   window.weightData && window.weightData.length >= 5;
            
            if (hasEnoughData) {
                console.log('Calculating correlation insights with sufficient data...');
                
                // 1. Strength vs. Weight Changes
                // Compare last 2 weeks vs prior 2 weeks
                const today = new Date();
                const twoWeeksAgo = new Date(today.getTime() - (14 * 24 * 60 * 60 * 1000));
                const fourWeeksAgo = new Date(today.getTime() - (28 * 24 * 60 * 60 * 1000));
                
                const recentWorkouts = allWorkouts.filter(w => new Date(w.date) >= twoWeeksAgo);
                const priorWorkouts = allWorkouts.filter(w => {
                    const date = new Date(w.date);
                    return date >= fourWeeksAgo && date < twoWeeksAgo;
                });
                
                if (recentWorkouts.length > 0 && priorWorkouts.length > 0) {
                    const recentVolume = recentWorkouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0) / recentWorkouts.length;
                    const priorVolume = priorWorkouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0) / priorWorkouts.length;
                    const volumeChangePercent = priorVolume > 0 ? Math.round(((recentVolume - priorVolume) / priorVolume) * 100) : 0;
                    
                    console.log(`Volume change: ${volumeChangePercent}%`);
                    
                    // Weight changes
                    const recentWeights = window.weightData.filter(w => new Date(w.date) >= twoWeeksAgo);
                    const priorWeights = window.weightData.filter(w => {
                        const date = new Date(w.date);
                        return date >= fourWeeksAgo && date < twoWeeksAgo;
                    });
                    
                    if (recentWeights.length > 0 && priorWeights.length > 0) {
                        const avgRecentWeight = recentWeights.reduce((sum, w) => sum + parseFloat(w.weight), 0) / recentWeights.length;
                        const avgPriorWeight = priorWeights.reduce((sum, w) => sum + parseFloat(w.weight), 0) / priorWeights.length;
                        const weightChange = avgRecentWeight - avgPriorWeight;
                        
                        console.log(`Weight change: ${weightChange.toFixed(1)}lbs`);
                        
                        // Generate strength vs weight correlation insight
                        if (volumeChangePercent > 5 && weightChange > 1) {
                            insights.push(`Your strength is up ${volumeChangePercent}% while weight increased ${weightChange.toFixed(1)}lbs - excellent lean mass gains!`);
                        } else if (Math.abs(volumeChangePercent) < 5 && weightChange < -2) {
                            insights.push(`Strength maintaining while weight down ${Math.abs(weightChange).toFixed(1)}lbs - good cutting progress`);
                        } else if (Math.abs(weightChange) < 1 && volumeChangePercent > 10) {
                            insights.push(`Weight stable but strength up ${volumeChangePercent}% - great recomp!`);
                        } else if (volumeChangePercent < -5 && weightChange < -3) {
                            insights.push(`Strength declining ${Math.abs(volumeChangePercent)}% while weight down ${Math.abs(weightChange).toFixed(1)}lbs - may need more calories`);
                        }
                    }
                }
                
                // 2. Nutrition Adequacy (Past 7 Days)
                const last7Days = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
                const recentNutrition = window.nutritionData.filter(n => new Date(n.date) >= last7Days);
                
                // Get workout days in last 7 days
                const recentWorkoutDates = allWorkouts
                    .filter(w => new Date(w.date) >= last7Days)
                    .map(w => w.date);
                const workoutDaysCount = recentWorkoutDates.length;
                
                // Group nutrition by date and calculate daily totals
                const dailyNutrition = {};
                recentNutrition.forEach(meal => {
                    if (!dailyNutrition[meal.date]) {
                        dailyNutrition[meal.date] = { protein: 0, carbs: 0, fats: 0, calories: 0 };
                    }
                    (meal.foods || []).forEach(food => {
                        const qty = food.quantity || 1;
                        dailyNutrition[meal.date].protein += (parseFloat(food.protein) || 0) * qty;
                        dailyNutrition[meal.date].carbs += (parseFloat(food.carbs) || 0) * qty;
                        dailyNutrition[meal.date].fats += (parseFloat(food.fats) || 0) * qty;
                        dailyNutrition[meal.date].calories += (parseFloat(food.calories) || 0) * qty;
                    });
                });
                
                // Filter out days with zero nutrition (not logged)
                const datesWithNutrition = Object.keys(dailyNutrition).filter(date => 
                    dailyNutrition[date].protein > 0 || dailyNutrition[date].calories > 0
                );
                
                if (datesWithNutrition.length >= 3) {
                    // Separate workout days and rest days
                    const workoutDayData = datesWithNutrition.filter(date => recentWorkoutDates.includes(date));
                    const restDayData = datesWithNutrition.filter(date => !recentWorkoutDates.includes(date));
                    
                    if (workoutDayData.length > 0) {
                        const workoutAvgProtein = Math.round(
                            workoutDayData.reduce((sum, date) => sum + dailyNutrition[date].protein, 0) / workoutDayData.length
                        );
                        const workoutAvgCalories = Math.round(
                            workoutDayData.reduce((sum, date) => sum + dailyNutrition[date].calories, 0) / workoutDayData.length
                        );
                        
                        console.log(`Avg protein on workout days (${workoutDayData.length} days): ${workoutAvgProtein}g`);
                        
                        if (workoutAvgProtein >= 150 && workoutDaysCount >= 3) {
                            insights.push(`Averaging ${workoutAvgProtein}g protein on ${workoutDayData.length} workout days (past 7 days) - excellent for muscle growth`);
                        } else if (workoutAvgProtein < 120 && workoutDaysCount >= 2) {
                            insights.push(`Only ${workoutAvgProtein}g protein on workout days (${workoutDayData.length} days tracked) - aim for 0.8-1g per lb bodyweight`);
                        }
                    }
                    
                    if (restDayData.length > 0 && workoutDayData.length > 0) {
                        const restAvgProtein = Math.round(
                            restDayData.reduce((sum, date) => sum + dailyNutrition[date].protein, 0) / restDayData.length
                        );
                        const workoutAvgProtein = Math.round(
                            workoutDayData.reduce((sum, date) => sum + dailyNutrition[date].protein, 0) / workoutDayData.length
                        );
                        
                        if (restAvgProtein < workoutAvgProtein - 30) {
                            insights.push(`Rest day protein (${restAvgProtein}g avg) is much lower than workout days (${workoutAvgProtein}g) - keep protein consistent for recovery`);
                        }
                    }
                }
                
                // 3. Recovery Indicators - correlate intensity ratings with volume changes
                const workoutsWithIntensity = allWorkouts.filter(w => w.intensity && 
                    (w.intensity.energy || w.intensity.motivation || w.intensity.fatigue || w.intensity.satisfaction));
                
                if (workoutsWithIntensity.length >= 5) {
                    const recentIntensity = workoutsWithIntensity.slice(0, 7);
                    
                    const avgEnergy = recentIntensity.reduce((sum, w) => sum + (w.intensity.energy || 0), 0) / recentIntensity.length;
                    const avgFatigue = recentIntensity.reduce((sum, w) => sum + (w.intensity.fatigue || 0), 0) / recentIntensity.length;
                    const avgSatisfaction = recentIntensity.reduce((sum, w) => sum + (w.intensity.satisfaction || 0), 0) / recentIntensity.length;
                    
                    console.log(`Recent intensity - Energy: ${avgEnergy.toFixed(1)}, Fatigue: ${avgFatigue.toFixed(1)}, Satisfaction: ${avgSatisfaction.toFixed(1)}`);
                    
                    // Compare recent vs prior volume (only if we have enough data)
                    if (recentIntensity.length >= 6) {
                        const recentVol = recentIntensity.slice(0, 3).reduce((sum, w) => sum + calculateWorkoutVolume(w), 0) / 3;
                        const priorVol = recentIntensity.slice(3, 6).reduce((sum, w) => sum + calculateWorkoutVolume(w), 0) / 3;
                        const volChange = priorVol > 0 ? Math.round(((recentVol - priorVol) / priorVol) * 100) : 0;
                    
                        if (avgEnergy < 2.5 && volChange > 0) {
                            insights.push(`Low energy scores (avg ${avgEnergy.toFixed(1)}/5) last week but volume still up - good mental toughness`);
                        } else if (avgFatigue > 3.5 && volChange < -10) {
                            insights.push(`High fatigue scores correlate with ${Math.abs(volChange)}% volume drop - consider deload week`);
                        }
                    }
                    
                    // Add satisfaction insight regardless of volume data
                    if (avgSatisfaction >= 4.5) {
                        insights.push(`Satisfaction scores averaging ${avgSatisfaction.toFixed(1)}/5 - training is going well!`);
                    }
                }
            }
            
            return insights;
        }

        function getLastWorkoutForDay(day, exerciseApproach = null) {
            // Filter workouts by day
            const dayWorkouts = allWorkouts.filter(workout => workout.day === day);
            
            if (dayWorkouts.length === 0) return null;
            
            // If no specific approach requested, return the most recent workout
            if (!exerciseApproach) {
                return dayWorkouts[0];
            }
            
            // Filter by matching approach (standard, heavy, form focus, etc.)
            const matchingWorkouts = dayWorkouts.filter(workout => {
                // Check if this workout has exercises with the matching approach
                const exercises = Object.values(workout.exercises || {});
                return exercises.some(ex => {
                    const workoutApproach = ex.approach || 'standard';
                    return workoutApproach.toLowerCase() === exerciseApproach.toLowerCase();
                });
            });
            
            return matchingWorkouts.length > 0 ? matchingWorkouts[0] : dayWorkouts[0];
        }

        function getPersonalRecords() {
            const prs = {};
            
            allWorkouts.forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (exercise.exercise.toLowerCase().includes('stretch')) return;
                    
                    exercise.sets.forEach(set => {
                        const weight = parseFloat(set.weight);
                        const reps = parseInt(set.reps);
                        
                        if (weight && reps) {
                            const exerciseName = exercise.exercise;
                            if (!prs[exerciseName] || weight > prs[exerciseName].weight) {
                                prs[exerciseName] = { weight, reps, date: workout.date };
                            }
                        }
                    });
                });
            });
            
            return prs;
        }

        function getExerciseProgression() {
            const progression = {};
            
            // Group workouts by exercise
            allWorkouts.forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (exercise.exercise.toLowerCase().includes('stretch')) return;
                    
                    if (!progression[exercise.exercise]) {
                        progression[exercise.exercise] = [];
                    }
                    
                    const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                    const maxReps = Math.max(...exercise.sets.map(set => parseInt(set.reps) || 0));
                    const totalVolume = exercise.sets.reduce((sum, set) => 
                        sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0);
                    
                    progression[exercise.exercise].push({
                        date: workout.date,
                        maxWeight,
                        maxReps,
                        totalVolume,
                        rawSets: exercise.sets
                    });
                });
            });
            
            // Sort by date and analyze progression
            const progressionSummary = {};
            Object.keys(progression).forEach(exerciseName => {
                const sessions = progression[exerciseName].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (sessions.length >= 2) {
                    const latest = sessions[0];
                    const previous = sessions[1];
                    
                    let progressionText = '';
                    let progressionType = 'none';
                    
                    if (latest.maxWeight > previous.maxWeight) {
                        progressionText = `${previous.maxWeight}lbs â†’ ${latest.maxWeight}lbs (+${latest.maxWeight - previous.maxWeight}lbs)`;
                        progressionType = 'strength';
                    } else if (latest.maxWeight === previous.maxWeight && latest.maxReps > previous.maxReps) {
                        progressionText = `${latest.maxWeight}lbs: ${previous.maxReps} â†’ ${latest.maxReps} reps (+${latest.maxReps - previous.maxReps})`;
                        progressionType = 'volume';
                    } else if (latest.totalVolume > previous.totalVolume) {
                        progressionText = `Volume: ${previous.totalVolume} â†’ ${latest.totalVolume} lbs (+${Math.round(((latest.totalVolume - previous.totalVolume) / previous.totalVolume) * 100)}%)`;
                        progressionType = 'total_volume';
                    } else {
                        progressionText = `${latest.maxWeight}lbs Ã— ${latest.maxReps} (maintaining)`;
                        progressionType = 'maintaining';
                    }
                    
                    const daysSince = Math.floor((new Date() - new Date(latest.date)) / (1000 * 60 * 60 * 24));
                    
                    progressionSummary[exerciseName] = {
                        progression: progressionText,
                        type: progressionType,
                        daysSince,
                        sessions: sessions.length
                    };
                }
            });
            
            return progressionSummary;
        }

        // Chart Functions
        function createPRTimelineChart(exerciseName) {
            const ctx = document.getElementById('pr-timeline-chart');
            if (!ctx) return;
            
            if (charts.prTimeline) charts.prTimeline.destroy();
            
            if (!exerciseName) {
                // No exercise selected
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }
            
            const progression = getExerciseProgressionForTimeline(exerciseName);
            
            if (progression.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }
            
            const maxWeight = Math.max(...progression.map(p => p.y));
            
            // Separate PR points from regular points
            const prPoints = progression.filter(p => p.isPR);
            const regularPoints = progression.filter(p => !p.isPR);
            
            const datasets = [];
            
            // Regular progression line
            if (regularPoints.length > 0) {
                datasets.push({
                    label: 'Weight',
                    data: progression.map(p => ({ x: p.x, y: p.y })),
                    borderColor: '#4A5D4A',
                    backgroundColor: 'rgba(74, 93, 74, 0.15)',
                    pointRadius: 4,
                    pointBackgroundColor: '#4A5D4A',
                    tension: 0.4,
                    fill: true
                });
            }
            
            // PR points overlay
            if (prPoints.length > 0) {
                datasets.push({
                    label: 'PRs',
                    data: prPoints.map(p => ({ x: p.x, y: p.y })),
                    borderColor: '#5D8A66',
                    backgroundColor: '#5D8A66',
                    pointRadius: 8,
                    pointStyle: 'star',
                    showLine: false
                });
            }
            
            charts.prTimeline = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: { color: 'var(--color-text-secondary)' }
                        },
                        title: {
                            display: true,
                            text: `Max Weight: ${maxWeight} lbs`,
                            color: '#ffffff',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            ticks: { color: 'var(--color-text-secondary)' },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Weight (lbs)', color: 'var(--color-text-secondary)' },
                            ticks: { color: 'var(--color-text-secondary)' },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' }
                        }
                    }
                }
            });
        }

        function updateSessionComparison(workoutType) {
            const workouts = getWorkoutsByType(workoutType);
            const container = document.getElementById('session-comparison-content');
            
            if (workouts.length < 2) {
                container.innerHTML = '<p>Need at least 2 sessions to compare</p>';
                return;
            }
            
            const lastSession = workouts[0];
            const previousSession = workouts[1];
            
            const lastVolume = calculateWorkoutVolume(lastSession);
            const previousVolume = calculateWorkoutVolume(previousSession);
            
            const volumeChange = lastVolume - previousVolume;
            const volumeChangePercent = previousVolume > 0 ? Math.round((volumeChange / previousVolume) * 100) : 0;
            
            const isImproving = volumeChange > 0;
            const changeColor = isImproving ? 'var(--color-success)' : 'var(--color-error)';
            const changeIcon = isImproving ? 'âœ“' : 'âœ—';
            
            // Exercise-by-exercise comparison
            const exerciseChanges = { increased: [], decreased: [], plateaued: [] };
            
            // Get exercises from last session
            Object.values(lastSession.exercises || {}).forEach(lastExercise => {
                const exerciseName = lastExercise.exercise;
                
                // Find matching exercise in previous session
                const previousExercise = Object.values(previousSession.exercises || {})
                    .find(ex => ex.exercise === exerciseName);
                
                if (previousExercise) {
                    // Calculate max weight Ã— reps for each session
                    const lastMax = Math.max(...lastExercise.sets.map(set => 
                        (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0)
                    ));
                    const previousMax = Math.max(...previousExercise.sets.map(set => 
                        (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0)
                    ));
                    
                    // Find the sets that correspond to those max values
                    const lastBestSet = lastExercise.sets.find(set => 
                        (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0) === lastMax
                    );
                    const previousBestSet = previousExercise.sets.find(set => 
                        (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0) === previousMax
                    );
                    
                    const lastWeight = parseFloat(lastBestSet?.weight) || 0;
                    const lastReps = parseInt(lastBestSet?.reps) || 0;
                    const previousWeight = parseFloat(previousBestSet?.weight) || 0;
                    const previousReps = parseInt(previousBestSet?.reps) || 0;
                    
                    if (lastMax > previousMax) {
                        exerciseChanges.increased.push({
                            name: exerciseName,
                            previous: `${previousWeight}Ã—${previousReps}`,
                            current: `${lastWeight}Ã—${lastReps}`
                        });
                    } else if (lastMax < previousMax) {
                        exerciseChanges.decreased.push({
                            name: exerciseName,
                            previous: `${previousWeight}Ã—${previousReps}`,
                            current: `${lastWeight}Ã—${lastReps}`
                        });
                    }
                    // Note: Plateaued detection requires 3+ sessions, handled separately
                }
            });
            
            // Build exercise breakdown HTML
            let exerciseBreakdownHTML = '';
            if (exerciseChanges.increased.length > 0) {
                exerciseBreakdownHTML += `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(93, 138, 102, 0.1); border-radius: 8px; border-left: 3px solid #5D8A66;">
                        <div style="color: #5D8A66; font-weight: bold; margin-bottom: 0.5rem;">â†‘ Increased</div>
                        ${exerciseChanges.increased.map(ex => 
                            `<div style="font-size: 0.9rem; margin: 0.25rem 0;">â€¢ ${ex.name}: ${ex.previous} â†’ ${ex.current}</div>`
                        ).join('')}
                    </div>
                `;
            }
            
            if (exerciseChanges.decreased.length > 0) {
                exerciseBreakdownHTML += `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(196, 115, 109, 0.1); border-radius: 8px; border-left: 3px solid #C4736D;">
                        <div style="color: #C4736D; font-weight: bold; margin-bottom: 0.5rem;">â†“ Decreased</div>
                        ${exerciseChanges.decreased.map(ex => 
                            `<div style="font-size: 0.9rem; margin: 0.25rem 0;">â€¢ ${ex.name}: ${ex.previous} â†’ ${ex.current}</div>`
                        ).join('')}
                    </div>
                `;
            }
            
            // Check for plateaued exercises (need 3+ sessions)
            if (workouts.length >= 3) {
                const plateauedExercises = [];
                const thirdSession = workouts[2];
                
                Object.values(lastSession.exercises || {}).forEach(lastEx => {
                    const exName = lastEx.exercise;
                    const prevEx = Object.values(previousSession.exercises || {}).find(e => e.exercise === exName);
                    const thirdEx = Object.values(thirdSession.exercises || {}).find(e => e.exercise === exName);
                    
                    if (prevEx && thirdEx) {
                        const lastMax = Math.max(...lastEx.sets.map(s => (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0)));
                        const prevMax = Math.max(...prevEx.sets.map(s => (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0)));
                        const thirdMax = Math.max(...thirdEx.sets.map(s => (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0)));
                        
                        if (lastMax === prevMax && prevMax === thirdMax && lastMax > 0) {
                            const bestSet = lastEx.sets.find(s => (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0) === lastMax);
                            plateauedExercises.push({
                                name: exName,
                                value: `${parseFloat(bestSet?.weight) || 0}Ã—${parseInt(bestSet?.reps) || 0}`
                            });
                        }
                    }
                });
                
                if (plateauedExercises.length > 0) {
                    exerciseBreakdownHTML += `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(212, 168, 75, 0.1); border-radius: 8px; border-left: 3px solid #D4A84B;">
                            <div style="color: #D4A84B; font-weight: bold; margin-bottom: 0.5rem;">Plateaued (3+ sessions)</div>
                            ${plateauedExercises.map(ex => 
                                `<div style="font-size: 0.9rem; margin: 0.25rem 0;">â€¢ ${ex.name}: ${ex.value}</div>`
                            ).join('')}
                        </div>
                    `;
                }
            }
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <strong style="color: white;">Last Session</strong>
                        <div style="margin-top: 0.5rem;">
                            <div>Volume: <strong>${lastVolume.toLocaleString()} lbs</strong></div>
                            <div style="font-size: 0.8rem; color: var(--color-text-secondary);">${new Date(lastSession.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div>
                        <strong style="color: white;">Previous Session</strong>
                        <div style="margin-top: 0.5rem;">
                            <div>Volume: <strong>${previousVolume.toLocaleString()} lbs</strong></div>
                            <div style="font-size: 0.8rem; color: var(--color-text-secondary);">${new Date(previousSession.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: ${isImproving ? 'rgba(93, 138, 102, 0.1)' : 'rgba(196, 115, 109, 0.1)'}; border-radius: 8px; border-left: 4px solid ${changeColor};">
                    <div style="color: ${changeColor}; font-weight: bold; font-size: 1.1rem;">
                        ${changeIcon} ${isImproving ? 'Improving' : 'Declining'}
                    </div>
                    <div style="margin-top: 0.5rem; color: var(--color-text-primary);">
                        Volume Change: <strong style="color: ${changeColor};">${volumeChange > 0 ? '+' : ''}${volumeChange.toLocaleString()} lbs (${volumeChangePercent > 0 ? '+' : ''}${volumeChangePercent}%)</strong>
                    </div>
                </div>
                ${exerciseBreakdownHTML}
            `;
        }

        function updateIntensityHeatmap() {
            const container = document.getElementById('heatmap-content');
            
            if (allWorkouts.length === 0) {
                container.innerHTML = '<p>Complete workouts to see intensity patterns!</p>';
                return;
            }
            
            // Get last 4 weeks of workouts
            const today = new Date();
            const fourWeeksAgo = new Date(today.getTime() - (28 * 24 * 60 * 60 * 1000));
            
            const recentWorkouts = allWorkouts.filter(w => {
                const workoutDate = new Date(w.date);
                return workoutDate >= fourWeeksAgo;
            });
            
            // Group by day of week
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const intensityByDay = {};
            
            dayNames.forEach(day => {
                intensityByDay[day] = [];
            });
            
            recentWorkouts.forEach(workout => {
                const workoutDate = new Date(workout.date);
                const dayOfWeek = dayNames[workoutDate.getDay()];
                
                // Calculate average intensity score (1-5 scale)
                const intensity = workout.intensity || {};
                const avgScore = (
                    (intensity.energy || 0) +
                    (intensity.motivation || 0) +
                    (6 - (intensity.fatigue || 1)) +  // Invert fatigue: 1->5, 2->4, 3->3, 4->2, 5->1
                    (intensity.satisfaction || 0)
                ) / 4;
                
                // Scale to 0-10 range
                const scaledScore = (avgScore / 5) * 10;
                
                intensityByDay[dayOfWeek].push(scaledScore);
            });
            
            // Calculate average for each day
            const dayAverages = {};
            Object.keys(intensityByDay).forEach(day => {
                const scores = intensityByDay[day];
                dayAverages[day] = scores.length > 0 
                    ? scores.reduce((a, b) => a + b, 0) / scores.length 
                    : 0;
            });
            
            // Create heatmap HTML
            const getColorForScore = (score) => {
                if (score === 0) return 'rgba(71, 85, 105, 0.3)';
                if (score < 4) return 'var(--color-error)';
                if (score < 6) return 'var(--color-warning)';
                if (score < 8) return 'var(--color-success)';
                return 'var(--color-accent-primary)';
            };
            
            const heatmapHTML = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-top: 1rem;">
                    ${dayNames.map(day => {
                        const score = dayAverages[day];
                        const color = getColorForScore(score);
                        return `
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; margin-bottom: 0.5rem; color: var(--color-text-secondary);">${day}</div>
                                <div style="
                                    background: ${color};
                                    border-radius: 8px;
                                    padding: 1rem 0.5rem;
                                    font-weight: bold;
                                    color: white;
                                    font-size: 0.9rem;
                                ">
                                    ${score > 0 ? score.toFixed(1) : '-'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 1rem; font-size: 0.8rem; color: var(--color-text-secondary); text-align: center;">
                    Intensity score (0-10) - calculated from your 1-5 ratings. Fatigue is inverted (lower fatigue = higher score).
                </div>
            `;
            
            container.innerHTML = heatmapHTML;
        }
        
        // UI Functions
        function updateSuggestions() {
            const suggestions = generateAdvancedSuggestions();
            const container = document.getElementById('suggestions-container');
            
            container.innerHTML = suggestions.map(suggestion => `
                <div class="suggestion-card">
                    <div class="suggestion-type">${suggestion.type}</div>
                    <div class="suggestion-text">${suggestion.text}</div>
                </div>
            `).join('');
        }

        function updateAnalytics() {
            // Update basic stats
            document.getElementById('pr-count').textContent = calculatePRCount();
            document.getElementById('workout-streak').textContent = calculateWorkoutStreak();
            
            // Update volume cards for each workout type
            const workoutTypes = ['Upper', 'Lower', 'Push', 'Pull', 'Legs'];
            workoutTypes.forEach(type => {
                const typeKey = type.toLowerCase();
                
                // Record volume
                const recordVolume = getRecordVolumeForType(type);
                const recordElement = document.getElementById(`${typeKey}-record`);
                const recordLbsElement = document.getElementById(`${typeKey}-record-lbs`);
                if (recordElement && recordLbsElement) {
                    recordElement.textContent = recordVolume > 0 ? recordVolume.toLocaleString() : '0';
                    recordLbsElement.textContent = recordVolume > 0 ? recordVolume.toLocaleString() : '0';
                }
                
                // Current month average
                const currentAvg = getCurrentMonthAverageVolume(type);
                const avgElement = document.getElementById(`${typeKey}-avg`);
                if (avgElement) {
                    avgElement.textContent = currentAvg > 0 ? currentAvg.toLocaleString() : '0';
                }
                
                // Trend
                const trend = getTrendDirection(type);
                const trendElement = document.getElementById(`${typeKey}-trend`);
                if (trendElement) {
                    trendElement.textContent = trend;
                }
                
                // Month-over-month
                const lastMonthAvg = getLastMonthAverageVolume(type);
                const momElement = document.getElementById(`${typeKey}-mom`);
                if (momElement) {
                    if (currentAvg > 0 && lastMonthAvg > 0) {
                        const diff = currentAvg - lastMonthAvg;
                        const sign = diff > 0 ? '+' : '';
                        momElement.textContent = `${sign}${diff.toLocaleString()} lbs vs last month`;
                        momElement.style.color = diff > 0 ? 'var(--color-success)' : (diff < 0 ? 'var(--color-error)' : 'var(--color-text-secondary)');
                    } else if (currentAvg > 0) {
                        momElement.textContent = 'First month tracked';
                        momElement.style.color = 'var(--color-text-secondary)';
                    } else {
                        momElement.textContent = 'No data this month';
                        momElement.style.color = 'var(--color-text-secondary)';
                    }
                }
            });
            
            // Update exercise selector for PR Timeline
            const exerciseSelector = document.getElementById('exercise-selector');
            if (exerciseSelector) {
                const exercises = getAllExercises();
                exerciseSelector.innerHTML = '<option value="">Select an exercise</option>' +
                    exercises.map(ex => `<option value="${ex}">${ex}</option>`).join('');
                
                // Set default to first exercise if available
                if (exercises.length > 0) {
                    exerciseSelector.value = exercises[0];
                    createPRTimelineChart(exercises[0]);
                }
            }
            
            // Update session comparison with default (Upper)
            updateSessionComparison('Upper');
            
            // Update progression snapshot
            updateProgressionSnapshot();
            
            // Update focus areas
            updateFocusAreas();
            
            // Update intensity heatmap
            updateIntensityHeatmap();
        }

        function updateProgressionSnapshot() {
            // Quick Wins
            const recentPRs = getRecentPRs(7);
            const quickWinsElement = document.getElementById('quick-wins');
            if (quickWinsElement) {
                if (recentPRs.length > 0) {
                    const uniqueExercises = [...new Set(recentPRs.map(pr => pr.exercise))];
                    quickWinsElement.innerHTML = `<strong>${uniqueExercises.length}</strong> exercise${uniqueExercises.length !== 1 ? 's' : ''} hit PRs this week!`;
                    quickWinsElement.style.color = 'var(--color-success)';
                } else {
                    quickWinsElement.innerHTML = 'No PRs this week yet. Keep pushing!';
                    quickWinsElement.style.color = 'var(--color-text-secondary)';
                }
            }
            
            // Trending Up
            const trendingExercises = getTrendingUpExercises();
            const trendingUpElement = document.getElementById('trending-up');
            if (trendingUpElement) {
                if (trendingExercises.length > 0) {
                    trendingUpElement.innerHTML = trendingExercises.map(ex => `â€¢ ${ex}`).join('<br>');
                    trendingUpElement.style.color = 'var(--color-success)';
                } else {
                    trendingUpElement.innerHTML = 'Need 3+ sessions per exercise to detect trends';
                    trendingUpElement.style.color = 'var(--color-text-secondary)';
                }
            }
            
            // Needs Attention
            const plateauedExercises = getPlateauedExercises(3);
            const needsAttentionElement = document.getElementById('needs-attention');
            if (needsAttentionElement) {
                if (plateauedExercises.length > 0) {
                    needsAttentionElement.innerHTML = plateauedExercises.map(ex => 
                        `â€¢ ${ex.exercise} (stuck at ${ex.weight} lbs)`
                    ).join('<br>');
                    needsAttentionElement.style.color = 'var(--color-warning)';
                } else {
                    needsAttentionElement.innerHTML = 'All exercises progressing well!';
                    needsAttentionElement.style.color = 'var(--color-success)';
                }
            }
        }

        function updateFocusAreas() {
            const container = document.getElementById('focus-areas-content');
            if (!container) return;
            
            const workoutTypes = ['Upper', 'Lower', 'Push', 'Pull', 'Legs'];
            const warnings = [];
            
            // Check for workout types not done recently
            workoutTypes.forEach(type => {
                const daysSince = getDaysSinceLastWorkout(type);
                if (daysSince !== null && daysSince > 5) {
                    warnings.push(`It's been ${daysSince} days since your last ${type} workout`);
                }
            });
            
            // Check for imbalanced training this month
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const typeFrequency = {};
            
            workoutTypes.forEach(type => {
                typeFrequency[type] = allWorkouts.filter(w => {
                    const workoutDate = new Date(w.date);
                    return w.day === type && 
                           workoutDate.getMonth() === thisMonth && 
                           workoutDate.getFullYear() === thisYear;
                }).length;
            });
            
            const frequencies = Object.values(typeFrequency).filter(f => f > 0);
            if (frequencies.length > 1) {
                const maxFreq = Math.max(...frequencies);
                const minFreq = Math.min(...frequencies);
                
                if (maxFreq - minFreq >= 2) {
                    const undertrainedTypes = Object.keys(typeFrequency).filter(type => typeFrequency[type] === minFreq);
                    warnings.push(`ðŸ’¡ Consider adding more ${undertrainedTypes.join(' or ')} workouts to balance your training`);
                }
            }
            
            if (warnings.length > 0) {
                container.innerHTML = warnings.map(w => `<div style="margin-bottom: 0.5rem;">${w}</div>`).join('');
                container.style.color = 'var(--color-warning)';
            } else {
                container.innerHTML = '<div>Your training is well balanced! Keep it up!</div>';
                container.style.color = 'var(--color-success)';
            }
        }

        function updateInsights() {
            const insights = generateAIInsights();
            const plateaus = detectPlateaus();
            const container = document.getElementById('insights-list');
            
            let html = '';
            
            // Add plateau alerts first
            plateaus.slice(0, 2).forEach(plateau => {
                html += `<li class="insight-item plateau-alert">${plateau.exercise} plateaued for ${plateau.sessions} sessions. ${plateau.suggestion}</li>`;
            });
            
            // Add regular insights
            insights.forEach(insight => {
                const isProgression = insight.includes('Outstanding') || insight.includes('excellent');
                const className = isProgression ? 'progression-highlight' : '';
                html += `<li class="insight-item ${className}">${insight}</li>`;
            });
            
            container.innerHTML = html || '<li class="insight-item">Complete more workouts to get personalized insights!</li>';
            
            // Update nutrition insights
            updateNutritionInsights();
        }

        function updateNutritionInsights() {
            const today = new Date();
            const last7Days = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
            
            // Get nutrition data for past 7 days
            const recentNutrition = window.nutritionData?.filter(n => new Date(n.date) >= last7Days) || [];
            
            // Get workout dates for past 7 days
            const recentWorkouts = allWorkouts.filter(w => new Date(w.date) >= last7Days);
            const workoutDates = recentWorkouts.map(w => w.date);
            
            // Group nutrition by date and calculate daily totals
            const dailyNutrition = {};
            recentNutrition.forEach(meal => {
                if (!dailyNutrition[meal.date]) {
                    dailyNutrition[meal.date] = { protein: 0, carbs: 0, fats: 0, calories: 0, meals: [] };
                }
                dailyNutrition[meal.date].meals.push(meal);
                (meal.foods || []).forEach(food => {
                    const qty = food.quantity || 1;
                    dailyNutrition[meal.date].protein += (parseFloat(food.protein) || 0) * qty;
                    dailyNutrition[meal.date].carbs += (parseFloat(food.carbs) || 0) * qty;
                    dailyNutrition[meal.date].fats += (parseFloat(food.fats) || 0) * qty;
                    dailyNutrition[meal.date].calories += (parseFloat(food.calories) || 0) * qty;
                });
            });
            
            // Filter out days with zero nutrition
            const datesWithNutrition = Object.keys(dailyNutrition).filter(date => 
                dailyNutrition[date].protein > 0 || dailyNutrition[date].calories > 0
            );
            
            // Workout Days vs Rest Days Comparison
            const comparisonContainer = document.getElementById('nutrition-comparison');
            if (datesWithNutrition.length >= 3) {
                const workoutDayData = datesWithNutrition.filter(date => workoutDates.includes(date));
                const restDayData = datesWithNutrition.filter(date => !workoutDates.includes(date));
                
                let comparisonHtml = '<div style="font-size: 0.85rem; line-height: 1.6;">';
                comparisonHtml += `<div style="margin-bottom: 0.5rem; color: var(--color-text-secondary);">Data from ${datesWithNutrition.length} days with logged nutrition</div>`;
                
                if (workoutDayData.length > 0) {
                    const workoutAvg = {
                        protein: Math.round(workoutDayData.reduce((sum, date) => sum + dailyNutrition[date].protein, 0) / workoutDayData.length),
                        carbs: Math.round(workoutDayData.reduce((sum, date) => sum + dailyNutrition[date].carbs, 0) / workoutDayData.length),
                        fats: Math.round(workoutDayData.reduce((sum, date) => sum + dailyNutrition[date].fats, 0) / workoutDayData.length),
                        calories: Math.round(workoutDayData.reduce((sum, date) => sum + dailyNutrition[date].calories, 0) / workoutDayData.length)
                    };
                    
                    comparisonHtml += `<div style="margin-bottom: 0.5rem; color: var(--color-success);">`;
                    comparisonHtml += `<strong>Workout Days (${workoutDayData.length}):</strong> `;
                    comparisonHtml += `${workoutAvg.protein}g protein, ${workoutAvg.carbs}g carbs, ${workoutAvg.fats}g fat, ${workoutAvg.calories} cal`;
                    comparisonHtml += `</div>`;
                }
                
                if (restDayData.length > 0) {
                    const restAvg = {
                        protein: Math.round(restDayData.reduce((sum, date) => sum + dailyNutrition[date].protein, 0) / restDayData.length),
                        carbs: Math.round(restDayData.reduce((sum, date) => sum + dailyNutrition[date].carbs, 0) / restDayData.length),
                        fats: Math.round(restDayData.reduce((sum, date) => sum + dailyNutrition[date].fats, 0) / restDayData.length),
                        calories: Math.round(restDayData.reduce((sum, date) => sum + dailyNutrition[date].calories, 0) / restDayData.length)
                    };
                    
                    comparisonHtml += `<div style="margin-bottom: 0.5rem; color: var(--color-accent-primary);">`;
                    comparisonHtml += `<strong>Rest Days (${restDayData.length}):</strong> `;
                    comparisonHtml += `${restAvg.protein}g protein, ${restAvg.carbs}g carbs, ${restAvg.fats}g fat, ${restAvg.calories} cal`;
                    comparisonHtml += `</div>`;
                }
                
                comparisonHtml += '</div>';
                comparisonContainer.innerHTML = comparisonHtml;
            } else {
                comparisonContainer.innerHTML = '<div style="color: var(--color-text-secondary);">Log nutrition for at least 3 days to see insights</div>';
            }
            
            // Pre-Workout Nutrition Analysis
            const preworkoutContainer = document.getElementById('preworkout-insights');
            let preworkoutHtml = '<div style="font-size: 0.85rem; line-height: 1.6;">';
            
            // Note: Full meal timing analysis would require meal time data
            preworkoutHtml += '<div style="color: var(--color-text-secondary);">Meal timing analysis requires logged meal times. ';
            preworkoutHtml += 'This feature tracks meals 1-4 hours before workouts to correlate with performance.</div>';
            preworkoutContainer.innerHTML = preworkoutHtml + '</div>';
            
            // Post-Workout Recovery Analysis
            const postworkoutContainer = document.getElementById('postworkout-insights');
            let postworkoutHtml = '<div style="font-size: 0.85rem; line-height: 1.6;">';
            postworkoutHtml += '<div style="color: var(--color-text-secondary);">Post-workout analysis tracks protein intake within 2 hours of completing workouts ';
            postworkoutHtml += 'to correlate with next session performance.</div>';
            postworkoutContainer.innerHTML = postworkoutHtml + '</div>';
        }

        function updateProgress() {
            const prs = getPersonalRecords();
            const progression = getExerciseProgression();
            const prContainer = document.getElementById('progress-list');
            const progressionContainer = document.getElementById('exercise-progress-list');
            
            // Update PRs
            if (Object.keys(prs).length === 0) {
                prContainer.innerHTML = '<p style="color: var(--color-text-secondary);">Complete some workouts to see your personal records!</p>';
            } else {
                const sortedPRs = Object.entries(prs).sort(([,a], [,b]) => b.weight - a.weight);
                
                prContainer.innerHTML = sortedPRs.slice(0, 10).map(([exercise, pr]) => `
                    <div class="insight-item">
                        <strong>${exercise}</strong><br>
                        ${pr.weight}lbs Ã— ${pr.reps} reps - ${formatDateString(pr.date)}
                    </div>
                `).join('');
            }
            
            // Update exercise progression
            if (Object.keys(progression).length === 0) {
                progressionContainer.innerHTML = '<p style="color: var(--color-text-secondary);">Complete some workouts to see your detailed progression!</p>';
            } else {
                const sortedProgression = Object.entries(progression).sort(([,a], [,b]) => {
                    const typeOrder = { strength: 4, volume: 3, total_volume: 2, maintaining: 1 };
                    return typeOrder[b.type] - typeOrder[a.type];
                });
                
                progressionContainer.innerHTML = sortedProgression.slice(0, 15).map(([exercise, data]) => {
                    const typeColors = {
                        strength: 'var(--color-success)',
                        volume: 'var(--color-accent-primary)', 
                        total_volume: 'var(--color-warning)',
                        maintaining: 'var(--color-text-secondary)'
                    };
                    
                    return `
                        <div class="insight-item" style="border-left-color: ${typeColors[data.type]};">
                            <strong>${exercise}</strong><br>
                            ${data.progression}<br>
                            <span style="color: var(--color-text-secondary); font-size: 0.75rem;">
                                ${data.daysSince} days ago â€¢ ${data.sessions} sessions tracked
                            </span>
                        </div>
                    `;
                }).join('');
            }
        }

        // Calendar Functions
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
            
            // Get first and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Build calendar grid
            let html = '';
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Add days from previous month
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${day}</div>
                </div>`;
            }
            
            // Add days of current month
            const today = getTodayDateString();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const scheduledWorkout = getScheduledWorkout(dateStr);
                const actualWorkout = getWorkoutForDate(dateStr);
                
                let classes = ['calendar-day'];
                if (dateStr === today) classes.push('today');
                
                // Determine display label and workout type
                let displayLabel;
                let labelClass;
                
                // Priority 1: If there's an actual logged workout, show it (overrides sick/travel)
                if (actualWorkout && actualWorkout.day) {
                    classes.push('has-workout');
                    displayLabel = actualWorkout.day;
                    labelClass = actualWorkout.day;
                } else if (isDateSickDay(dateStr)) {
                    // Priority 2: Sick day (only if no workout logged)
                    classes.push('sick');
                    displayLabel = 'Sick Day';
                    labelClass = 'Sick';
                } else if (scheduledWorkout === 'Travel') {
                    // Priority 3: Travel day (only if no workout logged)
                    classes.push('travel');
                    const wouldBeWorkout = getWouldBeScheduledWorkout(dateStr);
                    displayLabel = `Travel (${wouldBeWorkout})`;
                    labelClass = scheduledWorkout;
                } else if (scheduledWorkout !== 'Rest' && scheduledWorkout !== 'Travel' && date < new Date()) {
                    classes.push('missed');
                    displayLabel = scheduledWorkout;
                    labelClass = scheduledWorkout;
                } else if (scheduledWorkout !== 'Rest' && scheduledWorkout !== 'Travel') {
                    classes.push('scheduled');
                    displayLabel = scheduledWorkout;
                    labelClass = scheduledWorkout;
                } else {
                    // Rest day
                    displayLabel = scheduledWorkout;
                    labelClass = scheduledWorkout;
                }
                
                html += `<div class="${classes.join(' ')}" onclick="selectCalendarDay('${dateStr}')">
                    <div class="calendar-day-number">${day}</div>
                    <div class="calendar-day-label ${labelClass}">${displayLabel}</div>
                </div>`;
            }
            
            // Add days from next month
            const remainingDays = 42 - (startingDayOfWeek + daysInMonth); // 6 weeks * 7 days
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${day}</div>
                </div>`;
            }
            
            document.getElementById('calendar-grid').innerHTML = html;
            
            // Update adherence
            const adherence = calculateAdherence();
            document.getElementById('adherence-score').textContent = `${adherence.score}%`;
            document.getElementById('workouts-completed').textContent = adherence.completed;
            document.getElementById('workouts-scheduled').textContent = adherence.scheduled;
            document.getElementById('workouts-missed').textContent = adherence.missed;
        }

        // Helper function to format date string correctly without timezone issues
        function formatDateString(dateStr) {
            // dateStr is in format "YYYY-MM-DD"
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day); // month is 0-indexed
            return date.toLocaleDateString();
        }

        window.selectCalendarDay = function(dateStr) {
            selectedCalendarDay = dateStr;
            const workout = getWorkoutForDate(dateStr);
            const scheduledWorkout = getScheduledWorkout(dateStr);
            
            const container = document.getElementById('selected-day-workout');
            const content = document.getElementById('selected-day-content');
            const title = document.getElementById('selected-day-title');
            
            if (workout) {
                title.textContent = `${workout.day} Workout - ${formatDateString(dateStr)}`;
                
                let html = '<div style="display: grid; gap: 1rem;">';
                
                // Show intensity if available
                if (workout.intensity) {
                    html += '<div style="background: rgba(15, 23, 42, 0.6); padding: 1rem; border-radius: 8px;">';
                    html += '<h4 style="color: var(--color-accent-primary); margin-bottom: 0.5rem;">Session Intensity</h4>';
                    html += '<div style="display: flex; gap: 1rem; flex-wrap: wrap;">';
                    if (workout.intensity.energy) html += `<span style="color: var(--color-text-secondary);">Energy: ${workout.intensity.energy}/5</span>`;
                    if (workout.intensity.motivation) html += `<span style="color: var(--color-text-secondary);">Motivation: ${workout.intensity.motivation}/5</span>`;
                    if (workout.intensity.fatigue) html += `<span style="color: var(--color-text-secondary);">Fatigue: ${workout.intensity.fatigue}/5</span>`;
                    if (workout.intensity.satisfaction) html += `<span style="color: var(--color-text-secondary);">Satisfaction: ${workout.intensity.satisfaction}/5</span>`;
                    html += '</div></div>';
                }
                
                // Show exercises
                Object.values(workout.exercises || {}).forEach(exercise => {
                    html += '<div style="background: rgba(15, 23, 42, 0.6); padding: 1rem; border-radius: 8px;">';
                    html += `<h4 style="color: white; margin-bottom: 0.5rem;">${exercise.exercise}`;
                    if (exercise.substitution && exercise.originalExercise) {
                        html += ` <span style="background: rgba(74, 93, 74, 0.2); color: var(--color-accent-primary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: normal;">Alt for ${exercise.originalExercise}</span>`;
                    } else if (exercise.approach) {
                        html += ` <span style="background: rgba(74, 93, 74, 0.2); color: var(--color-accent-primary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: normal;">${exercise.approach}</span>`;
                    }
                    html += `</h4>`;
                    
                    exercise.sets.forEach((set, idx) => {
                        if (set.completed) {
                            html += `<div style="color: var(--color-success); padding: 0.25rem;">âœ“ Completed</div>`;
                        } else if (set.weight || set.reps) {
                            html += `<div style="color: #93c5fd; padding: 0.25rem;">Set ${idx + 1}: ${set.weight}lbs Ã— ${set.reps} reps`;
                            if (set.notes) html += ` (${set.notes})`;
                            html += '</div>';
                        }
                    });
                    
                    html += '</div>';
                });
                
                html += '</div>';
                content.innerHTML = html;
            } else {
                title.textContent = `${scheduledWorkout} - ${formatDateString(dateStr)}`;
                if (scheduledWorkout === 'Sick') {
                    content.innerHTML = `<p style="color: #f472b6;">This day is marked as a sick day. Workout was canceled and schedule adjusted.</p>`;
                } else if (scheduledWorkout === 'Travel') {
                    const wouldBeWorkout = getWouldBeScheduledWorkout(dateStr);
                    content.innerHTML = `<p style="color: #a855f7;">Travel day - workout schedule paused.</p>
                        <p style="color: var(--color-text-secondary); margin-top: 0.5rem;">Scheduled workout if not traveling: <strong style="color: var(--color-text-secondary);">${wouldBeWorkout}</strong></p>`;
                } else {
                    content.innerHTML = `<p style="color: var(--color-text-secondary);">No workout logged for this day. Scheduled: ${scheduledWorkout}</p>`;
                }
            }
            
            container.style.display = 'block';
        };

        // Travel Mode Functions
        function isDateInTravelMode(dateStr) {
            if (!window.travelModeData || window.travelModeData.length === 0) return false;
            
            const checkDate = new Date(dateStr);
            return window.travelModeData.some(period => {
                const start = new Date(period.startDate);
                const end = new Date(period.endDate);
                return checkDate >= start && checkDate <= end;
            });
        }

        function getCurrentTravelPeriod() {
            const today = new Date().toISOString().split('T')[0];
            if (!window.travelModeData) return null;
            
            return window.travelModeData.find(period => {
                const start = new Date(period.startDate);
                const end = new Date(period.endDate);
                const check = new Date(today);
                return check >= start && check <= end;
            });
        }

        window.toggleScheduleExceptions = function() {
            const content = document.getElementById('schedule-exceptions-content');
            const toggle = document.getElementById('schedule-exceptions-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–²';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¼';
            }
        };

        window.enableTravelMode = async function() {
            const startDate = document.getElementById('travel-start-date').value;
            const endDate = document.getElementById('travel-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after start date');
                return;
            }
            
            try {
                const travelPeriod = {
                    startDate,
                    endDate,
                    createdAt: new Date().toISOString()
                };
                
                const docRef = await addDoc(collection(db, "travelMode"), travelPeriod);
                console.log('Travel mode enabled:', docRef.id);
                
                await loadTravelModeData();
                updateTravelModeBanner();
                renderCalendar();
                
                // Clear inputs
                document.getElementById('travel-start-date').value = '';
                document.getElementById('travel-end-date').value = '';
                
                alert('Travel mode enabled! Your workout schedule is paused during these dates.');
            } catch (e) {
                console.error('Error enabling travel mode:', e);
                alert('Failed to enable travel mode');
            }
        };

        window.endTravelMode = async function() {
            const currentPeriod = getCurrentTravelPeriod();
            if (!currentPeriod || !currentPeriod.id) {
                alert('No active travel period found');
                return;
            }
            
            // Store the period ID for later use
            window.currentTravelPeriodToEnd = currentPeriod.id;
            
            // Show the post-travel modal
            document.getElementById('post-travel-modal').classList.add('active');
        };

        window.resumeWorkoutProgram = async function(mode) {
            // Close the modal
            document.getElementById('post-travel-modal').classList.remove('active');
            
            try {
                // Delete the travel period
                await deleteDoc(doc(db, "travelMode", window.currentTravelPeriodToEnd));
                console.log('Travel mode ended');
                
                if (mode === 'restart') {
                    // Restart the program by creating a Rest day workout for today
                    // This will cause the schedule to restart from Upper tomorrow
                    const today = getTodayDateString();
                    const restartWorkout = {
                        date: today,
                        day: 'Rest',
                        exercises: {},
                        timestamp: new Date().toISOString()
                    };
                    
                    // Check if there's already a workout today
                    const existingWorkout = getWorkoutForDate(today);
                    if (!existingWorkout) {
                        await addDoc(collection(db, "workouts"), restartWorkout);
                        console.log('Program restarted - Rest day logged for today');
                    }
                    
                    await loadWorkoutsFromFirebase();
                }
                
                await loadTravelModeData();
                updateTravelModeBanner();
                renderCalendar();
                
                const message = mode === 'restart' 
                    ? 'Welcome back! Your workout program has been restarted from day 1.' 
                    : 'Welcome back! Your workout schedule has resumed from where you left off.';
                alert(message);
            } catch (e) {
                console.error('Error ending travel mode:', e);
                alert('Failed to end travel mode');
            }
        };

        async function loadTravelModeData() {
            try {
                const q = query(collection(db, "travelMode"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                window.travelModeData = [];
                querySnapshot.forEach((document) => {
                    window.travelModeData.push({ id: document.id, ...document.data() });
                });
                console.log('Travel mode data loaded:', window.travelModeData.length, 'periods');
            } catch (e) {
                console.error('Error loading travel mode data:', e);
            }
        }

        function updateTravelModeBanner() {
            const banner = document.getElementById('travel-mode-banner');
            const datesSpan = document.getElementById('travel-mode-dates');
            const currentPeriod = getCurrentTravelPeriod();
            
            if (currentPeriod) {
                banner.classList.add('active');
                datesSpan.textContent = `${formatDateString(currentPeriod.startDate)} - ${formatDateString(currentPeriod.endDate)}`;
            } else {
                banner.classList.remove('active');
            }
        }

        // Sick Day Functions
        function isDateSickDay(dateStr) {
            if (!window.sickDayData || window.sickDayData.length === 0) return false;
            return window.sickDayData.some(sickDay => sickDay.date === dateStr);
        }

        window.markSickDay = async function() {
            const dateInput = document.getElementById('sick-day-date').value;
            
            if (!dateInput) {
                alert('Please select a date');
                return;
            }
            
            // Check if already marked as sick day
            if (isDateSickDay(dateInput)) {
                // Ask if user wants to remove the sick day
                if (confirm('This day is already marked as sick. Do you want to remove it?')) {
                    try {
                        const sickDayToRemove = window.sickDayData.find(sd => sd.date === dateInput);
                        if (sickDayToRemove && sickDayToRemove.id) {
                            await deleteDoc(doc(db, "sickDays", sickDayToRemove.id));
                            console.log('Sick day removed');
                            
                            await loadSickDayData();
                            renderCalendar();
                            
                            document.getElementById('sick-day-date').value = '';
                            alert('Sick day removed. Schedule will adjust accordingly.');
                        }
                    } catch (e) {
                        console.error('Error removing sick day:', e);
                        alert('Failed to remove sick day');
                    }
                }
                return;
            }
            
            // Check if there's already a workout logged for this date
            const existingWorkout = getWorkoutForDate(dateInput);
            if (existingWorkout) {
                const message = 'There is already a workout logged for this day.\n\n' +
                                'The logged workout will remain visible and count toward adherence.\n\n' +
                                'Continue marking as sick day?';
                if (!confirm(message)) {
                    return;
                }
            }
            
            try {
                const sickDay = {
                    date: dateInput,
                    createdAt: new Date().toISOString()
                };
                
                const docRef = await addDoc(collection(db, "sickDays"), sickDay);
                console.log('Sick day marked:', docRef.id);
                
                await loadSickDayData();
                renderCalendar();
                
                // Clear input
                document.getElementById('sick-day-date').value = '';
                
                alert('Day marked as sick. All remaining workouts have been pushed back by one day.');
            } catch (e) {
                console.error('Error marking sick day:', e);
                alert('Failed to mark sick day');
            }
        };

        async function loadSickDayData() {
            try {
                const q = query(collection(db, "sickDays"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                window.sickDayData = [];
                querySnapshot.forEach((document) => {
                    window.sickDayData.push({ id: document.id, ...document.data() });
                });
                console.log('Sick day data loaded:', window.sickDayData.length, 'sick days');
            } catch (e) {
                console.error('Error loading sick day data:', e);
            }
        }

        // Nutrition Functions
        // Track collapsed state for each meal
        let collapsedMeals = {};

        window.toggleMealCollapse = function(mealId) {
            collapsedMeals[mealId] = !collapsedMeals[mealId];
            renderMeals();
        };

        function calculateMealTotals(meal) {
            let calories = 0, protein = 0, carbs = 0, fats = 0, foodCount = 0;
            (meal.foods || []).forEach(food => {
                const quantity = food.quantity || 1;
                calories += (parseFloat(food.calories) || 0) * quantity;
                protein += (parseFloat(food.protein) || 0) * quantity;
                carbs += (parseFloat(food.carbs) || 0) * quantity;
                fats += (parseFloat(food.fats) || 0) * quantity;
                if (food.name && food.name.trim()) foodCount++;
            });
            return { calories: Math.round(calories), protein: Math.round(protein), carbs: Math.round(carbs), fats: Math.round(fats), foodCount };
        }

        function renderMeals() {
            const meals = nutritionData.filter(n => n.date === currentNutritionDate);
            const container = document.getElementById('meals-container');
            
            if (meals.length === 0) {
                container.innerHTML = '';
                updateNutritionSummary();
                return;
            }
            
            let html = '';
            meals.forEach((meal, mealIndex) => {
                const isCollapsed = collapsedMeals[meal.id] === true; // Default to expanded (not collapsed)
                const totals = calculateMealTotals(meal);
                
                html += `<div class="meal-card ${isCollapsed ? 'collapsed' : ''}" id="meal-card-${meal.id}">
                    <div class="meal-header" onclick="toggleMealCollapse('${meal.id}')">
                        <div style="flex: 1;">
                            <div class="meal-type">
                                ${meal.mealType}
                            </div>
                            <div class="meal-time">${meal.time || ''}</div>
                        </div>
                        <span class="meal-collapse-icon">â–¼</span>
                    </div>`;
                
                // Show summary when collapsed
                if (isCollapsed && totals.foodCount > 0) {
                    html += `<div class="meal-summary">
                        <div class="meal-summary-stats">
                            <div class="meal-summary-stat">
                                <span class="meal-summary-value">${totals.calories}</span>
                                <span class="meal-summary-label">Calories</span>
                            </div>
                            <div class="meal-summary-stat">
                                <span class="meal-summary-value">${totals.protein}g</span>
                                <span class="meal-summary-label">Protein</span>
                            </div>
                            <div class="meal-summary-stat">
                                <span class="meal-summary-value">${totals.carbs}g</span>
                                <span class="meal-summary-label">Carbs</span>
                            </div>
                            <div class="meal-summary-stat">
                                <span class="meal-summary-value">${totals.fats}g</span>
                                <span class="meal-summary-label">Fats</span>
                            </div>
                            <div class="meal-summary-stat">
                                <span class="meal-summary-value">${totals.foodCount}</span>
                                <span class="meal-summary-label">Foods</span>
                            </div>
                        </div>
                    </div>`;
                }
                
                html += `<div class="meal-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 0.75rem; flex-wrap: wrap;">
                        <select class="meal-type" style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; color: var(--color-text-primary); padding: 0.75rem; font-size: 1rem; font-weight: 500; cursor: pointer; min-height: 48px;" onchange="changeMealType('${meal.id}', this.value); event.stopPropagation();">
                            <option value="Breakfast" ${meal.mealType === 'Breakfast' ? 'selected' : ''}>Breakfast</option>
                            <option value="Lunch" ${meal.mealType === 'Lunch' ? 'selected' : ''}>Lunch</option>
                            <option value="Dinner" ${meal.mealType === 'Dinner' ? 'selected' : ''}>Dinner</option>
                            <option value="Snack" ${meal.mealType === 'Snack' ? 'selected' : ''}>Snack</option>
                        </select>
                        <button class="btn" style="background: rgba(196, 115, 109, 0.15); color: var(--color-error); border: 1px solid rgba(196, 115, 109, 0.3); padding: 0.75rem 1rem; min-height: 48px; border-radius: 12px; font-weight: 500;" onclick="deleteMeal('${meal.id}'); event.stopPropagation();">Delete</button>
                    </div>
                    <div id="meal-${meal.id}">`;
                
                (meal.foods || []).forEach((food, foodIndex) => {
                    const quantity = food.quantity || 1;
                    const displayProtein = ((food.protein || 0) * quantity).toFixed(1);
                    const displayCarbs = ((food.carbs || 0) * quantity).toFixed(1);
                    const displayFats = ((food.fats || 0) * quantity).toFixed(1);
                    const displayCalories = Math.round((food.calories || 0) * quantity);
                    
                    html += `<div class="food-input-row">
                        <input type="text" class="food-input" value="${food.name}" placeholder="Food name" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'name', this.value)">
                        <div class="macro-inputs-grid">
                            <div class="macro-input-wrapper">
                                <label class="macro-input-label">Qty</label>
                                <input type="number" class="macro-input" value="${quantity}" placeholder="1" step="0.1" min="0.1" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'quantity', this.value)">
                            </div>
                            <div class="macro-input-wrapper">
                                <label class="macro-input-label">Protein</label>
                                <input type="number" class="macro-input" value="${food.protein || 0}" placeholder="0" step="0.1" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'protein', this.value)">
                                ${quantity !== 1 ? `<div style="font-size: 0.7rem; color: var(--color-text-secondary); text-align: center; margin-top: 0.25rem;">${displayProtein}g</div>` : ''}
                            </div>
                            <div class="macro-input-wrapper">
                                <label class="macro-input-label">Carbs</label>
                                <input type="number" class="macro-input" value="${food.carbs || 0}" placeholder="0" step="0.1" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'carbs', this.value)">
                                ${quantity !== 1 ? `<div style="font-size: 0.7rem; color: var(--color-text-secondary); text-align: center; margin-top: 0.25rem;">${displayCarbs}g</div>` : ''}
                            </div>
                            <div class="macro-input-wrapper">
                                <label class="macro-input-label">Fats</label>
                                <input type="number" class="macro-input" value="${food.fats || 0}" placeholder="0" step="0.1" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'fats', this.value)">
                                ${quantity !== 1 ? `<div style="font-size: 0.7rem; color: var(--color-text-secondary); text-align: center; margin-top: 0.25rem;">${displayFats}g</div>` : ''}
                            </div>
                            <div class="macro-input-wrapper">
                                <label class="macro-input-label">Calories</label>
                                <input type="number" class="macro-input" value="${food.calories || 0}" placeholder="0" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'calories', this.value)">
                                ${quantity !== 1 ? `<div style="font-size: 0.7rem; color: var(--color-text-secondary); text-align: center; margin-top: 0.25rem;">${displayCalories}</div>` : ''}
                            </div>
                        </div>
                        <div class="food-action-buttons">
                            <button class="btn-save-food" onclick="saveFoodToLibrary('${meal.id}', ${foodIndex})" title="Save to library">Save</button>
                            <button class="btn-delete-food" onclick="deleteFoodFromMeal('${meal.id}', ${foodIndex})" title="Delete food">Delete</button>
                        </div>
                    </div>`;
                });
                
                html += `</div>
                    <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                        <button class="quick-add-food-btn" onclick="addFoodToMeal('${meal.id}'); event.stopPropagation();">+ Add Food</button>
                        ${meal.hasUnsavedChanges ? `<button class="btn" style="background: rgba(93, 138, 102, 0.2); color: var(--color-success); border: 1px solid rgba(93, 138, 102, 0.3); border-radius: 12px; padding: 0.75rem 1.25rem; font-weight: 500; min-height: 44px;" onclick="saveMealChanges('${meal.id}'); event.stopPropagation();">Save Changes</button>` : ''}
                    </div>
                </div>
                </div>`;
            });
            
            container.innerHTML = html;
            updateNutritionSummary();
        }

        function updateNutritionSummary() {
            const meals = nutritionData.filter(n => n.date === currentNutritionDate);
            let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFats = 0;
            
            meals.forEach(meal => {
                (meal.foods || []).forEach(food => {
                    const quantity = food.quantity || 1;
                    totalCalories += (parseFloat(food.calories) || 0) * quantity;
                    totalProtein += (parseFloat(food.protein) || 0) * quantity;
                    totalCarbs += (parseFloat(food.carbs) || 0) * quantity;
                    totalFats += (parseFloat(food.fats) || 0) * quantity;
                });
            });
            
            // Animate the value changes
            animateValue('total-calories', Math.round(totalCalories));
            animateValue('total-protein', Math.round(totalProtein), 'g');
            animateValue('total-carbs', Math.round(totalCarbs), 'g');
            animateValue('total-fats', Math.round(totalFats), 'g');
            
            // Update calories remaining if body goal is set
            updateNutritionCalories();
        }

        function animateValue(elementId, newValue, suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const currentText = element.textContent.replace(/[^\d.-]/g, '');
            const currentValue = parseFloat(currentText) || 0;
            
            if (currentValue === newValue) {
                element.textContent = newValue + suffix;
                return;
            }
            
            element.style.transition = 'color 0.3s ease';
            element.style.color = 'var(--color-accent-primary)';
            
            // Simple direct update with highlight
            element.textContent = newValue + suffix;
            
            setTimeout(() => {
                element.style.color = '';
            }, 300);
        }

        // Meal type selection modal functions
        window.showMealTypeModal = function() {
            document.getElementById('meal-type-modal').classList.add('active');
        };

        window.closeMealTypeModal = function() {
            document.getElementById('meal-type-modal').classList.remove('active');
        };

        window.selectMealType = async function(mealType) {
            closeMealTypeModal();
            
            const currentTime = getCurrentTimeString();
            const mealData = {
                date: currentNutritionDate,
                mealType: mealType,
                time: currentTime,
                foods: []
            };
            
            console.log('Adding meal:', {
                date: currentNutritionDate,
                mealType: mealType,
                time: currentTime,
                timezone: userTimezone
            });
            
            try {
                const docRef = await addDoc(collection(db, "nutrition"), mealData);
                const newMeal = { id: docRef.id, ...mealData };
                nutritionData.unshift(newMeal);
                currentEditingMealId = newMeal.id; // Set context to the newly created meal
                collapsedMeals[newMeal.id] = false; // Ensure new meal is expanded
                console.log('Meal successfully added with ID:', docRef.id);
                renderMeals();
            } catch (e) {
                console.error("Error adding meal:", e);
                alert('Error adding meal. Please check your connection and try again.');
                throw e; // Re-throw for debugging
            }
        };

        window.addMeal = function() {
            showMealTypeModal();
        };

        window.addFoodToMeal = function(mealId) {
            const meal = nutritionData.find(m => m.id === mealId);
            if (!meal.foods) meal.foods = [];
            meal.foods.push({ name: '', protein: 0, carbs: 0, fats: 0, calories: 0, quantity: 1 });
            currentEditingMealId = mealId; // Set the context to this meal
            renderMeals();
        };

        window.changeMealType = async function(mealId, newMealType) {
            try {
                const meal = nutritionData.find(m => m.id === mealId);
                if (!meal) return;
                
                meal.mealType = newMealType;
                
                // Update in Firestore
                const docRef = doc(db, "nutrition", mealId);
                await updateDoc(docRef, { mealType: newMealType });
                
                console.log(`Updated meal ${mealId} to ${newMealType}`);
            } catch (e) {
                console.error("Error changing meal type:", e);
                alert('Error changing meal type. Please try again.');
            }
        };

        window.updateMealFood = async function(mealId, foodIndex, field, value) {
            const meal = nutritionData.find(m => m.id === mealId);
            if (meal && meal.foods && meal.foods[foodIndex]) {
                meal.foods[foodIndex][field] = value;
                meal.hasUnsavedChanges = true; // Mark meal as having unsaved changes
                updateNutritionSummary();
                renderMeals(); // Re-render to show save button
            }
        };
        
        window.saveMealChanges = async function(mealId) {
            const meal = nutritionData.find(m => m.id === mealId);
            if (!meal) {
                console.error('Meal not found:', mealId);
                return;
            }
            
            console.log('Saving meal changes:', {
                mealId: mealId,
                date: meal.date,
                mealType: meal.mealType,
                foods: meal.foods,
                timezone: userTimezone
            });
            
            try {
                const docRef = doc(db, "nutrition", mealId);
                await updateDoc(docRef, { foods: meal.foods });
                meal.hasUnsavedChanges = false;
                console.log('Meal changes saved successfully to Firestore');
                alert('Meal saved! Changes have been updated to the database and counted in daily calories.');
                renderMeals();
            } catch (e) {
                console.error("Error saving meal:", e);
                alert('Error saving meal. Please try again.');
                throw e; // Re-throw for debugging
            }
        };

        async function saveMealToFirebase(meal) {
            // This function is no longer needed as we use updateDoc directly
            console.warn('saveMealToFirebase is deprecated, use updateDoc directly');
        }

        window.deleteMeal = async function(mealId) {
            if (confirm('Delete this meal?')) {
                try {
                    // Delete from Firestore
                    const docRef = doc(db, "nutrition", mealId);
                    await deleteDoc(docRef);
                    
                    // Remove from local state
                    nutritionData = nutritionData.filter(m => m.id !== mealId);
                    renderMeals();
                } catch (e) {
                    console.error("Error deleting meal:", e);
                    alert('Error deleting meal. Please try again.');
                }
            }
        };

        window.deleteFoodFromMeal = async function(mealId, foodIndex) {
            if (confirm('Delete this food item?')) {
                try {
                    const meal = nutritionData.find(m => m.id === mealId);
                    if (!meal || !meal.foods) return;
                    
                    // Remove the food from the array
                    meal.foods.splice(foodIndex, 1);
                    
                    // If meal has no foods left, delete the entire meal
                    if (meal.foods.length === 0) {
                        await window.deleteMeal(mealId);
                        return;
                    }
                    
                    // Update in Firestore
                    const docRef = doc(db, "nutrition", mealId);
                    await updateDoc(docRef, { foods: meal.foods });
                    
                    renderMeals();
                } catch (e) {
                    console.error("Error deleting food from meal:", e);
                    alert('Error deleting food item. Please try again.');
                }
            }
        };

        // Saved Foods Functions
        window.saveFoodToLibrary = async function(mealId, foodIndex) {
            const meal = nutritionData.find(m => m.id === mealId);
            if (!meal || !meal.foods || !meal.foods[foodIndex]) return;
            
            const food = meal.foods[foodIndex];
            
            if (!food.name || !food.name.trim()) {
                alert('Please enter a food name before saving');
                return;
            }
            
            const newProtein = parseFloat(food.protein) || 0;
            const newCarbs = parseFloat(food.carbs) || 0;
            const newFats = parseFloat(food.fats) || 0;
            const newCalories = parseFloat(food.calories) || 0;
            
            // Prompt for serving size and unit
            const servingSize = prompt('Enter serving size (e.g., "46" for 46g, "1" for 1 each):', '1');
            if (servingSize === null) return; // User cancelled
            const servingSizeNum = parseFloat(servingSize);
            if (!servingSizeNum || servingSizeNum <= 0) {
                alert('Please enter a valid serving size');
                return;
            }
            
            const servingUnit = prompt('Enter serving unit:\n  g = grams\n  oz = ounces\n  ml = milliliters\n  each = individual items\n  serving = generic serving', 'serving');
            if (servingUnit === null) return; // User cancelled
            const validUnits = ['g', 'oz', 'ml', 'each', 'serving'];
            if (!validUnits.includes(servingUnit.toLowerCase())) {
                alert('Please enter a valid unit (g, oz, ml, each, or serving)');
                return;
            }
            
            // Check if food already exists (by name and nutritional values)
            const existingFood = savedFoods.find(f => {
                const nameMatch = f.name.toLowerCase().trim() === food.name.toLowerCase().trim();
                const proteinMatch = (parseFloat(f.protein) || 0) === newProtein;
                const carbsMatch = (parseFloat(f.carbs) || 0) === newCarbs;
                const fatsMatch = (parseFloat(f.fats) || 0) === newFats;
                const caloriesMatch = (parseFloat(f.calories) || 0) === newCalories;
                
                return nameMatch && proteinMatch && carbsMatch && fatsMatch && caloriesMatch;
            });
            
            if (existingFood) {
                // Exact duplicate found - just update lastUsed and serving info
                try {
                    existingFood.lastUsed = new Date().toISOString();
                    existingFood.useCount = (existingFood.useCount || 0) + 1;
                    existingFood.servingSize = servingSizeNum;
                    existingFood.servingUnit = servingUnit.toLowerCase();
                    
                    const docRef = doc(db, "savedFoods", existingFood.id);
                    await updateDoc(docRef, {
                        lastUsed: existingFood.lastUsed,
                        useCount: existingFood.useCount,
                        servingSize: existingFood.servingSize,
                        servingUnit: existingFood.servingUnit
                    });
                    alert('Food updated in your library with serving information!');
                    renderSavedFoods();
                } catch (e) {
                    console.error("Error updating food:", e);
                    alert('Error updating food in library');
                }
            } else {
                // Check if food with same name but different nutritional values exists
                const sameName = savedFoods.find(f => f.name.toLowerCase().trim() === food.name.toLowerCase().trim());
                
                if (sameName) {
                    if (!confirm(`"${food.name}" already exists in saved foods with different nutritional values. Save as a new entry?`)) {
                        return;
                    }
                }
                
                // Add new food
                const savedFood = {
                    name: food.name.trim(),
                    protein: newProtein,
                    carbs: newCarbs,
                    fats: newFats,
                    calories: newCalories,
                    servingSize: servingSizeNum,
                    servingUnit: servingUnit.toLowerCase(),
                    created: new Date().toISOString(),
                    lastUsed: new Date().toISOString(),
                    useCount: 0
                };
                
                try {
                    const docRef = await addDoc(collection(db, "savedFoods"), savedFood);
                    savedFoods.unshift({ id: docRef.id, ...savedFood });
                    alert('Food saved to library!');
                    renderSavedFoods();
                } catch (e) {
                    console.error("Error saving food:", e);
                    alert('Error saving food to library');
                }
            }
        };

        async function saveSavedFoodsToFirebase() {
            // Update existing saved food documents in Firebase
            for (const food of savedFoods) {
                if (food.id) {
                    try {
                        const docRef = doc(db, "savedFoods", food.id);
                        await updateDoc(docRef, {
                            name: food.name,
                            protein: food.protein,
                            carbs: food.carbs,
                            fats: food.fats,
                            calories: food.calories,
                            lastUsed: food.lastUsed,
                            useCount: food.useCount
                        });
                    } catch (e) {
                        console.error("Error updating saved food:", e);
                    }
                }
            }
        }

        function renderSavedFoods(searchTerm = '') {
            const container = document.getElementById('saved-food-list');
            const mobileContainer = document.getElementById('saved-food-list-mobile');
            
            let filteredFoods = savedFoods;
            if (searchTerm) {
                filteredFoods = savedFoods.filter(food => 
                    food.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Sort by last used, then by use count
            filteredFoods.sort((a, b) => {
                const dateA = new Date(a.lastUsed || 0);
                const dateB = new Date(b.lastUsed || 0);
                if (dateB - dateA !== 0) return dateB - dateA;
                return (b.useCount || 0) - (a.useCount || 0);
            });
            
            let html = '';
            if (filteredFoods.length === 0) {
                html = '<div class="empty-state">No saved foods found. Save a food from a meal below!</div>';
            } else {
                filteredFoods.forEach(food => {
                    const servingInfo = food.servingSize && food.servingUnit 
                        ? `(1 serving = ${food.servingSize}${food.servingUnit})` 
                        : '';
                    html += `<div class="saved-food-item">
                        <div class="saved-food-info">
                            <div class="saved-food-name">${food.name}</div>
                            ${servingInfo ? `<div style="font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 0.25rem;">${servingInfo}</div>` : ''}
                            <div class="saved-food-macros">
                                <span>P: ${food.protein}g</span>
                                <span>C: ${food.carbs}g</span>
                                <span>F: ${food.fats}g</span>
                                <span>Cal: ${food.calories}</span>
                            </div>
                        </div>
                        <div class="saved-food-actions">
                            <button class="btn-quick-add" onclick="quickAddFood('${food.id}'); closeSavedFoodsModal();">Quick Add</button>
                            <button class="btn-delete-food" onclick="deleteSavedFood('${food.id}')">Delete</button>
                        </div>
                    </div>`;
                });
            }
            
            // Update both desktop and mobile containers
            if (container) container.innerHTML = html;
            if (mobileContainer) mobileContainer.innerHTML = html;
        }

        // Modal functions for mobile saved foods
        window.openSavedFoodsModal = function() {
            const modal = document.getElementById('saved-foods-modal');
            const backdrop = document.getElementById('saved-foods-backdrop');
            
            if (modal && backdrop) {
                // Render saved foods in mobile list
                renderSavedFoods();
                
                // Show backdrop first
                backdrop.style.display = 'block';
                backdrop.classList.add('active');
                
                // Then show modal with animation
                setTimeout(() => {
                    modal.classList.add('active');
                }, 10);
                
                // Prevent body scroll when modal is open
                document.body.style.overflow = 'hidden';
            }
        };

        window.closeSavedFoodsModal = function() {
            const modal = document.getElementById('saved-foods-modal');
            const backdrop = document.getElementById('saved-foods-backdrop');
            
            if (modal && backdrop) {
                // Hide modal with animation
                modal.classList.remove('active');
                
                // Hide backdrop after animation
                setTimeout(() => {
                    backdrop.classList.remove('active');
                    backdrop.style.display = 'none';
                }, 300);
                
                // Re-enable body scroll
                document.body.style.overflow = '';
            }
        };


        window.quickAddFood = async function(foodId) {
            const food = savedFoods.find(f => f.id === foodId);
            if (!food) return;
            
            let quantity = 1;
            
            // If food has serving size and unit, offer dual entry mode
            if (food.servingSize && food.servingUnit) {
                const choice = prompt(
                    `${food.name}\n(1 serving = ${food.servingSize}${food.servingUnit})\n\n` +
                    `Enter amount:\n` +
                    `  â€¢ Type a number + unit (e.g., "120g", "3oz", "2each")\n` +
                    `  â€¢ Or just a number for servings (e.g., "2" for 2 servings)`,
                    '1'
                );
                
                if (choice === null) return; // User cancelled
                
                const trimmed = choice.trim();
                
                // Check if input contains a unit
                const unitMatch = trimmed.match(/^([0-9.]+)\s*(g|oz|ml|each|serving)s?$/i);
                
                if (unitMatch) {
                    // User entered amount with unit - calculate servings
                    const amount = parseFloat(unitMatch[1]);
                    const inputUnit = unitMatch[2].toLowerCase();
                    
                    if (amount <= 0) {
                        alert('Please enter a positive amount');
                        return;
                    }
                    
                    // Convert units if needed
                    let amountInFoodUnit = amount;
                    if (inputUnit !== food.servingUnit) {
                        amountInFoodUnit = convertUnits(amount, inputUnit, food.servingUnit);
                        if (amountInFoodUnit === null) {
                            alert(`Cannot convert ${inputUnit} to ${food.servingUnit}. Please use ${food.servingUnit}.`);
                            return;
                        }
                    }
                    
                    // Calculate servings
                    quantity = amountInFoodUnit / food.servingSize;
                    
                    // Show confirmation with calculation
                    const macros = {
                        calories: Math.round(food.calories * quantity),
                        protein: Math.round(food.protein * quantity * 10) / 10,
                        carbs: Math.round(food.carbs * quantity * 10) / 10,
                        fats: Math.round(food.fats * quantity * 10) / 10
                    };
                    
                    const confirm = window.confirm(
                        `${food.name}\n\n` +
                        `${amount}${inputUnit} = ${quantity.toFixed(2)} servings\n\n` +
                        `This will add:\n` +
                        `  ${macros.calories} calories\n` +
                        `  ${macros.protein}g protein\n` +
                        `  ${macros.carbs}g carbs\n` +
                        `  ${macros.fats}g fats\n\n` +
                        `Add to meal?`
                    );
                    
                    if (!confirm) return;
                } else {
                    // User entered plain number - treat as servings
                    quantity = parseFloat(trimmed);
                    if (isNaN(quantity) || quantity <= 0) {
                        alert('Please enter a valid number');
                        return;
                    }
                }
            } else {
                // Legacy mode: food doesn't have serving info, just ask for servings
                const quantityInput = prompt('How many servings?', '1');
                if (quantityInput === null) return; // User cancelled
                
                quantity = parseFloat(quantityInput) || 1;
                if (quantity <= 0) {
                    alert('Please enter a positive quantity');
                    return;
                }
            }
            
            let targetMeal;
            
            // If a meal is currently being edited, add food to that meal
            if (currentEditingMealId) {
                targetMeal = nutritionData.find(m => m.id === currentEditingMealId);
                
                if (!targetMeal) {
                    alert('Could not find the meal you were editing. Please try again.');
                    currentEditingMealId = null;
                    return;
                }
            } else {
                // No meal is being edited, prompt user to select or create a meal
                const meals = nutritionData.filter(n => n.date === currentNutritionDate);
                
                if (meals.length === 0) {
                    // No meals exist for today, create one with smart default
                    const defaultMealType = getDefaultMealType();
                    const mealType = prompt(`Enter meal type (Breakfast, Lunch, Dinner, or Snack):`, defaultMealType);
                    if (!mealType) return; // User cancelled
                    
                    const mealData = {
                        date: currentNutritionDate,
                        mealType: mealType,
                        time: getCurrentTimeString(),
                        foods: []
                    };
                    
                    try {
                        const docRef = await addDoc(collection(db, "nutrition"), mealData);
                        targetMeal = { id: docRef.id, ...mealData };
                        nutritionData.unshift(targetMeal);
                        currentEditingMealId = targetMeal.id;
                    } catch (e) {
                        console.error("Error creating meal:", e);
                        alert('Error creating meal');
                        return;
                    }
                } else {
                    // Meals exist, ask which one to add to
                    alert('Please click "Add Food" on the specific meal you want to add to, then use Quick Add.');
                    return;
                }
            }
            
            // Add food to meal with quantity
            if (!targetMeal.foods) targetMeal.foods = [];
            targetMeal.foods.push({
                name: food.name,
                protein: food.protein,
                carbs: food.carbs,
                fats: food.fats,
                calories: food.calories,
                quantity: quantity
            });
            
            // Update use count and last used
            food.useCount = (food.useCount || 0) + 1;
            food.lastUsed = new Date().toISOString();
            
            // Save to Firebase
            try {
                // Update the meal with the new food
                const mealDocRef = doc(db, "nutrition", targetMeal.id);
                await updateDoc(mealDocRef, { foods: targetMeal.foods });
                
                // Update only this specific saved food's usage stats
                const foodDocRef = doc(db, "savedFoods", food.id);
                await updateDoc(foodDocRef, {
                    useCount: food.useCount,
                    lastUsed: food.lastUsed
                });
                
                // Clear unsaved changes flag since we just saved
                targetMeal.hasUnsavedChanges = false;
                
                renderMeals();
                renderSavedFoods();
            } catch (e) {
                console.error("Error quick adding food:", e);
                alert('Error adding food to meal. Please try again.');
            }
        };

        window.deleteSavedFood = async function(foodId) {
            if (!confirm('Delete this saved food?')) return;
            
            try {
                // Delete from Firebase
                const docRef = doc(db, "savedFoods", foodId);
                await deleteDoc(docRef);
                
                // Remove from local state
                savedFoods = savedFoods.filter(f => f.id !== foodId);
                renderSavedFoods();
                
                console.log(`Deleted saved food ${foodId} from Firebase`);
            } catch (e) {
                console.error("Error deleting saved food:", e);
                alert('Error deleting saved food. Please try again.');
            }
        };

        async function loadSavedFoods() {
            try {
                const q = query(collection(db, "savedFoods"), orderBy("lastUsed", "desc"));
                const querySnapshot = await getDocs(q);
                
                const allFoods = [];
                querySnapshot.forEach((doc) => {
                    allFoods.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`Loaded ${allFoods.length} saved foods from database`);
                
                // Deduplicate foods based on name and nutritional values
                const deduplicatedFoods = await deduplicateSavedFoods(allFoods);
                savedFoods = deduplicatedFoods;
                
                console.log(`After deduplication: ${savedFoods.length} unique saved foods`);
            } catch (e) {
                console.error("Error loading saved foods:", e);
                // Initialize with empty array if error
                savedFoods = [];
            }
        }
        
        /**
         * Deduplicates saved foods based on name and nutritional values.
         * If duplicates exist, keeps the most recently used one and deletes others from Firebase.
         */
        async function deduplicateSavedFoods(foods) {
            if (!foods || foods.length === 0) return [];
            
            const foodMap = new Map();
            const duplicatesToDelete = [];
            
            // Create a unique key for each food based on name and nutritional values
            const createFoodKey = (food) => {
                const name = (food.name || '').toLowerCase().trim();
                const protein = parseFloat(food.protein) || 0;
                const carbs = parseFloat(food.carbs) || 0;
                const fats = parseFloat(food.fats) || 0;
                const calories = parseFloat(food.calories) || 0;
                return `${name}_${protein}_${carbs}_${fats}_${calories}`;
            };
            
            // Group foods by their unique key
            for (const food of foods) {
                const key = createFoodKey(food);
                
                if (!foodMap.has(key)) {
                    foodMap.set(key, food);
                } else {
                    // Duplicate found - keep the one with more recent lastUsed date
                    const existing = foodMap.get(key);
                    const existingDate = new Date(existing.lastUsed || 0);
                    const currentDate = new Date(food.lastUsed || 0);
                    
                    if (currentDate > existingDate) {
                        // Current food is more recent, replace existing and mark old for deletion
                        duplicatesToDelete.push(existing.id);
                        foodMap.set(key, food);
                    } else {
                        // Existing is more recent, mark current for deletion
                        duplicatesToDelete.push(food.id);
                    }
                }
            }
            
            // Delete duplicates from Firebase
            if (duplicatesToDelete.length > 0) {
                console.log(`Found ${duplicatesToDelete.length} duplicate saved foods to clean up`);
                
                for (const foodId of duplicatesToDelete) {
                    try {
                        const docRef = doc(db, "savedFoods", foodId);
                        await deleteDoc(docRef);
                        console.log(`Deleted duplicate saved food ${foodId}`);
                    } catch (e) {
                        console.error(`Error deleting duplicate food ${foodId}:`, e);
                    }
                }
                
                console.log(`Cleaned up ${duplicatesToDelete.length} duplicate saved foods from database`);
            }
            
            // Return deduplicated list
            return Array.from(foodMap.values());
        }

        // Weight Functions
        window.logWeight = async function() {
            const date = document.getElementById('weight-date-input').value;
            const weight = parseFloat(document.getElementById('weight-value-input').value);
            
            if (!date || !weight) {
                alert('Please enter both date and weight');
                return;
            }
            
            const weightData = { date, weight };
            
            try {
                const docRef = await addDoc(collection(db, "weight"), weightData);
                weightData.id = docRef.id;
                
                // Safety check: Initialize window.weightData if undefined
                if (!window.weightData) {
                    window.weightData = [];
                }
                
                window.weightData.unshift(weightData);
                
                document.getElementById('weight-value-input').value = '';
                
                createWeightChart();
                updateBodyGoalDisplay();
                updateNutritionCalories();
                alert('Weight logged successfully!');
            } catch (e) {
                console.error("Error logging weight:", e);
                alert('Error logging weight');
            }
        };

        function createWeightChart() {
            const ctx = document.getElementById('weight-chart');
            if (!ctx) return;
            
            if (charts.weight) charts.weight.destroy();
            
            const sortedWeights = [...weightData].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            charts.weight = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedWeights.map(w => formatDateString(w.date)),
                    datasets: [{
                        label: 'Weight (lbs)',
                        data: sortedWeights.map(w => w.weight),
                        borderColor: '#4A5D4A',
                        backgroundColor: 'rgba(74, 93, 74, 0.15)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Weight (lbs)' }
                        }
                    }
                }
            });
        }

        // Photo Functions
        window.uploadProgressPhoto = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const photoData = {
                    date: new Date().toISOString().split('T')[0],
                    dataUrl: e.target.result,
                    timestamp: new Date()
                };
                
                try {
                    const docRef = await addDoc(collection(db, "photos"), photoData);
                    
                    // Safety check: Initialize window.photoData if undefined
                    if (!window.photoData) {
                        window.photoData = [];
                    }
                    
                    window.photoData.unshift({ id: docRef.id, ...photoData });
                    renderPhotos();
                    alert('Photo uploaded successfully!');
                } catch (error) {
                    console.error("Error uploading photo:", error);
                    alert('Error uploading photo');
                }
            };
            reader.readAsDataURL(file);
        };

        window.deleteProgressPhoto = async function(photoId) {
            if (confirm('Delete this progress photo?')) {
                try {
                    // Delete from Firestore
                    await deleteDoc(doc(db, "photos", photoId));
                    
                    // Remove from local photoData array
                    window.photoData = window.photoData.filter(p => p.id !== photoId);
                    
                    // Re-render the gallery
                    renderPhotos();
                } catch (e) {
                    console.error("Error deleting progress photo:", e);
                    alert('Error deleting photo. Please try again.');
                }
            }
        };

        function renderPhotos() {
            const container = document.getElementById('photo-gallery');
            if (!container) return;
            
            if (window.photoData.length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center; padding: 2rem;">No progress photos yet. Upload your first one!</p>';
                return;
            }
            
            let html = '';
            window.photoData.forEach(photo => {
                html += `<div class="photo-item">
                    <img src="${photo.dataUrl}" alt="Progress photo">
                    <button class="btn-delete-photo" onclick="deleteProgressPhoto('${photo.id}')" title="Delete photo">Delete</button>
                    <div class="photo-date">${formatDateString(photo.date)}</div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        // Utility function to wipe all nutrition data (call from console: window.wipeNutritionData())
        window.wipeNutritionData = async function() {
            if (!confirm('WARNING: This will delete ALL nutrition and food data from Firestore. This cannot be undone!\n\nAre you sure you want to continue?')) {
                return;
            }
            
            if (!confirm('Please confirm one more time: Delete ALL nutrition data?')) {
                return;
            }
            
            try {
                console.log('Starting data wipe...');
                let deletedCount = 0;
                
                // Delete all nutrition documents
                const nutritionQuery = query(collection(db, "nutrition"));
                const nutritionSnapshot = await getDocs(nutritionQuery);
                
                for (const document of nutritionSnapshot.docs) {
                    await deleteDoc(doc(db, "nutrition", document.id));
                    deletedCount++;
                }
                
                console.log(`Deleted ${deletedCount} nutrition documents`);
                
                // Delete all saved foods
                const savedFoodsQuery = query(collection(db, "savedFoods"));
                const savedFoodsSnapshot = await getDocs(savedFoodsQuery);
                let savedFoodsDeleted = 0;
                
                for (const document of savedFoodsSnapshot.docs) {
                    await deleteDoc(doc(db, "savedFoods", document.id));
                    savedFoodsDeleted++;
                }
                
                console.log(`Deleted ${savedFoodsDeleted} saved food documents`);
                
                // Clear local state
                nutritionData = [];
                window.nutritionData = [];
                savedFoods = [];
                window.savedFoods = [];
                
                // Refresh UI
                renderMeals();
                renderSavedFoods();
                
                alert(`Data wipe complete!\n\nDeleted:\n- ${deletedCount} nutrition entries\n- ${savedFoodsDeleted} saved foods`);
            } catch (e) {
                console.error("Error wiping data:", e);
                alert('Error wiping data: ' + e.message);
            }
        };

        // Main app initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing Fitness Command Center...');
            
            // Initialize timezone-aware current nutrition date
            currentNutritionDate = getTodayDateString();
            
            // Set up UI immediately
            setupEventListeners();
            initializeWorkout();
            
            // Load data in background
            await Promise.all([
                loadWorkoutsFromFirebase(),
                loadNutritionData(),
                loadWeightData(),
                loadPhotoData(),
                loadSavedFoods(),
                loadBodyGoalData(),
                loadTravelModeData(),
                loadSickDayData()
            ]);
            
            // Update with real data
            updateSuggestions();
            updateAnalytics();
            updateInsights();
            updateProgress();
            renderSavedFoods();
            updateTravelModeBanner();
            
            console.log('Fitness Command Center loaded successfully!');
        });

        function setupEventListeners() {
            // Tab switching
            document.getElementById('workout-tab-btn').addEventListener('click', () => {
                showTab('workout');
                updateSuggestions();
            });
            document.getElementById('calendar-tab-btn').addEventListener('click', () => {
                showTab('calendar');
                renderCalendar();
            });
            document.getElementById('nutrition-tab-btn').addEventListener('click', () => {
                showTab('nutrition');
                renderMeals();
                renderSavedFoods();
                updateNutritionCalories();
            });
            document.getElementById('body-metrics-tab-btn').addEventListener('click', () => {
                showTab('body-metrics');
                createWeightChart();
                renderPhotos();
                updateBodyGoalDisplay();
            });
            document.getElementById('analytics-tab-btn').addEventListener('click', () => {
                showTab('analytics');
                updateAnalytics();
            });
            document.getElementById('progress-tab-btn').addEventListener('click', () => {
                showTab('progress');
                updateProgress();
            });
            document.getElementById('intelligence-tab-btn').addEventListener('click', () => {
                showTab('intelligence');
                updateInsights();
            });

            // Day selection
            document.getElementById('upper-btn').addEventListener('click', () => selectDay('Upper'));
            document.getElementById('lower-btn').addEventListener('click', () => selectDay('Lower'));
            document.getElementById('rest-btn').addEventListener('click', () => selectDay('Rest'));
            document.getElementById('push-btn').addEventListener('click', () => selectDay('Push'));
            document.getElementById('pull-btn').addEventListener('click', () => selectDay('Pull'));
            document.getElementById('legs-btn').addEventListener('click', () => selectDay('Legs'));

            // Complete workout
            document.getElementById('complete-workout-btn').addEventListener('click', completeWorkout);
            
            // Initialize date input to today (timezone-aware)
            const today = getTodayDateString();
            document.getElementById('workout-date-input').value = today;

            // Date input handling
            document.getElementById('workout-date-input').addEventListener('change', setWorkoutDate);
            document.getElementById('log-past-workout-btn').addEventListener('click', () => {
                const dateInput = document.getElementById('workout-date-input');
                if (dateInput.style.display === 'none' || !dateInput.style.display) {
                    dateInput.style.display = 'block';
                    dateInput.focus();
                }
            });

            // Intensity inputs
            setupIntensityInputs();

            setWorkoutDate(); // Initialize the button text
            
            // Calendar navigation
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
            
            // Nutrition date input
            const nutritionDateInput = document.getElementById('nutrition-date-input');
            nutritionDateInput.value = currentNutritionDate;
            nutritionDateInput.addEventListener('change', (e) => {
                currentNutritionDate = e.target.value;
                currentEditingMealId = null; // Clear meal context when changing dates
                renderMeals();
            });
            
            // Saved food search
            const savedFoodSearch = document.getElementById('saved-food-search');
            if (savedFoodSearch) {
                savedFoodSearch.addEventListener('input', (e) => {
                    renderSavedFoods(e.target.value);
                });
            }
            
            // Mobile saved food search
            const savedFoodSearchMobile = document.getElementById('saved-food-search-mobile');
            if (savedFoodSearchMobile) {
                savedFoodSearchMobile.addEventListener('input', (e) => {
                    renderSavedFoods(e.target.value);
                });
            }
            
            // Weight date input (timezone-aware)
            const weightDateInput = document.getElementById('weight-date-input');
            weightDateInput.value = getTodayDateString();
            
            // Goal start date input (timezone-aware)
            const goalStartDateInput = document.getElementById('goal-start-date-input');
            if (goalStartDateInput && !goalStartDateInput.value) {
                goalStartDateInput.value = getTodayDateString();
            }
            
            // Analytics dropdowns
            const exerciseSelector = document.getElementById('exercise-selector');
            if (exerciseSelector) {
                exerciseSelector.addEventListener('change', (e) => {
                    createPRTimelineChart(e.target.value);
                });
            }
            
            const comparisonSelector = document.getElementById('comparison-selector');
            if (comparisonSelector) {
                comparisonSelector.addEventListener('change', (e) => {
                    updateSessionComparison(e.target.value);
                });
            }
        }

        function setupIntensityInputs() {
            ['energy', 'motivation', 'fatigue', 'satisfaction'].forEach(type => {
                const scale = document.getElementById(`${type}-scale`);
                if (scale) {
                    scale.addEventListener('click', (e) => {
                        if (e.target.classList.contains('intensity-btn')) {
                            // Remove active class from siblings
                            scale.querySelectorAll('.intensity-btn').forEach(btn => btn.classList.remove('active'));
                            
                            // Add active class to clicked button
                            e.target.classList.add('active');
                            
                            // Update workout intensity
                            const value = parseInt(e.target.dataset.value);
                            if (['energy', 'motivation'].includes(type)) {
                                workoutIntensity.preWorkout[type] = value;
                            } else {
                                workoutIntensity.postWorkout[type] = value;
                            }
                        }
                    });
                }
            });
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-content').classList.add('active');
            document.getElementById(tabName + '-tab-btn').classList.add('active');
        }

        function selectDay(day) {
            currentDay = day;
            
            // Update day buttons
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(day.toLowerCase() + '-btn').classList.add('active');

            initializeWorkout();
            updateSuggestions();
        }

        function initializeWorkout() {
            currentWorkout = {};
            const exercises = workoutPlans[currentDay];

            exercises.forEach((exercise, index) => {
                const isStretch = exercise.name.toLowerCase().includes('stretch');
                const isRest = currentDay === 'Rest';
                
                currentWorkout[index] = {
                    exercise: exercise.name,
                    sets: (isStretch || isRest) ? 
                        [{ completed: false }] : 
                        Array(typeof exercise.sets === 'number' ? exercise.sets : 1).fill().map(() => ({
                            weight: '',
                            reps: '',
                            notes: ''
                        }))
                };
            });

            renderWorkout();
        }
        function renderWorkout() {
            const container = document.getElementById('exercises-container');
            const exercises = workoutPlans[currentDay];
            const exerciseProgression = getExerciseProgression();
            
            let html = '';
            
            exercises.forEach((exercise, exerciseIndex) => {
                const workoutExercise = currentWorkout[exerciseIndex];
                // Get last workout matching current exercise's approach
                const currentApproach = workoutExercise.approach || 'standard';
                const lastWorkout = getLastWorkoutForDay(currentDay, currentApproach);
                const previousExercise = lastWorkout?.exercises?.[exerciseIndex];
                
                // Check if this is a stretch exercise or rest day
                const isStretch = exercise.name.toLowerCase().includes('stretch');
                const isRest = currentDay === 'Rest';
                
                // Calculate suggested weight and get progression info
                let suggestedWeight = '';
                let progressionInfo = '';
                
                if (!isStretch && !isRest && previousExercise && previousExercise.sets.length > 0) {
                    const prevSets = previousExercise.sets.filter(set => set.weight && set.reps);
                    if (prevSets.length > 0) {
                        const avgWeight = prevSets.reduce((sum, set) => sum + parseFloat(set.weight), 0) / prevSets.length;
                        const avgReps = prevSets.reduce((sum, set) => sum + parseInt(set.reps), 0) / prevSets.length;
                        
                        if (avgReps >= 10) {
                            suggestedWeight = Math.round(avgWeight + 5);
                        } else if (avgReps >= 8) {
                            suggestedWeight = Math.round(avgWeight + 2.5);
                        } else {
                            suggestedWeight = Math.round(avgWeight);
                        }
                    }
                }
                
                // Get progression information
                if (!isStretch && !isRest && exerciseProgression[exercise.name]) {
                    const prog = exerciseProgression[exercise.name];
                    if (prog.type === 'strength') {
                        progressionInfo = `+${prog.progression.split('(+')[1]?.split(')')[0] || 'improved'}`;
                    } else if (prog.type === 'volume') {
                        progressionInfo = `+${prog.progression.split('(+')[1]?.split(')')[0] || 'reps'}`;
                    }
                }

                // Get PR for this exercise
                const prs = getPersonalRecords();
                const exercisePR = (!isStretch && !isRest) ? prs[exercise.name] : null;
                
                html += `
                    <div class="exercise-card">
                        <div class="exercise-header">
                            <div>
                                <div class="exercise-name">
                                    ${exercise.name}
                                    ${workoutExercise.substitution ? `<span class="substitution-tag">Alt for ${workoutExercise.originalExercise}</span>` : ''}
                                    ${workoutExercise.approach && !workoutExercise.substitution ? `<span class="substitution-tag">${workoutExercise.approach}</span>` : ''}
                                </div>
                                <div class="exercise-target">${exercise.sets} Ã— ${exercise.reps}</div>
                                ${progressionInfo ? `<div class="exercise-progress-indicator">${progressionInfo} last session</div>` : ''}
                                ${!isStretch && !isRest ? `
                                    <div class="approach-selector">
                                        <button class="approach-btn ${!workoutExercise.approach ? 'active' : ''}" onclick="setExerciseApproach(${exerciseIndex}, null)">Standard</button>
                                        <button class="approach-btn ${workoutExercise.approach === 'Heavy' ? 'active' : ''}" onclick="setExerciseApproach(${exerciseIndex}, 'Heavy')">Heavy</button>
                                        <button class="approach-btn ${workoutExercise.approach === 'Form Focus' ? 'active' : ''}" onclick="setExerciseApproach(${exerciseIndex}, 'Form Focus')">Form Focus</button>
                                        <button class="approach-btn ${workoutExercise.substitution ? 'active' : ''}" onclick="toggleSubstitution(${exerciseIndex})">Alt Exercise</button>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="exercise-intelligence">
                                ${suggestedWeight ? `<div class="suggested-weight">Try ${suggestedWeight}lbs</div>` : ''}
                                ${exercisePR ? `<div class="pr-indicator">PR: ${exercisePR.weight}lbs Ã— ${exercisePR.reps}</div>` : ''}
                            </div>
                        </div>

                        ${previousExercise && !isStretch && !isRest ? `
                            <div class="previous-session">
                                <div class="previous-header">Last session (${formatDateString(lastWorkout.date)})${lastWorkout.exercises?.[exerciseIndex]?.approach ? ` - ${lastWorkout.exercises[exerciseIndex].approach}` : ''}:</div>
                                <div class="previous-sets-compact">
                                    ${previousExercise.sets.filter(set => set.weight || set.reps).map(set => {
                                        let setStr = `${set.weight}Ã—${set.reps}`;
                                        if (set.notes) setStr += ` (${set.notes})`;
                                        return setStr;
                                    }).join(', ')}
                                </div>
                            </div>
                        ` : ''}`;

                if (isStretch || isRest) {
                    const label = isRest ? 'Rest Day Complete' : exercise.name;
                    html += `
                        <div class="stretch-row">
                            <div class="stretch-info">
                                <div class="set-number">âœ“</div>
                                <div class="stretch-label">${label}</div>
                            </div>
                            <input type="checkbox" class="stretch-checkbox" 
                                   ${workoutExercise.sets[0]?.completed ? 'checked' : ''}
                                   onchange="updateStretch(${exerciseIndex}, this.checked)">
                        </div>
                    `;
                } else {
                    html += `<div class="set-input-grid">`;
                    
                    workoutExercise.sets.forEach((set, setIndex) => {
                        html += `
                            <div class="set-row">
                                <div class="set-number">${setIndex + 1}</div>
                                <input type="number" class="weight-input" placeholder="lbs" 
                                       value="${set.weight}" 
                                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'weight', this.value)">
                                <span style="color: var(--color-text-secondary);">Ã—</span>
                                <input type="number" class="reps-input" placeholder="reps" 
                                       value="${set.reps}" 
                                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'reps', this.value)">
                                <input type="text" class="notes-input" placeholder="notes" 
                                       value="${set.notes}" 
                                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'notes', this.value)">
                                ${previousExercise?.sets[setIndex]?.weight ? `
                                    <button class="btn btn-copy" onclick="copyPrevious(${exerciseIndex}, ${setIndex})">Copy</button>
                                ` : ''}
                            </div>`;
                    });
                    
                    html += `
                            </div>
                            <button class="btn btn-add" onclick="addSet(${exerciseIndex})" style="margin-top: 0.75rem;">+ Add Set</button>
                        `;
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        // Make functions globally available
        window.updateSet = function(exerciseIndex, setIndex, field, value) {
            currentWorkout[exerciseIndex].sets[setIndex][field] = value;
        };

        window.addSet = function(exerciseIndex) {
            currentWorkout[exerciseIndex].sets.push({ weight: '', reps: '', notes: '' });
            renderWorkout();
        };

        window.copyPrevious = function(exerciseIndex, setIndex) {
            // Get last workout matching current exercise's approach
            const currentApproach = currentWorkout[exerciseIndex].approach || 'standard';
            const lastWorkout = getLastWorkoutForDay(currentDay, currentApproach);
            const previousSet = lastWorkout?.exercises?.[exerciseIndex]?.sets[setIndex];
            
            if (previousSet) {
                currentWorkout[exerciseIndex].sets[setIndex].weight = previousSet.weight;
                currentWorkout[exerciseIndex].sets[setIndex].reps = previousSet.reps;
                renderWorkout();
            }
        };

        window.updateStretch = function(exerciseIndex, completed) {
            currentWorkout[exerciseIndex].sets[0] = { completed: completed };
        };

        window.setExerciseApproach = function(exerciseIndex, approach) {
            currentWorkout[exerciseIndex].approach = approach;
            renderWorkout();
        };

        window.toggleSubstitution = function(exerciseIndex) {
            if (currentWorkout[exerciseIndex].substitution) {
                // Remove substitution
                delete currentWorkout[exerciseIndex].substitution;
                delete currentWorkout[exerciseIndex].originalExercise;
                renderWorkout();
            } else {
                // Open modal to select/enter alternative exercise
                currentAltExerciseIndex = exerciseIndex;
                showAltExerciseModal(exerciseIndex);
            }
        };

        window.showAltExerciseModal = function(exerciseIndex) {
            const modal = document.getElementById('alt-exercise-modal');
            const nameInput = document.getElementById('alt-exercise-name-input');
            const originalExerciseName = currentWorkout[exerciseIndex].exercise;
            
            // Clear input
            nameInput.value = '';
            
            // Show modal
            modal.classList.add('active');
            
            // Focus input
            setTimeout(() => nameInput.focus(), 100);
            
            // Load and display history for this exercise
            loadAltExerciseHistory(originalExerciseName);
        };

        window.closeAltExerciseModal = function() {
            const modal = document.getElementById('alt-exercise-modal');
            modal.classList.remove('active');
            currentAltExerciseIndex = null;
        };

        window.confirmAltExercise = function() {
            const nameInput = document.getElementById('alt-exercise-name-input');
            const altExerciseName = nameInput.value.trim();
            
            if (!altExerciseName) {
                alert('Please enter an alternative exercise name');
                return;
            }
            
            if (currentAltExerciseIndex !== null) {
                const originalExercise = currentWorkout[currentAltExerciseIndex].exercise;
                
                currentWorkout[currentAltExerciseIndex].substitution = altExerciseName;
                currentWorkout[currentAltExerciseIndex].originalExercise = originalExercise;
                currentWorkout[currentAltExerciseIndex].exercise = altExerciseName;
                
                // Save to history
                saveAltExerciseToHistory(originalExercise, altExerciseName);
                
                closeAltExerciseModal();
                renderWorkout();
            }
        };

        window.selectAltExerciseFromHistory = function(altExerciseName) {
            const nameInput = document.getElementById('alt-exercise-name-input');
            nameInput.value = altExerciseName;
        };

        async function loadAltExerciseHistory(originalExerciseName) {
            try {
                const q = query(
                    collection(db, "alternativeExercises"),
                    where("originalExercise", "==", originalExerciseName),
                    orderBy("lastUsed", "desc"),
                    limit(10)
                );
                
                const querySnapshot = await getDocs(q);
                const history = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    history.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                // Also check local state
                if (!alternativeExerciseHistory[originalExerciseName]) {
                    alternativeExerciseHistory[originalExerciseName] = [];
                }
                
                // Merge and deduplicate
                const seenNames = new Set();
                const merged = [];
                
                for (const item of history) {
                    if (!seenNames.has(item.alternativeExercise)) {
                        seenNames.add(item.alternativeExercise);
                        merged.push(item);
                    }
                }
                
                alternativeExerciseHistory[originalExerciseName] = merged;
                renderAltExerciseHistory(merged);
                
            } catch (e) {
                console.error("Error loading alternative exercise history:", e);
                renderAltExerciseHistory([]);
            }
        }

        function renderAltExerciseHistory(history) {
            const historySection = document.getElementById('alt-exercise-history-section');
            const historyList = document.getElementById('alt-exercise-history-list');
            
            if (history.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            
            historySection.style.display = 'block';
            
            let html = '';
            history.forEach(item => {
                const lastUsedDate = item.lastUsed ? new Date(item.lastUsed).toLocaleDateString() : 'Unknown';
                const useCount = item.useCount || 1;
                
                html += `
                    <div class="alt-exercise-history-item" onclick="selectAltExerciseFromHistory('${item.alternativeExercise.replace(/'/g, "\\'")}')">
                        <div class="alt-exercise-history-item-name">${item.alternativeExercise}</div>
                        <div class="alt-exercise-history-item-meta">
                            <div class="alt-exercise-history-item-date">${lastUsedDate}</div>
                            <div class="alt-exercise-history-item-count">Used ${useCount}x</div>
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        async function saveAltExerciseToHistory(originalExercise, alternativeExercise) {
            try {
                // Check if this combination already exists
                const q = query(
                    collection(db, "alternativeExercises"),
                    where("originalExercise", "==", originalExercise),
                    where("alternativeExercise", "==", alternativeExercise)
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    // Create new entry
                    const data = {
                        originalExercise: originalExercise,
                        alternativeExercise: alternativeExercise,
                        firstUsed: new Date().toISOString(),
                        lastUsed: new Date().toISOString(),
                        useCount: 1
                    };
                    
                    await addDoc(collection(db, "alternativeExercises"), data);
                    console.log('Saved new alternative exercise to history');
                } else {
                    // Update existing entry
                    querySnapshot.forEach(async (document) => {
                        const docRef = doc(db, "alternativeExercises", document.id);
                        const currentData = document.data();
                        await updateDoc(docRef, {
                            lastUsed: new Date().toISOString(),
                            useCount: (currentData.useCount || 0) + 1
                        });
                    });
                    console.log('Updated alternative exercise history');
                }
            } catch (e) {
                console.error("Error saving alternative exercise to history:", e);
            }
        }

        window.setWorkoutDate = function() {
            const dateInput = document.getElementById('workout-date-input');
            const logBtn = document.getElementById('log-past-workout-btn');
            const today = getTodayDateString();
            
            if (dateInput.value && dateInput.value !== today) {
                logBtn.textContent = 'For ' + formatDateString(dateInput.value);
                logBtn.style.background = 'rgba(93, 138, 102, 0.15)';
                logBtn.style.color = '#5D8A66';
                logBtn.style.borderColor = '#A8B5A0';
            } else {
                logBtn.textContent = 'Log Past Workout';
                logBtn.style.background = 'rgba(168, 181, 160, 0.15)';
                logBtn.style.color = '#4A5D4A';
                logBtn.style.borderColor = '#A8B5A0';
            }
        };

        async function completeWorkout() {
            const dateInput = document.getElementById('workout-date-input');
            const today = getTodayDateString();
            const selectedDate = dateInput.value && dateInput.value !== today ? dateInput.value : today;
            
            const workoutData = {
                date: selectedDate,
                day: currentDay,
                exercises: currentWorkout,
                intensity: {
                    energy: workoutIntensity.preWorkout.energy,
                    motivation: workoutIntensity.preWorkout.motivation,
                    fatigue: workoutIntensity.postWorkout.fatigue,
                    satisfaction: workoutIntensity.postWorkout.satisfaction
                }
            };
            
            try {
                // Save to Firebase
                await saveWorkoutToFirebase(workoutData);
                
                // Also save locally as backup
                const localHistory = JSON.parse(localStorage.getItem('fitnessData') || '{}');
                const workoutKey = currentDay + '-' + selectedDate + '-' + Date.now();
                localHistory[workoutKey] = workoutData;
                localStorage.setItem('fitnessData', JSON.stringify(localHistory));
                
                // Reload data from Firebase
                await loadWorkoutsFromFirebase();
                
                // Export to clipboard
                exportToClipboard();
                
                alert('Workout saved to Firebase and copied to clipboard!');
                
                // Reset intensity inputs
                workoutIntensity = {
                    preWorkout: { energy: null, motivation: null },
                    postWorkout: { fatigue: null, satisfaction: null }
                };
                
                // Clear active intensity buttons
                document.querySelectorAll('.intensity-btn').forEach(btn => btn.classList.remove('active'));
                
                // Reset and refresh
                initializeWorkout();
                updateSuggestions();
                updateAnalytics();
                
            } catch (error) {
                console.error('Error saving workout:', error);
                alert('Error saving workout. Check your internet connection.');
            }
        }

        function exportToClipboard() {
            const dateInput = document.getElementById('workout-date-input');
            const workoutDate = dateInput.value ? new Date(dateInput.value) : new Date();
            const dateString = workoutDate.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short', 
                day: 'numeric'
            });
            
            let exportText = currentDay + ' | ' + dateString + '\n';
            exportText += '=========================\n';
            
            // Add intensity ratings if available
            if (workoutIntensity.preWorkout.energy || workoutIntensity.postWorkout.satisfaction) {
                exportText += '\nSession Intensity:\n';
                if (workoutIntensity.preWorkout.energy) exportText += `Energy: ${workoutIntensity.preWorkout.energy}/5 `;
                if (workoutIntensity.preWorkout.motivation) exportText += `| Motivation: ${workoutIntensity.preWorkout.motivation}/5\n`;
                if (workoutIntensity.postWorkout.fatigue) exportText += `Fatigue: ${workoutIntensity.postWorkout.fatigue}/5 `;
                if (workoutIntensity.postWorkout.satisfaction) exportText += `| Satisfaction: ${workoutIntensity.postWorkout.satisfaction}/5\n`;
                exportText += '\n';
            }
            
            Object.values(currentWorkout).forEach(exercise => {
                exportText += exercise.exercise;
                if (exercise.substitution && exercise.originalExercise) {
                    exportText += ' (Alt for ' + exercise.originalExercise + ')';
                } else if (exercise.approach) {
                    exportText += ' (' + exercise.approach + ')';
                }
                exportText += '\n';
                
                exercise.sets.forEach((set, index) => {
                    if (set.completed) {
                        exportText += '  âœ“ Completed\n';
                    } else if (set.weight || set.reps) {
                        exportText += '  ' + set.weight + 'lbs Ã— ' + set.reps;
                        if (set.notes) exportText += ' (' + set.notes + ')';
                        exportText += '\n';
                    }
                });
                exportText += '\n';
            });
            
            // Copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(exportText);
            } else {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = exportText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }
    </script>
</body>
</html>
