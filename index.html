<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zach's Fitness Command Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            background: linear-gradient(45deg, #06b6d4, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #64748b;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .workout-day-selector {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .day-btn {
            padding: 0.75rem 1.25rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
            border: none;
        }

        .day-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .intelligence-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .intelligence-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .intelligence-header h3 {
            color: #06b6d4;
            font-weight: 600;
        }

        .ai-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .suggestion-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.2);
            border-radius: 12px;
            padding: 1rem;
        }

        .suggestion-type {
            color: #f59e0b;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .suggestion-text {
            color: #e2e8f0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .exercise-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .exercise-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .exercise-target {
            display: inline-block;
            background: rgba(6, 182, 212, 0.2);
            color: #06b6d4;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .exercise-intelligence {
            text-align: right;
            flex-shrink: 0;
        }

        .suggested-weight {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .pr-indicator {
            color: #f59e0b;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .progression-indicator {
            color: #10b981;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .previous-session {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .previous-header {
            color: #60a5fa;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .previous-sets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
        }

        .previous-set {
            color: #93c5fd;
            font-size: 0.8rem;
            text-align: center;
            padding: 0.25rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
        }

        .previous-sets-compact {
            color: #93c5fd;
            font-size: 0.85rem;
            line-height: 1.4;
            background: rgba(59, 130, 246, 0.05);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid rgba(59, 130, 246, 0.15);
            max-height: 4rem;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .previous-sets-compact::-webkit-scrollbar {
            width: 6px;
        }
        
        .previous-sets-compact::-webkit-scrollbar-track {
            background: rgba(59, 130, 246, 0.05);
            border-radius: 3px;
        }
        
        .previous-sets-compact::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        
        .previous-sets-compact::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }

        .intensity-inputs {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .intensity-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .intensity-row:last-child {
            margin-bottom: 0;
        }

        .intensity-label {
            color: #e2e8f0;
            font-weight: 500;
            min-width: 80px;
        }

        .intensity-scale {
            display: flex;
            gap: 0.5rem;
        }

        .intensity-btn {
            width: 2rem;
            height: 2rem;
            border: 1px solid rgba(71, 85, 105, 0.5);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .intensity-btn.active {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
            border-color: transparent;
        }

        .set-input-grid {
            display: grid;
            gap: 0.75rem;
        }

        .set-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(15, 23, 42, 0.6);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .set-number {
            width: 2rem;
            color: #64748b;
            font-weight: 600;
            text-align: center;
        }

        .weight-input, .reps-input {
            width: 4rem;
            padding: 0.5rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            color: white;
            text-align: center;
            font-weight: 500;
        }

        .weight-input:focus, .reps-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .notes-input {
            flex: 1;
            padding: 0.5rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }

        .notes-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .notes-input::placeholder {
            color: #64748b;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-copy {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-copy:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-add {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .btn-add:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .btn-complete {
            padding: 1rem 3rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            display: block;
            margin: 2rem auto 0;
        }

        .btn-complete:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .analytics-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }



        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .insights-list {
            list-style: none;
        }

        .insight-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            border-left: 4px solid #06b6d4;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .plateau-alert {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .progression-highlight {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .stretch-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(71, 85, 105, 0.5);
            border-radius: 4px;
            cursor: pointer;
            appearance: none;
            position: relative;
            transition: all 0.3s ease;
        }

        .stretch-checkbox:checked {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
        }

        .stretch-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .stretch-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(15, 23, 42, 0.6);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            justify-content: space-between;
        }

        .stretch-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .stretch-label {
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .exercise-progress-indicator {
            font-size: 0.75rem;
            color: #10b981;
            margin-bottom: 0.25rem;
        }

        /* Calendar Styles */
        .calendar-container {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-nav-btn {
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            color: #3b82f6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-nav-btn:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .calendar-month-year {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day-header {
            text-align: center;
            padding: 0.5rem;
            color: #64748b;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(71, 85, 105, 0.5);
            transform: scale(1.05);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.3);
        }

        .calendar-day.has-workout {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
        }

        .calendar-day.scheduled {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .calendar-day.missed {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .calendar-day-number {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .calendar-day-label {
            font-size: 0.7rem;
            color: #94a3b8;
            text-align: center;
        }

        .calendar-day-label.Upper { color: #10b981; }
        .calendar-day-label.Lower { color: #f59e0b; }
        .calendar-day-label.Push { color: #ef4444; }
        .calendar-day-label.Pull { color: #3b82f6; }
        .calendar-day-label.Legs { color: #8b5cf6; }
        .calendar-day-label.Rest { color: #64748b; }

        .adherence-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .adherence-score {
            text-align: center;
            margin-bottom: 1rem;
        }

        .adherence-score-value {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .adherence-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .adherence-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
        }

        .adherence-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
        }

        .adherence-stat-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .selected-day-workout {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
        }

        /* Nutrition Styles */
        .meal-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.75rem;
        }

        .meal-type {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .meal-time {
            color: #64748b;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .food-input-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .food-input {
            flex: 2;
            min-width: 200px;
            padding: 0.75rem;
            min-height: 44px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            color: white;
            font-size: 1rem;
        }

        .food-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .macro-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .macro-input-label {
            color: #94a3b8;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .macro-input {
            width: 80px;
            padding: 0.75rem 0.5rem;
            min-height: 44px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            color: white;
            text-align: center;
            font-size: 1rem;
        }

        .macro-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .macro-inputs-grid {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .food-action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .macro-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(71, 85, 105, 0.3);
        }

        .macro-item {
            text-align: center;
        }

        .macro-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
        }

        .macro-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        /* Body Metrics Styles */
        .weight-input-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .weight-input-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .weight-input-field {
            flex: 1;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }

        .weight-input-field:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .photo-upload-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .photo-upload-area {
            border: 2px dashed rgba(71, 85, 105, 0.5);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload-area:hover {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.05);
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-date {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.25rem;
            font-size: 0.7rem;
            color: white;
            text-align: center;
        }

        .btn-delete-photo {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.5rem;
            min-width: 36px;
            min-height: 36px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .btn-delete-photo:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        /* Saved Foods Styles */
        .saved-foods-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .saved-food-search {
            width: 100%;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 8px;
            color: white;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .saved-food-search:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .saved-food-list {
            display: grid;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .saved-food-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .saved-food-item:hover {
            background: rgba(71, 85, 105, 0.3);
            border-color: #06b6d4;
        }

        .saved-food-info {
            flex: 1;
        }

        .saved-food-name {
            color: white;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .saved-food-macros {
            color: #94a3b8;
            font-size: 0.75rem;
            display: flex;
            gap: 0.75rem;
        }

        .saved-food-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-quick-add {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-quick-add:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-delete-food {
            padding: 0.75rem;
            min-width: 44px;
            min-height: 44px;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-delete-food:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .btn-save-food {
            padding: 0.75rem 1rem;
            min-height: 44px;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-save-food:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        /* Meal Type Selection Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .meal-type-buttons {
            display: grid;
            gap: 1rem;
        }

        .meal-type-btn {
            padding: 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(71, 85, 105, 0.5);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
        }

        .meal-type-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .modal-close {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #ef4444;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Exercise Substitution Styles */
        .substitution-tag {
            display: inline-block;
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .approach-selector {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .approach-btn {
            padding: 0.25rem 0.75rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .approach-btn.active {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border-color: #a855f7;
        }

        .approach-btn:hover {
            background: rgba(71, 85, 105, 0.5);
        }

        @media (max-width: 768px) {
            /* Reduce body padding for more screen space */
            body {
                padding: 0.5rem;
            }

            /* Optimize header for mobile */
            .header {
                margin-bottom: 1rem;
                padding: 1rem 0;
            }

            .header h1 {
                font-size: 1.75rem;
                margin-bottom: 0.25rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            /* Optimize tabs for mobile scrolling */
            .nav-tabs {
                gap: 0.5rem;
                margin-bottom: 1rem;
            }

            .nav-tab {
                padding: 0.65rem 1rem;
                font-size: 0.9rem;
                min-height: 44px;
            }
            
            .exercise-header {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .set-row {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .intensity-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            /* Fix calendar grid overflow on mobile */
            .calendar-container {
                overflow-x: auto;
                overflow-y: hidden;
            }

            .calendar-grid {
                min-width: 100%;
            }

            .calendar-day {
                min-width: 40px;
                min-height: 40px;
                padding: 0.25rem;
                font-size: 0.8rem;
            }

            .calendar-day-number {
                font-size: 0.85rem;
            }

            .calendar-day-label {
                font-size: 0.6rem;
            }

            /* Fix weight tracking section overflow on mobile */
            .weight-input-row {
                flex-direction: column;
                gap: 0.75rem;
            }

            .weight-input-field {
                width: 100%;
            }

            /* Ensure photo gallery is responsive */
            .photo-gallery {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            /* Mobile-optimized meal cards */
            .meal-card {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 12px;
            }

            .meal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                margin-bottom: 0.75rem;
            }

            .meal-header > div:first-child {
                width: 100%;
            }

            .meal-header button {
                width: 100%;
                min-height: 44px;
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .meal-type {
                width: 100%;
                font-size: 1.1rem;
                padding: 0.75rem;
                min-height: 48px;
            }

            .meal-time {
                font-size: 0.8rem;
            }

            /* Optimize food input rows for mobile */
            .food-input-row {
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 0.75rem;
            }

            .food-input {
                width: 100%;
                min-width: 100%;
                padding: 0.75rem;
                font-size: 1rem;
            }

            /* Create a grid layout for macro inputs on mobile */
            .macro-inputs-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                width: 100%;
            }

            .macro-input-wrapper {
                width: 100%;
            }

            .macro-input {
                width: 100%;
                padding: 0.75rem;
                font-size: 1rem;
                min-height: 48px;
            }

            /* Make action buttons full width on mobile */
            .food-action-buttons {
                display: flex;
                gap: 0.5rem;
                width: 100%;
                margin-top: 0.5rem;
            }

            .btn-save-food,
            .btn-delete-food {
                flex: 1;
                min-height: 48px;
                padding: 0.75rem;
                font-size: 0.95rem;
            }

            /* Optimize macro summary for mobile */
            .macro-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-top: 1rem;
                padding-top: 1rem;
            }

            .macro-item {
                padding: 0.75rem;
                background: rgba(15, 23, 42, 0.6);
                border-radius: 8px;
            }

            .macro-value {
                font-size: 1.3rem;
            }

            .macro-label {
                font-size: 0.75rem;
            }

            /* Add Meal button optimization */
            .btn-add {
                width: 100%;
                min-height: 48px;
                padding: 0.75rem;
                font-size: 0.95rem;
                margin-top: 0.5rem;
            }

            /* Optimize saved foods panel */
            .saved-foods-panel {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .saved-food-item {
                padding: 0.75rem;
            }

            .btn-quick-add {
                min-height: 44px;
                padding: 0.65rem 0.85rem;
                font-size: 0.85rem;
            }

            /* Analytics card optimization */
            .analytics-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .analytics-title {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            /* Reduce intelligence panel spacing */
            .intelligence-panel {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .suggestions-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .suggestion-card {
                padding: 0.75rem;
            }
        }

        /* Additional breakpoint for very small phones (iPhone SE, etc.) */
        @media (max-width: 375px) {
            body {
                padding: 0.25rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.85rem;
            }

            .meal-card {
                padding: 0.75rem;
            }

            .macro-summary {
                grid-template-columns: 1fr;
            }

            .macro-input {
                width: 100%;
            }

            .food-input-row {
                gap: 0.4rem;
            }
        }

        /* Breakpoint for larger phones */
        @media (min-width: 414px) and (max-width: 768px) {
            .macro-inputs-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Zach's Fitness Command Center</h1>
            <p>Intelligent Workout Tracking & Performance Analytics</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" id="workout-tab-btn">üèãÔ∏è Workout</div>
            <div class="nav-tab" id="calendar-tab-btn">üìÖ Calendar</div>
            <div class="nav-tab" id="nutrition-tab-btn">üçé Nutrition</div>
            <div class="nav-tab" id="body-metrics-tab-btn">‚öñÔ∏è Body</div>
            <div class="nav-tab" id="analytics-tab-btn">üìä Analytics</div>
            <div class="nav-tab" id="progress-tab-btn">üìà Progress</div>
            <div class="nav-tab" id="intelligence-tab-btn">üß† Insights</div>
        </div>

        <!-- WORKOUT TAB -->
        <div id="workout-content" class="tab-content active">
            <div class="workout-day-selector">
                <button class="day-btn active" id="upper-btn">Upper</button>
                <button class="day-btn" id="lower-btn">Lower</button>
                <button class="day-btn" id="rest-btn">Rest</button>
                <button class="day-btn" id="push-btn">Push</button>
                <button class="day-btn" id="pull-btn">Pull</button>
                <button class="day-btn" id="legs-btn">Legs</button>
            </div>

            <div class="workout-controls" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap;">
                <button class="btn" id="log-past-workout-btn" style="background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3);">üìÖ Log Past Workout</button>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <label style="color: #94a3b8; font-size: 0.9rem;">Date:</label>
                    <input type="date" id="workout-date-input" style="padding: 0.5rem; background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 6px; color: white;">
                </div>
            </div>

            <div class="intensity-inputs">
                <h4 style="color: #06b6d4; margin-bottom: 1rem;">How are you feeling?</h4>
                <div class="intensity-row">
                    <span class="intensity-label">Energy:</span>
                    <div class="intensity-scale" id="energy-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: #64748b; font-size: 0.8rem;">Dragging ‚Üí Energetic</span>
                </div>
                <div class="intensity-row">
                    <span class="intensity-label">Motivation:</span>
                    <div class="intensity-scale" id="motivation-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: #64748b; font-size: 0.8rem;">Forced ‚Üí Eager</span>
                </div>
            </div>

            <div class="intelligence-panel">
                <div class="intelligence-header">
                    <div class="ai-icon">AI</div>
                    <h3>Workout Intelligence</h3>
                </div>
                <div class="suggestions-grid" id="suggestions-container">
                    <div class="suggestion-card">
                        <div class="suggestion-type">Loading...</div>
                        <div class="suggestion-text">Loading AI suggestions...</div>
                    </div>
                </div>
            </div>

            <div id="exercises-container">
                <!-- Exercises will be populated here -->
            </div>

            <div class="intensity-inputs">
                <h4 style="color: #06b6d4; margin-bottom: 1rem;">How did the workout go?</h4>
                <div class="intensity-row">
                    <span class="intensity-label">Fatigue:</span>
                    <div class="intensity-scale" id="fatigue-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: #64748b; font-size: 0.8rem;">Exhausted ‚Üí Energized</span>
                </div>
                <div class="intensity-row">
                    <span class="intensity-label">Satisfaction:</span>
                    <div class="intensity-scale" id="satisfaction-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: #64748b; font-size: 0.8rem;">Poor ‚Üí Crushed it</span>
                </div>
            </div>

            <button class="btn-complete" id="complete-workout-btn">Complete Session</button>
        </div>

        <!-- CALENDAR TAB -->
        <div id="calendar-content" class="tab-content">
            <div class="adherence-card">
                <h3 class="analytics-title">üìä Workout Adherence</h3>
                <div class="adherence-score">
                    <div class="adherence-score-value" id="adherence-score">0%</div>
                    <div class="stat-label">Discipline Score</div>
                </div>
                <div class="adherence-stats">
                    <div class="adherence-stat">
                        <div class="adherence-stat-value" id="workouts-completed">0</div>
                        <div class="adherence-stat-label">Completed</div>
                    </div>
                    <div class="adherence-stat">
                        <div class="adherence-stat-value" id="workouts-scheduled">0</div>
                        <div class="adherence-stat-label">Scheduled</div>
                    </div>
                    <div class="adherence-stat">
                        <div class="adherence-stat-value" id="workouts-missed">0</div>
                        <div class="adherence-stat-label">Missed</div>
                    </div>
                </div>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" id="prev-month-btn">‚Üê Previous</button>
                    <div class="calendar-month-year" id="calendar-month-year">Loading...</div>
                    <button class="calendar-nav-btn" id="next-month-btn">Next ‚Üí</button>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar will be rendered here -->
                </div>
            </div>

            <div class="selected-day-workout" id="selected-day-workout" style="display: none;">
                <h3 class="analytics-title" id="selected-day-title">Workout Details</h3>
                <div id="selected-day-content">
                    <!-- Selected day workout will be rendered here -->
                </div>
            </div>
        </div>

        <!-- NUTRITION TAB -->
        <div id="nutrition-content" class="tab-content">
            <div class="analytics-card">
                <h3 class="analytics-title">üçé Daily Nutrition</h3>
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <label style="color: #94a3b8; font-size: 0.9rem;">Date:</label>
                    <input type="date" id="nutrition-date-input" style="padding: 0.5rem; background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 6px; color: white;">
                </div>
                <div class="macro-summary">
                    <div class="macro-item">
                        <div class="macro-value" id="total-calories">0</div>
                        <div class="macro-label">Calories</div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-value" id="total-protein">0g</div>
                        <div class="macro-label">Protein</div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-value" id="total-carbs">0g</div>
                        <div class="macro-label">Carbs</div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-value" id="total-fats">0g</div>
                        <div class="macro-label">Fats</div>
                    </div>
                </div>
            </div>

            <div class="saved-foods-panel">
                <h3 class="analytics-title">‚≠ê Saved Foods</h3>
                <input type="text" id="saved-food-search" class="saved-food-search" placeholder="Search saved foods...">
                <div class="saved-food-list" id="saved-food-list">
                    <div class="empty-state">No saved foods yet. Save a food from a meal below!</div>
                </div>
            </div>

            <div id="meals-container">
                <!-- Meals will be rendered here -->
            </div>

            <button class="btn btn-add" onclick="addMeal()" style="width: 100%; padding: 1rem; font-size: 1rem;">+ Add Meal</button>
        </div>

        <!-- BODY METRICS TAB -->
        <div id="body-metrics-content" class="tab-content">
            <div class="weight-input-card">
                <h3 class="analytics-title">‚öñÔ∏è Weight Tracking</h3>
                <div class="weight-input-row">
                    <input type="date" id="weight-date-input" class="weight-input-field" style="flex: 0.5;">
                    <input type="number" id="weight-value-input" class="weight-input-field" placeholder="Weight (lbs)" step="0.1">
                    <button class="btn btn-complete" onclick="logWeight()" style="margin: 0; padding: 0.75rem 1.5rem;">Log Weight</button>
                </div>
            </div>

            <div class="analytics-card">
                <h3 class="analytics-title">üìà Weight Progress</h3>
                <div class="chart-container">
                    <canvas id="weight-chart"></canvas>
                </div>
            </div>

            <div class="photo-upload-card">
                <h3 class="analytics-title">üì∏ Progress Photos</h3>
                <div class="photo-upload-area" onclick="document.getElementById('photo-input').click()">
                    <input type="file" id="photo-input" accept="image/*" style="display: none;" onchange="uploadProgressPhoto(event)">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üì∑</div>
                    <div style="color: #94a3b8;">Click to upload a progress photo</div>
                </div>
                <div class="photo-gallery" id="photo-gallery">
                    <!-- Photos will be rendered here -->
                </div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics-content" class="tab-content">
            <!-- Row 1: Main Stats and Volume Cards -->
            <div class="analytics-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="analytics-card">
                    <h3 class="analytics-title">üéØ Personal Records</h3>
                    <div class="stat-value" id="pr-count">0</div>
                    <div class="stat-label">PRs set this week</div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üî• Workout Streak</h3>
                    <div class="stat-value" id="workout-streak">0</div>
                    <div class="stat-label">consecutive workouts</div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üí™ Upper Volume</h3>
                    <div class="stat-value" id="upper-record">0</div>
                    <div class="stat-label">Record: <span id="upper-record-lbs">0</span> lbs</div>
                    <div class="stat-label">Avg: <span id="upper-avg">0</span> lbs | <span id="upper-trend">‚Üí</span></div>
                    <div class="stat-label" style="font-size: 0.8rem; margin-top: 0.5rem;"><span id="upper-mom"></span></div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üèãÔ∏è Lower Volume</h3>
                    <div class="stat-value" id="lower-record">0</div>
                    <div class="stat-label">Record: <span id="lower-record-lbs">0</span> lbs</div>
                    <div class="stat-label">Avg: <span id="lower-avg">0</span> lbs | <span id="lower-trend">‚Üí</span></div>
                    <div class="stat-label" style="font-size: 0.8rem; margin-top: 0.5rem;"><span id="lower-mom"></span></div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üöÄ Push Volume</h3>
                    <div class="stat-value" id="push-record">0</div>
                    <div class="stat-label">Record: <span id="push-record-lbs">0</span> lbs</div>
                    <div class="stat-label">Avg: <span id="push-avg">0</span> lbs | <span id="push-trend">‚Üí</span></div>
                    <div class="stat-label" style="font-size: 0.8rem; margin-top: 0.5rem;"><span id="push-mom"></span></div>
                </div>
            </div>

            <!-- Row 2: More Volume Cards -->
            <div class="analytics-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                <div class="analytics-card">
                    <h3 class="analytics-title">üéØ Pull Volume</h3>
                    <div class="stat-value" id="pull-record">0</div>
                    <div class="stat-label">Record: <span id="pull-record-lbs">0</span> lbs</div>
                    <div class="stat-label">Avg: <span id="pull-avg">0</span> lbs | <span id="pull-trend">‚Üí</span></div>
                    <div class="stat-label" style="font-size: 0.8rem; margin-top: 0.5rem;"><span id="pull-mom"></span></div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">ü¶µ Legs Volume</h3>
                    <div class="stat-value" id="legs-record">0</div>
                    <div class="stat-label">Record: <span id="legs-record-lbs">0</span> lbs</div>
                    <div class="stat-label">Avg: <span id="legs-avg">0</span> lbs | <span id="legs-trend">‚Üí</span></div>
                    <div class="stat-label" style="font-size: 0.8rem; margin-top: 0.5rem;"><span id="legs-mom"></span></div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">‚ö†Ô∏è Focus Areas</h3>
                    <div id="focus-areas-content" style="color: #94a3b8; font-size: 0.9rem;">
                        <p>Complete more workouts to see focus areas!</p>
                    </div>
                </div>
            </div>

            <!-- Row 3: Charts -->
            <div class="chart-grid">
                <div class="analytics-card">
                    <h3 class="analytics-title">üèÜ PR Timeline</h3>
                    <div style="margin-bottom: 1rem;">
                        <label for="exercise-selector" style="color: #94a3b8; font-size: 0.9rem; margin-right: 0.5rem;">Exercise:</label>
                        <select id="exercise-selector" style="padding: 0.5rem; background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 8px; color: white; font-size: 0.9rem;">
                            <option value="">Select an exercise</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="pr-timeline-chart"></canvas>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üìä Session Comparison</h3>
                    <div style="margin-bottom: 1rem;">
                        <label for="comparison-selector" style="color: #94a3b8; font-size: 0.9rem; margin-right: 0.5rem;">Workout Type:</label>
                        <select id="comparison-selector" style="padding: 0.5rem; background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 8px; color: white; font-size: 0.9rem;">
                            <option value="Upper">Upper</option>
                            <option value="Lower">Lower</option>
                            <option value="Push">Push</option>
                            <option value="Pull">Pull</option>
                            <option value="Legs">Legs</option>
                        </select>
                    </div>
                    <div id="session-comparison-content" style="color: #94a3b8; font-size: 0.9rem;">
                        <p>Select a workout type to compare sessions</p>
                    </div>
                </div>
            </div>

            <!-- Row 4: Analytics -->
            <div class="chart-grid">
                <div class="analytics-card">
                    <h3 class="analytics-title">üìà Progression Snapshot</h3>
                    <div id="progression-snapshot" style="color: #94a3b8; font-size: 0.9rem;">
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: white;">Quick Wins:</strong>
                            <div id="quick-wins">Complete at least 2 workouts to see recent PRs</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: #10b981;">Trending Up:</strong>
                            <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">Improving over last 4 sessions</div>
                            <div id="trending-up">N/A</div>
                        </div>
                        <div>
                            <strong style="color: #f59e0b;">Needs Attention:</strong>
                            <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">No progress for 3+ sessions</div>
                            <div id="needs-attention">N/A</div>
                        </div>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üî• Intensity Heatmap</h3>
                    <div id="intensity-heatmap" style="color: #94a3b8; font-size: 0.9rem;">
                        <div id="heatmap-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROGRESS TAB -->
        <div id="progress-content" class="tab-content">
            <div class="analytics-card">
                <h3 class="analytics-title">üìà Exercise Progression</h3>
                <div id="exercise-progress-list">
                    <p style="color: #64748b;">Complete some workouts to see your detailed progression!</p>
                </div>
            </div>

            <div class="analytics-card">
                <h3 class="analytics-title">üèÜ Personal Records</h3>
                <div id="progress-list">
                    <p style="color: #64748b;">Complete some workouts to see your strength progression!</p>
                </div>
            </div>
        </div>

        <!-- INTELLIGENCE TAB -->
        <div id="intelligence-content" class="tab-content">
            <div class="analytics-card">
                <h3 class="analytics-title">üß† AI Insights</h3>
                <ul class="insights-list" id="insights-list">
                    <li class="insight-item">Complete some workouts to get personalized insights!</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Meal Type Selection Modal -->
    <div class="modal-overlay" id="meal-type-modal">
        <div class="modal-content">
            <h3 class="modal-title">üçΩÔ∏è Select Meal Type</h3>
            <div class="meal-type-buttons">
                <button class="meal-type-btn" onclick="selectMealType('Breakfast')">üåÖ Breakfast</button>
                <button class="meal-type-btn" onclick="selectMealType('Lunch')">‚òÄÔ∏è Lunch</button>
                <button class="meal-type-btn" onclick="selectMealType('Dinner')">üåô Dinner</button>
                <button class="meal-type-btn" onclick="selectMealType('Snack')">üç™ Snack</button>
            </div>
            <button class="modal-close" onclick="closeMealTypeModal()">Cancel</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, limit, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBouZ7KMUMSf8RdBKudMW2qEXI_FHgchIU",
            authDomain: "fitness-command-center.firebaseapp.com",
            projectId: "fitness-command-center",
            storageBucket: "fitness-command-center.firebasestorage.app",
            messagingSenderId: "416632779679",
            appId: "1:416632779679:web:768ab3ec04da3aecac03aa",
            measurementId: "G-F06G7Y9V25"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global state
        let currentDay = 'Upper';
        let currentWorkout = {};
        let allWorkouts = [];
        let workoutIntensity = {
            preWorkout: { energy: null, motivation: null },
            postWorkout: { fatigue: null, satisfaction: null }
        };
        let charts = {};
        let currentCalendarDate = new Date();
        let selectedCalendarDay = null;
        let nutritionData = [];
        window.nutritionData = nutritionData;
        let currentNutritionDate = new Date().toISOString().split('T')[0];
        let weightData = [];
        window.weightData = weightData;
        let photoData = [];
        window.photoData = photoData;
        let savedFoods = [];
        window.savedFoods = savedFoods;

        const workoutPlans = {
            Upper: [
                { name: 'Incline Dumbbell Press', sets: 3, reps: 8 },
                { name: 'Seated Cable Fly', sets: 2, reps: 10 },
                { name: 'Weighted Pull-Ups', sets: 3, reps: 6 },
                { name: 'High Cable Lateral Raise', sets: 2, reps: 10 },
                { name: 'Deficit Pendlay Row', sets: 2, reps: 8 },
                { name: 'Cable Tricep Extension', sets: 2, reps: 10 },
                { name: 'Bayesian Cable Bicep Curl', sets: 2, reps: 10 }
            ],
            Lower: [
                { name: 'Lying Leg Curls', sets: 2, reps: '8+partial to failure' },
                { name: 'Barbell Squat', sets: 3, reps: 8 },
                { name: 'Romanian Deadlift', sets: 3, reps: 8 },
                { name: 'Leg Extension', sets: 2, reps: 10 },
                { name: 'Hip Abduction', sets: 2, reps: 10 },
                { name: 'Standing Calf Raise', sets: 3, reps: 10 }
            ],
            Rest: [
                { name: 'Rest Day Recovery', sets: 1, reps: 'Complete' }
            ],
            Push: [
                { name: 'Barbell Bench Press', sets: 1, reps: '3-5 with warmup ladder (15, 5, 3, 2, 1)' },
                { name: 'Dumbbell Larsen Press', sets: 2, reps: '10 (75% of bench press weight)' },
                { name: 'Standing Arnold Press', sets: 3, reps: '8-10' },
                { name: 'Cable Press-Around (Superset)', sets: 2, reps: '12-15' },
                { name: 'Pec Stretch (Superset)', sets: 2, reps: '30 seconds' },
                { name: 'Cross-Body Cable Y-Raise', sets: 3, reps: '12-15' },
                { name: 'Squeeze-Only Pressdown (Superset)', sets: 3, reps: 8 },
                { name: 'Overhead Extension - Extended Position (Superset)', sets: 3, reps: 8 },
                { name: 'Cross-Body Triceps Extension', sets: 2, reps: '10-12' }
            ],
            Pull: [
                { name: 'Lat Pulldown', sets: '4 feeder sets + 1-2 sets to failure + 1 dropset', reps: 'Varies' },
                { name: 'Machine Row/T-Bar Row/DB Helms Row', sets: 3, reps: '10-12' },
                { name: 'Bottom Half DB Lat Pullovers (Superset)', sets: 2, reps: '10-12' },
                { name: 'Static Lat Stretching (Superset)', sets: 2, reps: '30 seconds' },
                { name: 'Omni Directional Face Pulls', sets: 3, reps: '12-15' },
                { name: 'EZ Bar Bicep Curl', sets: 3, reps: '6-8' },
                { name: 'Bottom-Half DB Preacher Curl', sets: 2, reps: '10-12' } 
            ],
            Legs: [
                { name: 'Squats - Warmup 20%', sets: 1, reps: 10 },
                { name: 'Squats - Warmup 35%', sets: 1, reps: 5 },
                { name: 'Squats - Warmup 55%', sets: 1, reps: 3 },
                { name: 'Squats - Warmup 70%', sets: 1, reps: 2 },
                { name: 'Squats - Warmup 80%', sets: 1, reps: 1 },
                { name: 'Squats - 85-90%', sets: 1, reps: '2-4' },
                { name: 'Paused Squats (75% of working weight)', sets: 2, reps: 5 },
                { name: 'Romanian Deadlift', sets: 3, reps: '8-10' },
                { name: 'Walking Lunges', sets: 2, reps: '10 per leg' },
                { name: 'Seated Leg Curl', sets: 3, reps: '10-12' },
                { name: 'Leg Press Toe Press', sets: 4, reps: '10-12' },
                { name: 'Decline Plate Crunch', sets: 3, reps: '10-12' },
            ]
        };

        // Firebase functions
        async function saveWorkoutToFirebase(workoutData) {
            try {
                const docRef = await addDoc(collection(db, "workouts"), {
                    ...workoutData,
                    timestamp: new Date()
                });
                console.log("Workout saved with ID:", docRef.id);
                return docRef.id;
            } catch (e) {
                console.error("Error adding workout:", e);
                throw e;
            }
        }

        async function loadWorkoutsFromFirebase() {
            try {
                const q = query(collection(db, "workouts"), orderBy("timestamp", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                const workouts = [];
                querySnapshot.forEach((doc) => {
                    workouts.push({ id: doc.id, ...doc.data() });
                });
                allWorkouts = workouts;
                console.log("Loaded workouts:", workouts.length);
                return workouts;
            } catch (e) {
                console.error("Error loading workouts:", e);
                return [];
            }
        }

        async function loadNutritionData() {
            try {
                const q = query(collection(db, "nutrition"), orderBy("date", "desc"), limit(30));
                const querySnapshot = await getDocs(q);
                const nutrition = [];
                const seenIds = new Set();
                
                querySnapshot.forEach((doc) => {
                    // Prevent duplicate IDs
                    if (!seenIds.has(doc.id)) {
                        seenIds.add(doc.id);
                        nutrition.push({ id: doc.id, ...doc.data() });
                    }
                });
                
                nutritionData = nutrition;
                window.nutritionData = nutrition;
                console.log("Loaded nutrition data:", nutrition.length, "entries");
                return nutrition;
            } catch (e) {
                console.error("Error loading nutrition:", e);
                return [];
            }
        }

        async function loadWeightData() {
            try {
                const q = query(collection(db, "weight"), orderBy("date", "desc"), limit(90));
                const querySnapshot = await getDocs(q);
                const weights = [];
                querySnapshot.forEach((doc) => {
                    weights.push({ id: doc.id, ...doc.data() });
                });
                weightData = weights;
                window.weightData = weights;
                console.log("Loaded weight data:", weights.length);
                return weights;
            } catch (e) {
                console.error("Error loading weight:", e);
                return [];
            }
        }

        async function loadPhotoData() {
            try {
                const q = query(collection(db, "photos"), orderBy("date", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                const photos = [];
                querySnapshot.forEach((doc) => {
                    photos.push({ id: doc.id, ...doc.data() });
                });
                photoData = photos;
                window.photoData = photos;
                console.log("Loaded photo data:", photos.length);
                return photos;
            } catch (e) {
                console.error("Error loading photos:", e);
                return [];
            }
        }

        // Workout Schedule Cycle: upper/lower/rest/push/pull/legs/rest
        const workoutSchedule = ['Upper', 'Lower', 'Rest', 'Push', 'Pull', 'Legs', 'Rest'];
        
        function getScheduledWorkout(date) {
            const queryDate = new Date(date + 'T00:00:00.000Z');
            const actualWorkout = getWorkoutForDate(date);
            
            // If there's an actual workout on this date, return its type
            if (actualWorkout) {
                return actualWorkout.day;
            }
            
            // For future dates, project from the most recent completed workout
            const today = new Date();
            const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
            
            if (queryDate >= todayUTC) {
                // Find the most recent completed workout
                const sortedWorkouts = allWorkouts
                    .filter(w => new Date(w.date + 'T00:00:00.000Z') < todayUTC)
                    .sort((a, b) => new Date(b.date + 'T00:00:00.000Z') - new Date(a.date + 'T00:00:00.000Z'));
                
                if (sortedWorkouts.length > 0) {
                    const mostRecent = sortedWorkouts[0];
                    const mostRecentDate = new Date(mostRecent.date + 'T00:00:00.000Z');
                    const mostRecentType = mostRecent.day;
                    
                    // Find the index of the most recent workout type in the schedule
                    const lastIndex = workoutSchedule.indexOf(mostRecentType);
                    
                    // Calculate days forward from the most recent workout
                    const daysDiff = Math.floor((queryDate - mostRecentDate) / (1000 * 60 * 60 * 24));
                    
                    // Project forward in the cycle
                    const scheduleIndex = (lastIndex + daysDiff) % 7;
                    return workoutSchedule[scheduleIndex];
                } else {
                    // No workouts yet, use default schedule from reference date
                    const referenceDate = new Date('2024-01-01T00:00:00.000Z');
                    const daysDiff = Math.floor((queryDate - referenceDate) / (1000 * 60 * 60 * 24));
                    const scheduleIndex = ((daysDiff % 7) + 7) % 7;
                    return workoutSchedule[scheduleIndex];
                }
            }
            
            // For past dates without an actual workout, return empty or use default schedule
            // This allows showing "missed" workouts in the calendar
            const referenceDate = new Date('2024-01-01T00:00:00.000Z');
            const daysDiff = Math.floor((queryDate - referenceDate) / (1000 * 60 * 60 * 24));
            const scheduleIndex = ((daysDiff % 7) + 7) % 7;
            return workoutSchedule[scheduleIndex];
        }

        function getWorkoutForDate(dateString) {
            return allWorkouts.find(w => w.date === dateString);
        }

        function calculateAdherence() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            let scheduled = 0;
            let completed = 0;
            let missed = 0;
            
            for (let d = new Date(thirtyDaysAgo); d <= today; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const scheduledWorkout = getScheduledWorkout(dateStr);
                const actualWorkout = getWorkoutForDate(dateStr);
                
                if (scheduledWorkout !== 'Rest') {
                    scheduled++;
                    if (actualWorkout) {
                        completed++;
                    } else if (d < today) { // Don't count future dates as missed
                        missed++;
                    }
                }
            }
            
            const adherenceScore = scheduled > 0 ? Math.round((completed / scheduled) * 100) : 0;
            
            return {
                score: adherenceScore,
                completed,
                scheduled,
                missed
            };
        }
        // Enhanced Analytics Functions
        function calculateTotalVolume() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            return allWorkouts
                .filter(workout => {
                    const workoutDate = new Date(workout.date);
                    return workoutDate.getMonth() === thisMonth && workoutDate.getFullYear() === thisYear;
                })
                .reduce((total, workout) => {
                    return total + Object.values(workout.exercises || {}).reduce((exerciseTotal, exercise) => {
                        return exerciseTotal + exercise.sets.reduce((setTotal, set) => {
                            return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                        }, 0);
                    }, 0);
                }, 0);
        }

        function calculateWorkoutStreak() {
            if (allWorkouts.length === 0) return 0;
            
            const sortedWorkouts = allWorkouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            let streak = 1;
            let currentDate = new Date(sortedWorkouts[0].date);
            
            for (let i = 1; i < sortedWorkouts.length; i++) {
                const workoutDate = new Date(sortedWorkouts[i].date);
                const daysDiff = Math.floor((currentDate - workoutDate) / (1000 * 60 * 60 * 24));
                
                // Allow 1-2 day gaps (normal rest days in training program)
                if (daysDiff <= 2) {
                    streak++;
                    currentDate = workoutDate;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function calculatePRCount() {
            const today = new Date();
            const sevenDaysAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
            
            const recentPRs = getRecentPRs(7);
            return recentPRs.length;
        }

        function detectPlateaus() {
            const plateaus = [];
            const workoutsByDay = {};
            
            // Group recent workouts by day
            allWorkouts.slice(0, 12).forEach(workout => {
                if (!workoutsByDay[workout.day]) workoutsByDay[workout.day] = [];
                workoutsByDay[workout.day].push(workout);
            });
            
            // Check each exercise for plateaus
            Object.keys(workoutsByDay).forEach(dayType => {
                const dayWorkouts = workoutsByDay[dayType].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (dayWorkouts.length < 3) return;
                
                const exerciseMap = {};
                
                // Track exercise progression
                dayWorkouts.forEach(workout => {
                    Object.values(workout.exercises || {}).forEach(exercise => {
                        if (exercise.exercise.toLowerCase().includes('stretch') || workout.day === 'Rest') return;
                        
                        if (!exerciseMap[exercise.exercise]) {
                            exerciseMap[exercise.exercise] = [];
                        }
                        
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        const maxReps = Math.max(...exercise.sets.map(set => parseInt(set.reps) || 0));
                        const totalVolume = exercise.sets.reduce((sum, set) => 
                            sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0);
                        
                        exerciseMap[exercise.exercise].push({
                            date: workout.date,
                            maxWeight,
                            maxReps,
                            totalVolume
                        });
                    });
                });
                
                // Detect plateaus
                Object.keys(exerciseMap).forEach(exerciseName => {
                    const progression = exerciseMap[exerciseName].slice(0, 3);
                    
                    if (progression.length < 3) return;
                    
                    // Check if weight hasn't increased in 3 sessions
                    const weights = progression.map(p => p.maxWeight);
                    const hasWeightProgression = weights.some((w, i) => i > 0 && w > weights[i-1]);
                    
                    // Check if volume is declining
                    const volumes = progression.map(p => p.totalVolume);
                    const hasVolumeDecline = volumes.length >= 2 && volumes[0] < volumes[1];
                    
                    if (!hasWeightProgression || hasVolumeDecline) {
                        plateaus.push({
                            exercise: exerciseName,
                            sessions: progression.length,
                            lastWeight: weights[0],
                            suggestion: generatePlateauSuggestion(exerciseName, progression)
                        });
                    }
                });
            });
            
            return plateaus;
        }

        function generatePlateauSuggestion(exerciseName, progression) {
            const isCompound = ['squat', 'bench', 'deadlift', 'press'].some(compound => 
                exerciseName.toLowerCase().includes(compound));
            
            if (isCompound) {
                return `Try micro-loading (+2.5lbs) or add pause reps at 90% weight`;
            } else {
                return `Consider adding 1 set or trying drop sets for volume progression`;
            }
        }
        function generateAdvancedSuggestions() {
            if (allWorkouts.length === 0) {
                return [{
                    type: 'motivation',
                    text: 'Start logging workouts to get personalized AI suggestions!'
                }];
            }
            
            const suggestions = [];
            
            // Get plateaus
            const plateaus = detectPlateaus();
            
            // Plateau alerts
            plateaus.slice(0, 2).forEach(plateau => {
                suggestions.push({
                    type: 'plateau',
                    text: `${plateau.exercise} has plateaued for ${plateau.sessions} sessions. ${plateau.suggestion}`
                });
            });
            
            // Get last workout for current day
            const lastWorkout = allWorkouts.find(w => w.day === currentDay);
            
            if (lastWorkout) {
                const daysSince = Math.floor((Date.now() - new Date(lastWorkout.date).getTime()) / (1000 * 60 * 60 * 24));
                
                if (daysSince > 7) {
                    suggestions.push({
                        type: 'recovery',
                        text: `It's been ${daysSince} days since your last ${currentDay} workout. You should feel strong today!`
                    });
                } else if (daysSince === 0) {
                    suggestions.push({
                        type: 'warning',
                        text: `You already trained ${currentDay} today. Consider rest or a different muscle group.`
                    });
                }
                
                // Smart progression suggestions
                Object.values(lastWorkout.exercises || {}).forEach((exercise, idx) => {
                    if (idx < 2 && !exercise.exercise.toLowerCase().includes('stretch') && lastWorkout.day !== 'Rest') {
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        const completedReps = exercise.sets.map(set => parseInt(set.reps) || 0);
                        const avgReps = completedReps.reduce((a, b) => a + b, 0) / completedReps.length;
                        
                        if (maxWeight > 0) {
                            // If consistently hitting high reps, suggest weight increase
                            if (avgReps >= 10 && completedReps.every(r => r >= 8)) {
                                suggestions.push({
                                    type: 'progression',
                                    text: `${exercise.exercise}: Strong performance (${maxWeight}lbs √ó ${Math.round(avgReps)}). Try ${maxWeight + 5}lbs next time!`
                                });
                            }
                            // If struggling with reps, suggest technique focus
                            else if (avgReps < 6 && maxWeight > 0) {
                                suggestions.push({
                                    type: 'technique',
                                    text: `${exercise.exercise}: Focus on form at ${maxWeight - 5}lbs or add more warm-up sets`
                                });
                            }
                        }
                    }
                });
            }
            
            // Consistency suggestions
            const recentWorkouts = allWorkouts.slice(0, 7);
            if (recentWorkouts.length >= 3) {
                const consistency = (recentWorkouts.length / 7) * 100;
                if (consistency >= 60) {
                    suggestions.push({
                        type: 'motivation',
                        text: `Excellent consistency! ${Math.round(consistency)}% workout rate this week.`
                    });
                }
            } else if (recentWorkouts.length === 1) {
                suggestions.push({
                    type: 'consistency',
                    text: 'Great job getting back to training! Aim for 3-4 sessions this week.'
                });
            }
            
            return suggestions.slice(0, 4);
        }

        function calculateMuscleGroupVolumes() {
            const volumes = { Push: 0, Pull: 0, Legs: 0, Upper: 0, Lower: 0 };
            
            allWorkouts.slice(0, 8).forEach(workout => {
                if (workout.day === 'Rest') return;
                
                const workoutVolume = Object.values(workout.exercises || {}).reduce((total, exercise) => {
                    return total + exercise.sets.reduce((setTotal, set) => {
                        return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                    }, 0);
                }, 0);
                
                volumes[workout.day] = (volumes[workout.day] || 0) + workoutVolume;
            });
            
            return volumes;
        }

        function calculateWorkoutVolume(workout) {
            if (workout.day === 'Rest') return 0;
            
            return Object.values(workout.exercises || {}).reduce((total, exercise) => {
                return total + exercise.sets.reduce((setTotal, set) => {
                    return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                }, 0);
            }, 0);
        }

        // Get all workouts of a specific type (e.g., all "Upper" workouts)
        function getWorkoutsByType(workoutType) {
            return allWorkouts.filter(workout => workout.day === workoutType);
        }

        // Calculate record volume for a workout type
        function getRecordVolumeForType(workoutType) {
            const workouts = getWorkoutsByType(workoutType);
            if (workouts.length === 0) return 0;
            
            return Math.max(...workouts.map(workout => calculateWorkoutVolume(workout)));
        }

        // Calculate average volume for a workout type in current month
        function getCurrentMonthAverageVolume(workoutType) {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const monthWorkouts = allWorkouts.filter(workout => {
                const workoutDate = new Date(workout.date);
                return workout.day === workoutType && 
                       workoutDate.getMonth() === thisMonth && 
                       workoutDate.getFullYear() === thisYear;
            });
            
            if (monthWorkouts.length === 0) return 0;
            
            const totalVolume = monthWorkouts.reduce((sum, workout) => sum + calculateWorkoutVolume(workout), 0);
            return Math.round(totalVolume / monthWorkouts.length);
        }

        // Calculate average volume for a workout type in last month
        function getLastMonthAverageVolume(workoutType) {
            const lastMonth = new Date().getMonth() - 1;
            const year = lastMonth < 0 ? new Date().getFullYear() - 1 : new Date().getFullYear();
            const month = lastMonth < 0 ? 11 : lastMonth;
            
            const monthWorkouts = allWorkouts.filter(workout => {
                const workoutDate = new Date(workout.date);
                return workout.day === workoutType && 
                       workoutDate.getMonth() === month && 
                       workoutDate.getFullYear() === year;
            });
            
            if (monthWorkouts.length === 0) return 0;
            
            const totalVolume = monthWorkouts.reduce((sum, workout) => sum + calculateWorkoutVolume(workout), 0);
            return Math.round(totalVolume / monthWorkouts.length);
        }

        // Get trend direction for last 3 sessions
        function getTrendDirection(workoutType) {
            const workouts = getWorkoutsByType(workoutType).slice(0, 3);
            if (workouts.length < 2) return '‚Üí';
            
            const volumes = workouts.map(w => calculateWorkoutVolume(w)).reverse();
            
            // Check if trending up
            let isIncreasing = true;
            let isDecreasing = true;
            
            for (let i = 1; i < volumes.length; i++) {
                if (volumes[i] <= volumes[i - 1]) isIncreasing = false;
                if (volumes[i] >= volumes[i - 1]) isDecreasing = false;
            }
            
            if (isIncreasing) return '‚ÜóÔ∏è';
            if (isDecreasing) return '‚ÜòÔ∏è';
            return '‚Üí';
        }

        // Find exercises with recent PRs
        function getRecentPRs(daysBack) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysBack);
            
            const exercisePRs = {};
            const recentPRs = [];
            
            // Build PR history chronologically
            allWorkouts.slice().reverse().forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (!exercise.exercise.toLowerCase().includes('stretch')) {
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        
                        if (maxWeight > 0) {
                            const exerciseName = exercise.exercise;
                            const currentPR = exercisePRs[exerciseName] || 0;
                            
                            if (maxWeight > currentPR) {
                                const workoutDate = new Date(workout.date);
                                if (workoutDate >= cutoffDate) {
                                    recentPRs.push({ exercise: exerciseName, weight: maxWeight, date: workout.date });
                                }
                                exercisePRs[exerciseName] = maxWeight;
                            }
                        }
                    }
                });
            });
            
            return recentPRs;
        }

        // Find exercises without progression
        function getPlateauedExercises(sessionsBack) {
            const exerciseHistory = {};
            
            // Track last N sessions for each exercise
            allWorkouts.slice(0, sessionsBack * 2).forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (!exercise.exercise.toLowerCase().includes('stretch')) {
                        const exerciseName = exercise.exercise;
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        
                        if (maxWeight > 0) {
                            if (!exerciseHistory[exerciseName]) {
                                exerciseHistory[exerciseName] = [];
                            }
                            exerciseHistory[exerciseName].push(maxWeight);
                        }
                    }
                });
            });
            
            // Find exercises that haven't progressed
            const plateaued = [];
            Object.keys(exerciseHistory).forEach(exercise => {
                const weights = exerciseHistory[exercise].slice(0, sessionsBack);
                if (weights.length >= sessionsBack) {
                    const hasProgress = weights.some((weight, idx) => idx > 0 && weight > weights[idx - 1]);
                    if (!hasProgress) {
                        plateaued.push({ exercise, weight: weights[0] });
                    }
                }
            });
            
            return plateaued.slice(0, 3);
        }

        // Get all unique exercises from workout history
        function getAllExercises() {
            const exercises = new Set();
            allWorkouts.forEach(workout => {
                if (workout.day !== 'Rest') {
                    Object.values(workout.exercises || {}).forEach(exercise => {
                        if (!exercise.exercise.toLowerCase().includes('stretch')) {
                            exercises.add(exercise.exercise);
                        }
                    });
                }
            });
            return Array.from(exercises).sort();
        }

        // Get exercise progression data for PR Timeline (specific exercise)
        function getExerciseProgressionForTimeline(exerciseName) {
            const progression = [];
            
            allWorkouts.slice().reverse().forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (exercise.exercise === exerciseName) {
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        if (maxWeight > 0) {
                            progression.push({
                                x: workout.date,
                                y: maxWeight,
                                isPR: false
                            });
                        }
                    }
                });
            });
            
            // Mark PRs
            let currentPR = 0;
            progression.forEach(point => {
                if (point.y > currentPR) {
                    point.isPR = true;
                    currentPR = point.y;
                }
            });
            
            return progression;
        }

        // Get exercises showing consistent improvement
        function getTrendingUpExercises() {
            const exerciseHistory = {};
            
            // Track recent sessions for each exercise
            allWorkouts.slice(0, 10).forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (!exercise.exercise.toLowerCase().includes('stretch')) {
                        const exerciseName = exercise.exercise;
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        
                        if (maxWeight > 0) {
                            if (!exerciseHistory[exerciseName]) {
                                exerciseHistory[exerciseName] = [];
                            }
                            exerciseHistory[exerciseName].push(maxWeight);
                        }
                    }
                });
            });
            
            // Find exercises trending up
            const trending = [];
            Object.keys(exerciseHistory).forEach(exercise => {
                const weights = exerciseHistory[exercise].slice(0, 4);
                if (weights.length >= 3) {
                    // Check if generally increasing
                    const increases = weights.filter((weight, idx) => idx > 0 && weight > weights[idx - 1]).length;
                    if (increases >= 2) {
                        trending.push(exercise);
                    }
                }
            });
            
            return trending.slice(0, 5);
        }

        // Get days since last workout of a specific type
        function getDaysSinceLastWorkout(workoutType) {
            const workouts = getWorkoutsByType(workoutType);
            if (workouts.length === 0) return null;
            
            const lastWorkout = new Date(workouts[0].date);
            const today = new Date();
            return Math.floor((today - lastWorkout) / (1000 * 60 * 60 * 24));
        }

        function generateAIInsights() {
            if (allWorkouts.length < 3) {
                return [
                    "Complete more workouts to unlock AI insights!",
                    "Aim for consistency - 3-4 workouts per week is ideal.",
                    "Focus on progressive overload - gradually increase weight or reps."
                ];
            }
            
            const insights = [];
            
            // Workout frequency analysis
            const workoutDays = allWorkouts.slice(0, 10).map(w => new Date(w.date).getDay());
            const dayFrequency = {};
            workoutDays.forEach(day => {
                dayFrequency[day] = (dayFrequency[day] || 0) + 1;
            });
            
            if (Object.keys(dayFrequency).length > 0) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const preferredDay = Object.keys(dayFrequency).reduce((a, b) => dayFrequency[a] > dayFrequency[b] ? a : b);
                insights.push(`You train most often on ${dayNames[preferredDay]}s - this seems to be your power day!`);
            }
            
            // Volume analysis
            const totalVolume = allWorkouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0);
            const avgVolumePerWorkout = Math.round(totalVolume / allWorkouts.length);
            insights.push(`Your average workout volume is ${avgVolumePerWorkout.toLocaleString()}lbs - solid training stimulus.`);
            
            // Data requirements: minimum 5 workouts, 5 nutrition days, 5 weight entries
            const hasEnoughData = allWorkouts.length >= 5 && 
                                   window.nutritionData && window.nutritionData.length >= 5 && 
                                   window.weightData && window.weightData.length >= 5;
            
            if (hasEnoughData) {
                console.log('Calculating correlation insights with sufficient data...');
                
                // 1. Strength vs. Weight Changes
                // Compare last 2 weeks vs prior 2 weeks
                const today = new Date();
                const twoWeeksAgo = new Date(today.getTime() - (14 * 24 * 60 * 60 * 1000));
                const fourWeeksAgo = new Date(today.getTime() - (28 * 24 * 60 * 60 * 1000));
                
                const recentWorkouts = allWorkouts.filter(w => new Date(w.date) >= twoWeeksAgo);
                const priorWorkouts = allWorkouts.filter(w => {
                    const date = new Date(w.date);
                    return date >= fourWeeksAgo && date < twoWeeksAgo;
                });
                
                if (recentWorkouts.length > 0 && priorWorkouts.length > 0) {
                    const recentVolume = recentWorkouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0) / recentWorkouts.length;
                    const priorVolume = priorWorkouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0) / priorWorkouts.length;
                    const volumeChangePercent = priorVolume > 0 ? Math.round(((recentVolume - priorVolume) / priorVolume) * 100) : 0;
                    
                    console.log(`Volume change: ${volumeChangePercent}%`);
                    
                    // Weight changes
                    const recentWeights = window.weightData.filter(w => new Date(w.date) >= twoWeeksAgo);
                    const priorWeights = window.weightData.filter(w => {
                        const date = new Date(w.date);
                        return date >= fourWeeksAgo && date < twoWeeksAgo;
                    });
                    
                    if (recentWeights.length > 0 && priorWeights.length > 0) {
                        const avgRecentWeight = recentWeights.reduce((sum, w) => sum + parseFloat(w.weight), 0) / recentWeights.length;
                        const avgPriorWeight = priorWeights.reduce((sum, w) => sum + parseFloat(w.weight), 0) / priorWeights.length;
                        const weightChange = avgRecentWeight - avgPriorWeight;
                        
                        console.log(`Weight change: ${weightChange.toFixed(1)}lbs`);
                        
                        // Generate strength vs weight correlation insight
                        if (volumeChangePercent > 5 && weightChange > 1) {
                            insights.push(`Your strength is up ${volumeChangePercent}% while weight increased ${weightChange.toFixed(1)}lbs - excellent lean mass gains!`);
                        } else if (Math.abs(volumeChangePercent) < 5 && weightChange < -2) {
                            insights.push(`Strength maintaining while weight down ${Math.abs(weightChange).toFixed(1)}lbs - good cutting progress`);
                        } else if (Math.abs(weightChange) < 1 && volumeChangePercent > 10) {
                            insights.push(`Weight stable but strength up ${volumeChangePercent}% - great recomp!`);
                        } else if (volumeChangePercent < -5 && weightChange < -3) {
                            insights.push(`Strength declining ${Math.abs(volumeChangePercent)}% while weight down ${Math.abs(weightChange).toFixed(1)}lbs - may need more calories`);
                        }
                    }
                }
                
                // 2. Nutrition Adequacy
                const last14Days = new Date(today.getTime() - (14 * 24 * 60 * 60 * 1000));
                const recentNutrition = window.nutritionData.filter(n => new Date(n.date) >= last14Days);
                
                // Get workout days in last 14 days
                const recentWorkoutDates = allWorkouts
                    .filter(w => new Date(w.date) >= last14Days)
                    .map(w => w.date);
                const workoutDaysCount = recentWorkoutDates.length;
                
                if (recentNutrition.length >= 5 && workoutDaysCount >= 3) {
                    // Calculate average protein on workout days
                    const workoutDayNutrition = recentNutrition.filter(n => recentWorkoutDates.includes(n.date));
                    
                    if (workoutDayNutrition.length > 0) {
                        const totalProtein = workoutDayNutrition.reduce((sum, meal) => {
                            return sum + (meal.foods || []).reduce((foodSum, food) => 
                                foodSum + (parseFloat(food.protein) || 0), 0);
                        }, 0);
                        const avgProtein = Math.round(totalProtein / workoutDayNutrition.length);
                        
                        console.log(`Avg protein on workout days: ${avgProtein}g, Workouts/week: ${workoutDaysCount}`);
                        
                        if (avgProtein >= 150 && workoutDaysCount >= 4) {
                            insights.push(`Averaging ${avgProtein}g protein/day with ${workoutDaysCount} workouts/week - optimal for growth`);
                        } else if (avgProtein < 120 && workoutDaysCount >= 3) {
                            insights.push(`Only ${avgProtein}g protein on workout days - consider increasing to 0.8-1g per lb bodyweight`);
                        } else if (avgProtein >= 200) {
                            insights.push(`Great job hitting ${avgProtein}g+ protein on training days`);
                        }
                    }
                }
                
                // 3. Recovery Indicators - correlate intensity ratings with volume changes
                const workoutsWithIntensity = allWorkouts.filter(w => w.intensity && 
                    (w.intensity.energy || w.intensity.motivation || w.intensity.fatigue || w.intensity.satisfaction));
                
                if (workoutsWithIntensity.length >= 5) {
                    const recentIntensity = workoutsWithIntensity.slice(0, 7);
                    
                    const avgEnergy = recentIntensity.reduce((sum, w) => sum + (w.intensity.energy || 0), 0) / recentIntensity.length;
                    const avgFatigue = recentIntensity.reduce((sum, w) => sum + (w.intensity.fatigue || 0), 0) / recentIntensity.length;
                    const avgSatisfaction = recentIntensity.reduce((sum, w) => sum + (w.intensity.satisfaction || 0), 0) / recentIntensity.length;
                    
                    console.log(`Recent intensity - Energy: ${avgEnergy.toFixed(1)}, Fatigue: ${avgFatigue.toFixed(1)}, Satisfaction: ${avgSatisfaction.toFixed(1)}`);
                    
                    // Compare recent vs prior volume (only if we have enough data)
                    if (recentIntensity.length >= 6) {
                        const recentVol = recentIntensity.slice(0, 3).reduce((sum, w) => sum + calculateWorkoutVolume(w), 0) / 3;
                        const priorVol = recentIntensity.slice(3, 6).reduce((sum, w) => sum + calculateWorkoutVolume(w), 0) / 3;
                        const volChange = priorVol > 0 ? Math.round(((recentVol - priorVol) / priorVol) * 100) : 0;
                    
                        if (avgEnergy < 2.5 && volChange > 0) {
                            insights.push(`Low energy scores (avg ${avgEnergy.toFixed(1)}/5) last week but volume still up - good mental toughness`);
                        } else if (avgFatigue > 3.5 && volChange < -10) {
                            insights.push(`High fatigue scores correlate with ${Math.abs(volChange)}% volume drop - consider deload week`);
                        }
                    }
                    
                    // Add satisfaction insight regardless of volume data
                    if (avgSatisfaction >= 4.5) {
                        insights.push(`Satisfaction scores averaging ${avgSatisfaction.toFixed(1)}/5 - training is going well!`);
                    }
                }
            }
            
            return insights;
        }

        function getLastWorkoutForDay(day) {
            return allWorkouts.find(workout => workout.day === day);
        }

        function getPersonalRecords() {
            const prs = {};
            
            allWorkouts.forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (exercise.exercise.toLowerCase().includes('stretch')) return;
                    
                    exercise.sets.forEach(set => {
                        const weight = parseFloat(set.weight);
                        const reps = parseInt(set.reps);
                        
                        if (weight && reps) {
                            const exerciseName = exercise.exercise;
                            if (!prs[exerciseName] || weight > prs[exerciseName].weight) {
                                prs[exerciseName] = { weight, reps, date: workout.date };
                            }
                        }
                    });
                });
            });
            
            return prs;
        }

        function getExerciseProgression() {
            const progression = {};
            
            // Group workouts by exercise
            allWorkouts.forEach(workout => {
                if (workout.day === 'Rest') return;
                
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (exercise.exercise.toLowerCase().includes('stretch')) return;
                    
                    if (!progression[exercise.exercise]) {
                        progression[exercise.exercise] = [];
                    }
                    
                    const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                    const maxReps = Math.max(...exercise.sets.map(set => parseInt(set.reps) || 0));
                    const totalVolume = exercise.sets.reduce((sum, set) => 
                        sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0);
                    
                    progression[exercise.exercise].push({
                        date: workout.date,
                        maxWeight,
                        maxReps,
                        totalVolume,
                        rawSets: exercise.sets
                    });
                });
            });
            
            // Sort by date and analyze progression
            const progressionSummary = {};
            Object.keys(progression).forEach(exerciseName => {
                const sessions = progression[exerciseName].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (sessions.length >= 2) {
                    const latest = sessions[0];
                    const previous = sessions[1];
                    
                    let progressionText = '';
                    let progressionType = 'none';
                    
                    if (latest.maxWeight > previous.maxWeight) {
                        progressionText = `${previous.maxWeight}lbs ‚Üí ${latest.maxWeight}lbs (+${latest.maxWeight - previous.maxWeight}lbs)`;
                        progressionType = 'strength';
                    } else if (latest.maxWeight === previous.maxWeight && latest.maxReps > previous.maxReps) {
                        progressionText = `${latest.maxWeight}lbs: ${previous.maxReps} ‚Üí ${latest.maxReps} reps (+${latest.maxReps - previous.maxReps})`;
                        progressionType = 'volume';
                    } else if (latest.totalVolume > previous.totalVolume) {
                        progressionText = `Volume: ${previous.totalVolume} ‚Üí ${latest.totalVolume} lbs (+${Math.round(((latest.totalVolume - previous.totalVolume) / previous.totalVolume) * 100)}%)`;
                        progressionType = 'total_volume';
                    } else {
                        progressionText = `${latest.maxWeight}lbs √ó ${latest.maxReps} (maintaining)`;
                        progressionType = 'maintaining';
                    }
                    
                    const daysSince = Math.floor((new Date() - new Date(latest.date)) / (1000 * 60 * 60 * 24));
                    
                    progressionSummary[exerciseName] = {
                        progression: progressionText,
                        type: progressionType,
                        daysSince,
                        sessions: sessions.length
                    };
                }
            });
            
            return progressionSummary;
        }

        // Chart Functions
        function createPRTimelineChart(exerciseName) {
            const ctx = document.getElementById('pr-timeline-chart');
            if (!ctx) return;
            
            if (charts.prTimeline) charts.prTimeline.destroy();
            
            if (!exerciseName) {
                // No exercise selected
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }
            
            const progression = getExerciseProgressionForTimeline(exerciseName);
            
            if (progression.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }
            
            const maxWeight = Math.max(...progression.map(p => p.y));
            
            // Separate PR points from regular points
            const prPoints = progression.filter(p => p.isPR);
            const regularPoints = progression.filter(p => !p.isPR);
            
            const datasets = [];
            
            // Regular progression line
            if (regularPoints.length > 0) {
                datasets.push({
                    label: 'Weight',
                    data: progression.map(p => ({ x: p.x, y: p.y })),
                    borderColor: '#06b6d4',
                    backgroundColor: 'rgba(6, 182, 212, 0.1)',
                    pointRadius: 4,
                    pointBackgroundColor: '#06b6d4',
                    tension: 0.4,
                    fill: true
                });
            }
            
            // PR points overlay
            if (prPoints.length > 0) {
                datasets.push({
                    label: 'PRs',
                    data: prPoints.map(p => ({ x: p.x, y: p.y })),
                    borderColor: '#10b981',
                    backgroundColor: '#10b981',
                    pointRadius: 8,
                    pointStyle: 'star',
                    showLine: false
                });
            }
            
            charts.prTimeline = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: { color: '#94a3b8' }
                        },
                        title: {
                            display: true,
                            text: `Max Weight: ${maxWeight} lbs`,
                            color: '#ffffff',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(71, 85, 105, 0.3)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Weight (lbs)', color: '#94a3b8' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(71, 85, 105, 0.3)' }
                        }
                    }
                }
            });
        }

        function updateSessionComparison(workoutType) {
            const workouts = getWorkoutsByType(workoutType);
            const container = document.getElementById('session-comparison-content');
            
            if (workouts.length < 2) {
                container.innerHTML = '<p>Need at least 2 sessions to compare</p>';
                return;
            }
            
            const lastSession = workouts[0];
            const previousSession = workouts[1];
            
            const lastVolume = calculateWorkoutVolume(lastSession);
            const previousVolume = calculateWorkoutVolume(previousSession);
            
            const volumeChange = lastVolume - previousVolume;
            const volumeChangePercent = previousVolume > 0 ? Math.round((volumeChange / previousVolume) * 100) : 0;
            
            const isImproving = volumeChange > 0;
            const changeColor = isImproving ? '#10b981' : '#ef4444';
            const changeIcon = isImproving ? '‚úì' : '‚úó';
            
            // Exercise-by-exercise comparison
            const exerciseChanges = { increased: [], decreased: [], plateaued: [] };
            
            // Get exercises from last session
            Object.values(lastSession.exercises || {}).forEach(lastExercise => {
                const exerciseName = lastExercise.exercise;
                
                // Find matching exercise in previous session
                const previousExercise = Object.values(previousSession.exercises || {})
                    .find(ex => ex.exercise === exerciseName);
                
                if (previousExercise) {
                    // Calculate max weight √ó reps for each session
                    const lastMax = Math.max(...lastExercise.sets.map(set => 
                        (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0)
                    ));
                    const previousMax = Math.max(...previousExercise.sets.map(set => 
                        (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0)
                    ));
                    
                    // Find the sets that correspond to those max values
                    const lastBestSet = lastExercise.sets.find(set => 
                        (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0) === lastMax
                    );
                    const previousBestSet = previousExercise.sets.find(set => 
                        (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0) === previousMax
                    );
                    
                    const lastWeight = parseFloat(lastBestSet?.weight) || 0;
                    const lastReps = parseInt(lastBestSet?.reps) || 0;
                    const previousWeight = parseFloat(previousBestSet?.weight) || 0;
                    const previousReps = parseInt(previousBestSet?.reps) || 0;
                    
                    if (lastMax > previousMax) {
                        exerciseChanges.increased.push({
                            name: exerciseName,
                            previous: `${previousWeight}√ó${previousReps}`,
                            current: `${lastWeight}√ó${lastReps}`
                        });
                    } else if (lastMax < previousMax) {
                        exerciseChanges.decreased.push({
                            name: exerciseName,
                            previous: `${previousWeight}√ó${previousReps}`,
                            current: `${lastWeight}√ó${lastReps}`
                        });
                    }
                    // Note: Plateaued detection requires 3+ sessions, handled separately
                }
            });
            
            // Build exercise breakdown HTML
            let exerciseBreakdownHTML = '';
            if (exerciseChanges.increased.length > 0) {
                exerciseBreakdownHTML += `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
                        <div style="color: #10b981; font-weight: bold; margin-bottom: 0.5rem;">‚Üë Increased</div>
                        ${exerciseChanges.increased.map(ex => 
                            `<div style="font-size: 0.9rem; margin: 0.25rem 0;">‚Ä¢ ${ex.name}: ${ex.previous} ‚Üí ${ex.current}</div>`
                        ).join('')}
                    </div>
                `;
            }
            
            if (exerciseChanges.decreased.length > 0) {
                exerciseBreakdownHTML += `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                        <div style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem;">‚Üì Decreased</div>
                        ${exerciseChanges.decreased.map(ex => 
                            `<div style="font-size: 0.9rem; margin: 0.25rem 0;">‚Ä¢ ${ex.name}: ${ex.previous} ‚Üí ${ex.current}</div>`
                        ).join('')}
                    </div>
                `;
            }
            
            // Check for plateaued exercises (need 3+ sessions)
            if (workouts.length >= 3) {
                const plateauedExercises = [];
                const thirdSession = workouts[2];
                
                Object.values(lastSession.exercises || {}).forEach(lastEx => {
                    const exName = lastEx.exercise;
                    const prevEx = Object.values(previousSession.exercises || {}).find(e => e.exercise === exName);
                    const thirdEx = Object.values(thirdSession.exercises || {}).find(e => e.exercise === exName);
                    
                    if (prevEx && thirdEx) {
                        const lastMax = Math.max(...lastEx.sets.map(s => (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0)));
                        const prevMax = Math.max(...prevEx.sets.map(s => (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0)));
                        const thirdMax = Math.max(...thirdEx.sets.map(s => (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0)));
                        
                        if (lastMax === prevMax && prevMax === thirdMax && lastMax > 0) {
                            const bestSet = lastEx.sets.find(s => (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0) === lastMax);
                            plateauedExercises.push({
                                name: exName,
                                value: `${parseFloat(bestSet?.weight) || 0}√ó${parseInt(bestSet?.reps) || 0}`
                            });
                        }
                    }
                });
                
                if (plateauedExercises.length > 0) {
                    exerciseBreakdownHTML += `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 3px solid #f59e0b;">
                            <div style="color: #f59e0b; font-weight: bold; margin-bottom: 0.5rem;">‚ö†Ô∏è Plateaued (3+ sessions)</div>
                            ${plateauedExercises.map(ex => 
                                `<div style="font-size: 0.9rem; margin: 0.25rem 0;">‚Ä¢ ${ex.name}: ${ex.value}</div>`
                            ).join('')}
                        </div>
                    `;
                }
            }
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <strong style="color: white;">Last Session</strong>
                        <div style="margin-top: 0.5rem;">
                            <div>Volume: <strong>${lastVolume.toLocaleString()} lbs</strong></div>
                            <div style="font-size: 0.8rem; color: #64748b;">${new Date(lastSession.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div>
                        <strong style="color: white;">Previous Session</strong>
                        <div style="margin-top: 0.5rem;">
                            <div>Volume: <strong>${previousVolume.toLocaleString()} lbs</strong></div>
                            <div style="font-size: 0.8rem; color: #64748b;">${new Date(previousSession.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border-left: 3px solid ${changeColor};">
                    <div style="color: ${changeColor}; font-weight: bold; font-size: 1.1rem;">
                        ${changeIcon} ${isImproving ? 'Improving' : 'Declining'}
                    </div>
                    <div style="margin-top: 0.5rem;">
                        Volume Change: <strong style="color: ${changeColor};">${volumeChange > 0 ? '+' : ''}${volumeChange.toLocaleString()} lbs (${volumeChangePercent > 0 ? '+' : ''}${volumeChangePercent}%)</strong>
                    </div>
                </div>
                ${exerciseBreakdownHTML}
            `;
        }

        function updateIntensityHeatmap() {
            const container = document.getElementById('heatmap-content');
            
            if (allWorkouts.length === 0) {
                container.innerHTML = '<p>Complete workouts to see intensity patterns!</p>';
                return;
            }
            
            // Get last 4 weeks of workouts
            const today = new Date();
            const fourWeeksAgo = new Date(today.getTime() - (28 * 24 * 60 * 60 * 1000));
            
            const recentWorkouts = allWorkouts.filter(w => {
                const workoutDate = new Date(w.date);
                return workoutDate >= fourWeeksAgo;
            });
            
            // Group by day of week
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const intensityByDay = {};
            
            dayNames.forEach(day => {
                intensityByDay[day] = [];
            });
            
            recentWorkouts.forEach(workout => {
                const workoutDate = new Date(workout.date);
                const dayOfWeek = dayNames[workoutDate.getDay()];
                
                // Calculate average intensity score (1-5 scale)
                const intensity = workout.intensity || {};
                const avgScore = (
                    (intensity.energy || 0) +
                    (intensity.motivation || 0) +
                    (6 - (intensity.fatigue || 1)) +  // Invert fatigue: 1->5, 2->4, 3->3, 4->2, 5->1
                    (intensity.satisfaction || 0)
                ) / 4;
                
                // Scale to 0-10 range
                const scaledScore = (avgScore / 5) * 10;
                
                intensityByDay[dayOfWeek].push(scaledScore);
            });
            
            // Calculate average for each day
            const dayAverages = {};
            Object.keys(intensityByDay).forEach(day => {
                const scores = intensityByDay[day];
                dayAverages[day] = scores.length > 0 
                    ? scores.reduce((a, b) => a + b, 0) / scores.length 
                    : 0;
            });
            
            // Create heatmap HTML
            const getColorForScore = (score) => {
                if (score === 0) return 'rgba(71, 85, 105, 0.3)';
                if (score < 4) return '#ef4444';
                if (score < 6) return '#f59e0b';
                if (score < 8) return '#10b981';
                return '#06b6d4';
            };
            
            const heatmapHTML = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-top: 1rem;">
                    ${dayNames.map(day => {
                        const score = dayAverages[day];
                        const color = getColorForScore(score);
                        return `
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; margin-bottom: 0.5rem; color: #94a3b8;">${day}</div>
                                <div style="
                                    background: ${color};
                                    border-radius: 8px;
                                    padding: 1rem 0.5rem;
                                    font-weight: bold;
                                    color: white;
                                    font-size: 0.9rem;
                                ">
                                    ${score > 0 ? score.toFixed(1) : '-'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 1rem; font-size: 0.8rem; color: #64748b; text-align: center;">
                    Intensity score (0-10) - calculated from your 1-5 ratings. Fatigue is inverted (lower fatigue = higher score).
                </div>
            `;
            
            container.innerHTML = heatmapHTML;
        }
        
        // UI Functions
        function updateSuggestions() {
            const suggestions = generateAdvancedSuggestions();
            const container = document.getElementById('suggestions-container');
            
            container.innerHTML = suggestions.map(suggestion => `
                <div class="suggestion-card">
                    <div class="suggestion-type">${suggestion.type}</div>
                    <div class="suggestion-text">${suggestion.text}</div>
                </div>
            `).join('');
        }

        function updateAnalytics() {
            // Update basic stats
            document.getElementById('pr-count').textContent = calculatePRCount();
            document.getElementById('workout-streak').textContent = calculateWorkoutStreak();
            
            // Update volume cards for each workout type
            const workoutTypes = ['Upper', 'Lower', 'Push', 'Pull', 'Legs'];
            workoutTypes.forEach(type => {
                const typeKey = type.toLowerCase();
                
                // Record volume
                const recordVolume = getRecordVolumeForType(type);
                const recordElement = document.getElementById(`${typeKey}-record`);
                const recordLbsElement = document.getElementById(`${typeKey}-record-lbs`);
                if (recordElement && recordLbsElement) {
                    recordElement.textContent = recordVolume > 0 ? recordVolume.toLocaleString() : '0';
                    recordLbsElement.textContent = recordVolume > 0 ? recordVolume.toLocaleString() : '0';
                }
                
                // Current month average
                const currentAvg = getCurrentMonthAverageVolume(type);
                const avgElement = document.getElementById(`${typeKey}-avg`);
                if (avgElement) {
                    avgElement.textContent = currentAvg > 0 ? currentAvg.toLocaleString() : '0';
                }
                
                // Trend
                const trend = getTrendDirection(type);
                const trendElement = document.getElementById(`${typeKey}-trend`);
                if (trendElement) {
                    trendElement.textContent = trend;
                }
                
                // Month-over-month
                const lastMonthAvg = getLastMonthAverageVolume(type);
                const momElement = document.getElementById(`${typeKey}-mom`);
                if (momElement) {
                    if (currentAvg > 0 && lastMonthAvg > 0) {
                        const diff = currentAvg - lastMonthAvg;
                        const sign = diff > 0 ? '+' : '';
                        momElement.textContent = `${sign}${diff.toLocaleString()} lbs vs last month`;
                        momElement.style.color = diff > 0 ? '#10b981' : (diff < 0 ? '#ef4444' : '#94a3b8');
                    } else if (currentAvg > 0) {
                        momElement.textContent = 'First month tracked';
                        momElement.style.color = '#94a3b8';
                    } else {
                        momElement.textContent = 'No data this month';
                        momElement.style.color = '#94a3b8';
                    }
                }
            });
            
            // Update exercise selector for PR Timeline
            const exerciseSelector = document.getElementById('exercise-selector');
            if (exerciseSelector) {
                const exercises = getAllExercises();
                exerciseSelector.innerHTML = '<option value="">Select an exercise</option>' +
                    exercises.map(ex => `<option value="${ex}">${ex}</option>`).join('');
                
                // Set default to first exercise if available
                if (exercises.length > 0) {
                    exerciseSelector.value = exercises[0];
                    createPRTimelineChart(exercises[0]);
                }
            }
            
            // Update session comparison with default (Upper)
            updateSessionComparison('Upper');
            
            // Update progression snapshot
            updateProgressionSnapshot();
            
            // Update focus areas
            updateFocusAreas();
            
            // Update intensity heatmap
            updateIntensityHeatmap();
        }

        function updateProgressionSnapshot() {
            // Quick Wins
            const recentPRs = getRecentPRs(7);
            const quickWinsElement = document.getElementById('quick-wins');
            if (quickWinsElement) {
                if (recentPRs.length > 0) {
                    const uniqueExercises = [...new Set(recentPRs.map(pr => pr.exercise))];
                    quickWinsElement.innerHTML = `üèÜ <strong>${uniqueExercises.length}</strong> exercise${uniqueExercises.length !== 1 ? 's' : ''} hit PRs this week!`;
                    quickWinsElement.style.color = '#10b981';
                } else {
                    quickWinsElement.innerHTML = 'No PRs this week yet. Keep pushing!';
                    quickWinsElement.style.color = '#94a3b8';
                }
            }
            
            // Trending Up
            const trendingExercises = getTrendingUpExercises();
            const trendingUpElement = document.getElementById('trending-up');
            if (trendingUpElement) {
                if (trendingExercises.length > 0) {
                    trendingUpElement.innerHTML = trendingExercises.map(ex => `‚Ä¢ ${ex}`).join('<br>');
                    trendingUpElement.style.color = '#10b981';
                } else {
                    trendingUpElement.innerHTML = 'Need 3+ sessions per exercise to detect trends';
                    trendingUpElement.style.color = '#94a3b8';
                }
            }
            
            // Needs Attention
            const plateauedExercises = getPlateauedExercises(3);
            const needsAttentionElement = document.getElementById('needs-attention');
            if (needsAttentionElement) {
                if (plateauedExercises.length > 0) {
                    needsAttentionElement.innerHTML = plateauedExercises.map(ex => 
                        `‚Ä¢ ${ex.exercise} (stuck at ${ex.weight} lbs)`
                    ).join('<br>');
                    needsAttentionElement.style.color = '#f59e0b';
                } else {
                    needsAttentionElement.innerHTML = 'All exercises progressing well! üí™';
                    needsAttentionElement.style.color = '#10b981';
                }
            }
        }

        function updateFocusAreas() {
            const container = document.getElementById('focus-areas-content');
            if (!container) return;
            
            const workoutTypes = ['Upper', 'Lower', 'Push', 'Pull', 'Legs'];
            const warnings = [];
            
            // Check for workout types not done recently
            workoutTypes.forEach(type => {
                const daysSince = getDaysSinceLastWorkout(type);
                if (daysSince !== null && daysSince > 5) {
                    warnings.push(`‚ö†Ô∏è It's been ${daysSince} days since your last ${type} workout`);
                }
            });
            
            // Check for imbalanced training this month
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const typeFrequency = {};
            
            workoutTypes.forEach(type => {
                typeFrequency[type] = allWorkouts.filter(w => {
                    const workoutDate = new Date(w.date);
                    return w.day === type && 
                           workoutDate.getMonth() === thisMonth && 
                           workoutDate.getFullYear() === thisYear;
                }).length;
            });
            
            const frequencies = Object.values(typeFrequency).filter(f => f > 0);
            if (frequencies.length > 1) {
                const maxFreq = Math.max(...frequencies);
                const minFreq = Math.min(...frequencies);
                
                if (maxFreq - minFreq >= 2) {
                    const undertrainedTypes = Object.keys(typeFrequency).filter(type => typeFrequency[type] === minFreq);
                    warnings.push(`üí° Consider adding more ${undertrainedTypes.join(' or ')} workouts to balance your training`);
                }
            }
            
            if (warnings.length > 0) {
                container.innerHTML = warnings.map(w => `<div style="margin-bottom: 0.5rem;">${w}</div>`).join('');
                container.style.color = '#f59e0b';
            } else {
                container.innerHTML = '<div>‚úÖ Your training is well balanced! Keep it up!</div>';
                container.style.color = '#10b981';
            }
        }

        function updateInsights() {
            const insights = generateAIInsights();
            const plateaus = detectPlateaus();
            const container = document.getElementById('insights-list');
            
            let html = '';
            
            // Add plateau alerts first
            plateaus.slice(0, 2).forEach(plateau => {
                html += `<li class="insight-item plateau-alert">‚ö†Ô∏è ${plateau.exercise} plateaued for ${plateau.sessions} sessions. ${plateau.suggestion}</li>`;
            });
            
            // Add regular insights
            insights.forEach(insight => {
                const isProgression = insight.includes('Outstanding') || insight.includes('excellent');
                const className = isProgression ? 'progression-highlight' : '';
                html += `<li class="insight-item ${className}">${insight}</li>`;
            });
            
            container.innerHTML = html || '<li class="insight-item">Complete more workouts to get personalized insights!</li>';
        }

        function updateProgress() {
            const prs = getPersonalRecords();
            const progression = getExerciseProgression();
            const prContainer = document.getElementById('progress-list');
            const progressionContainer = document.getElementById('exercise-progress-list');
            
            // Update PRs
            if (Object.keys(prs).length === 0) {
                prContainer.innerHTML = '<p style="color: #64748b;">Complete some workouts to see your personal records!</p>';
            } else {
                const sortedPRs = Object.entries(prs).sort(([,a], [,b]) => b.weight - a.weight);
                
                prContainer.innerHTML = sortedPRs.slice(0, 10).map(([exercise, pr]) => `
                    <div class="insight-item">
                        <strong>${exercise}</strong><br>
                        ${pr.weight}lbs √ó ${pr.reps} reps - ${formatDateString(pr.date)}
                    </div>
                `).join('');
            }
            
            // Update exercise progression
            if (Object.keys(progression).length === 0) {
                progressionContainer.innerHTML = '<p style="color: #64748b;">Complete some workouts to see your detailed progression!</p>';
            } else {
                const sortedProgression = Object.entries(progression).sort(([,a], [,b]) => {
                    const typeOrder = { strength: 4, volume: 3, total_volume: 2, maintaining: 1 };
                    return typeOrder[b.type] - typeOrder[a.type];
                });
                
                progressionContainer.innerHTML = sortedProgression.slice(0, 15).map(([exercise, data]) => {
                    const typeColors = {
                        strength: '#10b981',
                        volume: '#3b82f6', 
                        total_volume: '#f59e0b',
                        maintaining: '#64748b'
                    };
                    
                    return `
                        <div class="insight-item" style="border-left-color: ${typeColors[data.type]};">
                            <strong>${exercise}</strong><br>
                            ${data.progression}<br>
                            <span style="color: #94a3b8; font-size: 0.75rem;">
                                ${data.daysSince} days ago ‚Ä¢ ${data.sessions} sessions tracked
                            </span>
                        </div>
                    `;
                }).join('');
            }
        }

        // Calendar Functions
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
            
            // Get first and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Build calendar grid
            let html = '';
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Add days from previous month
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${day}</div>
                </div>`;
            }
            
            // Add days of current month
            const today = new Date().toISOString().split('T')[0];
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const scheduledWorkout = getScheduledWorkout(dateStr);
                const actualWorkout = getWorkoutForDate(dateStr);
                
                let classes = ['calendar-day'];
                if (dateStr === today) classes.push('today');
                if (actualWorkout) {
                    classes.push('has-workout');
                } else if (scheduledWorkout !== 'Rest' && date < new Date()) {
                    classes.push('missed');
                } else if (scheduledWorkout !== 'Rest') {
                    classes.push('scheduled');
                }
                
                html += `<div class="${classes.join(' ')}" onclick="selectCalendarDay('${dateStr}')">
                    <div class="calendar-day-number">${day}</div>
                    <div class="calendar-day-label ${scheduledWorkout}">${scheduledWorkout}</div>
                </div>`;
            }
            
            // Add days from next month
            const remainingDays = 42 - (startingDayOfWeek + daysInMonth); // 6 weeks * 7 days
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${day}</div>
                </div>`;
            }
            
            document.getElementById('calendar-grid').innerHTML = html;
            
            // Update adherence
            const adherence = calculateAdherence();
            document.getElementById('adherence-score').textContent = `${adherence.score}%`;
            document.getElementById('workouts-completed').textContent = adherence.completed;
            document.getElementById('workouts-scheduled').textContent = adherence.scheduled;
            document.getElementById('workouts-missed').textContent = adherence.missed;
        }

        // Helper function to format date string correctly without timezone issues
        function formatDateString(dateStr) {
            // dateStr is in format "YYYY-MM-DD"
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day); // month is 0-indexed
            return date.toLocaleDateString();
        }

        window.selectCalendarDay = function(dateStr) {
            selectedCalendarDay = dateStr;
            const workout = getWorkoutForDate(dateStr);
            const scheduledWorkout = getScheduledWorkout(dateStr);
            
            const container = document.getElementById('selected-day-workout');
            const content = document.getElementById('selected-day-content');
            const title = document.getElementById('selected-day-title');
            
            if (workout) {
                title.textContent = `${workout.day} Workout - ${formatDateString(dateStr)}`;
                
                let html = '<div style="display: grid; gap: 1rem;">';
                
                // Show intensity if available
                if (workout.intensity) {
                    html += '<div style="background: rgba(15, 23, 42, 0.6); padding: 1rem; border-radius: 8px;">';
                    html += '<h4 style="color: #06b6d4; margin-bottom: 0.5rem;">Session Intensity</h4>';
                    html += '<div style="display: flex; gap: 1rem; flex-wrap: wrap;">';
                    if (workout.intensity.energy) html += `<span style="color: #94a3b8;">Energy: ${workout.intensity.energy}/5</span>`;
                    if (workout.intensity.motivation) html += `<span style="color: #94a3b8;">Motivation: ${workout.intensity.motivation}/5</span>`;
                    if (workout.intensity.fatigue) html += `<span style="color: #94a3b8;">Fatigue: ${workout.intensity.fatigue}/5</span>`;
                    if (workout.intensity.satisfaction) html += `<span style="color: #94a3b8;">Satisfaction: ${workout.intensity.satisfaction}/5</span>`;
                    html += '</div></div>';
                }
                
                // Show exercises
                Object.values(workout.exercises || {}).forEach(exercise => {
                    html += '<div style="background: rgba(15, 23, 42, 0.6); padding: 1rem; border-radius: 8px;">';
                    html += `<h4 style="color: white; margin-bottom: 0.5rem;">${exercise.exercise}</h4>`;
                    
                    exercise.sets.forEach((set, idx) => {
                        if (set.completed) {
                            html += `<div style="color: #10b981; padding: 0.25rem;">‚úì Completed</div>`;
                        } else if (set.weight || set.reps) {
                            html += `<div style="color: #93c5fd; padding: 0.25rem;">Set ${idx + 1}: ${set.weight}lbs √ó ${set.reps} reps`;
                            if (set.notes) html += ` (${set.notes})`;
                            html += '</div>';
                        }
                    });
                    
                    html += '</div>';
                });
                
                html += '</div>';
                content.innerHTML = html;
            } else {
                title.textContent = `${scheduledWorkout} - ${formatDateString(dateStr)}`;
                content.innerHTML = `<p style="color: #64748b;">No workout logged for this day. Scheduled: ${scheduledWorkout}</p>`;
            }
            
            container.style.display = 'block';
        };

        // Nutrition Functions
        function renderMeals() {
            const meals = nutritionData.filter(n => n.date === currentNutritionDate);
            const container = document.getElementById('meals-container');
            
            if (meals.length === 0) {
                container.innerHTML = '';
                updateNutritionSummary();
                return;
            }
            
            let html = '';
            meals.forEach((meal, mealIndex) => {
                html += `<div class="meal-card">
                    <div class="meal-header">
                        <div>
                            <select class="meal-type" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 6px; color: white; padding: 0.75rem; font-size: 1.2rem; font-weight: 600; cursor: pointer;" onchange="changeMealType('${meal.id}', this.value)">
                                <option value="Breakfast" ${meal.mealType === 'Breakfast' ? 'selected' : ''}>üåÖ Breakfast</option>
                                <option value="Lunch" ${meal.mealType === 'Lunch' ? 'selected' : ''}>‚òÄÔ∏è Lunch</option>
                                <option value="Dinner" ${meal.mealType === 'Dinner' ? 'selected' : ''}>üåô Dinner</option>
                                <option value="Snack" ${meal.mealType === 'Snack' ? 'selected' : ''}>üç™ Snack</option>
                            </select>
                            <div class="meal-time">${meal.time || ''}</div>
                        </div>
                        <button class="btn" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 0.75rem 1rem; min-height: 44px;" onclick="deleteMeal('${meal.id}')">üóëÔ∏è Delete</button>
                    </div>
                    <div id="meal-${meal.id}">`;
                
                (meal.foods || []).forEach((food, foodIndex) => {
                    const quantity = food.quantity || 1;
                    const displayProtein = ((food.protein || 0) * quantity).toFixed(1);
                    const displayCarbs = ((food.carbs || 0) * quantity).toFixed(1);
                    const displayFats = ((food.fats || 0) * quantity).toFixed(1);
                    const displayCalories = Math.round((food.calories || 0) * quantity);
                    
                    html += `<div class="food-input-row">
                        <input type="text" class="food-input" value="${food.name}" placeholder="Food name" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'name', this.value)">
                        <div class="macro-inputs-grid">
                            <div class="macro-input-wrapper">
                                <label class="macro-input-label">Qty</label>
                                <input type="number" class="macro-input" value="${quantity}" placeholder="1" step="0.1" min="0.1" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'quantity', this.value)">
                            </div>
                            <div class="macro-input-wrapper">
                                <label class="macro-input-label">Protein</label>
                                <input type="number" class="macro-input" value="${food.protein || 0}" placeholder="0" step="0.1" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'protein', this.value)">
                                ${quantity !== 1 ? `<div style="font-size: 0.7rem; color: #64748b; text-align: center; margin-top: 0.25rem;">${displayProtein}g</div>` : ''}
                            </div>
                            <div class="macro-input-wrapper">
                                <label class="macro-input-label">Carbs</label>
                                <input type="number" class="macro-input" value="${food.carbs || 0}" placeholder="0" step="0.1" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'carbs', this.value)">
                                ${quantity !== 1 ? `<div style="font-size: 0.7rem; color: #64748b; text-align: center; margin-top: 0.25rem;">${displayCarbs}g</div>` : ''}
                            </div>
                            <div class="macro-input-wrapper">
                                <label class="macro-input-label">Fats</label>
                                <input type="number" class="macro-input" value="${food.fats || 0}" placeholder="0" step="0.1" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'fats', this.value)">
                                ${quantity !== 1 ? `<div style="font-size: 0.7rem; color: #64748b; text-align: center; margin-top: 0.25rem;">${displayFats}g</div>` : ''}
                            </div>
                            <div class="macro-input-wrapper">
                                <label class="macro-input-label">Calories</label>
                                <input type="number" class="macro-input" value="${food.calories || 0}" placeholder="0" onchange="updateMealFood('${meal.id}', ${foodIndex}, 'calories', this.value)">
                                ${quantity !== 1 ? `<div style="font-size: 0.7rem; color: #64748b; text-align: center; margin-top: 0.25rem;">${displayCalories}</div>` : ''}
                            </div>
                        </div>
                        <div class="food-action-buttons">
                            <button class="btn-save-food" onclick="saveFoodToLibrary('${meal.id}', ${foodIndex})" title="Save to library">üíæ Save</button>
                            <button class="btn-delete-food" onclick="deleteFoodFromMeal('${meal.id}', ${foodIndex})" title="Delete food">üóëÔ∏è Delete</button>
                        </div>
                    </div>`;
                });
                
                html += `</div>
                    <button class="btn btn-add" onclick="addFoodToMeal('${meal.id}')" style="margin-top: 0.5rem;">+ Add Food</button>
                </div>`;
            });
            
            container.innerHTML = html;
            updateNutritionSummary();
        }

        function updateNutritionSummary() {
            const meals = nutritionData.filter(n => n.date === currentNutritionDate);
            let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFats = 0;
            
            meals.forEach(meal => {
                (meal.foods || []).forEach(food => {
                    const quantity = food.quantity || 1;
                    totalCalories += (parseFloat(food.calories) || 0) * quantity;
                    totalProtein += (parseFloat(food.protein) || 0) * quantity;
                    totalCarbs += (parseFloat(food.carbs) || 0) * quantity;
                    totalFats += (parseFloat(food.fats) || 0) * quantity;
                });
            });
            
            document.getElementById('total-calories').textContent = Math.round(totalCalories);
            document.getElementById('total-protein').textContent = Math.round(totalProtein) + 'g';
            document.getElementById('total-carbs').textContent = Math.round(totalCarbs) + 'g';
            document.getElementById('total-fats').textContent = Math.round(totalFats) + 'g';
        }

        // Meal type selection modal functions
        window.showMealTypeModal = function() {
            document.getElementById('meal-type-modal').classList.add('active');
        };

        window.closeMealTypeModal = function() {
            document.getElementById('meal-type-modal').classList.remove('active');
        };

        window.selectMealType = async function(mealType) {
            closeMealTypeModal();
            
            const mealData = {
                date: currentNutritionDate,
                mealType: mealType,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                foods: []
            };
            
            try {
                const docRef = await addDoc(collection(db, "nutrition"), mealData);
                nutritionData.unshift({ id: docRef.id, ...mealData });
                renderMeals();
            } catch (e) {
                console.error("Error adding meal:", e);
                alert('Error adding meal. Please check your connection and try again.');
            }
        };

        window.addMeal = function() {
            showMealTypeModal();
        };

        window.addFoodToMeal = function(mealId) {
            const meal = nutritionData.find(m => m.id === mealId);
            if (!meal.foods) meal.foods = [];
            meal.foods.push({ name: '', protein: 0, carbs: 0, fats: 0, calories: 0, quantity: 1 });
            renderMeals();
        };

        window.changeMealType = async function(mealId, newMealType) {
            try {
                const meal = nutritionData.find(m => m.id === mealId);
                if (!meal) return;
                
                meal.mealType = newMealType;
                
                // Update in Firestore
                const docRef = doc(db, "nutrition", mealId);
                await updateDoc(docRef, { mealType: newMealType });
                
                console.log(`Updated meal ${mealId} to ${newMealType}`);
            } catch (e) {
                console.error("Error changing meal type:", e);
                alert('Error changing meal type. Please try again.');
            }
        };

        window.updateMealFood = async function(mealId, foodIndex, field, value) {
            const meal = nutritionData.find(m => m.id === mealId);
            if (meal && meal.foods && meal.foods[foodIndex]) {
                meal.foods[foodIndex][field] = value;
                updateNutritionSummary();
                
                // Auto-save to Firebase with debouncing
                if (meal.saveTimeout) {
                    clearTimeout(meal.saveTimeout);
                }
                meal.saveTimeout = setTimeout(async () => {
                    try {
                        const docRef = doc(db, "nutrition", mealId);
                        await updateDoc(docRef, { foods: meal.foods });
                    } catch (e) {
                        console.error("Error updating meal:", e);
                    }
                }, 1000); // Wait 1 second after last edit before saving
            }
        };

        async function saveMealToFirebase(meal) {
            // This function is no longer needed as we use updateDoc directly
            console.warn('saveMealToFirebase is deprecated, use updateDoc directly');
        }

        window.deleteMeal = async function(mealId) {
            if (confirm('Delete this meal?')) {
                try {
                    // Delete from Firestore
                    const docRef = doc(db, "nutrition", mealId);
                    await deleteDoc(docRef);
                    
                    // Remove from local state
                    nutritionData = nutritionData.filter(m => m.id !== mealId);
                    renderMeals();
                } catch (e) {
                    console.error("Error deleting meal:", e);
                    alert('Error deleting meal. Please try again.');
                }
            }
        };

        window.deleteFoodFromMeal = async function(mealId, foodIndex) {
            if (confirm('Delete this food item?')) {
                try {
                    const meal = nutritionData.find(m => m.id === mealId);
                    if (!meal || !meal.foods) return;
                    
                    // Remove the food from the array
                    meal.foods.splice(foodIndex, 1);
                    
                    // If meal has no foods left, delete the entire meal
                    if (meal.foods.length === 0) {
                        await window.deleteMeal(mealId);
                        return;
                    }
                    
                    // Update in Firestore
                    const docRef = doc(db, "nutrition", mealId);
                    await updateDoc(docRef, { foods: meal.foods });
                    
                    renderMeals();
                } catch (e) {
                    console.error("Error deleting food from meal:", e);
                    alert('Error deleting food item. Please try again.');
                }
            }
        };

        // Saved Foods Functions
        window.saveFoodToLibrary = async function(mealId, foodIndex) {
            const meal = nutritionData.find(m => m.id === mealId);
            if (!meal || !meal.foods || !meal.foods[foodIndex]) return;
            
            const food = meal.foods[foodIndex];
            
            if (!food.name || !food.name.trim()) {
                alert('Please enter a food name before saving');
                return;
            }
            
            const newProtein = parseFloat(food.protein) || 0;
            const newCarbs = parseFloat(food.carbs) || 0;
            const newFats = parseFloat(food.fats) || 0;
            const newCalories = parseFloat(food.calories) || 0;
            
            // Check if food already exists (by name and nutritional values)
            const existingFood = savedFoods.find(f => {
                const nameMatch = f.name.toLowerCase().trim() === food.name.toLowerCase().trim();
                const proteinMatch = (parseFloat(f.protein) || 0) === newProtein;
                const carbsMatch = (parseFloat(f.carbs) || 0) === newCarbs;
                const fatsMatch = (parseFloat(f.fats) || 0) === newFats;
                const caloriesMatch = (parseFloat(f.calories) || 0) === newCalories;
                
                return nameMatch && proteinMatch && carbsMatch && fatsMatch && caloriesMatch;
            });
            
            if (existingFood) {
                // Exact duplicate found - just update lastUsed
                try {
                    existingFood.lastUsed = new Date().toISOString();
                    existingFood.useCount = (existingFood.useCount || 0) + 1;
                    
                    const docRef = doc(db, "savedFoods", existingFood.id);
                    await updateDoc(docRef, {
                        lastUsed: existingFood.lastUsed,
                        useCount: existingFood.useCount
                    });
                    alert('This food is already saved in your library!');
                    renderSavedFoods();
                } catch (e) {
                    console.error("Error updating food:", e);
                    alert('Error updating food in library');
                }
            } else {
                // Check if food with same name but different nutritional values exists
                const sameName = savedFoods.find(f => f.name.toLowerCase().trim() === food.name.toLowerCase().trim());
                
                if (sameName) {
                    if (!confirm(`"${food.name}" already exists in saved foods with different nutritional values. Save as a new entry?`)) {
                        return;
                    }
                }
                
                // Add new food
                const savedFood = {
                    name: food.name.trim(),
                    protein: newProtein,
                    carbs: newCarbs,
                    fats: newFats,
                    calories: newCalories,
                    created: new Date().toISOString(),
                    lastUsed: new Date().toISOString(),
                    useCount: 0
                };
                
                try {
                    const docRef = await addDoc(collection(db, "savedFoods"), savedFood);
                    savedFoods.unshift({ id: docRef.id, ...savedFood });
                    alert('Food saved to library!');
                    renderSavedFoods();
                } catch (e) {
                    console.error("Error saving food:", e);
                    alert('Error saving food to library');
                }
            }
        };

        async function saveSavedFoodsToFirebase() {
            // Update existing saved food documents in Firebase
            for (const food of savedFoods) {
                if (food.id) {
                    try {
                        const docRef = doc(db, "savedFoods", food.id);
                        await updateDoc(docRef, {
                            name: food.name,
                            protein: food.protein,
                            carbs: food.carbs,
                            fats: food.fats,
                            calories: food.calories,
                            lastUsed: food.lastUsed,
                            useCount: food.useCount
                        });
                    } catch (e) {
                        console.error("Error updating saved food:", e);
                    }
                }
            }
        }

        function renderSavedFoods(searchTerm = '') {
            const container = document.getElementById('saved-food-list');
            if (!container) return;
            
            let filteredFoods = savedFoods;
            if (searchTerm) {
                filteredFoods = savedFoods.filter(food => 
                    food.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Sort by last used, then by use count
            filteredFoods.sort((a, b) => {
                const dateA = new Date(a.lastUsed || 0);
                const dateB = new Date(b.lastUsed || 0);
                if (dateB - dateA !== 0) return dateB - dateA;
                return (b.useCount || 0) - (a.useCount || 0);
            });
            
            if (filteredFoods.length === 0) {
                container.innerHTML = '<div class="empty-state">No saved foods found. Save a food from a meal below!</div>';
                return;
            }
            
            let html = '';
            filteredFoods.forEach(food => {
                html += `<div class="saved-food-item">
                    <div class="saved-food-info">
                        <div class="saved-food-name">${food.name}</div>
                        <div class="saved-food-macros">
                            <span>P: ${food.protein}g</span>
                            <span>C: ${food.carbs}g</span>
                            <span>F: ${food.fats}g</span>
                            <span>Cal: ${food.calories}</span>
                        </div>
                    </div>
                    <div class="saved-food-actions">
                        <button class="btn-quick-add" onclick="quickAddFood('${food.id}')">Quick Add</button>
                        <button class="btn-delete-food" onclick="deleteSavedFood('${food.id}')">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        window.quickAddFood = async function(foodId) {
            const food = savedFoods.find(f => f.id === foodId);
            if (!food) return;
            
            // Prompt for quantity
            const quantityInput = prompt('How many servings?', '1');
            if (quantityInput === null) return; // User cancelled
            
            const quantity = parseFloat(quantityInput) || 1;
            if (quantity <= 0) {
                alert('Please enter a positive quantity');
                return;
            }
            
            // Determine which meal type to add to based on current time
            const currentHour = new Date().getHours();
            let targetMealType;
            if (currentHour < 11) {
                targetMealType = 'Breakfast';
            } else if (currentHour < 15) {
                targetMealType = 'Lunch';
            } else if (currentHour < 20) {
                targetMealType = 'Dinner';
            } else {
                targetMealType = 'Snack';
            }
            
            // Find existing meal of this type for today, or create one
            let meals = nutritionData.filter(n => n.date === currentNutritionDate);
            let targetMeal = meals.find(m => m.mealType === targetMealType);
            
            if (!targetMeal) {
                // Create a new meal of the appropriate type
                const mealData = {
                    date: currentNutritionDate,
                    mealType: targetMealType,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    foods: []
                };
                
                try {
                    const docRef = await addDoc(collection(db, "nutrition"), mealData);
                    targetMeal = { id: docRef.id, ...mealData };
                    nutritionData.unshift(targetMeal);
                } catch (e) {
                    console.error("Error creating meal:", e);
                    alert('Error creating meal');
                    return;
                }
            }
            
            // Add food to meal with quantity
            if (!targetMeal.foods) targetMeal.foods = [];
            targetMeal.foods.push({
                name: food.name,
                protein: food.protein,
                carbs: food.carbs,
                fats: food.fats,
                calories: food.calories,
                quantity: quantity
            });
            
            // Update use count and last used
            food.useCount = (food.useCount || 0) + 1;
            food.lastUsed = new Date().toISOString();
            
            // Save to Firebase
            try {
                // Update the meal with the new food
                const mealDocRef = doc(db, "nutrition", targetMeal.id);
                await updateDoc(mealDocRef, { foods: targetMeal.foods });
                
                // Update only this specific saved food's usage stats
                const foodDocRef = doc(db, "savedFoods", food.id);
                await updateDoc(foodDocRef, {
                    useCount: food.useCount,
                    lastUsed: food.lastUsed
                });
                
                renderMeals();
                renderSavedFoods();
            } catch (e) {
                console.error("Error quick adding food:", e);
                alert('Error adding food to meal. Please try again.');
            }
        };

        window.deleteSavedFood = async function(foodId) {
            if (!confirm('Delete this saved food?')) return;
            
            try {
                // Delete from Firebase
                const docRef = doc(db, "savedFoods", foodId);
                await deleteDoc(docRef);
                
                // Remove from local state
                savedFoods = savedFoods.filter(f => f.id !== foodId);
                renderSavedFoods();
                
                console.log(`Deleted saved food ${foodId} from Firebase`);
            } catch (e) {
                console.error("Error deleting saved food:", e);
                alert('Error deleting saved food. Please try again.');
            }
        };

        async function loadSavedFoods() {
            try {
                const q = query(collection(db, "savedFoods"), orderBy("lastUsed", "desc"));
                const querySnapshot = await getDocs(q);
                
                const allFoods = [];
                querySnapshot.forEach((doc) => {
                    allFoods.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`Loaded ${allFoods.length} saved foods from database`);
                
                // Deduplicate foods based on name and nutritional values
                const deduplicatedFoods = await deduplicateSavedFoods(allFoods);
                savedFoods = deduplicatedFoods;
                
                console.log(`After deduplication: ${savedFoods.length} unique saved foods`);
            } catch (e) {
                console.error("Error loading saved foods:", e);
                // Initialize with empty array if error
                savedFoods = [];
            }
        }
        
        /**
         * Deduplicates saved foods based on name and nutritional values.
         * If duplicates exist, keeps the most recently used one and deletes others from Firebase.
         */
        async function deduplicateSavedFoods(foods) {
            if (!foods || foods.length === 0) return [];
            
            const foodMap = new Map();
            const duplicatesToDelete = [];
            
            // Create a unique key for each food based on name and nutritional values
            const createFoodKey = (food) => {
                const name = (food.name || '').toLowerCase().trim();
                const protein = parseFloat(food.protein) || 0;
                const carbs = parseFloat(food.carbs) || 0;
                const fats = parseFloat(food.fats) || 0;
                const calories = parseFloat(food.calories) || 0;
                return `${name}_${protein}_${carbs}_${fats}_${calories}`;
            };
            
            // Group foods by their unique key
            for (const food of foods) {
                const key = createFoodKey(food);
                
                if (!foodMap.has(key)) {
                    foodMap.set(key, food);
                } else {
                    // Duplicate found - keep the one with more recent lastUsed date
                    const existing = foodMap.get(key);
                    const existingDate = new Date(existing.lastUsed || 0);
                    const currentDate = new Date(food.lastUsed || 0);
                    
                    if (currentDate > existingDate) {
                        // Current food is more recent, replace existing and mark old for deletion
                        duplicatesToDelete.push(existing.id);
                        foodMap.set(key, food);
                    } else {
                        // Existing is more recent, mark current for deletion
                        duplicatesToDelete.push(food.id);
                    }
                }
            }
            
            // Delete duplicates from Firebase
            if (duplicatesToDelete.length > 0) {
                console.log(`Found ${duplicatesToDelete.length} duplicate saved foods to clean up`);
                
                for (const foodId of duplicatesToDelete) {
                    try {
                        const docRef = doc(db, "savedFoods", foodId);
                        await deleteDoc(docRef);
                        console.log(`Deleted duplicate saved food ${foodId}`);
                    } catch (e) {
                        console.error(`Error deleting duplicate food ${foodId}:`, e);
                    }
                }
                
                console.log(`Cleaned up ${duplicatesToDelete.length} duplicate saved foods from database`);
            }
            
            // Return deduplicated list
            return Array.from(foodMap.values());
        }

        // Weight Functions
        window.logWeight = async function() {
            const date = document.getElementById('weight-date-input').value;
            const weight = parseFloat(document.getElementById('weight-value-input').value);
            
            if (!date || !weight) {
                alert('Please enter both date and weight');
                return;
            }
            
            const weightData = { date, weight };
            
            try {
                const docRef = await addDoc(collection(db, "weight"), weightData);
                weightData.id = docRef.id;
                
                // Safety check: Initialize window.weightData if undefined
                if (!window.weightData) {
                    window.weightData = [];
                }
                
                window.weightData.unshift(weightData);
                
                document.getElementById('weight-value-input').value = '';
                
                createWeightChart();
                alert('Weight logged successfully!');
            } catch (e) {
                console.error("Error logging weight:", e);
                alert('Error logging weight');
            }
        };

        function createWeightChart() {
            const ctx = document.getElementById('weight-chart');
            if (!ctx) return;
            
            if (charts.weight) charts.weight.destroy();
            
            const sortedWeights = [...weightData].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            charts.weight = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedWeights.map(w => formatDateString(w.date)),
                    datasets: [{
                        label: 'Weight (lbs)',
                        data: sortedWeights.map(w => w.weight),
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Weight (lbs)' }
                        }
                    }
                }
            });
        }

        // Photo Functions
        window.uploadProgressPhoto = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const photoData = {
                    date: new Date().toISOString().split('T')[0],
                    dataUrl: e.target.result,
                    timestamp: new Date()
                };
                
                try {
                    const docRef = await addDoc(collection(db, "photos"), photoData);
                    
                    // Safety check: Initialize window.photoData if undefined
                    if (!window.photoData) {
                        window.photoData = [];
                    }
                    
                    window.photoData.unshift({ id: docRef.id, ...photoData });
                    renderPhotos();
                    alert('Photo uploaded successfully!');
                } catch (error) {
                    console.error("Error uploading photo:", error);
                    alert('Error uploading photo');
                }
            };
            reader.readAsDataURL(file);
        };

        window.deleteProgressPhoto = async function(photoId) {
            if (confirm('Delete this progress photo?')) {
                try {
                    // Delete from Firestore
                    await deleteDoc(doc(db, "photos", photoId));
                    
                    // Remove from local photoData array
                    window.photoData = window.photoData.filter(p => p.id !== photoId);
                    
                    // Re-render the gallery
                    renderPhotos();
                } catch (e) {
                    console.error("Error deleting progress photo:", e);
                    alert('Error deleting photo. Please try again.');
                }
            }
        };

        function renderPhotos() {
            const container = document.getElementById('photo-gallery');
            if (!container) return;
            
            if (window.photoData.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No progress photos yet. Upload your first one!</p>';
                return;
            }
            
            let html = '';
            window.photoData.forEach(photo => {
                html += `<div class="photo-item">
                    <img src="${photo.dataUrl}" alt="Progress photo">
                    <button class="btn-delete-photo" onclick="deleteProgressPhoto('${photo.id}')" title="Delete photo">üóëÔ∏è</button>
                    <div class="photo-date">${formatDateString(photo.date)}</div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        // Utility function to wipe all nutrition data (call from console: window.wipeNutritionData())
        window.wipeNutritionData = async function() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL nutrition and food data from Firestore. This cannot be undone!\n\nAre you sure you want to continue?')) {
                return;
            }
            
            if (!confirm('Please confirm one more time: Delete ALL nutrition data?')) {
                return;
            }
            
            try {
                console.log('Starting data wipe...');
                let deletedCount = 0;
                
                // Delete all nutrition documents
                const nutritionQuery = query(collection(db, "nutrition"));
                const nutritionSnapshot = await getDocs(nutritionQuery);
                
                for (const document of nutritionSnapshot.docs) {
                    await deleteDoc(doc(db, "nutrition", document.id));
                    deletedCount++;
                }
                
                console.log(`Deleted ${deletedCount} nutrition documents`);
                
                // Delete all saved foods
                const savedFoodsQuery = query(collection(db, "savedFoods"));
                const savedFoodsSnapshot = await getDocs(savedFoodsQuery);
                let savedFoodsDeleted = 0;
                
                for (const document of savedFoodsSnapshot.docs) {
                    await deleteDoc(doc(db, "savedFoods", document.id));
                    savedFoodsDeleted++;
                }
                
                console.log(`Deleted ${savedFoodsDeleted} saved food documents`);
                
                // Clear local state
                nutritionData = [];
                window.nutritionData = [];
                savedFoods = [];
                window.savedFoods = [];
                
                // Refresh UI
                renderMeals();
                renderSavedFoods();
                
                alert(`‚úÖ Data wipe complete!\n\nDeleted:\n- ${deletedCount} nutrition entries\n- ${savedFoodsDeleted} saved foods`);
            } catch (e) {
                console.error("Error wiping data:", e);
                alert('Error wiping data: ' + e.message);
            }
        };

        // Main app initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing Fitness Command Center...');
            
            // Set up UI immediately
            setupEventListeners();
            initializeWorkout();
            
            // Load data in background
            await Promise.all([
                loadWorkoutsFromFirebase(),
                loadNutritionData(),
                loadWeightData(),
                loadPhotoData(),
                loadSavedFoods()
            ]);
            
            // Update with real data
            updateSuggestions();
            updateAnalytics();
            updateInsights();
            updateProgress();
            renderSavedFoods();
            
            console.log('Fitness Command Center loaded successfully!');
        });

        function setupEventListeners() {
            // Tab switching
            document.getElementById('workout-tab-btn').addEventListener('click', () => {
                showTab('workout');
                updateSuggestions();
            });
            document.getElementById('calendar-tab-btn').addEventListener('click', () => {
                showTab('calendar');
                renderCalendar();
            });
            document.getElementById('nutrition-tab-btn').addEventListener('click', () => {
                showTab('nutrition');
                renderMeals();
                renderSavedFoods();
            });
            document.getElementById('body-metrics-tab-btn').addEventListener('click', () => {
                showTab('body-metrics');
                createWeightChart();
                renderPhotos();
            });
            document.getElementById('analytics-tab-btn').addEventListener('click', () => {
                showTab('analytics');
                updateAnalytics();
            });
            document.getElementById('progress-tab-btn').addEventListener('click', () => {
                showTab('progress');
                updateProgress();
            });
            document.getElementById('intelligence-tab-btn').addEventListener('click', () => {
                showTab('intelligence');
                updateInsights();
            });

            // Day selection
            document.getElementById('upper-btn').addEventListener('click', () => selectDay('Upper'));
            document.getElementById('lower-btn').addEventListener('click', () => selectDay('Lower'));
            document.getElementById('rest-btn').addEventListener('click', () => selectDay('Rest'));
            document.getElementById('push-btn').addEventListener('click', () => selectDay('Push'));
            document.getElementById('pull-btn').addEventListener('click', () => selectDay('Pull'));
            document.getElementById('legs-btn').addEventListener('click', () => selectDay('Legs'));

            // Complete workout
            document.getElementById('complete-workout-btn').addEventListener('click', completeWorkout);
            
            // Initialize date input to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('workout-date-input').value = today;

            // Date input handling
            document.getElementById('workout-date-input').addEventListener('change', setWorkoutDate);
            document.getElementById('log-past-workout-btn').addEventListener('click', () => {
                const dateInput = document.getElementById('workout-date-input');
                if (dateInput.style.display === 'none' || !dateInput.style.display) {
                    dateInput.style.display = 'block';
                    dateInput.focus();
                }
            });

            // Intensity inputs
            setupIntensityInputs();

            setWorkoutDate(); // Initialize the button text
            
            // Calendar navigation
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
            
            // Nutrition date input
            const nutritionDateInput = document.getElementById('nutrition-date-input');
            nutritionDateInput.value = currentNutritionDate;
            nutritionDateInput.addEventListener('change', (e) => {
                currentNutritionDate = e.target.value;
                renderMeals();
            });
            
            // Saved food search
            const savedFoodSearch = document.getElementById('saved-food-search');
            if (savedFoodSearch) {
                savedFoodSearch.addEventListener('input', (e) => {
                    renderSavedFoods(e.target.value);
                });
            }
            
            // Weight date input
            const weightDateInput = document.getElementById('weight-date-input');
            weightDateInput.value = new Date().toISOString().split('T')[0];
            
            // Analytics dropdowns
            const exerciseSelector = document.getElementById('exercise-selector');
            if (exerciseSelector) {
                exerciseSelector.addEventListener('change', (e) => {
                    createPRTimelineChart(e.target.value);
                });
            }
            
            const comparisonSelector = document.getElementById('comparison-selector');
            if (comparisonSelector) {
                comparisonSelector.addEventListener('change', (e) => {
                    updateSessionComparison(e.target.value);
                });
            }
        }

        function setupIntensityInputs() {
            ['energy', 'motivation', 'fatigue', 'satisfaction'].forEach(type => {
                const scale = document.getElementById(`${type}-scale`);
                if (scale) {
                    scale.addEventListener('click', (e) => {
                        if (e.target.classList.contains('intensity-btn')) {
                            // Remove active class from siblings
                            scale.querySelectorAll('.intensity-btn').forEach(btn => btn.classList.remove('active'));
                            
                            // Add active class to clicked button
                            e.target.classList.add('active');
                            
                            // Update workout intensity
                            const value = parseInt(e.target.dataset.value);
                            if (['energy', 'motivation'].includes(type)) {
                                workoutIntensity.preWorkout[type] = value;
                            } else {
                                workoutIntensity.postWorkout[type] = value;
                            }
                        }
                    });
                }
            });
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-content').classList.add('active');
            document.getElementById(tabName + '-tab-btn').classList.add('active');
        }

        function selectDay(day) {
            currentDay = day;
            
            // Update day buttons
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(day.toLowerCase() + '-btn').classList.add('active');

            initializeWorkout();
            updateSuggestions();
        }

        function initializeWorkout() {
            currentWorkout = {};
            const exercises = workoutPlans[currentDay];

            exercises.forEach((exercise, index) => {
                const isStretch = exercise.name.toLowerCase().includes('stretch');
                const isRest = currentDay === 'Rest';
                
                currentWorkout[index] = {
                    exercise: exercise.name,
                    sets: (isStretch || isRest) ? 
                        [{ completed: false }] : 
                        Array(typeof exercise.sets === 'number' ? exercise.sets : 1).fill().map(() => ({
                            weight: '',
                            reps: '',
                            notes: ''
                        }))
                };
            });

            renderWorkout();
        }
        function renderWorkout() {
            const container = document.getElementById('exercises-container');
            const exercises = workoutPlans[currentDay];
            const lastWorkout = getLastWorkoutForDay(currentDay);
            const exerciseProgression = getExerciseProgression();
            
            let html = '';
            
            exercises.forEach((exercise, exerciseIndex) => {
                const workoutExercise = currentWorkout[exerciseIndex];
                const previousExercise = lastWorkout?.exercises?.[exerciseIndex];
                
                // Check if this is a stretch exercise or rest day
                const isStretch = exercise.name.toLowerCase().includes('stretch');
                const isRest = currentDay === 'Rest';
                
                // Calculate suggested weight and get progression info
                let suggestedWeight = '';
                let progressionInfo = '';
                
                if (!isStretch && !isRest && previousExercise && previousExercise.sets.length > 0) {
                    const prevSets = previousExercise.sets.filter(set => set.weight && set.reps);
                    if (prevSets.length > 0) {
                        const avgWeight = prevSets.reduce((sum, set) => sum + parseFloat(set.weight), 0) / prevSets.length;
                        const avgReps = prevSets.reduce((sum, set) => sum + parseInt(set.reps), 0) / prevSets.length;
                        
                        if (avgReps >= 10) {
                            suggestedWeight = Math.round(avgWeight + 5);
                        } else if (avgReps >= 8) {
                            suggestedWeight = Math.round(avgWeight + 2.5);
                        } else {
                            suggestedWeight = Math.round(avgWeight);
                        }
                    }
                }
                
                // Get progression information
                if (!isStretch && !isRest && exerciseProgression[exercise.name]) {
                    const prog = exerciseProgression[exercise.name];
                    if (prog.type === 'strength') {
                        progressionInfo = `+${prog.progression.split('(+')[1]?.split(')')[0] || 'improved'}`;
                    } else if (prog.type === 'volume') {
                        progressionInfo = `+${prog.progression.split('(+')[1]?.split(')')[0] || 'reps'}`;
                    }
                }

                // Get PR for this exercise
                const prs = getPersonalRecords();
                const exercisePR = (!isStretch && !isRest) ? prs[exercise.name] : null;
                
                html += `
                    <div class="exercise-card">
                        <div class="exercise-header">
                            <div>
                                <div class="exercise-name">
                                    ${exercise.name}
                                    ${workoutExercise.substitution ? `<span class="substitution-tag">Substitution</span>` : ''}
                                    ${workoutExercise.approach ? `<span class="substitution-tag">${workoutExercise.approach}</span>` : ''}
                                </div>
                                <div class="exercise-target">${exercise.sets} √ó ${exercise.reps}</div>
                                ${progressionInfo ? `<div class="exercise-progress-indicator">${progressionInfo} last session</div>` : ''}
                                ${!isStretch && !isRest ? `
                                    <div class="approach-selector">
                                        <button class="approach-btn ${!workoutExercise.approach ? 'active' : ''}" onclick="setExerciseApproach(${exerciseIndex}, null)">Standard</button>
                                        <button class="approach-btn ${workoutExercise.approach === 'Heavy' ? 'active' : ''}" onclick="setExerciseApproach(${exerciseIndex}, 'Heavy')">Heavy</button>
                                        <button class="approach-btn ${workoutExercise.approach === 'Form Focus' ? 'active' : ''}" onclick="setExerciseApproach(${exerciseIndex}, 'Form Focus')">Form Focus</button>
                                        <button class="approach-btn ${workoutExercise.substitution ? 'active' : ''}" onclick="toggleSubstitution(${exerciseIndex})">Alt Exercise</button>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="exercise-intelligence">
                                ${suggestedWeight ? `<div class="suggested-weight">Try ${suggestedWeight}lbs</div>` : ''}
                                ${exercisePR ? `<div class="pr-indicator">PR: ${exercisePR.weight}lbs √ó ${exercisePR.reps}</div>` : ''}
                            </div>
                        </div>

                        ${previousExercise && !isStretch && !isRest ? `
                            <div class="previous-session">
                                <div class="previous-header">Last session (${formatDateString(lastWorkout.date)}):</div>
                                <div class="previous-sets-compact">
                                    ${previousExercise.sets.filter(set => set.weight || set.reps).map(set => `${set.weight}√ó${set.reps}`).join(', ')}
                                </div>
                            </div>
                        ` : ''}`;

                if (isStretch || isRest) {
                    const label = isRest ? 'Rest Day Complete' : exercise.name;
                    html += `
                        <div class="stretch-row">
                            <div class="stretch-info">
                                <div class="set-number">‚úì</div>
                                <div class="stretch-label">${label}</div>
                            </div>
                            <input type="checkbox" class="stretch-checkbox" 
                                   ${workoutExercise.sets[0]?.completed ? 'checked' : ''}
                                   onchange="updateStretch(${exerciseIndex}, this.checked)">
                        </div>
                    `;
                } else {
                    html += `<div class="set-input-grid">`;
                    
                    workoutExercise.sets.forEach((set, setIndex) => {
                        html += `
                            <div class="set-row">
                                <div class="set-number">${setIndex + 1}</div>
                                <input type="number" class="weight-input" placeholder="lbs" 
                                       value="${set.weight}" 
                                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'weight', this.value)">
                                <span style="color: #64748b;">√ó</span>
                                <input type="number" class="reps-input" placeholder="reps" 
                                       value="${set.reps}" 
                                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'reps', this.value)">
                                <input type="text" class="notes-input" placeholder="notes" 
                                       value="${set.notes}" 
                                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'notes', this.value)">
                                ${previousExercise?.sets[setIndex]?.weight ? `
                                    <button class="btn btn-copy" onclick="copyPrevious(${exerciseIndex}, ${setIndex})">Copy</button>
                                ` : ''}
                            </div>`;
                    });
                    
                    html += `
                            </div>
                            <button class="btn btn-add" onclick="addSet(${exerciseIndex})" style="margin-top: 0.75rem;">+ Add Set</button>
                        `;
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        // Make functions globally available
        window.updateSet = function(exerciseIndex, setIndex, field, value) {
            currentWorkout[exerciseIndex].sets[setIndex][field] = value;
        };

        window.addSet = function(exerciseIndex) {
            currentWorkout[exerciseIndex].sets.push({ weight: '', reps: '', notes: '' });
            renderWorkout();
        };

        window.copyPrevious = function(exerciseIndex, setIndex) {
            const lastWorkout = getLastWorkoutForDay(currentDay);
            const previousSet = lastWorkout?.exercises?.[exerciseIndex]?.sets[setIndex];
            
            if (previousSet) {
                currentWorkout[exerciseIndex].sets[setIndex].weight = previousSet.weight;
                currentWorkout[exerciseIndex].sets[setIndex].reps = previousSet.reps;
                renderWorkout();
            }
        };

        window.updateStretch = function(exerciseIndex, completed) {
            currentWorkout[exerciseIndex].sets[0] = { completed: completed };
        };

        window.setExerciseApproach = function(exerciseIndex, approach) {
            currentWorkout[exerciseIndex].approach = approach;
            renderWorkout();
        };

        window.toggleSubstitution = function(exerciseIndex) {
            if (currentWorkout[exerciseIndex].substitution) {
                delete currentWorkout[exerciseIndex].substitution;
            } else {
                const altExercise = prompt('Enter alternative exercise name:');
                if (altExercise) {
                    currentWorkout[exerciseIndex].substitution = altExercise;
                    currentWorkout[exerciseIndex].originalExercise = currentWorkout[exerciseIndex].exercise;
                    currentWorkout[exerciseIndex].exercise = altExercise;
                }
            }
            renderWorkout();
        };

        window.setWorkoutDate = function() {
            const dateInput = document.getElementById('workout-date-input');
            const logBtn = document.getElementById('log-past-workout-btn');
            const today = new Date().toISOString().split('T')[0];
            
            if (dateInput.value && dateInput.value !== today) {
                logBtn.textContent = 'üìÖ For ' + formatDateString(dateInput.value);
                logBtn.style.background = 'rgba(16, 185, 129, 0.2)';
                logBtn.style.color = '#10b981';
            } else {
                logBtn.textContent = 'üìÖ Log Past Workout';
                logBtn.style.background = 'rgba(168, 85, 247, 0.2)';
                logBtn.style.color = '#a855f7';
            }
        };

        async function completeWorkout() {
            const dateInput = document.getElementById('workout-date-input');
            const today = new Date().toISOString().split('T')[0];
            const selectedDate = dateInput.value && dateInput.value !== today ? dateInput.value : today;
            
            const workoutData = {
                date: selectedDate,
                day: currentDay,
                exercises: currentWorkout,
                intensity: {
                    energy: workoutIntensity.preWorkout.energy,
                    motivation: workoutIntensity.preWorkout.motivation,
                    fatigue: workoutIntensity.postWorkout.fatigue,
                    satisfaction: workoutIntensity.postWorkout.satisfaction
                }
            };
            
            try {
                // Save to Firebase
                await saveWorkoutToFirebase(workoutData);
                
                // Also save locally as backup
                const localHistory = JSON.parse(localStorage.getItem('fitnessData') || '{}');
                const workoutKey = currentDay + '-' + selectedDate + '-' + Date.now();
                localHistory[workoutKey] = workoutData;
                localStorage.setItem('fitnessData', JSON.stringify(localHistory));
                
                // Reload data from Firebase
                await loadWorkoutsFromFirebase();
                
                // Export to clipboard
                exportToClipboard();
                
                alert('üí™ Workout saved to Firebase and copied to clipboard!');
                
                // Reset intensity inputs
                workoutIntensity = {
                    preWorkout: { energy: null, motivation: null },
                    postWorkout: { fatigue: null, satisfaction: null }
                };
                
                // Clear active intensity buttons
                document.querySelectorAll('.intensity-btn').forEach(btn => btn.classList.remove('active'));
                
                // Reset and refresh
                initializeWorkout();
                updateSuggestions();
                updateAnalytics();
                
            } catch (error) {
                console.error('Error saving workout:', error);
                alert('Error saving workout. Check your internet connection.');
            }
        }

        function exportToClipboard() {
            const dateInput = document.getElementById('workout-date-input');
            const workoutDate = dateInput.value ? new Date(dateInput.value) : new Date();
            const dateString = workoutDate.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short', 
                day: 'numeric'
            });
            
            let exportText = 'üèãÔ∏è‚Äç‚ôÇÔ∏è ' + currentDay + ' | ' + dateString + '\n';
            exportText += '=========================\n';
            
            // Add intensity ratings if available
            if (workoutIntensity.preWorkout.energy || workoutIntensity.postWorkout.satisfaction) {
                exportText += '\nüìä Session Intensity:\n';
                if (workoutIntensity.preWorkout.energy) exportText += `Energy: ${workoutIntensity.preWorkout.energy}/5 `;
                if (workoutIntensity.preWorkout.motivation) exportText += `| Motivation: ${workoutIntensity.preWorkout.motivation}/5\n`;
                if (workoutIntensity.postWorkout.fatigue) exportText += `Fatigue: ${workoutIntensity.postWorkout.fatigue}/5 `;
                if (workoutIntensity.postWorkout.satisfaction) exportText += `| Satisfaction: ${workoutIntensity.postWorkout.satisfaction}/5\n`;
                exportText += '\n';
            }
            
            Object.values(currentWorkout).forEach(exercise => {
                exportText += exercise.exercise + '\n';
                
                exercise.sets.forEach((set, index) => {
                    if (set.completed) {
                        exportText += '  ‚úì Completed\n';
                    } else if (set.weight || set.reps) {
                        exportText += '  ' + set.weight + 'lbs √ó ' + set.reps;
                        if (set.notes) exportText += ' (' + set.notes + ')';
                        exportText += '\n';
                    }
                });
                exportText += '\n';
            });
            
            // Copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(exportText);
            } else {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = exportText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }
    </script>
</body>
</html>
