<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zach's Fitness Command Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            background: linear-gradient(45deg, #06b6d4, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #64748b;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .workout-day-selector {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .day-btn {
            padding: 0.75rem 1.25rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
            border: none;
        }

        .day-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .intelligence-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .intelligence-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .intelligence-header h3 {
            color: #06b6d4;
            font-weight: 600;
        }

        .ai-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .suggestion-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.2);
            border-radius: 12px;
            padding: 1rem;
        }

        .suggestion-type {
            color: #f59e0b;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .suggestion-text {
            color: #e2e8f0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .exercise-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .exercise-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .exercise-target {
            display: inline-block;
            background: rgba(6, 182, 212, 0.2);
            color: #06b6d4;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .exercise-intelligence {
            text-align: right;
            flex-shrink: 0;
        }

        .suggested-weight {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .pr-indicator {
            color: #f59e0b;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .progression-indicator {
            color: #10b981;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .previous-session {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .previous-header {
            color: #60a5fa;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .previous-sets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
        }

        .previous-set {
            color: #93c5fd;
            font-size: 0.8rem;
            text-align: center;
            padding: 0.25rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
        }

        .intensity-inputs {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .intensity-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .intensity-row:last-child {
            margin-bottom: 0;
        }

        .intensity-label {
            color: #e2e8f0;
            font-weight: 500;
            min-width: 80px;
        }

        .intensity-scale {
            display: flex;
            gap: 0.5rem;
        }

        .intensity-btn {
            width: 2rem;
            height: 2rem;
            border: 1px solid rgba(71, 85, 105, 0.5);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .intensity-btn.active {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
            border-color: transparent;
        }

        .set-input-grid {
            display: grid;
            gap: 0.75rem;
        }

        .set-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(15, 23, 42, 0.6);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .set-number {
            width: 2rem;
            color: #64748b;
            font-weight: 600;
            text-align: center;
        }

        .weight-input, .reps-input {
            width: 4rem;
            padding: 0.5rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            color: white;
            text-align: center;
            font-weight: 500;
        }

        .weight-input:focus, .reps-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .notes-input {
            flex: 1;
            padding: 0.5rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }

        .notes-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .notes-input::placeholder {
            color: #64748b;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-copy {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-copy:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-add {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .btn-add:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .btn-complete {
            padding: 1rem 3rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            display: block;
            margin: 2rem auto 0;
        }

        .btn-complete:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .analytics-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .overload-breakdown {
            display: grid;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .overload-component {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 6px;
        }

        .component-bar {
            flex: 1;
            height: 4px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 2px;
            margin: 0 0.75rem;
            overflow: hidden;
        }

        .component-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .insights-list {
            list-style: none;
        }

        .insight-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            border-left: 4px solid #06b6d4;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .plateau-alert {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .progression-highlight {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .stretch-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(71, 85, 105, 0.5);
            border-radius: 4px;
            cursor: pointer;
            appearance: none;
            position: relative;
            transition: all 0.3s ease;
        }

        .stretch-checkbox:checked {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
        }

        .stretch-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .stretch-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(15, 23, 42, 0.6);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            justify-content: space-between;
        }

        .stretch-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .stretch-label {
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .exercise-progress-indicator {
            font-size: 0.75rem;
            color: #10b981;
            margin-bottom: 0.25rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .exercise-header {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .set-row {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .intensity-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Zach's Fitness Command Center</h1>
            <p>Intelligent Workout Tracking & Performance Analytics</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" id="workout-tab-btn">üèãÔ∏è Workout</div>
            <div class="nav-tab" id="analytics-tab-btn">üìä Analytics</div>
            <div class="nav-tab" id="progress-tab-btn">üìà Progress</div>
            <div class="nav-tab" id="intelligence-tab-btn">üß† Insights</div>
        </div>

        <!-- WORKOUT TAB -->
        <div id="workout-content" class="tab-content active">
            <div class="workout-day-selector">
                <button class="day-btn active" id="upper-btn">Upper</button>
                <button class="day-btn" id="lower-btn">Lower</button>
                <button class="day-btn" id="rest-btn">Rest</button>
                <button class="day-btn" id="push-btn">Push</button>
                <button class="day-btn" id="pull-btn">Pull</button>
                <button class="day-btn" id="legs-btn">Legs</button>
                <button class="day-btn" id="rest-btn">Rest</button>

            </div>

            <div class="workout-controls" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap;">
                <button class="btn" id="log-past-workout-btn" style="background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3);">üìÖ Log Past Workout</button>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <label style="color: #94a3b8; font-size: 0.9rem;">Date:</label>
                    <input type="date" id="workout-date-input" style="padding: 0.5rem; background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 6px; color: white;">
                </div>
            </div>

            <div class="intensity-inputs">
                <h4 style="color: #06b6d4; margin-bottom: 1rem;">How are you feeling?</h4>
                <div class="intensity-row">
                    <span class="intensity-label">Energy:</span>
                    <div class="intensity-scale" id="energy-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: #64748b; font-size: 0.8rem;">Dragging ‚Üí Energetic</span>
                </div>
                <div class="intensity-row">
                    <span class="intensity-label">Motivation:</span>
                    <div class="intensity-scale" id="motivation-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: #64748b; font-size: 0.8rem;">Forced ‚Üí Eager</span>
                </div>
            </div>

            <div class="intelligence-panel">
                <div class="intelligence-header">
                    <div class="ai-icon">AI</div>
                    <h3>Workout Intelligence</h3>
                </div>
                <div class="suggestions-grid" id="suggestions-container">
                    <div class="suggestion-card">
                        <div class="suggestion-type">Loading...</div>
                        <div class="suggestion-text">Loading AI suggestions...</div>
                    </div>
                </div>
            </div>

            <div id="exercises-container">
                <!-- Exercises will be populated here -->
            </div>

            <div class="intensity-inputs">
                <h4 style="color: #06b6d4; margin-bottom: 1rem;">How did the workout go?</h4>
                <div class="intensity-row">
                    <span class="intensity-label">Fatigue:</span>
                    <div class="intensity-scale" id="fatigue-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: #64748b; font-size: 0.8rem;">Exhausted ‚Üí Energized</span>
                </div>
                <div class="intensity-row">
                    <span class="intensity-label">Satisfaction:</span>
                    <div class="intensity-scale" id="satisfaction-scale">
                        <button class="intensity-btn" data-value="1">1</button>
                        <button class="intensity-btn" data-value="2">2</button>
                        <button class="intensity-btn" data-value="3">3</button>
                        <button class="intensity-btn" data-value="4">4</button>
                        <button class="intensity-btn" data-value="5">5</button>
                    </div>
                    <span style="color: #64748b; font-size: 0.8rem;">Poor ‚Üí Crushed it</span>
                </div>
            </div>

            <button class="btn-complete" id="complete-workout-btn">Complete Session</button>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics-content" class="tab-content">
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3 class="analytics-title">üí™ Total Volume</h3>
                    <div class="stat-value" id="total-volume">0</div>
                    <div class="stat-label">lbs lifted this month</div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üéØ Personal Records</h3>
                    <div class="stat-value" id="pr-count">0</div>
                    <div class="stat-label">PRs set this month</div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üî• Workout Streak</h3>
                    <div class="stat-value" id="workout-streak">0</div>
                    <div class="stat-label">consecutive workouts</div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">‚ö° Overload Score</h3>
                    <div class="stat-value" id="overload-score">0</div>
                    <div class="stat-label">strength progression rating</div>
                    <div class="overload-breakdown" id="overload-breakdown">
                        <!-- Breakdown will be populated here -->
                    </div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="analytics-card">
                    <h3 class="analytics-title">üìà Volume Trends</h3>
                    <div class="chart-container">
                        <canvas id="volume-chart"></canvas>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üí™ Strength Progression</h3>
                    <div class="chart-container">
                        <canvas id="strength-chart"></canvas>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üéØ Muscle Group Balance</h3>
                    <div class="chart-container">
                        <canvas id="balance-chart"></canvas>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üèãÔ∏è Top Exercises</h3>
                    <div class="chart-container">
                        <canvas id="exercise-chart"></canvas>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üìä Rep Range Analysis</h3>
                    <div class="chart-container">
                        <canvas id="rep-range-chart"></canvas>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3 class="analytics-title">üèÜ PR Timeline</h3>
                    <div class="chart-container">
                        <canvas id="pr-timeline-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROGRESS TAB -->
        <div id="progress-content" class="tab-content">
            <div class="analytics-card">
                <h3 class="analytics-title">üìà Exercise Progression</h3>
                <div id="exercise-progress-list">
                    <p style="color: #64748b;">Complete some workouts to see your detailed progression!</p>
                </div>
            </div>

            <div class="analytics-card">
                <h3 class="analytics-title">üèÜ Personal Records</h3>
                <div id="progress-list">
                    <p style="color: #64748b;">Complete some workouts to see your strength progression!</p>
                </div>
            </div>
        </div>

        <!-- INTELLIGENCE TAB -->
        <div id="intelligence-content" class
        <!-- INTELLIGENCE TAB -->
        <div id="intelligence-content" class="tab-content">
            <div class="analytics-card">
                <h3 class="analytics-title">üß† AI Insights</h3>
                <ul class="insights-list" id="insights-list">
                    <li class="insight-item">Complete some workouts to get personalized insights!</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBouZ7KMUMSf8RdBKudMW2qEXI_FHgchIU",
            authDomain: "fitness-command-center.firebaseapp.com",
            projectId: "fitness-command-center",
            storageBucket: "fitness-command-center.firebasestorage.app",
            messagingSenderId: "416632779679",
            appId: "1:416632779679:web:768ab3ec04da3aecac03aa",
            measurementId: "G-F06G7Y9V25"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global state
        let currentDay = 'Upper';
        let currentWorkout = {};
        let allWorkouts = [];
        let workoutIntensity = {
            preWorkout: { energy: null, motivation: null },
            postWorkout: { fatigue: null, satisfaction: null }
        };
        let charts = {};

        const workoutPlans = {
    Upper: [
        { name: 'Incline Dumbbell Press', sets: 3, reps: 8 },
        { name: 'Seated Cable Fly', sets: 2, reps: 10 },
        { name: 'Weighted Pull-Ups', sets: 3, reps: 6 },
        { name: 'High Cable Lateral Raise', sets: 2, reps: 10 },
        { name: 'Deficit Pendlay Row', sets: 2, reps: 8 },
        { name: 'Cable Tricep Extension', sets: 2, reps: 10 },
        { name: 'Bayesian Cable Bicep Curl', sets: 2, reps: 10 }
    ],
    Lower: [
        { name: 'Lying Leg Curls', sets: 2, reps: '8+partial to failure' },
        { name: 'Barbell Squat', sets: 3, reps: 8 },
        { name: 'Romanian Deadlift', sets: 3, reps: 8 },
        { name: 'Leg Extension', sets: 2, reps: 10 },
        { name: 'Hip Abduction', sets: 2, reps: 10 },
        { name: 'Standing Calf Raise', sets: 3, reps: 10 }
    ],
    Rest: [
        { name: 'Rest Day Recovery', sets: 1, reps: 'Complete' }
    ],
    Push: [
        { name: 'Barbell Bench Press', sets: 1, reps: '3-5 with warmup ladder (15, 5, 3, 2, 1)' },
        { name: 'Dumbbell Larsen Press', sets: 2, reps: '10 (75% of bench press weight)' },
        { name: 'Standing Arnold Press', sets: 3, reps: '8-10' },
        { name: 'Cable Press-Around (Superset)', sets: 2, reps: '12-15' },
        { name: 'Pec Stretch (Superset)', sets: 2, reps: '30 seconds' },
        { name: 'Cross-Body Cable Y-Raise', sets: 3, reps: '12-15' },
        { name: 'Squeeze-Only Pressdown (Superset)', sets: 3, reps: 8 },
        { name: 'Overhead Extension - Stretch Position (Superset)', sets: 3, reps: 8 },
        { name: 'Cross-Body Triceps Extension', sets: 2, reps: '10-12' }
    ],
    Pull: [
        { name: 'Lat Pulldown', sets: '4 feeder sets + 1-2 sets to failure + 1 dropset', reps: 'Varies' },
        { name: 'Machine Row/T-Bar Row/DB Helms Row', sets: 3, reps: '10-12' },
        { name: 'Bottom Half DB Lat Pullovers (Superset)', sets: 2, reps: '10-12' },
        { name: 'Static Lat Stretching (Superset)', sets: 2, reps: '30 seconds' },
        { name: 'Omni Directional Face Pulls', sets: 3, reps: '12-15' },
        { name: 'EZ Bar Bicep Curl', sets: 3, reps: '6-8' },
        { name: 'Bottom-Half DB Preacher Curl', sets: 2, reps: '10-12' } 
    ],
    Legs: [
        { name: 'Squats - Warmup 20%', sets: 1, reps: 10 },
        { name: 'Squats - Warmup 35%', sets: 1, reps: 5 },
        { name: 'Squats - Warmup 55%', sets: 1, reps: 3 },
        { name: 'Squats - Warmup 70%', sets: 1, reps: 2 },
        { name: 'Squats - Warmup 80%', sets: 1, reps: 1 },
        { name: 'Squats - 85-90%', sets: 1, reps: '2-4' },
        { name: 'Paused Squats (75% of working weight)', sets: 2, reps: 5 },
        { name: 'Romanian Deadlift', sets: 3, reps: '8-10' },
        { name: 'Walking Lunges', sets: 2, reps: '10 per leg' },
        { name: 'Seated Leg Curl', sets: 3, reps: '10-12' },
        { name: 'Leg Press Toe Press', sets: 4, reps: '10-12' },
        { name: 'Decline Plate Crunch', sets: 3, reps: '10-12' },
    ]
};

        // Firebase functions
        async function saveWorkoutToFirebase(workoutData) {
            try {
                const docRef = await addDoc(collection(db, "workouts"), {
                    ...workoutData,
                    timestamp: new Date()
                });
                console.log("Workout saved with ID:", docRef.id);
                return docRef.id;
            } catch (e) {
                console.error("Error adding workout:", e);
                throw e;
            }
        }

        async function loadWorkoutsFromFirebase() {
            try {
                const q = query(collection(db, "workouts"), orderBy("timestamp", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                const workouts = [];
                querySnapshot.forEach((doc) => {
                    workouts.push({ id: doc.id, ...doc.data() });
                });
                allWorkouts = workouts;
                console.log("Loaded workouts:", workouts.length);
                return workouts;
            } catch (e) {
                console.error("Error loading workouts:", e);
                return [];
            }
        }

        // Enhanced Analytics Functions
        function calculateTotalVolume() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            return allWorkouts
                .filter(workout => {
                    const workoutDate = new Date(workout.date);
                    return workoutDate.getMonth() === thisMonth && workoutDate.getFullYear() === thisYear;
                })
                .reduce((total, workout) => {
                    return total + Object.values(workout.exercises || {}).reduce((exerciseTotal, exercise) => {
                        return exerciseTotal + exercise.sets.reduce((setTotal, set) => {
                            return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                        }, 0);
                    }, 0);
                }, 0);
        }

       function calculateWorkoutStreak() {
    if (allWorkouts.length === 0) return 0;
    
    const sortedWorkouts = allWorkouts.sort((a, b) => new Date(b.date) - new Date(a.date));
    let streak = 1;
    let currentDate = new Date(sortedWorkouts[0].date);
    
    for (let i = 1; i < sortedWorkouts.length; i++) {
        const workoutDate = new Date(sortedWorkouts[i].date);
        const daysDiff = Math.floor((currentDate - workoutDate) / (1000 * 60 * 60 * 24));
        
        // Allow 1-2 day gaps (normal rest days in training program)
        if (daysDiff <= 2) {
            streak++;
            currentDate = workoutDate;
        } else {
            break;
        }
    }
    
    return streak;
}
        function calculateEnhancedOverloadScore() {
            if (allWorkouts.length < 2) return { overall: 0, breakdown: {} };
            
            const recentWorkouts = allWorkouts.slice(0, 8);
            let scores = {
                volumeProgression: 0,
                intensityProgression: 0,
                workCapacity: 0,
                consistency: 0
            };
            
            // Group workouts by day type for comparison
            const workoutsByDay = {};
            recentWorkouts.forEach(workout => {
                if (!workoutsByDay[workout.day]) workoutsByDay[workout.day] = [];
                workoutsByDay[workout.day].push(workout);
            });
            
            let totalComparisons = 0;
            let validComparisons = 0;
            
            // Analyze progression for each workout type
            Object.keys(workoutsByDay).forEach(dayType => {
                const dayWorkouts = workoutsByDay[dayType].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                for (let i = 0; i < dayWorkouts.length - 1; i++) {
                    const current = dayWorkouts[i];
                    const previous = dayWorkouts[i + 1];
                    
                    Object.keys(current.exercises || {}).forEach(exerciseIndex => {
                        const currentEx = current.exercises[exerciseIndex];
                        const prevEx = previous.exercises?.[exerciseIndex];
                        
                        if (!prevEx || !currentEx) return;
                        
                        totalComparisons++;
                        
                        // Skip stretch exercises for strength analysis
                        if (currentEx.exercise.toLowerCase().includes('stretch')) return;
                        
                        // Volume progression (weight x reps)
                        const currentVolume = currentEx.sets.reduce((sum, set) =>
                            sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0
                        );
                        const prevVolume = prevEx.sets.reduce((sum, set) =>
                            sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0
                        );
                        
                        if (currentVolume > prevVolume) scores.volumeProgression += 15;
                        
                        // Intensity progression (max weight)
                        const currentMaxWeight = Math.max(...currentEx.sets.map(set => parseFloat(set.weight) || 0));
                        const prevMaxWeight = Math.max(...prevEx.sets.map(set => parseFloat(set.weight) || 0));
                        
                        if (currentMaxWeight > prevMaxWeight) {
                            scores.intensityProgression += 20;
                            validComparisons++;
                        }
                        
                        // Same weight, more reps
                        const currentMaxReps = Math.max(...currentEx.sets.map(set => parseInt(set.reps) || 0));
                        const prevMaxReps = Math.max(...prevEx.sets.map(set => parseInt(set.reps) || 0));
                        
                        if (currentMaxWeight === prevMaxWeight && currentMaxReps > prevMaxReps) {
                            scores.volumeProgression += 12;
                            validComparisons++;
                        }
                        
                        // Work capacity (total sets)
                        if (currentEx.sets.length > prevEx.sets.length) {
                            scores.workCapacity += 8;
                        }
                    });
                }
            });
            
            // Consistency bonus
            const recentDays = 14;
            const expectedWorkouts = Math.floor(recentDays / 2.5); // ~3-4 per week
            const actualWorkouts = allWorkouts.filter(w => {
                const workoutDate = new Date(w.date);
                const daysAgo = Math.floor((Date.now() - workoutDate.getTime()) / (1000 * 60 * 60 * 24));
                return daysAgo <= recentDays;
            }).length;
            
            scores.consistency = Math.min(100, (actualWorkouts / expectedWorkouts) * 100);
            
            // Normalize scores
            const maxComparisons = Math.max(totalComparisons, 1);
            scores.volumeProgression = Math.min(100, (scores.volumeProgression / maxComparisons) * 3);
            scores.intensityProgression = Math.min(100, (scores.intensityProgression / maxComparisons) * 2.5);
            scores.workCapacity = Math.min(100, (scores.workCapacity / maxComparisons) * 4);
            
            // Calculate overall score with weights
            const overall = Math.round(
                scores.volumeProgression * 0.30 +
                scores.intensityProgression * 0.25 +
                scores.workCapacity * 0.20 +
                scores.consistency * 0.15 +
                (validComparisons > 0 ? 10 : 0) // Recency bonus
            );
            
            return {
                overall: Math.min(100, overall),
                breakdown: {
                    'Volume Progression': Math.round(scores.volumeProgression),
                    'Intensity Progression': Math.round(scores.intensityProgression),
                    'Work Capacity': Math.round(scores.workCapacity),
                    'Consistency': Math.round(scores.consistency)
                }
            };
        }

        function calculatePRCount() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const monthlyWorkouts = allWorkouts.filter(workout => {
                const workoutDate = new Date(workout.date);
                return workoutDate.getMonth() === thisMonth && workoutDate.getFullYear() === thisYear;
            });
            
            let prCount = 0;
            const exercisePRs = {};
            
            // Track PRs by finding new max weights in current month
            allWorkouts.forEach(workout => {
                Object.values(workout.exercises || {}).forEach(exercise => {
                    exercise.sets.forEach(set => {
                        const weight = parseFloat(set.weight);
                        const reps = parseInt(set.reps);
                        
                        if (weight && reps) {
                            const exerciseName = exercise.exercise;
                            const workoutDate = new Date(workout.date);
                            
                            if (!exercisePRs[exerciseName]) {
                                exercisePRs[exerciseName] = { weight: 0, date: null };
                            }
                            
                            if (weight > exercisePRs[exerciseName].weight) {
                                // Check if this PR was set this month
                                if (workoutDate.getMonth() === thisMonth && workoutDate.getFullYear() === thisYear) {
                                    if (exercisePRs[exerciseName].date === null || workoutDate > exercisePRs[exerciseName].date) {
                                        prCount++;
                                    }
                                }
                                exercisePRs[exerciseName] = { weight, date: workoutDate };
                            }
                        }
                    });
                });
            });
            
            return prCount;
        }

        function detectPlateaus() {
            const plateaus = [];
            const workoutsByDay = {};
            
            // Group recent workouts by day
            allWorkouts.slice(0, 12).forEach(workout => {
                if (!workoutsByDay[workout.day]) workoutsByDay[workout.day] = [];
                workoutsByDay[workout.day].push(workout);
            });
            
            // Check each exercise for plateaus
            Object.keys(workoutsByDay).forEach(dayType => {
                const dayWorkouts = workoutsByDay[dayType].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (dayWorkouts.length < 3) return;
                
                const exerciseMap = {};
                
                // Track exercise progression
                dayWorkouts.forEach(workout => {
                    Object.values(workout.exercises || {}).forEach(exercise => {
                        if (exercise.exercise.toLowerCase().includes('stretch')) return;
                        
                        if (!exerciseMap[exercise.exercise]) {
                            exerciseMap[exercise.exercise] = [];
                        }
                        
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        const maxReps = Math.max(...exercise.sets.map(set => parseInt(set.reps) || 0));
                        const totalVolume = exercise.sets.reduce((sum, set) => 
                            sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0);
                        
                        exerciseMap[exercise.exercise].push({
                            date: workout.date,
                            maxWeight,
                            maxReps,
                            totalVolume
                        });
                    });
                });
                
                // Detect plateaus
                Object.keys(exerciseMap).forEach(exerciseName => {
                    const progression = exerciseMap[exerciseName].slice(0, 3);
                    
                    if (progression.length < 3) return;
                    
                    // Check if weight hasn't increased in 3 sessions
                    const weights = progression.map(p => p.maxWeight);
                    const hasWeightProgression = weights.some((w, i) => i > 0 && w > weights[i-1]);
                    
                    // Check if volume is declining
                    const volumes = progression.map(p => p.totalVolume);
                    const hasVolumeDecline = volumes.length >= 2 && volumes[0] < volumes[1];
                    
                    if (!hasWeightProgression || hasVolumeDecline) {
                        plateaus.push({
                            exercise: exerciseName,
                            sessions: progression.length,
                            lastWeight: weights[0],
                            suggestion: generatePlateauSuggestion(exerciseName, progression)
                        });
                    }
                });
            });
            
            return plateaus;
        }

        function generatePlateauSuggestion(exerciseName, progression) {
            const isCompound = ['squat', 'bench', 'deadlift', 'press'].some(compound => 
                exerciseName.toLowerCase().includes(compound));
            
            if (isCompound) {
                return `Try micro-loading (+2.5lbs) or add pause reps at 90% weight`;
            } else {
                return `Consider adding 1 set or trying drop sets for volume progression`;
            }
        }
        function generateAdvancedSuggestions() {
            if (allWorkouts.length === 0) {
                return [{
                    type: 'motivation',
                    text: 'Start logging workouts to get personalized AI suggestions!'
                }];
            }
            
            const suggestions = [];
            
            // Get plateaus
            const plateaus = detectPlateaus();
            
            // Plateau alerts
            plateaus.slice(0, 2).forEach(plateau => {
                suggestions.push({
                    type: 'plateau',
                    text: `${plateau.exercise} has plateaued for ${plateau.sessions} sessions. ${plateau.suggestion}`
                });
            });
            
            // Get last workout for current day
            const lastWorkout = allWorkouts.find(w => w.day === currentDay);
            
            if (lastWorkout) {
                const daysSince = Math.floor((Date.now() - new Date(lastWorkout.date).getTime()) / (1000 * 60 * 60 * 24));
                
                if (daysSince > 7) {
                    suggestions.push({
                        type: 'recovery',
                        text: `It's been ${daysSince} days since your last ${currentDay} workout. You should feel strong today!`
                    });
                } else if (daysSince === 0) {
                    suggestions.push({
                        type: 'warning',
                        text: `You already trained ${currentDay} today. Consider rest or a different muscle group.`
                    });
                }
                
                // Smart progression suggestions
                Object.values(lastWorkout.exercises || {}).forEach((exercise, idx) => {
                    if (idx < 2 && !exercise.exercise.toLowerCase().includes('stretch')) {
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        const completedReps = exercise.sets.map(set => parseInt(set.reps) || 0);
                        const avgReps = completedReps.reduce((a, b) => a + b, 0) / completedReps.length;
                        
                        if (maxWeight > 0) {
                            // If consistently hitting high reps, suggest weight increase
                            if (avgReps >= 10 && completedReps.every(r => r >= 8)) {
                                suggestions.push({
                                    type: 'progression',
                                    text: `${exercise.exercise}: Strong performance (${maxWeight}lbs √ó ${Math.round(avgReps)}). Try ${maxWeight + 5}lbs next time!`
                                });
                            }
                            // If struggling with reps, suggest technique focus
                            else if (avgReps < 6 && maxWeight > 0) {
                                suggestions.push({
                                    type: 'technique',
                                    text: `${exercise.exercise}: Focus on form at ${maxWeight - 5}lbs or add more warm-up sets`
                                });
                            }
                        }
                    }
                });
            }
            
            // Consistency suggestions
            const recentWorkouts = allWorkouts.slice(0, 7);
            if (recentWorkouts.length >= 3) {
                const consistency = (recentWorkouts.length / 7) * 100;
                if (consistency >= 60) {
                    suggestions.push({
                        type: 'motivation',
                        text: `Excellent consistency! ${Math.round(consistency)}% workout rate this week.`
                    });
                }
            } else if (recentWorkouts.length === 1) {
                suggestions.push({
                    type: 'consistency',
                    text: 'Great job getting back to training! Aim for 3-4 sessions this week.'
                });
            }
            
            // Volume balance suggestions
            const muscleGroupVolumes = calculateMuscleGroupVolumes();
            const maxVolume = Math.max(...Object.values(muscleGroupVolumes));
            const minVolume = Math.min(...Object.values(muscleGroupVolumes));
            
            if (maxVolume > 0 && minVolume < maxVolume * 0.6) {
                const undertrainedGroup = Object.keys(muscleGroupVolumes).find(group => 
                    muscleGroupVolumes[group] === minVolume);
                suggestions.push({
                    type: 'balance',
                    text: `Consider adding more ${undertrainedGroup} volume for better muscle balance`
                });
            }
            
            return suggestions.slice(0, 4);
        }

        function calculateMuscleGroupVolumes() {
            const volumes = { Push: 0, Pull: 0, Legs: 0, Upper: 0, Lower: 0 };
            
            allWorkouts.slice(0, 8).forEach(workout => {
                const workoutVolume = Object.values(workout.exercises || {}).reduce((total, exercise) => {
                    return total + exercise.sets.reduce((setTotal, set) => {
                        return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                    }, 0);
                }, 0);
                
                volumes[workout.day] = (volumes[workout.day] || 0) + workoutVolume;
            });
            
            return volumes;
        }

        function calculateWorkoutVolume(workout) {
            return Object.values(workout.exercises || {}).reduce((total, exercise) => {
                return total + exercise.sets.reduce((setTotal, set) => {
                    return setTotal + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                }, 0);
            }, 0);
        }

        function generateAIInsights() {
            if (allWorkouts.length < 3) {
                return [
                    "Complete more workouts to unlock AI insights!",
                    "Aim for consistency - 3-4 workouts per week is ideal.",
                    "Focus on progressive overload - gradually increase weight or reps."
                ];
            }
            
            const insights = [];
            
            // Workout frequency analysis
            const workoutDays = allWorkouts.slice(0, 10).map(w => new Date(w.date).getDay());
            const dayFrequency = {};
            workoutDays.forEach(day => {
                dayFrequency[day] = (dayFrequency[day] || 0) + 1;
            });
            
            if (Object.keys(dayFrequency).length > 0) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const preferredDay = Object.keys(dayFrequency).reduce((a, b) => dayFrequency[a] > dayFrequency[b] ? a : b);
                insights.push(`You train most often on ${dayNames[preferredDay]}s - this seems to be your power day!`);
            }
            
            // Volume analysis
            const totalVolume = allWorkouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0);
            const avgVolumePerWorkout = Math.round(totalVolume / allWorkouts.length);
            insights.push(`Your average workout volume is ${avgVolumePerWorkout.toLocaleString()}lbs - solid training stimulus.`);
            
            // Strength progression insights
            const overloadData = calculateEnhancedOverloadScore();
            if (overloadData.overall > 70) {
                insights.push(`Outstanding strength progression! Your overload score of ${overloadData.overall}/100 indicates excellent training adaptation.`);
            } else if (overloadData.overall > 40) {
                insights.push(`Good progress with an overload score of ${overloadData.overall}/100. Consider focusing on weak points.`);
            } else if (overloadData.overall > 0) {
                insights.push(`Room for improvement with overload score of ${overloadData.overall}/100. Focus on progressive overload principles.`);
            }
            
            // Exercise-specific insights
            const exerciseVolumes = {};
            allWorkouts.forEach(workout => {
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (!exercise.exercise.toLowerCase().includes('stretch')) {
                        const volume = exercise.sets.reduce((sum, set) => 
                            sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0);
                        exerciseVolumes[exercise.exercise] = (exerciseVolumes[exercise.exercise] || 0) + volume;
                    }
                });
            });
            
            const topExercise = Object.keys(exerciseVolumes).reduce((a, b) => 
                exerciseVolumes[a] > exerciseVolumes[b] ? a : b, '');
                
            if (topExercise) {
                insights.push(`${topExercise} is your highest volume exercise with ${exerciseVolumes[topExercise].toLocaleString()}lbs total.`);
            }
            
            // Intensity correlation insights
            const intensityWorkouts = allWorkouts.filter(w => w.intensity);
            if (intensityWorkouts.length >= 3) {
                const highEnergyWorkouts = intensityWorkouts.filter(w => w.intensity.energy >= 4);
                const avgVolumeHighEnergy = highEnergyWorkouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0) / highEnergyWorkouts.length;
                const avgVolumeAll = intensityWorkouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0) / intensityWorkouts.length;
                
                if (avgVolumeHighEnergy > avgVolumeAll * 1.15) {
                    insights.push(`You perform ${Math.round(((avgVolumeHighEnergy - avgVolumeAll) / avgVolumeAll) * 100)}% better on high-energy days. Prioritize sleep and nutrition!`);
                }
            }
            
            return insights;
        }

        function getLastWorkoutForDay(day) {
            return allWorkouts.find(workout => workout.day === day);
        }

       function getPersonalRecords() {
            const prs = {};
            
            allWorkouts.forEach(workout => {
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (exercise.exercise.toLowerCase().includes('stretch')) return;
                    
                    exercise.sets.forEach(set => {
                        const weight = parseFloat(set.weight);
                        const reps = parseInt(set.reps);
                        
                        if (weight && reps) {
                            const exerciseName = exercise.exercise;
                            if (!prs[exerciseName] || weight > prs[exerciseName].weight) {
                                prs[exerciseName] = { weight, reps, date: workout.date };
                            }
                        }
                    });
                });
            });
            
            return prs;
        }

        function getExerciseProgression() {
            const progression = {};
            
            // Group workouts by exercise
            allWorkouts.forEach(workout => {
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (exercise.exercise.toLowerCase().includes('stretch')) return;
                    
                    if (!progression[exercise.exercise]) {
                        progression[exercise.exercise] = [];
                    }
                    
                    const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                    const maxReps = Math.max(...exercise.sets.map(set => parseInt(set.reps) || 0));
                    const totalVolume = exercise.sets.reduce((sum, set) => 
                        sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0);
                    
                    progression[exercise.exercise].push({
                        date: workout.date,
                        maxWeight,
                        maxReps,
                        totalVolume,
                        rawSets: exercise.sets
                    });
                });
            });
            
            // Sort by date and analyze progression
            const progressionSummary = {};
            Object.keys(progression).forEach(exerciseName => {
                const sessions = progression[exerciseName].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (sessions.length >= 2) {
                    const latest = sessions[0];
                    const previous = sessions[1];
                    
                    let progressionText = '';
                    let progressionType = 'none';
                    
                    if (latest.maxWeight > previous.maxWeight) {
                        progressionText = `${previous.maxWeight}lbs ‚Üí ${latest.maxWeight}lbs (+${latest.maxWeight - previous.maxWeight}lbs)`;
                        progressionType = 'strength';
                    } else if (latest.maxWeight === previous.maxWeight && latest.maxReps > previous.maxReps) {
                        progressionText = `${latest.maxWeight}lbs: ${previous.maxReps} ‚Üí ${latest.maxReps} reps (+${latest.maxReps - previous.maxReps})`;
                        progressionType = 'volume';
                    } else if (latest.totalVolume > previous.totalVolume) {
                        progressionText = `Volume: ${previous.totalVolume} ‚Üí ${latest.totalVolume} lbs (+${Math.round(((latest.totalVolume - previous.totalVolume) / previous.totalVolume) * 100)}%)`;
                        progressionType = 'total_volume';
                    } else {
                        progressionText = `${latest.maxWeight}lbs √ó ${latest.maxReps} (maintaining)`;
                        progressionType = 'maintaining';
                    }
                    
                    const daysSince = Math.floor((new Date() - new Date(latest.date)) / (1000 * 60 * 60 * 24));
                    
                    progressionSummary[exerciseName] = {
                        progression: progressionText,
                        type: progressionType,
                        daysSince,
                        sessions: sessions.length
                    };
                }
            });
            
            return progressionSummary;
        }

        // Chart Functions
        function createVolumeChart() {
            const ctx = document.getElementById('volume-chart');
            if (!ctx) return;
            
            if (charts.volume) charts.volume.destroy();
            
            // Get last 12 weeks of data
            const weeklyData = {};
            const today = new Date();
            
            for (let i = 11; i >= 0; i--) {
                const weekStart = new Date(today.getTime() - (i * 7 * 24 * 60 * 60 * 1000));
                const weekKey = weekStart.toISOString().split('T')[0];
                weeklyData[weekKey] = { Push: 0, Pull: 0, Upper: 0, Lower: 0, Legs: 0 };
            }
            
            allWorkouts.forEach(workout => {
                const workoutDate = new Date(workout.date);
                const weekStart = new Date(workoutDate.getTime() - (workoutDate.getDay() * 24 * 60 * 60 * 1000));
                const weekKey = weekStart.toISOString().split('T')[0];
                
                if (weeklyData[weekKey]) {
                    const volume = calculateWorkoutVolume(workout);
                    weeklyData[weekKey][workout.day] += volume;
                }
            });
            
            const labels = Object.keys(weeklyData).map(date => new Date(date).toLocaleDateString());
            const datasets = [
                {
                    label: 'Push',
                    data: Object.values(weeklyData).map(week => week.Push),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Pull',
                    data: Object.values(weeklyData).map(week => week.Pull),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Upper',
                    data: Object.values(weeklyData).map(week => week.Upper),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Lower',
                    data: Object.values(weeklyData).map(week => week.Lower),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Legs',
                    data: Object.values(weeklyData).map(week => week.Legs),
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    tension: 0.4
                }
            ];
            
            charts.volume = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Volume (lbs)' }
                        }
                    }
                }
            });
        }

        function createStrengthChart() {
            const ctx = document.getElementById('strength-chart');
            if (!ctx) return;
            
            if (charts.strength) charts.strength.destroy();
            
            // Track key compound movements
            const keyExercises = ['Barbell Bench Press', 'Barbell Squat', 'Romanian Deadlift', 'Weighted Pull-Ups'];
            const datasets = [];
            
            keyExercises.forEach((exerciseName, index) => {
                const exerciseData = [];
                const exerciseWorkouts = allWorkouts.filter(workout =>
                    Object.values(workout.exercises || {}).some(ex => ex.exercise === exerciseName)
                ).slice(0, 10).reverse();
                
                exerciseWorkouts.forEach(workout => {
                    const exercise = Object.values(workout.exercises || {}).find(ex => ex.exercise === exerciseName);
                    if (exercise) {
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        if (maxWeight > 0) {
                            exerciseData.push({
                                x: workout.date,
                                y: maxWeight
                            });
                        }
                    }
                });
                
                if (exerciseData.length > 0) {
                    const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b'];
                    datasets.push({
                        label: exerciseName,
                        data: exerciseData,
                        borderColor: colors[index],
                        backgroundColor: colors[index],
                        tension: 0.4
                    });
                }
            });
            
            charts.strength = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Max Weight (lbs)' }
                        }
                    }
                }
            });
        }

        function createBalanceChart() {
            const ctx = document.getElementById('balance-chart');
            if (!ctx) return;
            
            if (charts.balance) charts.balance.destroy();
            
            const muscleGroupVolumes = calculateMuscleGroupVolumes();
            const labels = Object.keys(muscleGroupVolumes);
            const data = Object.values(muscleGroupVolumes);
            
            charts.balance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: [
                            '#ef4444',
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function createExerciseChart() {
            const ctx = document.getElementById('exercise-chart');
            if (!ctx) return;
            
            if (charts.exercise) charts.exercise.destroy();
            
            const exerciseVolumes = {};
            allWorkouts.slice(0, 8).forEach(workout => {
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (!exercise.exercise.toLowerCase().includes('stretch')) {
                        const volume = exercise.sets.reduce((sum, set) => 
                            sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0), 0);
                        exerciseVolumes[exercise.exercise] = (exerciseVolumes[exercise.exercise] || 0) + volume;
                    }
                });
            });
            
            const sortedExercises = Object.entries(exerciseVolumes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            charts.exercise = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedExercises.map(([name]) => name.length > 20 ? name.substring(0, 17) + '...' : name),
                    datasets: [{
                        label: 'Volume (lbs)',
                        data: sortedExercises.map(([,volume]) => volume),
                        backgroundColor: '#06b6d4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Volume (lbs)' }
                        }
                    }
                }
            });
        }
        function createRepRangeChart() {
            const ctx = document.getElementById('rep-range-chart');
            if (!ctx) return;
            
            if (charts.repRange) charts.repRange.destroy();
            
            const repRanges = {
                'Heavy (1-5)': 0,
                'Strength (6-8)': 0,
                'Hypertrophy (9-12)': 0,
                'Endurance (13+)': 0
            };
            
            allWorkouts.slice(0, 8).forEach(workout => {
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (!exercise.exercise.toLowerCase().includes('stretch')) {
                        exercise.sets.forEach(set => {
                            const reps = parseInt(set.reps) || 0;
                            const weight = parseFloat(set.weight) || 0;
                            const volume = weight * reps;
                            
                            if (reps <= 5) repRanges['Heavy (1-5)'] += volume;
                            else if (reps <= 8) repRanges['Strength (6-8)'] += volume;
                            else if (reps <= 12) repRanges['Hypertrophy (9-12)'] += volume;
                            else repRanges['Endurance (13+)'] += volume;
                        });
                    }
                });
            });
            
            charts.repRange = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(repRanges),
                    datasets: [{
                        label: 'Volume (lbs)',
                        data: Object.values(repRanges),
                        backgroundColor: ['#dc2626', '#ea580c', '#ca8a04', '#16a34a']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Volume (lbs)' }
                        }
                    }
                }
            });
        }

        function createPRTimelineChart() {
            const ctx = document.getElementById('pr-timeline-chart');
            if (!ctx) return;
            
            if (charts.prTimeline) charts.prTimeline.destroy();
            
            const prs = [];
            const exercisePRHistory = {};
            
            // Build PR history
            allWorkouts.slice().reverse().forEach(workout => {
                Object.values(workout.exercises || {}).forEach(exercise => {
                    if (!exercise.exercise.toLowerCase().includes('stretch')) {
                        const maxWeight = Math.max(...exercise.sets.map(set => parseFloat(set.weight) || 0));
                        
                        if (maxWeight > 0) {
                            const exerciseName = exercise.exercise;
                            const currentPR = exercisePRHistory[exerciseName] || 0;
                            
                            if (maxWeight > currentPR) {
                                prs.push({
                                    x: workout.date,
                                    y: maxWeight,
                                    exercise: exerciseName
                                });
                                exercisePRHistory[exerciseName] = maxWeight;
                            }
                        }
                    }
                });
            });
            
            // Group PRs by exercise for different colors
            const exerciseColors = {};
            const uniqueExercises = [...new Set(prs.map(pr => pr.exercise))];
            const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6'];
            
            uniqueExercises.forEach((exercise, index) => {
                exerciseColors[exercise] = colors[index % colors.length];
            });
            
            const datasets = uniqueExercises.slice(0, 5).map(exercise => ({
                label: exercise,
                data: prs.filter(pr => pr.exercise === exercise),
                backgroundColor: exerciseColors[exercise],
                borderColor: exerciseColors[exercise],
                pointRadius: 6
            }));
            
            charts.prTimeline = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Weight (lbs)' }
                        }
                    }
                }
            });
        }

        // UI Functions
        function updateSuggestions() {
            const suggestions = generateAdvancedSuggestions();
            const container = document.getElementById('suggestions-container');
            
            container.innerHTML = suggestions.map(suggestion => `
                <div class="suggestion-card">
                    <div class="suggestion-type">${suggestion.type}</div>
                    <div class="suggestion-text">${suggestion.text}</div>
                </div>
            `).join('');
        }

        function updateAnalytics() {
            document.getElementById('total-volume').textContent = calculateTotalVolume().toLocaleString();
            document.getElementById('pr-count').textContent = calculatePRCount();
            document.getElementById('workout-streak').textContent = calculateWorkoutStreak();
            
            const overloadData = calculateEnhancedOverloadScore();
            document.getElementById('overload-score').textContent = overloadData.overall;
            
            // Update overload breakdown
            const breakdownContainer = document.getElementById('overload-breakdown');
            breakdownContainer.innerHTML = Object.entries(overloadData.breakdown).map(([component, score]) => `
                <div class="overload-component">
                    <span style="color: #e2e8f0; font-size: 0.8rem;">${component}</span>
                    <div class="component-bar">
                        <div class="component-fill" style="width: ${score}%; background: linear-gradient(135deg, #06b6d4, #3b82f6);"></div>
                    </div>
                    <span style="color: #06b6d4; font-size: 0.8rem; font-weight: 600;">${score}</span>
                </div>
            `).join('');
            
            // Update charts
            createVolumeChart();
            createStrengthChart();
            createBalanceChart();
            createExerciseChart();
            createRepRangeChart();
            createPRTimelineChart();
        }

        function updateInsights() {
            const insights = generateAIInsights();
            const plateaus = detectPlateaus();
            const container = document.getElementById('insights-list');
            
            let html = '';
            
            // Add plateau alerts first
            plateaus.slice(0, 2).forEach(plateau => {
                html += `<li class="insight-item plateau-alert">‚ö†Ô∏è ${plateau.exercise} plateaued for ${plateau.sessions} sessions. ${plateau.suggestion}</li>`;
            });
            
            // Add regular insights
            insights.forEach(insight => {
                const isProgression = insight.includes('Outstanding') || insight.includes('excellent');
                const className = isProgression ? 'progression-highlight' : '';
                html += `<li class="insight-item ${className}">${insight}</li>`;
            });
            
            container.innerHTML = html || '<li class="insight-item">Complete more workouts to get personalized insights!</li>';
        }

        function updateProgress() {
            const prs = getPersonalRecords();
            const progression = getExerciseProgression();
            const prContainer = document.getElementById('progress-list');
            const progressionContainer = document.getElementById('exercise-progress-list');
            
            // Update PRs
            if (Object.keys(prs).length === 0) {
                prContainer.innerHTML = '<p style="color: #64748b;">Complete some workouts to see your personal records!</p>';
            } else {
                const sortedPRs = Object.entries(prs).sort(([,a], [,b]) => b.weight - a.weight);
                
                prContainer.innerHTML = sortedPRs.slice(0, 10).map(([exercise, pr]) => `
                    <div class="insight-item">
                        <strong>${exercise}</strong><br>
                        ${pr.weight}lbs √ó ${pr.reps} reps - ${new Date(pr.date).toLocaleDateString()}
                    </div>
                `).join('');
            }
            
            // Update exercise progression
            if (Object.keys(progression).length === 0) {
                progressionContainer.innerHTML = '<p style="color: #64748b;">Complete some workouts to see your detailed progression!</p>';
            } else {
                const sortedProgression = Object.entries(progression).sort(([,a], [,b]) => {
                    const typeOrder = { strength: 4, volume: 3, total_volume: 2, maintaining: 1 };
                    return typeOrder[b.type] - typeOrder[a.type];
                });
                
                progressionContainer.innerHTML = sortedProgression.slice(0, 15).map(([exercise, data]) => {
                    const typeColors = {
                        strength: '#10b981',
                        volume: '#3b82f6', 
                        total_volume: '#f59e0b',
                        maintaining: '#64748b'
                    };
                    
                    return `
                        <div class="insight-item" style="border-left-color: ${typeColors[data.type]};">
                            <strong>${exercise}</strong><br>
                            ${data.progression}<br>
                            <span style="color: #94a3b8; font-size: 0.75rem;">
                                ${data.daysSince} days ago ‚Ä¢ ${data.sessions} sessions tracked
                            </span>
                        </div>
                    `;
                }).join('');
            }
        }
        // Main app initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing Fitness Command Center...');
            
            // Set up UI immediately
            setupEventListeners();
            initializeWorkout();
            
            // Load data in background
            await loadWorkoutsFromFirebase();
            
            // Update with real data
            updateSuggestions();
            updateAnalytics();
            updateInsights();
            updateProgress();
            
            console.log('Fitness Command Center loaded successfully!');
        });

        function setupEventListeners() {
            // Tab switching
            document.getElementById('workout-tab-btn').addEventListener('click', () => {
                showTab('workout');
                updateSuggestions();
            });
            document.getElementById('analytics-tab-btn').addEventListener('click', () => {
                showTab('analytics');
                updateAnalytics();
            });
            document.getElementById('progress-tab-btn').addEventListener('click', () => {
                showTab('progress');
                updateProgress();
            });
            document.getElementById('intelligence-tab-btn').addEventListener('click', () => {
                showTab('intelligence');
                updateInsights();
            });

            // Day selection
           // Day selection
            document.getElementById('upper-btn').addEventListener('click', () => selectDay('Upper'));
            document.getElementById('lower-btn').addEventListener('click', () => selectDay('Lower'));
            document.getElementById('rest-btn').addEventListener('click', () => selectDay('Rest'));
            document.getElementById('push-btn').addEventListener('click', () => selectDay('Push'));
            document.getElementById('pull-btn').addEventListener('click', () => selectDay('Pull'));
            document.getElementById('legs-btn').addEventListener('click', () => selectDay('Legs'));

            // Complete workout
            document.getElementById('complete-workout-btn').addEventListener('click', completeWorkout);
            
            // Initialize date input to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('workout-date-input').value = today;

            // Date input handling
            document.getElementById('workout-date-input').addEventListener('change', setWorkoutDate);
            document.getElementById('log-past-workout-btn').addEventListener('click', () => {
                const dateInput = document.getElementById('workout-date-input');
                if (dateInput.style.display === 'none' || !dateInput.style.display) {
                    dateInput.style.display = 'block';
                    dateInput.focus();
                }
            });

            // Intensity inputs
            setupIntensityInputs();

            setWorkoutDate(); // Initialize the button text
        }

        function setupIntensityInputs() {
            ['energy', 'motivation', 'fatigue', 'satisfaction'].forEach(type => {
                const scale = document.getElementById(`${type}-scale`);
                if (scale) {
                    scale.addEventListener('click', (e) => {
                        if (e.target.classList.contains('intensity-btn')) {
                            // Remove active class from siblings
                            scale.querySelectorAll('.intensity-btn').forEach(btn => btn.classList.remove('active'));
                            
                            // Add active class to clicked button
                            e.target.classList.add('active');
                            
                            // Update workout intensity
                            const value = parseInt(e.target.dataset.value);
                            if (['energy', 'motivation'].includes(type)) {
                                workoutIntensity.preWorkout[type] = value;
                            } else {
                                workoutIntensity.postWorkout[type] = value;
                            }
                        }
                    });
                }
            });
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-content').classList.add('active');
            document.getElementById(tabName + '-tab-btn').classList.add('active');
        }

        function selectDay(day) {
            currentDay = day;
            
            // Update day buttons
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(day.toLowerCase() + '-btn').classList.add('active');

            initializeWorkout();
            updateSuggestions();
        }

        function initializeWorkout() {
            currentWorkout = {};
            const exercises = workoutPlans[currentDay];

            exercises.forEach((exercise, index) => {
                const isStretch = exercise.name.toLowerCase().includes('stretch');
                currentWorkout[index] = {
                    exercise: exercise.name,
                    sets: isStretch ? 
                        [{ completed: false }] : 
                        Array(typeof exercise.sets === 'number' ? exercise.sets : 1).fill().map(() => ({
                            weight: '',
                            reps: '',
                            notes: ''
                        }))
                };
            });

            renderWorkout();
        }

        function renderWorkout() {
            const container = document.getElementById('exercises-container');
            const exercises = workoutPlans[currentDay];
            const lastWorkout = getLastWorkoutForDay(currentDay);
            const exerciseProgression = getExerciseProgression();
            
            let html = '';
            
            exercises.forEach((exercise, exerciseIndex) => {
                const workoutExercise = currentWorkout[exerciseIndex];
                const previousExercise = lastWorkout?.exercises?.[exerciseIndex];
                                
                // Calculate suggested weight and get progression info
                let suggestedWeight = '';
                let progressionInfo = '';
                
                if (!isStretch && previousExercise && previousExercise.sets.length > 0) {
                    const prevSets = previousExercise.sets.filter(set => set.weight && set.reps);
                    if (prevSets.length > 0) {
                        const avgWeight = prevSets.reduce((sum, set) => sum + parseFloat(set.weight), 0) / prevSets.length;
                        const avgReps = prevSets.reduce((sum, set) => sum + parseInt(set.reps), 0) / prevSets.length;
                        
                        if (avgReps >= 10) {
                            suggestedWeight = Math.round(avgWeight + 5);
                        } else if (avgReps >= 8) {
                            suggestedWeight = Math.round(avgWeight + 2.5);
                        } else {
                            suggestedWeight = Math.round(avgWeight);
                        }
                    }
                }
                
                // Get progression information
                if (!isStretch && exerciseProgression[exercise.name]) {
                    const prog = exerciseProgression[exercise.name];
                    if (prog.type === 'strength') {
                        progressionInfo = `+${prog.progression.split('(+')[1]?.split(')')[0] || 'improved'}`;
                    } else if (prog.type === 'volume') {
                        progressionInfo = `+${prog.progression.split('(+')[1]?.split(')')[0] || 'reps'}`;
                    }
                }

                // Get PR for this exercise
                const prs = getPersonalRecords();
                const exercisePR = !isStretch ? prs[exercise.name] : null;
                html += `
                    <div class="exercise-card">
                        <div class="exercise-header">
                            <div>
                                <div class="exercise-name">${exercise.name}</div>
                                <div class="exercise-target">${exercise.sets} √ó ${exercise.reps}</div>
                                ${progressionInfo ? `<div class="exercise-progress-indicator">${progressionInfo} last session</div>` : ''}
                            </div>
                            <div class="exercise-intelligence">
                                ${suggestedWeight ? `<div class="suggested-weight">Try ${suggestedWeight}lbs</div>` : ''}
                                ${exercisePR ? `<div class="pr-indicator">PR: ${exercisePR.weight}lbs √ó ${exercisePR.reps}</div>` : ''}
                            </div>
                        </div>

                        ${previousExercise && !isStretch ? `
                            <div class="previous-session">
                                <div class="previous-header">Last session (${new Date(lastWorkout.date).toLocaleDateString()}):</div>
                                <div class="previous-sets">
                                    ${previousExercise.sets.filter(set => set.weight || set.reps).map((set, idx) => `
                                        <div class="previous-set">Set ${idx + 1}: ${set.weight}√ó${set.reps}</div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}`;

                // Check if this is a stretch exercise or rest day
            const isStretch = exercise.name.toLowerCase().includes('stretch');
            const isRest = currentDay === 'Rest';

            if (isStretch || isRest) {
                const label = isRest ? 'Rest Day Complete' : exercise.name;
                html += `
                    <div class="stretch-row">
                        <div class="stretch-info">
                            <div class="set-number">‚úì</div>
                            <div class="stretch-label">${label}</div>
                        </div>
                        <input type="checkbox" class="stretch-checkbox" 
                            ${workoutExercise.sets[0]?.completed ? 'checked' : ''}
                            onchange="updateStretch(${exerciseIndex}, this.checked)">
                    </div>
                `;
            } else {
                    html += `<div class="set-input-grid">`;
                    
                    workoutExercise.sets.forEach((set, setIndex) => {
                        html += `
                            <div class="set-row">
                                <div class="set-number">${setIndex + 1}</div>
                                <input type="number" class="weight-input" placeholder="lbs" 
                                       value="${set.weight}" 
                                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'weight', this.value)">
                                <span style="color: #64748b;">√ó</span>
                                <input type="number" class="reps-input" placeholder="reps" 
                                       value="${set.reps}" 
                                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'reps', this.value)">
                                <input type="text" class="notes-input" placeholder="notes" 
                                       value="${set.notes}" 
                                       onchange="updateSet(${exerciseIndex}, ${setIndex}, 'notes', this.value)">
                                ${previousExercise?.sets[setIndex]?.weight ? `
                                    <button class="btn btn-copy" onclick="copyPrevious(${exerciseIndex}, ${setIndex})">Copy</button>
                                ` : ''}
                            </div>`;
                    });
                    
                    html += `
                            </div>
                            <button class="btn btn-add" onclick="addSet(${exerciseIndex})" style="margin-top: 0.75rem;">+ Add Set</button>
                        `;
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        // Make functions globally available
        window.updateSet = function(exerciseIndex, setIndex, field, value) {
            currentWorkout[exerciseIndex].sets[setIndex][field] = value;
        };

        window.addSet = function(exerciseIndex) {
            currentWorkout[exerciseIndex].sets.push({ weight: '', reps: '', notes: '' });
            renderWorkout();
        };

        window.copyPrevious = function(exerciseIndex, setIndex) {
            const lastWorkout = getLastWorkoutForDay(currentDay);
            const previousSet = lastWorkout?.exercises?.[exerciseIndex]?.sets[setIndex];
            
            if (previousSet) {
                currentWorkout[exerciseIndex].sets[setIndex].weight = previousSet.weight;
                currentWorkout[exerciseIndex].sets[setIndex].reps = previousSet.reps;
                renderWorkout();
            }
        };

        window.updateStretch = function(exerciseIndex, completed) {
            currentWorkout[exerciseIndex].sets[0] = { completed: completed };
        };

        window.setWorkoutDate = function() {
            const dateInput = document.getElementById('workout-date-input');
            const logBtn = document.getElementById('log-past-workout-btn');
            const today = new Date().toISOString().split('T')[0];
            
            if (dateInput.value && dateInput.value !== today) {
                logBtn.textContent = 'üìÖ For ' + new Date(dateInput.value + 'T00:00:00').toLocaleDateString();
                logBtn.style.background = 'rgba(16, 185, 129, 0.2)';
                logBtn.style.color = '#10b981';
            } else {
                logBtn.textContent = 'üìÖ Log Past Workout';
                logBtn.style.background = 'rgba(168, 85, 247, 0.2)';
                logBtn.style.color = '#a855f7';
            }
        };

        async function completeWorkout() {
            const dateInput = document.getElementById('workout-date-input');
            const today = new Date().toISOString().split('T')[0];
            const selectedDate = dateInput.value && dateInput.value !== today ? dateInput.value : today;
            
            const workoutData = {
                date: selectedDate,
                day: currentDay,
                exercises: currentWorkout,
                intensity: {
                    energy: workoutIntensity.preWorkout.energy,
                    motivation: workoutIntensity.preWorkout.motivation,
                    fatigue: workoutIntensity.postWorkout.fatigue,
                    satisfaction: workoutIntensity.postWorkout.satisfaction
                }
            };
            
            try {
                // Save to Firebase
                await saveWorkoutToFirebase(workoutData);
                
                // Also save locally as backup
                const localHistory = JSON.parse(localStorage.getItem('fitnessData') || '{}');
                const workoutKey = currentDay + '-' + selectedDate + '-' + Date.now();
                localHistory[workoutKey] = workoutData;
                localStorage.setItem('fitnessData', JSON.stringify(localHistory));
                
                // Reload data from Firebase
                await loadWorkoutsFromFirebase();
                
                // Export to clipboard
                exportToClipboard();
                
                alert('üí™ Workout saved to Firebase and copied to clipboard!');
                
                // Reset intensity inputs
                workoutIntensity = {
                    preWorkout: { energy: null, motivation: null },
                    postWorkout: { fatigue: null, satisfaction: null }
                };
                
                // Clear active intensity buttons
                document.querySelectorAll('.intensity-btn').forEach(btn => btn.classList.remove('active'));
                
                // Reset and refresh
                initializeWorkout();
                updateSuggestions();
                updateAnalytics();
                
            } catch (error) {
                console.error('Error saving workout:', error);
                alert('Error saving workout. Check your internet connection.');
            }
        }

        function exportToClipboard() {
            const dateInput = document.getElementById('workout-date-input');
            const workoutDate = dateInput.value ? new Date(dateInput.value) : new Date();
            const dateString = workoutDate.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short', 
                day: 'numeric'
            });
            
            let exportText = 'üèãÔ∏è‚Äç‚ôÇÔ∏è ' + currentDay + ' | ' + dateString + '\n';
            exportText += '=========================\n';
            
            // Add intensity ratings if available
            if (workoutIntensity.preWorkout.energy || workoutIntensity.postWorkout.satisfaction) {
                exportText += '\nüìä Session Intensity:\n';
                if (workoutIntensity.preWorkout.energy) exportText += `Energy: ${workoutIntensity.preWorkout.energy}/5 `;
                if (workoutIntensity.preWorkout.motivation) exportText += `| Motivation: ${workoutIntensity.preWorkout.motivation}/5\n`;
                if (workoutIntensity.postWorkout.fatigue) exportText += `Fatigue: ${workoutIntensity.postWorkout.fatigue}/5 `;
                if (workoutIntensity.postWorkout.satisfaction) exportText += `| Satisfaction: ${workoutIntensity.postWorkout.satisfaction}/5\n`;
                exportText += '\n';
            }
            
            Object.values(currentWorkout).forEach(exercise => {
                exportText += exercise.exercise + '\n';
                
                exercise.sets.forEach((set, index) => {
                    if (set.completed) {
                        exportText += '  ‚úì Completed\n';
                    } else if (set.weight || set.reps) {
                        exportText += '  ' + set.weight + 'lbs √ó ' + set.reps;
                        if (set.notes) exportText += ' (' + set.notes + ')';
                        exportText += '\n';
                    }
                });
                exportText += '\n';
            });
            
            // Copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(exportText);
            } else {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = exportText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }
    </script>
</body>
</html>
